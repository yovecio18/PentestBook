## SameSite Cookies
Another CSRF protection mechanism is the SameSite cookie attribute (originally drafted in this Internet Draft and subsequently updated in another Internet Draft). A web application can set this attribute to configure if the cookie should be sent along with cross-origin requests. The attribute can have the following values:
```
    none: no additional measures are enforced by the browser. The cookie is sent with all cross-origin requests
    lax: the browser only sends the cookie with some cross-origin requests. For instance, only cross-origin form submissions using GET. The           cookie is not sent with any cross-origin requests made from JavaScript
    strict: the browser does not send the cookie with any cross-origin requests
```
Most modern browsers enforce a SameSite attribute of Lax by default (i.e., if no SameSite cookie attribute is explicitly set). This prevents many CSRF attacks by default, as the browser only sends cookies with safe HTTP requests, which prevents POST-based CSRF attacks. GET-based CSRF attacks are still possible but significantly less common than POST-based CSRF attacks.


## SameSite vs Origin:
**Origin=** more strict, takes in account Schema+Domain+Port all of them need to match in order to pass ex(https://cacca.com & https://cacca.com:80 will pass as schema,domain and port are all the same).
**SameSite=** less strict, takes in account only Schema and if it's same then it will pass(example https://cacca.com & https//culo.com will pass as both uses same schema). OBS: if no SameSite is specified by backend in the Cookie part then most browser will enfore Lax mode which means Cookie will be passed in Crossite request ONLY in GET request and not JS, this effectively kills the CSRF and sniff the token!


## How to check SameSite coookie
Catch the request via Burpsuite and it should show into Cookie header of the response, if not shown then by default browsers tend to use the Lax which mean no Cookie in JS crosssite request but yes into GET reuest.
Another alternative is to install Cookie Editor plugin and check under advanced options the Cookie status.


## SameSite=Strict cookie Bypass
In this case is the most restrictive one as the cookies will no pass in any CrossOrigin request which means if we try to use a external exploit server to host our code it will fail cause the cookie will no pass(Refer header will point to our server and not to the victim one indicating that samesite condition is not matching) consequently the logged session will be lost as the victim clicks on the link.

### How to solve?
In this case we need to find a vulnerable endpoint on the site that performs a client-side redirect(HTTP 2xx - aka redirect from HTML code ex via meta tag) by doing so it will be performed from same Origin and likely pass the **Samesite=Strict**

**Example:**
If we login to http://vulnerablesite.htb/admin.php?user=cacca here we can see that the website perform a client-side redirect via metatag to http://vulnerablesite.htb/profile.php?user=cacca
(if we know that profile.php is vulnerable and can promote our user to Admin via `profile.php?promote=cacca`)
Then we can deliver to the victim the following code:
```
<script>
document.location = "http://vulnerablesite.htb/admin.php?user=htb-stdnt%26promote=htb-stdnt";
</script>
```

**Explanation:**
The code first open `/admin.php?user=cacca`, then we know if performs a client-side redirect to `/profile.php?user=cacca` and we don't need to take that into cound as is a HTTP 2xx is habdled by the browser and no need to refresh of the page. By adding `&promote=cacca` we are jumping to last step as we know profile.php can promote us like that.
Visually will be something like:

```

http://xxxx/admin.php?user=cacca --> http://xxxx/profile.php?user=cacca             -->    http://xxxx/profile.php?promote=cacca
                                    (client side redirect performed by browser)             (This is the last step where we can promote us)
```
As you see here we don't need to care about what redirects happens by browser and by just adding `&promote=cacca` we know that we will end being on **profile.php**