## Introduction
Now that we've covered `MSSQL Server` attacks from an `attacker's` perspective, let's discuss the `defender's` side. In this section, we will discuss various considerations which should be made when reviewing the security posture of an `MSSQL Server` instance.

## MSSQL Server-Specific Considerations
`MSSQL Server` offers a large number of [security capabilities](https://learn.microsoft.com/en-us/sql/relational-databases/security/security-center-for-sql-server-database-engine-and-azure-sql-database?view=sql-server-ver16) which may be fine-tuned to better protect an organizations data, as well as to comply with any necessary regulations. Although we won't cover everything in this section, we will discuss the most important ones.

#### Authentication and Authorization
Properly configured `authentication` and `authorization` settings are crucial to securing a `MSSQL Server`. In `Microsoft's` documentation ([SQL Server Security Best Practices](https://learn.microsoft.com/en-us/sql/relational-databases/security/sql-server-security-best-practices?view=sql-server-ver16)) they make the following recommendations:
- The use of `Windows Authentication` is preferred over `SQL Server Authentication` for various reasons, including the fact it uses the `Kerberos` security protocol, has additional password policies, and makes the management of users simpler.
- The [Principle of Least Privilege](https://www.techtarget.com/searchsecurity/definition/principle-of-least-privilege-POLP) should be used when granting permissions to logins and users. The idea is that all users should be given the minimum permissions required for them to be able to carry out their tasks.
- [Strong and complex passwords](https://learn.microsoft.com/en-us/sql/relational-databases/security/strong-passwords?view=sql-server-ver16) should be `enforced` for all logins by ways of a `password policy`. For `SQL Server Authentication` logins, this is enforced by the server itself, and for `Windows Authentication` logins by the domain.

Besides the few suggestions `Microsoft` provides in their article, recommended actions defenders may take include:
- Not assigning any additional privileges to the `public` [server role](https://learn.microsoft.com/en-us/sql/relational-databases/security/authentication-access/server-level-roles?view=sql-server-ver16), which is assigned by default to every login.
- Revoking the `guest` database user's `CONNECT` permission if it isn't required ([Microsoft Documentation](https://learn.microsoft.com/en-us/sql/relational-databases/policy-based-management/guest-permissions-on-user-databases?view=sql-server-ver16)).
- Disabling and removing [orphaned users](https://learn.microsoft.com/en-us/sql/sql-server/failover-clusters/troubleshoot-orphaned-users-sql-server?view=sql-server-ver16). These are database users which are not assigned to any login.
- Revoking `sysadmin` access for the `BUILTIN\Administrators` group. This is assigned by default when installing the server, and is most likely unnecessary. Do note, however, that it may be possible for attackers to escalate from a `local administrator` account to `sysadmin` even if this is revoked ([blog post](https://www.netspi.com/blog/technical-blog/network-pentesting/get-sql-server-sysadmin-privileges-local-admin-powerupsql/)).

In addition to all these recommendations, it is important that defenders understand [server-](https://learn.microsoft.com/en-us/sql/relational-databases/security/authentication-access/server-level-roles?view=sql-server-ver16) and [database-level roles](https://learn.microsoft.com/en-us/sql/relational-databases/security/authentication-access/database-level-roles?view=sql-server-ver16) and the risks of assigning them. In particular:
- `serveradmin` should be considered the same as `sysadmin`, since escalation is trivial, as we saw in a previous section.
- `db_securityadmin` should be considered the same as `db_owner`, since [escalation](https://www.mssqltips.com/sqlservertip/5222/backdoor-to-elevate-sql-server-security-privileges/) is trivial.
- `db_owner` can drop the database, and can escalate to `sysadmin` if assigned to a [TRUSTWORTHY](https://learn.microsoft.com/en-us/sql/relational-databases/security/trustworthy-database-property?view=sql-server-ver16) database.

#### Surface Area Configuration
The next topic defenders should consider are the large number of [configuration settings](https://learn.microsoft.com/en-us/sql/database-engine/configure-windows/server-configuration-options-sql-server?view=sql-server-ver16&redirectedfrom=MSDN) which can be altered in `MSSQL Server`. By [default](https://learn.microsoft.com/en-us/sql/relational-databases/security/surface-area-configuration?view=sql-server-ver16), most of these are disabled, and the recommendation is to keep everything which is unused disable in order to minimize attack surface.
For example, let's take a look at what is enabled on the `SQL01` server we used in this section. To do so, let's enable `advanced options`, and then use the [sp_configure](https://learn.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-configure-transact-sql?view=sql-server-ver16) stored procedure to enumerate the list of features.
```sql
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;

EXEC sp_configure;

EXEC sp_configure 'show advanced options', 0;
RECONFIGURE;
```

![image](https://academy.hackthebox.com/storage/modules/267/mssql/6/1.png)

Of all the configuration settings returned, only the ones which are strictly necessary for the server to function should be enabled. In particular, defenders should pay close attention to the following configuration settings:
- [xp_cmdshell](https://learn.microsoft.com/en-us/sql/database-engine/configure-windows/xp-cmdshell-server-configuration-option?view=sql-server-ver16&redirectedfrom=MSDN), which can be used to execute code.
- [Ole Automation Procedures](https://learn.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option?view=sql-server-ver16&redirectedfrom=MSDN), which can be used to interact with COM objects and potentially execute code.
- [clr enabled](https://learn.microsoft.com/en-us/sql/database-engine/configure-windows/clr-enabled-server-configuration-option?view=sql-server-ver16), which can be used to run user assemblies.
Note that `show advanced options` itself is a configuration setting, and should remain disabled unless otherwise necessary.

#### Extended Stored Procedures
Another thing to consider are the large number of (extended) stored procedures which `Microsoft` generously provide. As we saw in the `privilege escalation` section, some procedures such as `xp_dirtree`, `xp_fileexist` and `xp_subdirs` may be used to capture the server's `NetNTLMv2` hash. Unless this functionality is strictly needed, disabling them would be a good idea.
Technically speaking, these stored procedure can not be disabled, but [EXECUTION](https://learn.microsoft.com/en-us/sql/relational-databases/stored-procedures/grant-permissions-on-a-stored-procedure?view=sql-server-ver16) permissions may be revoked. For example, to revoke access to the public role so that general users can not execute the `xp_dirtree` stored procedure, we would run the following query:
```sql
REVOKE EXECUTE ON xp_dirtree TO public;
```
As we can see below, we are no longer able to execute the `xp_dirtree` stored procedure as `ws_user`.
![image](https://academy.hackthebox.com/storage/modules/267/mssql/6/2.png)
Note that the mentioned stored procedures are undocumented, and are used by the server to perform various tasks. Before revoking access to these procedures in a production environment, it is recommended to test this change in a testing environment to make sure everything still functions. If necessary, it is preferential to grant execute permissions to individual logins.

#### Updates and Patches
As with any other software, security patches and new features are regularly added to [MSSQL Server](https://learn.microsoft.com/en-us/troubleshoot/sql/releases/download-and-install-latest-updates). `Microsoft` use the following terminology to describe updates:
- `Cumulative Update`: A roll-up update that contains all previous critical on-demand hotfixes to date.
- `Service Pack`: A tested, cumulative set of all hotfixes, security updates, critical updates, and updates.

It is recommended to keep `MSSQL Server` instances [up-to-date](https://learn.microsoft.com/en-us/troubleshoot/sql/releases/download-and-install-latest-updates). That being said, verifying that updates do not break anything in a test environment prior to updating the production environment is just as important.

## General Considerations
Up until now, we have discussed defensive considerations specific to `MSSQL Server` itself, but a secure database server in an insecure environment is pointless, so let's discuss other factors which must be considered.

#### Server Security
Arguably as important as securing the `MSSQL Server` instance is securing the `server` it is running on. An attacker with access to the server running the `MSSQL Server` service has many possibilities for attacking the `MSSQL Server` instance. It is therefore important to:
- Keep the server operating system up to date, to prevent unpatched vulnerabilities from being exploited.
- Use the `Principle of Least Privilege` when granting access to the server.
- Restrict access to the physical `MSSQL Server` files by settings correct file permissions.
- Use the [appropriate user](https://academy.hackthebox.com/module/267/section/(https://learn.microsoft.com/en-us/previous-versions/sql/sql-server-2008-r2/ms143504(v=sql.105)?redirectedfrom=MSDN)) to run the `MSSQL Server` service.

#### Application Security
One of the most common way attackers interact with `MSSQL Server` instance is through `SQL injection` vulnerabilities in applications such as `websites`. It is important to review all applications which interact with the `MSSQL Server` for `SQL injection` vulnerabilities to prevent this from happening. Besides this, it is recommended to host applications and the `MSSQL Server` on seperate servers, so that if a remote code execution vulnerability is discovered in the application, for example, the attackers don't immediatly have access to the database.

#### Firewall Configuration
It is recommended to restrict network access to the `MSSQL Server` instance as much as possible (once again, `Principle of Least Privilege`). `MSSQL Server` makes use of various ports, as is described by Microsoft in this [article](https://learn.microsoft.com/en-us/sql/sql-server/install/configure-the-windows-firewall-to-allow-sql-server-access?view=sql-server-ver16), however `TCP/1433` is the most common since it is what is used by default for TCP connections. Most importantly, unless absolutely necessary, connections to the `MSSQL Server` from the public internet should not be allowed.

#### Regular Security Audits
The final consideration we will discuss is that of (regular) security audits, such as penetration tests. Database administrators are humans, and as such make mistakes, so it is recommended to carry out regular security audits to catch anything that may have been missed. Ideally this would be carried out by a qualified team of professionals, however simply running `Invoke-SQLAudit` from [PowerUpSQL](https://github.com/NetSPI/PowerUpSQL/blob/master/PowerUpSQL.psd1) as mentioned in the previous section is a good start.