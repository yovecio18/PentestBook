## What is?
[Kerberos](https://docs.microsoft.com/en-us/windows/win32/secauthn/microsoft-kerberos) is a protocol that allows users to authenticate on the network and access services once authenticated. Kerberos is a stateless authentication protocol based on tickets. It effectively decouples a user's credentials from their requests to consumable resources, ensuring their password is not transmitted over the network.

## How to identify?
It runs over port 88/TCP.

## Buzzwords
- TGT(Ticket Granting Ticket): it's the ticket granted to a user to perform login/requesting resources etc.
- TGS(Ticket Granting Services): it's a module part of the KDC that issues TGT to user and services.
- KDC(Key Distribution Service): it's the key distribution system in a AD environment. It contains TGS as named before.
- ST(Service Ticket): sometimes also named just "TGS" it is a kerberos ticket used to access services(uses SPNs as well).

## Kerberos Authentication Process
![[Pasted image 20240926100748.png]]
1. To start, the user will request the first ticket from the key server (the KDC), proving they are who they claim to be. This is when the client `authenticates` to the KDC. This ticket, called a `TGT` (Ticket Granting Ticket), is the user's identity card. It contains all the information about the user, such as name, date of account creation, security information about the user, the groups to which the user belongs, etc. This identity card, the TGT, is limited to a few hours by default. This ticket is presented for all other requests to the KDC.
2. Once this TGT has been obtained, the user will present it to the KDC each time they need to access a service. The KDC will then verify that the submitted TGT is valid and that the user did not forge it, and if so, it will return a Ticket Granting Service (TGS) ticket or Service Ticket (ST) to the user. A copy of the user's information in the TGT is included in the TGS ticket.
3. Now that the user has a TGS ticket for a particular service, they will present this TGS ticket to the service to use it. The service will then check the validity of this ticket, and if all is well, it will read the content of the user's information to determine if the user is entitled to use the requested service. It is, therefore, `the service that checks the user's access rights`.

## Ticket protection
![[Pasted image 20240926101500.png]]
1. The `TGT` sent by the KDC to the user is encrypted using `the secret key of the KDC`, which only the KDC knows. Thus, the user cannot read or modify the information about themself. The KDC itself protects it.
2. The `TGS ticket` sent by the KDC to the user is encrypted using `the service's secret key`. In the same way, as the user does not know the service key, they cannot modify the information in the `TGS ticket`. On the other hand, when they send this `TGS ticket` to the service, the latter can decrypt the ticket's content and read the user's information.

# Authentication Steps(drill down...)
## Request(AS-REQ)
![[Pasted image 20240926102722.png]]
This is the first step when a user contact the KDC and is requesting to receive a valid TGT ticket. 
In this phase(named  `AS-REQ`) the requestor is required to provide a proof of its validity(timestamp that the user will use to encrypt the request).
Upon receive by the KDC will attempt to decrypt and if succeed then the proof is matched.
*OBS: this is active by default but can be disabled which is the "do not require pre-authentication" aka AS-REP Attack!*
## Response(AS-REP)
![[Pasted image 20240926102732.png]]
This is the step when the KDC succeed to decryp the AS-REQ request and the proof of validity is passed. In this stage the following steps will occur:
1. First, we are waiting for the `TGT` that the user requested. It contains all the user's information and is protected with the KDC's key, so the user can't tamper with it. It also contains a `copy` of the `generated session key`.
2. Second is the `session key`, but this time `protected` with the `user's key`.
Therefore, this session key is duplicated in the response—one version is protected with the KDC's key, and another is protected with the user's key.
## Request(TGS-REQ)
![[Pasted image 20240926102749.png]]
This is the step when the client(requestor) is asking the TGS to provide a ST/TGS ticket by shipping a valid TGT obtained before from the KDC. This request send by the client will contain the following piece of informations:
1. The name of the service they wish to access (SERVICE/HOST, which is the Service Principal Name (SPN) representation)
2. The TGT they previously received, containing their information and a copy of the session key
3. An authenticator, which will be encrypted using the session key at this time
## Response(TGS-RES)
![[Pasted image 20240926104207.png]]
The KDC will decrypt the TGT (checking its authenticity along the way) and extract the session key. With this session key, it will be able to verify the authenticator's validity.
If all this is done correctly, the KDC only has to read the requested service and respond to the user with a `TGS-REP` message.
 Here are all the elements sent by the KDC back in a ST/TGS ticket:
 1. The name of the requested service (its SPN)
2. A copy of the user information that was present in the TGT. The service will read this information to determine whether or not the user has the right to use it.
3. A copy of the session key
## Request (AP-REQ)
![[Pasted image 20240926104920.png]]
The user can now decrypt this response to extract the user/service session key and the TGS ticket, but the TGS ticket is protected with the service key. The user can't modify this TGS ticket, so they can't modify their rights, just like with the TGT.

The user will only transmit this TGS ticket to the service, and just like with the TGS request,  an authenticator is added to it. What will the user encrypt this authenticator with? You guessed it, with the user/service session key just extracted. The process is very similar to the previous TGS request.
## Response (AP-REP)
The service finally receives the TGS ticket and an authenticator encrypted with the user/service session key generated by the KDC. This TGS ticket is protected with the service's key so that it can decrypt it. Remember that a copy of the user/service session key is embedded within the TGS ticket, so it can extract it and check the validity of the authenticator with this session key.

If everything goes correctly, the service can finally read the information about the user, including the groups to which they belong, and according to its access rules, grant or deny them access to the service. If authentication is successful, the service responds to the client with an `AP-REP` message by encrypting the timestamp with the extracted session key. The client can then verify that this message is coming from the service and can start issuing service requests.