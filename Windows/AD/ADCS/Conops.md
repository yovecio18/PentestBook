## What is ADCS?

`Active Directory Certificate Services (AD CS)` is a Windows server role that enables organizations to establish and manage their own Public Key Infrastructure (PKI).

AD CS integrates with Active Directory Domain Services (AD DS), which is a centralized database of users, computers, groups, and other objects in a Windows network.

AD CS can be used to secure various network services, such as Secure Socket Layer/Transport Layer Security (SSL/TLS), Virtual Private Network (VPN), Remote Desktop Services (RDS), and Wireless LAN (WLAN). It can also issue certificates for smart cards and other physical tokens, which can be used to authenticate users to network resources. The private key stored on the smart card or token is then used to authenticate the user to the network.

Active Directory Certificate Services includes:

1. Digital Certificates
2. Certificate Authority
    1. Stand-alone CA or Enterprise CA
    2. Root CA or Subordinate CA
3. Certificate Templates
4. Key Pair Generation
5. Certificate Revocation
6. Secure Communication
7. Digital Signatures
8. Encryption and Decryption
9. Enhanced Security and Identity Management


## Key Terminologies in ADCS:

- `Certificate Templates`: These predefined configurations dictate the properties and usage of certificates issued by AD CS. They encompass settings like certificate purpose, key size, validity period, and issuance policies. AD CS offers standard templates (e.g., Web Server, Code Signing) while empowering administrators to craft custom templates catering to specific business requisites.
    
- `Public Key Infrastructure (PKI)`: A comprehensive system integrating hardware, software, policies, and procedures for creating, managing, distributing, and revoking digital certificates. It houses Certification Authorities (CAs) and registration authorities validating entities involved in electronic transactions via public key cryptography.
    
- `Certificate Authority (CA)`: This component issues certificates to users, computers, and services while overseeing certificate validity management.
    
- `Certificate Enrollment`: Entities request certificates from CAs, where verification of the requester's identity precedes certificate issuance.
    
- `Certificate Manager`: Responsible for certificate issuance, management, and authorization of enrollment and revocation requests.
    
- `Digital Certificate`: An electronic document housing identity details, such as user or organizational names, and a corresponding public key. These certificates serve for authentication, proving a person's or device's identity.
    
- `Certificate Revocation`: ADCS supports revoking certificates if they are compromised or no longer valid. Revocation can be managed through Certificate Revocation Lists (CRLs) or Online Certificate Status Protocol (OCSP).
    
- `Key Management`: ADCS provides mechanisms to manage private keys, ensuring their security and proper usage.
    
- `Backup Operator`: The backup operator backs up and restores files and directories. Backup operators are assigned using Active Directory Users and Computers or Computer Management. They can back up and restore the system state, including CA information, Start and stop the AD CS service, Possess the system backup user right, and Read records and configuration information in the CA database.
    
- `Standalone CA & Enterprise CA`: `Standalone CAs` operate autonomously without Active Directory, allowing manual or web-based certificate requests. In contrast, `Enterprise CAs`, reliant on Active Directory, issue certificates for users, devices, and servers within an organization, automating processes using Group Policy or Certificate Enrollment Web Services.
    
- `Certificate Signing Requests`: `Certificate Signing Requests (CSRs)` are requests submitted by users or devices to an ADCS CA to obtain a certificate. A CSR contains the user or device's public key and other identifying information, such as the certificate's subject name and intended usage. When a CSR is submitted to a CA, the CA verifies the requester's identity and performs various checks to ensure the integrity and validity of the CSR. If the CSR is approved, the CA issues a digital certificate that binds the requester's public key to their identity and intended usage.
    
- `Certificate Revocation List`: A digitally signed inventory issued by a CA cataloging revoked certificates. The CRL includes details of certificates invalidated by the CA, ensuring entities can verify the revoked status of specific certificates.
    
- `Extended/Enhanced Key Usages`: Certificate extensions delineating authorized uses for a certificate. EKUs allow administrators to restrict certificate usage to defined applications or scenarios, such as code signing, email encryption, or smart card logon. AD CS furnishes prebuilt EKUs like Server Authentication, Client Authentication, and Code Signing, empowering administrators to craft custom EKUs aligning with specific business requisites.


## Certificates

A certificate is an `X.509-formatted digitally signed document` serves purposes like encryption, message signing, and authentication. It consists of multiple key fields:

- `Subject`: The certificate owner's identity.
- `Public Key`: Links the Subject to a separate private key.
- `NotBefore` and `NotAfter` dates: Define the certificate's validity duration.
- `Serial Number`: A unique identifier assigned by the issuing CA.
- `Issuer`: Identifies the certificate issuer, often a CA.
- `SubjectAlternativeName`: Specifies alternative names associated with the Subject.
- `Basic Constraints`: Delineates if the certificate is a CA or end entity, along with any usage constraints.
- `Extended Key Usages (EKUs)`: Object identifiers describing specific usage scenarios for the certificate. Common EKUs cover functionalities like code signing, encrypting file systems, secure email, client and server authentication, and smart card logon.
- `Signature Algorithm` and `Signature`: Indicate the algorithm used for signing the certificate and the resulting signature made with the issuer's private key.

The certificate's content links an identity (`the Subject`) to a `key pair`, enabling applications to utilize this key pair in operations as evidence of the user's identity.


## Certificate Templates

AD CS Enterprise `CAs` use `certificate templates` to establish certificate settings that include enrollment policies, validity duration, intended usage, subject specifications, and requester eligibility. These templates are managed through the Certificate Templates feature and are stored as AD objects with the objectClass of `pKICertificateTemplate`. The settings of these certificate templates are defined through attributes while their enrollment permissions and template edits are controlled through their security descriptors.

The `pKIExtendedKeyUsage` attribute within an AD certificate template object contains a cluster of enabled `OIDs (Object Identifier)` that impact the permissible uses of the certificate. These EKU `OIDs` encompass functionalities such as Encrypting File System, Code Signing, Smart Card Logon, and Client Authentication, among others, which are detailed in Microsoft's breakdown of EKU `OIDs` by PKI Solutions.

[SpecterOps research](https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf) focused on `EKUs` that enable authentication to AD when present in a certificate. While it was initially believed that only the Client Authentication OID (`1.3.6.1.5.5.7.3.2`) offered this capability, their findings identified several other enabling OIDs:

|Description|OID|
|---|---|
|Client Authentication|1.3.6.1.5.5.7.3.2|
|PKINIT Client Authentication*|1.3.6.1.5.2.3.4|
|Smart Card Logon|1.3.6.1.4.1.311.20.2.2|
|Any Purpose|2.5.29.37.0|
|SubCA|(no EKUs)|

**Note:** The `1.3.6.1.5.2.3.4 OID` requires manual addition in AD CS deployments but it can be used for client authentication.


## Enrollment Process

To obtain a certificate from ADCS, clients need to go through the process of enrollment.

1. `Find an Enterprise CA`: The first step for clients is to find an Enterprise CA, which is based on the objects in the Enrollment Services container.
    
2. `Generate a public-private key pair and create a CSR`: Clients generate a public-private key pair and create a certificate signing request (CSR) message. This message contains the public key along with various other details such as the certificate template name and subject of the certificate.
    
3. `Sign the CSR with private key and send to Enterprise CA server`: Clients sign the CSR with their private key and send it to the Enterprise CA server.
    
4. `CA check if the client is authorized to request certificates`: The CA server checks if the client is authorized to request certificates. If so, it looks up the certificate template AD object specified in the CSR to determine whether or not to issue a certificate. The CA checks if the certificate template AD object's permissions allow the authenticating account to obtain a certificate.
    
5. `CA generate the certificate, sign it and if allowed, send it to the client`: If the permissions allow, the CA generates a certificate using the "blueprint" settings defined by the certificate template, such as EKUs, cryptography settings, and issuance requirements. If allowed by the certificate's template settings, the CA uses other information supplied in the CSR and signs the certificate using its private key and returns it to the client.
    
6. `The Client Receive the certificate`: The client store the certificate in Windows Certificate store and uses to do <EKU OID>