## Attack Types
The realm of ADCS misconfiguration continued to evolve, leading to further investigations and discoveries crucial to understanding the system's weaknesses. In this module, we'll cover a comprehensive spectrum of misconfiguration that have been categorized for ease of understanding:

- `Abusing Certificate Templates`: This category encompasses ESC1, ESC2, ESC3, ESC9, and ESC10, focusing on misconfiguration within certificate templates.
    
- `Abusing CA Configuration (ESC6)`: Exploiting weaknesses within the Certificate Authority configuration falls under this category.
    
- `Abusing Access Control (ESC4, ESC5, ESC7)`: Understanding misconfiguration associated with Access Control is vital, and these misconfiguration highlight potential weaknesses within ADCS.
    
- `NTLM Relay (ESC8, ESC11)`: Exploiting NTLM relay misconfiguration is crucial, and these misconfiguration (ESC8 and ESC11) delve into this aspect within ADCS.
    
- `Miscellaneous ADCS Attacks`: This category covers other significant vulnerabilities, including Certifried and PKINIT not Supported, providing a broad overview of diverse attack vectors within ADCS.


## Enumeration
One indicative factor of an ADCS installation is the presence of the built-in `Cert Publishers` group. This group typically authorizes `Certificate Authorities` to publish certificates to the directory, often indicating the presence of an ADCS server. That means that the ADCS server will be a member of this group.
```
net localgroup "Cert Publishers"
```
To enumerate deeper like vulnerable Templates and possible PE vectors you can do the following.
**Windows:**
Use `Certify.exe` to enumerate a ADCS from a Windows based client([GhostPack/Certify: Active Directory certificate abuse. (github.com)](https://github.com/GhostPack/Certify))
```
 Certify.exe find [/ca:SERVER\ca-name | /domain:domain.local 
```
**Linux:**
Same can be archived directly from your Linux client
```
netexec ldap IP -u "USER" -p "PASSWORD" -M adcs
```
Alternatively you can use the Certipy Linux implementation.
```
//Install the Tool
pip3 install certipy-ad

//Enumeration time
certipy-ad find -u 'USER' -p 'PASSWORD' -dc-ip IP -stdout
```

### Automatic Enumeration
There is a third alternative by not outputting to terminal the results via *-stdout* but instead by omitting I will get a result zipped instead.
```
certipy-ad find -u 'blwasp@lab.local' -p 'Password123!' -dc-ip 10.129.205.199 -bloodhound

Certipy v4.8.2 - by Oliver Lyak (ly4k)
[*] Finding certificate templates
[*] Found 40 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 18 enabled certificate templates
[*] Trying to get CA configuration for 'lab-LAB-DC-CA' via CSRA
[*] Got CA configuration for 'lab-LAB-DC-CA'
[*] Saved BloodHound data to '20231128193735_Certipy.zip'. Drag and drop the file into the BloodHound GUI from @ly4k
```
This archive can be parsed by using a customized "Bloodhound" variant that supports ADCS template analysis.
```
//Getting the tool
wget -q https://github.com/ly4k/BloodHound/releases/download/v4.2.0-ly4k/BloodHound-linux-x64.zip
unzip BloodHound-linux-x64.zip

//Starting the neo4j DB
sudo /usr/bin/neo4j console

//Starting the tool
cd BloodHound-linux-x64/
./BloodHound --no-sandbox
```
Execute a standard scan with same user and grab a screenshot of the AD schema(outside the ADCS) and upload it to the Bloodhound, this will help to mix & match the data between ADCS and AD.
From here upload the archive as usual up for analysis in Bloodhound and check the GUI for vulnerabilities.

### Extra
If you will even need to use a pivot machine to perform some tasks where only that machine can reach the ADCS target then you can setup a reverse dynamic forward tunnel + proxychains.
```
sshpass -p 'HTB_@cademy_stdnt!' ssh -N -f -D 127.0.0.1:9050 htb-student@10.129.205.205
```
(This logins to the pivot machine via SSH and setup a dynamic reverse tunnel that redirects to local port 9050 which is used by proxychains4).
The you can send commands directly from you kali via connection:
```
proxychains4 -q netexec smb 172.16.19.3-5 -u cken -p Superman001
```